<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog 
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

  <property name="boolean.type" value="boolean" dbms="mysql" />
  <property name="boolean.type" value="number(1,0)" dbms="oracle" />

  <property name="int.type" value="bigint" dbms="mysql" />
  <property name="int.type" value="number(19,0)" dbms="oracle" />

  <property name="smallint.type" value="smallint" dbms="mysql" />
  <property name="smallint.type" value="number(5,0)" dbms="oracle" />

  <property name="text.type" value="varchar" dbms="mysql" />
  <property name="text.type" value="varchar2" dbms="oracle" />

  <property name="double.type" value="double"/>

  <property name="autoIncrement" value="true" dbms="mysql"/>
  <property name="autoIncrement" value="false" dbms="oracle"/>

  <property name="timestamp.type" value="timestamp" dbms="mysql" />
  <property name="timestamp.type" value="timestamp" dbms="oracle" />

  <property name="nullable.ts.type" value="timestamp null" dbms="mysql" />
  <property name="nullable.ts.type" value="timestamp" dbms="oracle" />

  <changeSet author="vpawar" id="Simplified storage containers" failOnError="true">
    <createTable tableName="OS_STORAGE_CONTAINERS">
      <column name="IDENTIFIER" type="${int.type}" autoIncrement="${autoIncrement}">
        <constraints primaryKey="true" nullable="false"/>
      </column>

      <column name="NAME" type="${text.type}(64)">
        <constraints unique="true" nullable="false" />
      </column>
     
      <column name="BARCODE" type="${text.type}(64)">
        <constraints unique="true" />
      </column>

      <column name="TEMPERATURE" type="${double.type}">
      </column>
     
      <column name="DIMENSION_ONE_CAPACITY" type="${int.type}">
        <constraints nullable="false"/>
      </column>
     
      <column name="DIMENSION_TWO_CAPACITY" type="${int.type}">
        <constraints nullable="false"/>
      </column>
     
      <column name="DIMENSION_ONE_LABELING_SCHEME" type="${text.type}(64)" defaultValue="Numbers">
      </column>
     
      <column name="DIMENSION_TWO_LABELING_SCHEME" type="${text.type}(64)" defaultValue="Numbers">
      </column>

      <column name="SITE_ID" type="${int.type}">
        <constraints nullable="false"/>
      </column>

      <column name="PARENT_CONTAINER_ID" type="${int.type}">
      </column>

      <column name="CREATED_BY" type="${int.type}">
        <constraints nullable="false"/>
      </column>
     
      <column name="ACTIVITY_STATUS" type="${text.type}(16)">
      </column>

      <column name="POSITION_ID" type="${int.type}">
      </column>

      <column name="COMMENTS" type="${text.type}(255)">
      </column>
    </createTable>
  </changeSet>

  <changeSet author="vpawar" id="Add FK to container site">
    <addForeignKeyConstraint
      constraintName="FK_OS_ST_CONT_SITE_ID"
      baseTableName="OS_STORAGE_CONTAINERS"
      baseColumnNames="SITE_ID"
      referencedTableName="CATISSUE_SITE"
      referencedColumnNames="IDENTIFIER" />
  </changeSet>

  <changeSet author="vpawar" id="Add FK to container's parent container">
    <addForeignKeyConstraint
      constraintName="FK_OS_ST_CONT_PARENT_CONT"
      baseTableName="OS_STORAGE_CONTAINERS"
      baseColumnNames="PARENT_CONTAINER_ID"
      referencedTableName="OS_STORAGE_CONTAINERS"
      referencedColumnNames="IDENTIFIER" />
  </changeSet>

  <changeSet author="vpawar" id="Add FK to container creator">
    <addForeignKeyConstraint
      constraintName="FK_OS_ST_CONT_CREATED_BY"
      baseTableName="OS_STORAGE_CONTAINERS"
      baseColumnNames="CREATED_BY"
      referencedTableName="CATISSUE_USER"
      referencedColumnNames="IDENTIFIER" />
  </changeSet>

  <changeSet author="vpawar" id="Containers table sequence">
    <createSequence 
      sequenceName="OS_STORAGE_CONTAINERS_SEQ" 
      startValue="1" 
      incrementBy="1" 
      ordered="true" />
  </changeSet>

  <changeSet author="vpawar" id="Allowed specimen classes in container">
    <createTable tableName="OS_STOR_CONT_SPEC_CLASSES">
      <column name="STORAGE_CONTAINER_ID" type="${int.type}">
        <constraints nullable="false"/>
      </column>
      <column name="SPECIMEN_CLASS" type="${text.type}(32)">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet author="vpawar" id="Add FK to container in allowed specimen classes">
    <addForeignKeyConstraint
      constraintName="FK_OS_ST_CONT_SC_CONT_ID"
      baseTableName="OS_STOR_CONT_SPEC_CLASSES"
      baseColumnNames="STORAGE_CONTAINER_ID"
      referencedTableName="OS_STORAGE_CONTAINERS"
      referencedColumnNames="IDENTIFIER" />
  </changeSet>

  <changeSet author="vpawar" id="Allowed specimen types in container">
    <createTable tableName="OS_STOR_CONT_SPEC_TYPES">
      <column name="STORAGE_CONTAINER_ID" type="${int.type}">
        <constraints nullable="false"/>
      </column>
      <column name="SPECIMEN_TYPE" type="${text.type}(128)">
      </column>
    </createTable>
  </changeSet>

  <changeSet author="vpawar" id="Add FK to container in allowed specimen types">
    <addForeignKeyConstraint
      constraintName="FK_OS_ST_CONT_ST_CONT_ID"
      baseTableName="OS_STOR_CONT_SPEC_TYPES"
      baseColumnNames="STORAGE_CONTAINER_ID"
      referencedTableName="OS_STORAGE_CONTAINERS"
      referencedColumnNames="IDENTIFIER" />
  </changeSet>

  <changeSet author="vpawar" id="Allowed CP specimens in container">
    <createTable tableName="OS_STOR_CONTAINER_CPS">
      <column name="STORAGE_CONTAINER_ID" type="${int.type}">
        <constraints nullable="false"/>
      </column>
      <column name="CP_ID" type="${int.type}">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet author="vpawar" id="Add FK to container in allowed CP specimens">
    <addForeignKeyConstraint
      constraintName="FK_OS_ST_CONT_CPS_CONT_ID"
      baseTableName="OS_STOR_CONTAINER_CPS"
      baseColumnNames="STORAGE_CONTAINER_ID"
      referencedTableName="OS_STORAGE_CONTAINERS"
      referencedColumnNames="IDENTIFIER" />
  </changeSet>

  <changeSet author="vpawar" id="Add FK to CP in allowed CP specimens">
    <addForeignKeyConstraint
      constraintName="FK_OS_ST_CONT_CPS_CP_ID"
      baseTableName="OS_STOR_CONTAINER_CPS"
      baseColumnNames="CP_ID"
      referencedTableName="CATISSUE_COLLECTION_PROTOCOL"
      referencedColumnNames="IDENTIFIER" />
  </changeSet>

  <changeSet author="vpawar" id="Container position occupancy table">
    <createTable tableName="OS_CONTAINER_POSITIONS">
      <column name="IDENTIFIER" type="${int.type}" autoIncrement="${autoIncrement}">
        <constraints primaryKey="true" nullable="false"/>
      </column>

      <column name="POS_ONE" type="${smallint.type}">
        <constraints nullable="false"/>
      </column>
     
      <column name="POS_TWO" type="${smallint.type}">
        <constraints nullable="false"/>
      </column>

      <column name="POS_ONE_STR" type="${text.type}(8)">
        <constraints nullable="false"/>
      </column>
     
      <column name="POS_TWO_STR" type="${text.type}(8)">
        <constraints nullable="false"/>
      </column>

      <column name="STORAGE_CONTAINER_ID" type="${int.type}">
        <constraints nullable="false"/>
      </column>

      <column name="OCCUPYING_SPECIMEN_ID" type="${int.type}">
      </column>

      <column name="OCCUPYING_CONTAINER_ID" type="${int.type}">
      </column>
    </createTable>
  </changeSet>

  <changeSet author="vpawar" id="Add FK to container in container occupancy table">
    <addForeignKeyConstraint
      constraintName="FK_OS_POS_ST_CONTS_CONT_ID"
      baseTableName="OS_CONTAINER_POSITIONS"
      baseColumnNames="STORAGE_CONTAINER_ID"
      referencedTableName="OS_STORAGE_CONTAINERS"
      referencedColumnNames="IDENTIFIER" />
  </changeSet>

  <changeSet author="vpawar" id="Containers occupancy table sequence">
    <createSequence 
      sequenceName="OS_CONTAINER_POSITIONS_SEQ"
      startValue="1" 
      incrementBy="1" 
      ordered="true" />
  </changeSet>

  <changeSet author="vpawar" id="Add FK to occupying specimen id in container occupancy table">
    <addForeignKeyConstraint
      constraintName="FK_OS_POS_ST_CONTS_OSPID"
      baseTableName="OS_CONTAINER_POSITIONS"
      baseColumnNames="OCCUPYING_SPECIMEN_ID"
      referencedTableName="CATISSUE_SPECIMEN"
      referencedColumnNames="IDENTIFIER"/>
  </changeSet>

  <changeSet author="vpawar" id="Add FK to occupying container id in container occupancy table">
    <addForeignKeyConstraint
      constraintName="FK_OS_POS_ST_CONTS_OCPID"
      baseTableName="OS_CONTAINER_POSITIONS"
      baseColumnNames="OCCUPYING_CONTAINER_ID"
      referencedTableName="OS_STORAGE_CONTAINERS"
      referencedColumnNames="IDENTIFIER"/>
  </changeSet>

  <changeSet author="vpawar" id="Unique constraint on specimen id in container occupancy table">
    <addUniqueConstraint 
      tableName="OS_CONTAINER_POSITIONS"
      columnNames="OCCUPYING_SPECIMEN_ID"
      constraintName="OS_POS_ST_CONTS_OSPID_UQ"/>
  </changeSet>

  <changeSet author="vpawar" id="Unique constraint on container id in container occupancy table">
    <addUniqueConstraint 
      tableName="OS_CONTAINER_POSITIONS"
      columnNames="OCCUPYING_CONTAINER_ID"
      constraintName="OS_POS_ST_CONTS_OCPID_UQ"/>
  </changeSet>

  <changeSet author="vpawar" id="Storage container stats view" runOnChange="true">
    <sql> 
      create or replace view OS_STORAGE_CONT_STATS_VIEW as (
        select 
          s.identifier as container_id, s.name as container_name, 
          s.dimension_one_capacity * s.dimension_two_capacity - count(p.identifier) as free_positions
        from 
          os_storage_containers s 
          left join os_container_positions p on p.storage_container_id = s.identifier 
        group by 
          s.identifier, s.name, s.dimension_one_capacity, s.dimension_two_capacity
      )
    </sql>
  </changeSet>

  <changeSet author="vlonushte" id="Rename facility_id column to code of site table">
    <renameColumn columnDataType="${text.type}(50)" newColumnName="CODE" oldColumnName="FACILITY_ID" tableName="CATISSUE_SITE"/>
  </changeSet>

  <changeSet author="vlonushte" id="Add unique constraint on code column of catissue_site">
    <addUniqueConstraint constraintName="CATISSUE_SITE_CODE_UQ" tableName="CATISSUE_SITE" columnNames="CODE"/>
  </changeSet>

  <changeSet author="vlonuste" id="OS forgot password tokens table">
    <createTable tableName="OS_FORGOT_PASSWORD_TOKENS">
      <column name="USER_ID" type="${int.type}">
        <constraints primaryKey="true" nullable="false"/>
      </column>

      <column name="TOKEN" type="${text.type}(64)">
        <constraints nullable="false"/>
      </column>

      <column name="CREATED_DATE" type="${timestamp.type}">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet author="vlonushte" id="FK on user of forgot password token">
    <addForeignKeyConstraint 
      constraintName="FK_FG_TOKENS_USER_ID"
      baseTableName="OS_FORGOT_PASSWORD_TOKENS"
      baseColumnNames="USER_ID"
      referencedTableName="CATISSUE_USER"
      referencedColumnNames="IDENTIFIER"/>
  </changeSet>

  <changeSet author="vlonushte" id="Adding password column to user table">
    <addColumn tableName="CATISSUE_USER">
      <column name="password" type="${text.type}(64)"/>
    </addColumn>
  </changeSet>

  <changeSet author="vlonushte" id="OS auth domains table">
    <createTable tableName="OS_AUTH_DOMAINS">
      <column name="IDENTIFIER" type="${int.type}" autoIncrement="${autoIncrement}">
        <constraints primaryKey="true" nullable="false"/>
      </column>

      <column name="DOMAIN_NAME" type="${text.type}(64)">
        <constraints unique="true" nullable="false" />
      </column>

      <column name="AUTH_TYPE" type="${text.type}(64)">
        <constraints nullable="false" />
      </column>
    </createTable>
  </changeSet>

  <changeSet author="vlonushte" id="OS auth domains table sequence" dbms="oracle">
    <createSequence 
      sequenceName="OS_AUTH_DOMAINS_SEQ" 
      startValue="1" 
      incrementBy="1" 
      ordered="true"/>
  </changeSet>

  <changeSet author="vlonushte" id="OS auth providers table">
    <createTable tableName="OS_AUTH_PROVIDERS">
      <column name="IDENTIFIER" type="${int.type}" autoIncrement="${autoIncrement}">
        <constraints primaryKey="true" nullable="false"/>
      </column>

      <column name="AUTH_TYPE" type="${text.type}(64)">
        <constraints unique="true" nullable="false" />
      </column>

      <column name="IMPL_CLASS" type="${text.type}(255)">
        <constraints nullable="false" />
      </column>
    </createTable>
  </changeSet>

  <changeSet author="vlonushte" id="OS auth providers table sequence" dbms="oracle">
    <createSequence 
      sequenceName="OS_AUTH_PROVIDERS_SEQ" 
      startValue="1" 
      incrementBy="1" 
      ordered="true" />
  </changeSet>

  <changeSet author="vlonushte" id="OS auth provider properties table">
    <createTable tableName="OS_AUTH_PROVIDER_PROPS">
      <column name="AUTH_PROVIDER_ID" type="${int.type}">
        <constraints nullable="false"/>
      </column>

      <column name="NAME" type="${text.type}(32)">
        <constraints nullable="false"/>
      </column>

      <column name="VALUE" type="${text.type}(255)">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet author="vlonushte" id="FK on auth type of auth domains">
    <addForeignKeyConstraint 
      constraintName="FK_AUTH_DOMAINS_AUTH_TYPE"
      baseTableName="OS_AUTH_DOMAINS"
      baseColumnNames="AUTH_TYPE"
      referencedTableName="OS_AUTH_PROVIDERS"
      referencedColumnNames="AUTH_TYPE"/>
  </changeSet>

  <changeSet author="vlonushte" id="FK on auth provider of auth provider props">
    <addForeignKeyConstraint 
      constraintName="FK_AP_PROPS_AP_ID"
      baseTableName="OS_AUTH_PROVIDER_PROPS"
      baseColumnNames="AUTH_PROVIDER_ID"
      referencedTableName="OS_AUTH_PROVIDERS"
      referencedColumnNames="IDENTIFIER"/>
  </changeSet>

  <changeSet author="vlonushte" id="Drop domain name column of users table">
    <preConditions>
      <columnExists columnName="DOMAIN_NAME" tableName="CATISSUE_USER"/>
    </preConditions>
    <dropColumn columnName="DOMAIN_NAME" tableName="CATISSUE_USER"/>
  </changeSet>

  <changeSet author="vlonushte" id="Add domain name column to users table">
    <addColumn tableName="CATISSUE_USER">
      <column name="DOMAIN_NAME" type="${text.type}(64)" defaultValue="openspecimen"/>
    </addColumn>
  </changeSet>

  <changeSet author="vlonushte" id="Add openspecimen domain and auth provider" dbms="mysql">
    <sql>
      insert into OS_AUTH_PROVIDERS(IDENTIFIER, AUTH_TYPE, IMPL_CLASS) 
      values(default, 'openspecimen', 'com.krishagni.catissueplus.core.auth.services.impl.OpenSpecimenAuthServiceImpl');
 
      insert into OS_AUTH_DOMAINS(IDENTIFIER, DOMAIN_NAME, AUTH_TYPE)
      values(default, 'openspecimen', 'openspecimen');
    </sql>
  </changeSet>

  <changeSet author="vlonushte" id="Add openspecimen domain and auth provider" dbms="oracle">
    <sql>
      insert into OS_AUTH_PROVIDERS(IDENTIFIER, AUTH_TYPE, IMPL_CLASS) 
      values(OS_AUTH_PROVIDERS_SEQ.nextval, 'openspecimen', 'com.krishagni.catissueplus.core.auth.services.impl.OpenSpecimenAuthServiceImpl');

      insert into OS_AUTH_DOMAINS(IDENTIFIER, DOMAIN_NAME, AUTH_TYPE)
      values(OS_AUTH_DOMAINS_SEQ.nextval, 'openspecimen', 'openspecimen');
    </sql>
  </changeSet>

  <changeSet author="vlonushte" id="FK on domain name of users table">
    <addForeignKeyConstraint 
      constraintName="FK_USER_DOMAIN_NAME"
      baseTableName="CATISSUE_USER"
      baseColumnNames="DOMAIN_NAME"
      referencedTableName="OS_AUTH_DOMAINS"
      referencedColumnNames="DOMAIN_NAME"/>
  </changeSet>

  <changeSet author="vlonushte" id="OS Login Audit Logs table">
    <createTable tableName="OS_LOGIN_AUDIT_LOGS">
      <column name="IDENTIFIER" type="${int.type}" autoIncrement="${autoIncrement}">
        <constraints primaryKey="true" nullable="false"/>
      </column>

      <column name="USER_ID" type="${int.type}">
        <constraints nullable="false"/>
      </column>

      <column name="IP_ADDRESS" type="${text.type}(32)">
        <constraints nullable="false"/>
      </column>

      <column name="LOGIN_TIME" type="${nullable.ts.type}">
        <constraints nullable="false"/>
      </column>

      <column name="LOGOUT_TIME" type="${nullable.ts.type}">
        <constraints nullable="true"/>
      </column>

      <column name="IS_LOGIN_SUCCESSFUL" type="${boolean.type}">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet author="vlonushte" id="Login audit logs table sequence" dbms="oracle">
    <createSequence 
      sequenceName="OS_LOGIN_AUDIT_LOGS_SEQ" 
      startValue="1" 
      incrementBy="1" 
      ordered="true" />
  </changeSet>

  <changeSet author="vlonushte" id="FK on user of login audit log">
    <addForeignKeyConstraint 
      constraintName="FK_LOGIN_AUDIT_LOGS_USER_ID"
      baseTableName="OS_LOGIN_AUDIT_LOGS"
      baseColumnNames="USER_ID"
      referencedTableName="CATISSUE_USER"
      referencedColumnNames="IDENTIFIER"/>
  </changeSet>

  <changeSet author="vlonushte" id="OS Auth Tokens table">
    <createTable tableName="OS_AUTH_TOKENS">
      <column name="TOKEN" type="${text.type}(64)">
        <constraints primaryKey="true"/>
      </column>

      <column name="USER_ID" type="${int.type}">
        <constraints nullable="false"/>
      </column>

      <column name="EXPIRES_ON" type="${timestamp.type}">
        <constraints nullable="false"/>
      </column>

      <column name="IP_ADDRESS" type="${text.type}(32)">
        <constraints nullable="false"/>
      </column>

      <column name="LOGIN_AUDIT_LOG_ID" type="${int.type}">
        <constraints nullable="false" unique="true"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet author="vlonushte" id="FK on user of auth tokens">
    <addForeignKeyConstraint 
      constraintName="FK_AUTH_TOKENS_USER_ID"
      baseTableName="OS_AUTH_TOKENS"
      baseColumnNames="USER_ID"
      referencedTableName="CATISSUE_USER"
      referencedColumnNames="IDENTIFIER"/>
  </changeSet>

  <changeSet author="vlonushte" id="FK on login audit log of auth tokens">
    <addForeignKeyConstraint 
      constraintName="FK_AUTH_TOKENS_LA_LOG_ID"
      baseTableName="OS_AUTH_TOKENS"
      baseColumnNames="LOGIN_AUDIT_LOG_ID"
      referencedTableName="OS_LOGIN_AUDIT_LOGS"
      referencedColumnNames="IDENTIFIER"/>
  </changeSet>

</databaseChangeLog>
