<?xml version ="1.0"?>
<!--Ant Script for create Build for caTissue Suite-->

<project name="caTissue Suite v1.2 Installation" default="deploy_app">

	<!--define require dir and Properties -->
	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
		<classpath>
			<pathelement location="./lib/ant-contrib.jar" />
		</classpath>
	</taskdef>

	<property environment="env" />
	<import file="build-properties.xml"/>
	<import file="dbunit_temp.xml"/>

	<property name="delete.failonerror" value="true"/>
	<property name="base.dir" value="." />
	<property name="prop.temp.dir" value="${caTissue-webapp.dir.dist}/deploytempCatissuecore" />
	<property name="globus.download.dir" value="${caTissue-webapp.dir.dist}/deploytempCatissuecore/globus" />
	<property name="camodel.dir" value="${caTissue-webapp.dir.dist}/ca_model" />
	<property name="csm.dir" value="${prop.temp.dir}/tempcsm" />
	<property name="lib.dir" value="${caTissue-webapp.dir.dist}/modules/caTissue/lib" />
	<property name="resources.dir" value="${caTissue-webapp.dir.dist}/modules/caTissue/resources" />
	<property name="mysql.sql.dir" value="${caTissue-webapp.dir.dist}/db/db-install/MySql" />
	<property name="dbupgrade.sql.dir" value="${caTissue-webapp.dir.dist}/db/db-upgrade" />
	<property name="oracle.sql.dir" value="${caTissue-webapp.dir.dist}/db/db-install/Oracle" />
	<property name="common.sql.dir" value="${caTissue-webapp.dir.dist}/db/Common" />
	<property name="install.common.sql.dir" value="${caTissue-webapp.dir.dist}/db/db-install/Common" />
	<property name="mssqlserver.sql.dir" value="${caTissue-webapp.dir.dist}/SQL/MsSqlServer" />
	<property name="oracle.dialect.string" value="org.hibernate.dialect.Oracle9Dialect" />
	<property name="mysql.dialect.string" value="org.hibernate.dialect.MySQLDialect" />
	<property name="catissue.datasource" value="java:/catissuecore" />
	<property name="dynamicextensions.datasource" value="java:/dynamicextensions" />
	<property name="oracle.dialect.h3.string" value="org.hibernate.dialect.Oracle9Dialect" />
	<property name="mysql.dialect.h3.string" value="org.hibernate.dialect.MySQLDialect" />
	<property name="mssqlserver.dialect.string" value="org.hibernate.dialect.SQLServerDialect" />

	<property name="oracle.driver.string" value="oracle.jdbc.driver.OracleDriver" />
	<property name="mysql.driver.string" value="org.gjt.mm.mysql.Driver" />
	<property name="mssqlserver.driver.string" value="com.microsoft.sqlserver.jdbc.SQLServerDriver" />
	<!-- Added for eMPI integration -->
	<property name="db2.driver.string" value="com.ibm.db2.jcc.DB2Driver" />
	<!-- end -->

	<property name="mysql.lib" value="mysql-connector-java-5.0.8-bin.jar" />
	<property name="oracle.lib" value="ojdbc14.jar" />
	<property name="mssqlserver.lib" value="sqljdbc.jar" />

	<property name="catissue.struts.config.file" value="struts-config.xml" />
	<property name="catissue.hibernate.config.file" value="hibernate.cfg.xml" />
	<property name="catissue.tiles.def.file" value="tiles-defs.xml" />

	<property name="oracle_home" value="${env.ORACLE_HOME}"/>
	<property name="jboss.bin.run.jar" value="${jboss.home.dir}/bin/run.jar"/>
	<property name="env.COMPUTERNAME" value="${env.HOSTNAME}"/>

	<property name="mysql.dao.prop.filename" value="MySQLDAOProperties.xml" />
	<property name="oracle.dao.prop.filename" value="OracleDAOProperties.xml" />
	<property name="oracle.dao.datasource.prop.filename" value="OracleDataSourceDAOProperties.xml"/>
	<property name="mysql.dao.datasource.prop.filename" value="MysqlDataSourceDAOProperties.xml"/>

	<var name="databaseurl" value="" />
	<import file="${caTissue-webapp.dir.dist}/modules/dynamic_extensions/conf/DEDeploy.xml" />

	<property name="tempcacore.dir" value="${caTissue-webapp.dir.dist}/temp_deaudit_related_files" />
	<property name="export.dir" value="${tempcacore.dir}/temp_exported_xmi" />
	<property name="cacaore.deployables" value="${cacore.deployable.location}" />
	<property name="notificationservice.dir" value="${caTissue-webapp.dir.dist}/modules/caGrid_service/NotificationService" />

	<property name="database.host" value="${database.server}" />
	<property name="database.username" value="${database.user}" />


	<if>
		<available file="${caTissue-webapp.dir.dist}/install.properties" />
		<then>
			<property name="catissue.deploy.config.file" value="${caTissue-webapp.dir.dist}/install.properties"></property>
		</then>
		<else>
			<property name="catissue.deploy.config.file" value="${caTissue-webapp.dir.dist}/upgrade.properties"></property>
		</else>
	</if>

	<property name="jboss.server.host.port" value="${jboss.server.hostname}:${jboss.server.port}" />
	<if>
		<equals arg1="" arg2="${jboss.server.port}" />
		<then>
			<var name="jboss.server.host.port" unset="true"/>
			<property name="jboss.server.host.port" value="${jboss.server.hostname}" />
		</then>
	</if>

	<!-- Check for required properties -->
	<target name="assert" description="Check for required properties">
		<!-- Validation for ORACLE_HOME ,tns name and sqlldr if database is oracle-->
		<if>
		<equals arg1="oracle" arg2="${database.type}" />
			<then>
				<available file="${oracle_home}" type="dir" property="IsOracleHomeBlank" />
				<if>
					<not>
					<equals arg1="true" arg2="${IsOracleHomeBlank}" />
					</not>
					<then>
						<fail message="ORACLE_HOME is not set on your server. For windows set oracle_home as environment variable or in linux set in .bash_profile file." />
					</then>
				</if>

				<if>
					<equals arg1="" arg2="${oracle.tns.name}" />
					<then>
						<fail message="The property 'oracle.tns.name' can not be empty" />
					</then>
				</if>
				<trycatch>
					<try>
						<exec executable="tnsping" failonerror="true" >
							<arg value="${oracle.tns.name}"/>
						</exec>
					</try>
					<catch>
						<fail message="'${oracle.tns.name}' is not a valid tns name. Please set valid tns name for property 'oracle.tns.name'." />
					</catch>
				</trycatch>
				<trycatch>
					<try>
						<exec executable="sqlldr" failonerror="true"/>
				 	</try>
					<catch>
						<fail message="'sqlldr' file not found in path. Please make sure this file must be in path." />
					</catch>
				</trycatch>
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${database.server}" />
			<then>
				<fail message="The property 'database.host' can not be empty" />
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${database.port}" />
			<then>
				<fail message="The property 'database.port' can not be empty. Default port for MySQL:3306 ,for Oracle: 1521 and for MsSqlServer: 1433" />
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${database.name}" />
			<then>
				<fail message="The property 'database.name' can not be empty" />
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${database.user}" />
			<then>
				<fail message="The property 'database.username' can not be empty" />
			</then>
		</if>
		<!-- Mandar 17May06 check for first user -->
		<if>
			<equals arg1="" arg2="${first.admin.department}" />
			<then>
				<fail message="The property 'first.admin.department' can not be empty" />
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${first.admin.institution}" />
			<then>
				<fail message="The property 'first.admin.institution' can not be empty" />
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${first.admin.cancerresearchgroup}" />
			<then>
				<fail message="The property 'first.admin.cancerresearchgroup' can not be empty" />
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${first.admin.emailAddress}" />
			<then>
				<fail message="The property 'first.admin.emailAddress' can not be empty" />
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${first.admin.password}" />
			<then>
				<fail message="The property 'first.admin.password' can not be empty" />
			</then>
		</if>

		<if>
			<equals arg1="" arg2="${email.administrative.emailAddress}" />
			<then>
				<echo>email.adminstartive.emailaddress can be left blank.</echo>
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${email.sendEmailFrom.emailAddress}" />
			<then>
				<echo>email.sendEmailFrom.emailAddress can be left blank.</echo>
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${email.mailServer}" />
			<then>
				<echo>email.mailServer can be left blank.</echo>
			</then>
		</if>

		<!-- Validation of database schema name for MsSqlServer-->
		<if>
			<equals arg1="mssqlserver" arg2="${database.type}" />
			<then>
				<antcall target="validate_schema_name" />
			</then>
		</if>

		<!-- check for CAS URL -->
		<if>
					<equals arg1="true" arg2="${integrate.catissue.with.cas}" />
					<then>
						<if>
							<equals arg1="" arg2="${cas.url}" />
							<then>
								<fail message="To integrate caTissue with CAS, the cas.url property need to b filled up." />
							</then>
							
						</if>
					</then>
				</if>
		<!-- Check whether JAVA_HOME environment variable set or not -->
		<if>
			<contains string="${env.JAVA_HOME}" substring="env.JAVA_HOME"/>
			<then>
				<fail message="JAVA_HOME is not set. Please make sure to set JAVA_HOME environment variable to the directory of your local JDK." />
			</then>
		</if>
	</target>

	<!--Target for validation of connection parameters-->
	<target name="validate_database_connection" description="Target for validation of connection parameters">
		<!-- validation for database connection -->
		<trycatch>
        	<try>
					<if>
						<equals arg1="mysql" arg2="${database.type}" />
						<then>
							<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}">
									<transaction>select 1;</transaction>
									<transaction>commit;</transaction>
									<classpath>
									  <fileset dir="${lib.dir}">
									 	<include name="*.jar" />
									  </fileset>
									</classpath>
							</sql>
						</then>
						<elseif >
							<equals arg1="oracle" arg2="${database.type}" />
							<then>
								<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle">
									<transaction>select sysdate from dual;</transaction>
									<transaction>commit;</transaction>
										<classpath>
											<fileset dir="${lib.dir}">
												<include name="*.jar" />
											</fileset>
										</classpath>
								</sql>
							</then>
						</elseif>
						<elseif>
							<equals arg1="mssqlserver" arg2="${database.type}" />
							<then>
								<echo message="Upgrading MsSqlServer Database for CA models metadata ..." />
								<sql driver="${mssqlserver.driver.string}" url="jdbc:sqlserver://${database.server}:${database.port};databaseName=${database.name};" userid="${database.user}" password="${database.password}">
									<transaction>select 1;</transaction>
									<!--transaction>commit;</transaction-->
									<classpath>
										 <fileset dir="${lib.dir}">
										 	<include name="*.jar" />
										 </fileset>
									</classpath>
							</sql>
						</then>
						</elseif>

				</if>
		</try>
		<catch>
			<fail message="Connection fails.Please check the database configuration parameters like database.host,database.port,database.name etc.  " />
		</catch>
	</trycatch>
	</target>
	<target name="configure_contactus" description="configure email address for contactus property">
		<replace dir="${prop.temp.dir}/catissuecore-properties" propertyfile="${catissue.deploy.config.file}">
			<include name ="ContactUs.txt"/>
			<replacefilter token="@@SUPPORTEMAIL@@" value="${email.administrative.emailAddress}"/>
		</replace>
	</target>
	<!--Extrct WAR and copy Configuration files to temp directory-->
	<target name="init" description="Extrct WAR and copy Configuration files to temp directory">
		<echo message="Initializing installation..." />
		<unwar src="${caTissue-webapp.dir.dist}/modules/caTissue/lib/catissuecore.war" dest="${prop.temp.dir}/catissuecore" />
		<unwar src="${caTissue-webapp.dir.dist}/modules/print_web_service/lib/caTissuePrintWebService.war" dest="${prop.temp.dir}/caTissuePrintWebService" />
		<unjar src="${prop.temp.dir}/catissuecore/WEB-INF/lib/DynamicExtensions.jar" dest="${prop.temp.dir}/dynamicExtensionsjar" />
		<unzip src="${caTissue-webapp.dir.dist}/modules/dynamic_extensions/lib/dynamicextensions.zip" dest="${prop.temp.dir}/dynamicextensions" overwrite="true" />
		<copy todir="${prop.temp.dir}/catissuecore-properties" overwrite="true">
			<fileset dir="${caTissue-webapp.dir.dist}/modules/caTissue/conf/catissuecore-properties" />
		</copy>
		<copy todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" overwrite="true">
					<fileset dir="${caTissue-webapp.dir.dist}/modules/custom_impl_lib" />
		</copy>
		<!-- Copying common jars to caTissueCore web-inf/lib -->
		<copy todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" overwrite="true">
			<fileset dir="${caTissue-webapp.dir.dist}/modules/caTissue/lib/common_lib" />
		</copy>
		<antcall target="configure_log4j" />

		<!-- <unwar src="${base.dir}/catissuecorecsm.war" dest="${prop.temp.dir}/tempcsm"/> -->

		<antcall target="configure_contactus" />
		<copy file="${caTissue-webapp.dir.dist}/modules/caTIES/conf/SectionHeaderConfig.txt" todir="${prop.temp.dir}/catissuecore-properties" overwrite="true" />
		<copy file="${jboss-conf.dir.dest}/catissuecore-ds.xml" todir="${prop.temp.dir}" overwrite="true" />

		<!--copy file="${prop.temp.dir}/catissuecore/WEB-INF/classes/DAOConfig.xml" todir="${prop.temp.dir}" /> -->
		<!--Kapil V 1.0.1 Changes-->
		<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/conf/login-config.xml" todir="${prop.temp.dir}" overwrite="true" />
		<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/conf/properties-service.xml" todir="${prop.temp.dir}" overwrite="true" />
	</target>

	<target name="configure_log4j" description="Configure log4j.properties">
		<echo message="catissue.deploy.config.file = ${catissue.deploy.config.file}" />
		<replace dir="${prop.temp.dir}/catissuecore-properties" propertyfile="${catissue.deploy.config.file}">
			<include name ="log4j.properties"/>
		<replacefilter token="@@jbosshome@@" value="${jboss.server.url}"/>
		</replace>
	</target>

	<!--Modify Configuration such as Session Timeout, Admin details and JBoss server port-->
	<target name="configure_war" description="Modify Configuration such as Session Timeout, Admin details and JBoss server port">
		<echo message="Modifying caTissueCore Configuration File..." />

		<replace file="${prop.temp.dir}/catissuecore/WEB-INF/web.xml">
			<replacefilter token="&lt;session-timeout>30&lt;/session-timeout>" value="&lt;session-timeout>${session.timeout}&lt;/session-timeout>" />
		</replace>

		<!--<replace file="${prop.temp.dir}/catissuecore/WEB-INF/classes/remoteService.xml">
			<replacefilter token="@@server.port@@" value="${jboss.server.port}"/>
		</replace>-->

	</target>


	<!--Modify Adopter's Institution images, URL of Institution website and Contact Us, Privacy Notice, Disclaimer, Accessibility Text Files-->
	<target name="adopter_configuration" description="Modify Adopter's Institution images, URL of Institution website and Contact Us, Privacy Notice, Disclaimer, Accessibility Text Files">
		<echo message="Updating Site Images" />
		<copy todir="${prop.temp.dir}/catissuecore/images/uIEnhancementImages" overwrite="true">
			<fileset dir="${caTissue-webapp.dir.dist}/modules/caTissue/images" />
		</copy>
	</target>

	<!--Modify Configuration For MySQL-->
	<target name="mysql_config" description="Modify Configuration For MySQL">
		<echo message="Modifying caTissue Suite MySQL specific Configuration File..." />

		<replace dir="${prop.temp.dir}/catissuecore-properties" propertyfile="${catissue.deploy.config.file}">
			<include name="upt.hibernate.cfg.xml" />
			<include name="catissuecore.hibernate.cfg.xml" />
			<replacefilter token="@@dialect@@" value="${mysql.dialect.string}" />
		</replace>
		<!-- added for csm orm1.cfg.xml file-->
		<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes" propertyfile="${catissue.deploy.config.file}">
			<include name="orm1.cfg.xml" />
			<replacefilter token="@@dialect@@" value="${mysql.dialect.h3.string}" />
		</replace>

		<replace dir="${prop.temp.dir}" propertyfile="${catissue.deploy.config.file}">
			<include name="catissuecore-ds.xml" />
			<include name="login-config.xml" />
			<replacefilter token="@@databaseurl@@" value="jdbc:mysql://${database.server}:${database.port}/${database.name}" />
			<replacefilter token="@@username@@" value="${database.user}" />
			<replacefilter token="@@pasword@@" value="${database.password}" />
			<replacefilter token="@@databasedriver@@" value="${mysql.driver.string}" />
		</replace>

		<replace file="${prop.temp.dir}/catissuecore/WEB-INF/classes/hibernate.cfg.xml">
			<replacefilter token="${mysql.dialect.string}" value="${mysql.dialect.string}" />
		</replace>
		<replace file="${prop.temp.dir}/catissuecore/WEB-INF/classes/DynamicExtensionsHibernate.cfg.xml">
			<replacefilter token="${mysql.dialect.string}" value="${mysql.dialect.string}" />
		</replace>

		<replace file="${prop.temp.dir}/catissuecore/WEB-INF/classes/ApplicationDAOProperties.xml">
			<replacefilter token="${oracle.dao.prop.filename}" value="${mysql.dao.prop.filename}" />
		</replace>


		<replace file="${prop.temp.dir}/catissuecore/WEB-INF/classes/ApplicationDAOProperties.xml">
			<replacefilter token="${oracle.dao.prop.filename}" value="${mysql.dao.prop.filename}" />
		</replace>

		<replace file="${prop.temp.dir}/catissuecore/WEB-INF/classes/ApplicationDAOProperties.xml">
					<replacefilter token="${oracle.dao.datasource.prop.filename}" value="${mysql.dao.datasource.prop.filename}" />
				</replace>


		<replace file="${prop.temp.dir}/dynamicExtensionsjar/DynamicExtensionsHibernate.cfg.xml">
			<replacefilter token="${mysql.dialect.string}" value="${mysql.dialect.string}" />
			<replacefilter token="${dynamicextensions.datasource}" value="${catissue.datasource}" />
		</replace>

	</target>

	<!--Modify Configuration For Oracle-->
	<target name="oracle_config" description="Modify Configuration For Oracle">
		<echo message="Modifying caTissue Suite Oracle specific Configuration File..." />
		<replace dir="${prop.temp.dir}/catissuecore-properties" propertyfile="${catissue.deploy.config.file}">
			<include name="upt.hibernate.cfg.xml" />
			<include name="catissuecore.hibernate.cfg.xml" />
			<replacefilter token="@@dialect@@" value="${oracle.dialect.string}" />
		</replace>


		<!-- added for csm orm1.cfg.xml file-->
		<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes" propertyfile="${catissue.deploy.config.file}">
			<include name="orm1.cfg.xml" />
			<replacefilter token="@@dialect@@" value="${oracle.dialect.h3.string}" />
		</replace>

		<!-- Configuring Data Source File-->
		<replace dir="${prop.temp.dir}" propertyfile="${catissue.deploy.config.file}">
			<include name="catissuecore-ds.xml" />
			<include name="login-config.xml" />
			<replacefilter token="@@databaseurl@@" value="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" />
			<replacefilter token="@@username@@" value="${database.user}" />
			<replacefilter token="@@pasword@@" value="${database.password}" />
			<replacefilter token="@@databasedriver@@" value="${oracle.driver.string}" />
		</replace>

		<replace file="${prop.temp.dir}/catissuecore/WEB-INF/classes/hibernate.cfg.xml">
			<replacefilter token="${mysql.dialect.string}" value="${oracle.dialect.string}" />
		</replace>

		<replace file="${prop.temp.dir}/catissuecore/WEB-INF/classes/ApplicationDAOProperties.xml">
			<replacefilter token="${mysql.dao.prop.filename}" value="${oracle.dao.prop.filename}" />
		</replace>

		<replace file="${prop.temp.dir}/catissuecore/WEB-INF/classes/DynamicExtensionsHibernate.cfg.xml">
			<replacefilter token="${mysql.dialect.string}" value="${oracle.dialect.string}" />
			<replacefilter token="&lt;!-- My sql settings -->" value="&lt;!-- My sql settings " />
			<replacefilter token="&lt;!-- My sql settings end -->" value="My sql settings end -->" />
		</replace>


		<replace file="${prop.temp.dir}/catissuecore/WEB-INF/classes/ApplicationDAOProperties.xml">
			<replacefilter token="${mysql.dao.prop.filename}" value="${oracle.dao.prop.filename}" />
		</replace>
		<replace file="${prop.temp.dir}/catissuecore/WEB-INF/classes/ApplicationDAOProperties.xml">
			<replacefilter token="${mysql.dao.prop.filename}" value="${oracle.dao.prop.filename}" />
		</replace>

		<replace file="${prop.temp.dir}/dynamicExtensionsjar/DynamicExtensionsHibernate.cfg.xml">
			<replacefilter token="${mysql.dialect.string}" value="${oracle.dialect.string}" />
			<replacefilter token="${dynamicextensions.datasource}" value="${catissue.datasource}" />
			<replacefilter token="&lt;!-- My sql settings -->" value="&lt;!-- My sql settings " />
			<replacefilter token="&lt;!-- My sql settings end -->" value="My sql settings end -->" />
		</replace>
	</target>

	<!--Server clean-up-->

	<target name="clean_server" description="deletes the WAR file and cache from server, clean-up the server ">
		<delete file="${jboss.server.url}/deploy/catissuecore.war" />
		<delete file="${jboss.home}/server/${jboss.server.name}/deploy/dynamicExtensions.war" />
		<delete file="${jboss.home}/server/${jboss.server.name}/deploy/caTissuePrintWebService.war" />
		<delete file="${jboss.home}/server/${jboss.server.name}/deploy/pathologySCG.war" />
		<delete file="${jboss.home}/server/${jboss.server.name}/deploy/pathologySpecimen.war" />
		<delete file="${jboss.home}/server/${jboss.server.name}/deploy/CA.war" />
		<delete file="${jboss.home}/server/${jboss.server.name}/deploy/deintegration.war" />
		<!-- removed for BDA<mkdir dir="${jboss.server.url}/work"/>
		<mkdir dir="${jboss.server.url}/tmp"/>
		<delete includeemptydirs="true">
			<fileset dir="${jboss.server.url}/work">
				<include name="**/*" />
			</fileset>
		</delete>
		<delete includeemptydirs="true">
			<fileset dir="${jboss.server.url}/tmp">
				<include name="**/*" />
			</fileset>
		</delete>-->
	</target>

	<!--Buid New WAR File-->
	<target name="build_war" description="Buid New WAR File">
		<echo message="Creating New Web Application Archieve File..." />
		<delete failonerror="${delete.failonerror}" file="${prop.temp.dir}/catissuecore.war" />
	<!--	<delete file="${prop.temp.dir}/caTissuePrintWebService.war" />  -->
		<delete failonerror="${delete.failonerror}" file="${prop.temp.dir}/dynamicExtensions.jar" />

<!--
		<jar destfile="${prop.temp.dir}/dynamicExtensions.jar" basedir="${prop.temp.dir}/dynamicExtensionsjar" />

		<copy file="${prop.temp.dir}/dynamicExtensions.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" overwrite="true" />
		<copy file="${prop.temp.dir}/dynamicExtensions.jar" todir="${prop.temp.dir}/catissuecore/Applet" overwrite="true" />
		<copy file="${prop.temp.dir}/dynamicExtensions.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/Applet" overwrite="true" />
-->

		<antcall target="copydeletedjars">
			<param name="delPath" value="${prop.temp.dir}/catissuecore/WEB-INF/lib"/>
		</antcall>
		<!-- deleting the axis-1.4.jar which has missing enum fields -->
		<delete file="${prop.temp.dir}/catissuecore/WEB-INF/lib/axis-1.4.jar"/>


		<war destfile="${prop.temp.dir}/catissuecore.war"
			webxml="${prop.temp.dir}/catissuecore/WEB-INF/web.xml" manifest="${prop.temp.dir}/catissuecore/META-INF/MANIFEST.MF">
			<fileset dir="${prop.temp.dir}/catissuecore">
				<exclude name="**/*build*" />
				<exclude name="**/*WEB-INF*" />
				<exclude name="**/*servlet.jar*" />
				<exclude name="**/jsp.jar" />
				<exclude name="**/*jta.jar*" />
				<exclude name="**/WEB-INF/lib/log4j-1.2.9.jar*" />
				<exclude name="**/WEB-INF/lib/axis-1.4.jar*" />
				<exclude name="**/*hibernate2.jar*" />
				<exclude name="**/.*" />
				<exclude name="**/*.sql" />
				<exclude name="**/CVS*" />
				<exclude name="**/jta.jar" />
				<exclude name="**/pages/subMenu/**" />

<!--for jboss  upgrade -->
				<exclude name="**/WEB-INF/lib/xalan-2.6.0.jar" />
				<exclude name="**/WEB-INF/lib/xbean.jar" />
				<exclude name="**/WEB-INF/lib/xercesImpl.jar" />
				<exclude name="**/WEB-INF/lib/xml-apis.jar" />
				<exclude name="**/WEB-INF/lib/xmlrpc-2.0.jar" />
				<exclude name="**/WEB-INF/lib/spring-2.0.2.jar" />
				<exclude name="**/WEB-INF/lib/scrubber-runtime.jar" />
				<exclude name="**/WEB-INF/lib/jax-qname.jar" />
				<exclude name="**/WEB-INF/lib/dom4j-1.6.1.jar" />
				<exclude name="**/WEB-INF/lib/jce-jdk13-125.jar" />
				<exclude name="**/WEB-INF/lib/jaas.jar" />
				<exclude name="**/WEB-INF/lib/washu-commons-1.1.7.jar" />

<!--ends-->

			</fileset>
		</war>

		<copy file="${prop.temp.dir}/catissuecore/WEB-INF/classes/DynamicExtensionsHibernate.cfg.xml" todir="${prop.temp.dir}/dynamicExtensions/WEB-INF/classes" overwrite="true" />


		<!-- <war destfile="${prop.temp.dir}/caTissuePrintWebService.war" webxml="${prop.temp.dir}/caTissuePrintWebService/WEB-INF/web.xml">
					<fileset dir="${prop.temp.dir}/caTissuePrintWebService">
						<include name="**/**/**.*" />
					</fileset>
		</war>  -->

	</target>


	<target name="copydeletedjars" description="this will delete the unneccessary jar files">
	<delete >

		<fileset dir="${delPath}">
			<include name="backport-util-concurrent-3.0.jar" />
			<!--<include name="c3p0-0.8.4.5.jar" />
			<include name="c3p0-0.8.5.2.jar" />-->
			<include name="castor-1.0.2.jar" />
			<!--<include name="cglib-2.1.jar" />
			<include name="cglib*.jar"/>-->
			<!--<include name="commons-collections-2.1.1.jar" />
			<include name="commons-collections-3.1.jar" />
			<include name="commons-collections*.jar"/>
			<include name="commons-discovery-0.2.jar" />-->
			<!--<include name="commons-fileupload.jar" />
			<include name="commons-fileupload*.jar" />-->
			<include name="commons-lang-2.1.jar" />
			<!--<include name="commons-logging-1.0.4.jar" />
			<include name="commons-logging*.jar"/>-->
			<!--<include name="dom4*.jar" />-->
			<!--<include name="ehcache-1.2.3.jar" />
			<include name="ehcache*.jar"/>-->
			<include name="freemarker.jar" />
			<include name="jakarta-oro.jar" />
			<include name="uml-1.3.jar" />
			<include name="wsdl4j-1.5.1.jar" />
			<!--<include name="xalan-2.4.0.jar" />-->
			<include name="xalan*.jar"/>
			<include name="xercesImpl*.jar"/>
			<include name="p6spy.jar" />
			<include name="sdkClient.jar" />
			<include name="uuid-key-generator.jar" />
			<!--<include name="wsdl4j.jar" />-->
			<include name="j2ee.jar" />
			<include name="caGrid-1.0-caDSR-client.jar" />
			<include name="caGrid-1.0-caDSR-common.jar" />
			<include name="caGrid-1.0-caDSR-stubs.jar" />
			<include name="caGrid-1.0-core.jar" />
			<include name="caGrid-1.0-data-common.jar" />
			<include name="caGrid-1.0-data-stubs.jar" />
			<include name="caGrid-1.0-data-utils.jar" />
			<include name="caGrid-1.0-fqp-client.jar" />
			<include name="caGrid-1.0-fqp-common.jar" />
			<include name="caGrid-1.0-fqp-stubs.jar" />
			<include name="caGrid-1.0-metadata-common.jar" />
			<include name="caGrid-1.0-metadata-security.jar" />
			<include name="caGrid-1.0-sdkQuery.jar" />
			<include name="caGrid-1.0-ServiceSecurityProvider-client.jar" />
			<include name="caGrid-1.0-ServiceSecurityProvider-common.jar" />
			<include name="jboss-common-jdbc-wrapper.jar"/>
			<!--<include name="mysql-connector-java-3.1.13-bin.jar"/>-->
			<include name="oracleDriver.jar"/>
			<include name="boot.jar" />
			<include name="c3p0-0.9.0.jar" />
			<include name="catissuecore-client.jar" />
			<include name="experiment-client.jar" />
			<!-- include name="jboss-client.jar" /
			<include name="junit-4.1.jar" />-->
			<include name="mockobjects-core-0.09.jar" />
			<include name="mysql-connector-java-5.0.8-bin.jar" />
			<include name="ojdbc14.jar" />
			<include name="openide-util.jar" />
			<include name="acrobat-core.jar" />
			<!-- removed to work printwebservice -->
			<include name="jaxrpc.jar" />
			<include name="saaj.jar" />

			<include name="jboss-jaxws.jar" />
			<!-- deleted for grid authentication-->
			<include name="puretls.jar" />
			<include name="cog-jglobus.jar" />
			<include name="cryptix32.jar" />
			<include name="cryptix-asn1.jar" />
			<include name="cryptix.jar" />
			<include name="jce-jdk13-125.jar" />
			<include name="saaj-api.jar" />

		</fileset>

	</delete>
</target>
	<!--Copy WAR and Configuration Files to JBOSS Directory-->
	<target name="Configure_Printservice" description="Copy WAR and Configuration Files to JBOSS Directory">
	 <if>
	   <and>
		 <equals arg1="" arg2="${jboss.server.hostname}" />
		 <equals arg1="" arg2="${jboss.container.secure}"/>
		 <equals arg1="" arg2="${jboss.server.port}"/>
		</and>
	 <then>
	 	<replace file="${prop.temp.dir}/catissuecore-properties/PrintServiceImplementor.properties">
		<replacefilter token="http://localhost:8080/" value="https://${jboss.server.hostname}:${jboss.server.port}/" />
		</replace>
	</then>
	</if>
	</target>

	<target name="copy_files" description="copy Configuration Files to JBOSS Directory">
		<echo message="Copying caTissue Suite Application Components..." />
		<replace file="${prop.temp.dir}/catissuecore-properties/caTissueCore_Properties.xml">
			<replacefilter token="@@ADMIN-EMAILADDRESS@@" value="${email.administrative.emailAddress}" />
			<replacefilter token="@@SENDEMAILFROM-EMAILADDRESS@@" value="${email.sendEmailFrom.emailAddress}" />
			<replacefilter token="@@MAILSERVER-EMAILADDRESS@@" value="${email.mailServer}" />
			<!--replacefilter token="@@IDP-ENABLED@@" value="${idp.enabled}" /> -->
			<replacefilter token="@@SESSION-TIME-OUT@@" value="${session.timeout}" />
			<replacefilter token="@@APP-ADDITIONAL-INFO@@" value="${app.additional.info}" />
			<replacefilter token="@@integrationEnabled@@" value="${cdms.integrationEnabled}" />
			<replacefilter token="@@CdmsURL@@" value="${cdms.url}" />
			<replacefilter token="@@CdmsKeyStorePath@@" value="${cdms.keystorePath}" />

			<replacefilter token="@@use.email.commonpackage.config@@" value="${use.email.commonpackage.config}" />
			<replacefilter token="@@email.sendEmailTo.emailAddress@@" value="${email.sendEmailTo.emailAddress}" />
			<replacefilter token="@@email.admin.support.emailAddress@@" value="${email.admin.support.emailAddress}" />
			<replacefilter token="@@email.sendEmailFrom.name@@" value="${email.sendEmailFrom.name}" />
			<replacefilter token="@@email.exception.subject@@" value="${email.exception.subject}" />
			<replacefilter token="@@cas.available@@" value="${integrate.catissue.with.cas}" />

		<!-- added by Geeta .For eMPI integration -->
			<replacefilter token="@@empiDBURL@@" value="jdbc:db2://${empi.database.host}:${empi.database.port}/${empi.database.name}" />
			<replacefilter token="@@empiDBUserName@@" value="${empi.database.username}" />
			<replacefilter token="@@empiDBUserPassword@@" value="${empi.database.password}" />
			<replacefilter token="@@empiDBDriverName@@" value="${db2.driver.string}" />
			<replacefilter token="@@empiDBSchema@@" value="${empi.database.schema}" />
		<!-- END -->

		</replace>

		<!-- CAS logout url-->
					<replace file="${prop.temp.dir}/catissuecore-properties/caTissueCore_Properties.xml">
						<replacefilter token="@@cas.logout.url@@" value="${cas.url}" />
					</replace>
		<antcall target="Configure_Printservice"/>
		<copy todir="${jboss.server.url}/catissuecore-properties" overwrite="true">
			<fileset dir="${prop.temp.dir}/catissuecore-properties">
				<include name="**/*" />
			</fileset>
		</copy>
		<copy todir="${jboss.server.url}/catissuecore-properties" overwrite="true">
			<fileset dir="${caTissue-webapp.dir.dist}/modules/bulk_operations/conf">
				<include name="mapping.xml" />
				<include name="bulkOperation.properties" />
				<include name="bulkOperatorXMLTemplateRules.xml" />
				<include name="BulkOperations.xsd" />
			</fileset>
		</copy>
		<copy todir="${jboss.server.url}/deploy" overwrite="true">
			<fileset dir="${prop.temp.dir}">
				<include name="catissuecore.war" />
				<include name="catissuecore-ds.xml" />
				<include name="catissuecorecsm.war" />
				<include name="caTissuePrintWebService.war" />
			</fileset>
		</copy>

		<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/conf/performance.properties" todir="${jboss.home}/server/default/conf" overwrite="true"/>

		<replace dir="${jboss.server.url}/catissuecore-properties">
			<include name="ApplicationSecurityConfig.xml" />
			<replacefilter token="@@hibernate-config-file@@" value="${jboss.home}/server/${jboss.server.name}/catissuecore-properties/catissuecore.hibernate.cfg.xml" />
		</replace>
		<copy todir="${jboss.home}/server/default/lib" overwrite="true">
			<fileset dir="${lib.dir}">
				<include name="${mysql.lib}" />
				<include name="${oracle.lib}" />
				<!--<include name="${mssqlserver.lib}" />-->
<!--These jar files are required for caGrid authentication and to be copied to the JBOSS_HOME/server/default/lib directory -->
				<include name="puretls.jar" />
				<include name="cog-jglobus.jar" />
				<include name="cryptix32.jar" />
				<include name="cryptix-asn1.jar" />
				<include name="jce-jdk13-125.jar" />
			</fileset>
		</copy>
		<copy todir="${jboss.home}/bin" overwrite="true">
			<fileset dir="${prop.temp.dir}">
				<include name="DAOConfig.xml" />
			</fileset>
		</copy>
		<delete file="${jboss.server.url}/lib/oracleDriver.jar" casesensitive="false"/>
		<delete file="${jboss.home}/common/lib/jbossws-native-saaj.jar" casesensitive="false" verbose="true" failonerror="false"/>
		<!-- added for printwebservice -->
		<copy todir="${jboss.home}/server/default/lib" overwrite="true">
		   <fileset dir="${jboss.home}/client">
				<include name="policy.jar" />
				<include name="jbossws-client.jar" />
				<include name="wsdl4j-1.5.1.jar" />
		        <include name="jboss-common-client.jar" />
		   </fileset>
		</copy>
		<!--Copying mapping.xml and bulkOperation.properties file-->
		<!--copy todir="${basedir}/catissuecore-properties" overwrite="true">
			<fileset dir="${basedir}">
				<include name="bulkOperation.properties" />
			</fileset>
		</copy-->
		<!--Copying caTissueCdmsIntegration.properties file-->
		<copy todir="${jboss.server.url}/catissuecore-properties" overwrite="true">
			<fileset dir="${caTissue-webapp.dir.dist}/modules/caTissue/conf">
				<include name="caTissueCdmsIntegration.properties" />
			</fileset>
		</copy>
	</target>
	<target name="deploy_ca_model_war" description="deploy the ca_model_war">
		<antcall target="CopyCAModelWars"/>
	</target>

	<!--Target call for both fresh deployment and database creation-->
	<target name="deploy_all" description="Target call for both fresh deployment and database creation">
		<antcall target="assert" />
		<tstamp>
		      <format property="time" pattern="MM/dd/yyyy hh:mm:ss aa"
		          />
		    </tstamp>
		    <echo>before deploy_db: ${time}</echo>

		<antcall target="deploy_db" />

		<tstamp>
		      <format property="time2" pattern="MM/dd/yyyy hh:mm:ss aa"
		            />
		    </tstamp>
		    <echo>after deploy_db: ${time2}</echo>

		<tstamp>
				      <format property="time_deploy_app" pattern="MM/dd/yyyy hh:mm:ss aa"
				          />
				    </tstamp>
				    <echo>before deploy_app: ${time_deploy_app}</echo>
		<antcall target="deploy_app" />

		<tstamp>
						      <format property="time_deploy_app_after" pattern="MM/dd/yyyy hh:mm:ss aa"
						         />
						    </tstamp>
						    <echo>after deploy_app: ${time_deploy_app_after}</echo>

		<antcall target="server_security" />

		<!-- Configure the IIS properties, if configure.IIS.properties is 'true'. -->
		<if>
			<equals arg1="${configure.IIS.properties}" arg2="true" />
			<then>
				<antcall target="configure_IIS_properties" />
			</then>
		</if>
	</target>

	<!--Target for checking server security -->
		<target name="server_security" description="Target for checking server security">
			<copy file="${jboss.home}/server/default/deploy/jmx-console.war/WEB-INF/web.xml"
						tofile="${prop.temp.dir}/web.xml" >
			</copy>
				<concat destfile="${prop.temp.dir}/web1.xml" >
					<filelist dir="${prop.temp.dir}" files="web.xml"/>
						<filterchain>
							<headfilter lines="83"/>
						</filterchain>
				</concat>
				<concat destfile="${prop.temp.dir}/web2.xml" >
					<filelist dir="${prop.temp.dir}" files="web.xml"/>
						<filterchain>
							<headfilter lines="27" skip="83"/>
								<tokenfilter>
								 	<replacestring from="-->" to=""/>
								</tokenfilter>
								<tokenfilter>
								 	<replacestring from="console." to="console.-->"/>
								</tokenfilter>
						</filterchain>
			     </concat>
				 <concat destfile="${prop.temp.dir}/web1.xml" append="true">
					 <filelist dir="${prop.temp.dir}" files="web2.xml"/>
				 </concat>
			<copy file="${prop.temp.dir}/web1.xml" tofile="${prop.temp.dir}/web.xml" overwrite="true"/>
			<copy file="${prop.temp.dir}/web.xml"
						tofile="${jboss.home}/server/default/deploy/jmx-console.war/WEB-INF/web.xml" overwrite="true"/>

			<copy file="${jboss.home.dir}/server/default/deploy/jmx-console.war/WEB-INF/jboss-web.xml"
						tofile="${prop.temp.dir}/jboss-web.xml" >
			</copy>
				<concat destfile="${prop.temp.dir}/web3.xml" >
					<filelist dir="${prop.temp.dir}" files="jboss-web.xml"/>
						<filterchain>
							<headfilter lines="7" />
								<tokenfilter>
									<replacestring from="-->" to=""/>
								</tokenfilter>
								<tokenfilter>
									<replacestring from="users." to="users.-->"/>
								</tokenfilter>
						</filterchain>
				</concat>
			<copy file="${prop.temp.dir}/web3.xml" tofile="${prop.temp.dir}/jboss-web.xml" overwrite="true"/>
			<copy file="${prop.temp.dir}/jboss-web.xml"
						tofile="${jboss.home}/server/default/deploy/jmx-console.war/WEB-INF/jboss-web.xml" overwrite="true"/>
		</target>

	<target name="pre_initialization" description="initialisation prior to deploying application">
		<antcall target="clean_server" />
		<antcall target="assert" />
		<delete failonerror="${delete.failonerror}" dir="${prop.temp.dir}" />
		<antcall target="init" />
		<antcall target="configure_war" />
		<antcall target="adopter_configuration" />
	</target>

	<target name="db_configuration" description="for database configuration">
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="mysql_config" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="oracle_config" />

				</then>
			</elseif>
			<elseif>
				<equals arg1="mssqlserver" arg2="${database.type}" />
				<then>
					<antcall target="mssqlserver_config" />
				</then>
			</elseif>
		</if>
	</target>

	<target name="app_configuration" description="configure titli.properties">
		<!-- configure titli.properties -->
		 <antcall target="configure_keyword_search" >
		 	<param name="tempPath" value="${prop.temp.dir}/catissuecore/WEB-INF/classes"/>
			<param name="mysqlDriver" value="org.gjt.mm.mysql.Driver"/>
		</antcall>
   </target>

	<!--Start of Integrating the Bulk Operation Module  -->

	<target name="unzip_bulkoperation_installable" depends="bulkoperation_check_prerequisite" description="unzip the bulk operation zip">
		<unzip src="${caTissue-webapp.dir.dist}/modules/bulk_operations/lib/bulkoperator.zip" dest="${prop.temp.dir}/bulkoperation" overwrite="true" />
	</target>

	<target name="integrate_bulk_operation_mysql" description="Executes the Bulk Operation Mysql commands.">
		<antcall target="unzip_bulkoperation_installable" />
		<ant dir="${prop.temp.dir}/bulkoperation" inheritAll="false" antfile="bulkoperationintegration.xml" target="create_tables_for_bulk_operation">
			<property name="database.driver" value="${mysql.driver.string}" />
			<property name="database.type" value="${database.type}" />
			<property name="parent.base.dir" value="${caTissue-webapp.dir.dist}/modules/caTissue/lib" />
			<property name="database.url" value="jdbc:mysql://${database.server}:${database.port}/${database.name}" />
			<property name="database.username" value="${database.user}" />
			<property name="database.password" value="${database.password}" />
			<property name="deploy.temp.dir" value="${caTissue-webapp.dir.dist}/deploytempCatissuecore"/>
		</ant>
	</target>

	<target name="integrate_bulk_operation_oracle" description="Executes the Bulk Operation Oracle commands.">
		<antcall target="unzip_bulkoperation_installable" />
		<ant dir="${prop.temp.dir}/bulkoperation" inheritAll="false" antfile="bulkoperationintegration.xml" target="create_tables_for_bulk_operation">
			<property name="database.driver" value="${oracle.driver.string}" />
			<property name="database.type" value="${database.type}" />
			<property name="parent.base.dir" value="${caTissue-webapp.dir.dist}/modules/caTissue/lib" />
			<property name="database.url" value="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" />
			<property name="database.username" value="${database.user}" />
			<property name="database.password" value="${database.password}" />
			<property name="deploy.temp.dir" value="${caTissue-webapp.dir.dist}/deploytempCatissuecore"/>
			<property name="rdbms" value="oracle" />
		</ant>
	</target>

	<target name="bulkoperation_check_prerequisite" description="Check bulkoperation.zip file exists or not in base directory">
		<!--
			Check bulkoperation.zip file exists or not in base
			directory.
		-->
		<available file="${caTissue-webapp.dir.dist}/modules/bulk_operations/lib/bulkoperator.zip" property="file.exists" value="false" />
		<if>
			<not>
				<isset property="file.exists" />
			</not>
			<then>
				<echo
					message="bulkoperation.zip file not found. It should be in base directory to deploy Bulk Operation."
					level="error" />
			</then>
			<else>
			   <echo message="Bulk Operation is ready to use."/>
			</else>
		</if>
	</target>

	<!--End of Integrating the Bulk Operation Module  -->

	<!--Start of Integrating the Advance Query Module  -->
	<target name="integrate_advanced_query" description="Start of Integrating the Advance Query Module">
		<echo>Integrating the  Advance Query Module</echo>
			<antcall target="unzip_aq_installable" />
			<ant dir="${prop.temp.dir}/AdvanceQuery" inheritAll="false" antfile="queryintegration.xml" target="aq_integrate_app">
				<property name="parent.base.dir" value="${caTissue-webapp.dir.dist}" />
				<property name="deploy.temp.dir" value="${caTissue-webapp.dir.dist}/deploytempCatissuecore"/>
				<property name="war.dir" value="catissuecore"/>
				<property name="datasource" value="${catissue.datasource}" />
				<property name="database.type" value="${database.type}" />
				<property name="oracle.dialect.string" value="${oracle.dialect.string}" />
				<property name="mysql.dialect.string" value="${mysql.dialect.string}" />
			</ant>
	</target>
	<!--End of Integrating the Advance Query Module  -->
	<target name="jboss_configuration" description="configuring jboss">
		<antcall target="copy_files" />
			<!--<replace file="${basedir}/caTissueSuite_Client/conf/remoteService.xml">
	           <replacefilter token="@@HOST@@" value="${jboss.server.hostname}" />
	           <replacefilter token="@@PORT@@" value="${jboss.server.port}" />
	        </replace>-->
		<antcall target="config_jboss_files" />
		<antcall target="generate:cacore:all" />		
	</target>
	
	<!--Generate caCORE for all imported xmis in the system-->
	<target name="generate:cacore:all">
		<tstamp>
			<format property="before_cacore" pattern="MM/dd/yyyy hh:mm:ss aa"/>
		</tstamp>
		<echo>before cacore: ${before_cacore}</echo>
		<antcall target="generate.cacore.for.xmi">
			<param name="de.zip.location" value="${prop.temp.dir}/dynamicextensions" />
			<param name="jboss.home" value="${jboss.home}"/>
		</antcall>
		<tstamp>
			<format property="after_cacore" pattern="MM/dd/yyyy hh:mm:ss aa"/>
		</tstamp>
		<echo>after cacore: ${after_cacore}</echo>
	</target>

		<!--Target for fresh deployment of caTissue application-->
	<target name="deploy_app_catissue" description="Target for fresh deployment of caTissue application">
			<antcall target="pre_initialization" />
			<antcall target="db_configuration" />
			<antcall target="integrate_advanced_query"/>
			<antcall target="app_configuration"/>
			<antcall target="configure_gsid_properties"/>
			<antcall target="configure_gridgrouper_properties"/>
			<antcall target="configure_magetab_properties"/>
			<antcall target="configure_ctrp_properties"/>
		    <antcall target="configure_services_properties"/>
			<antcall target="integrate_bulkoperation_app" />
			<antcall target="de_integrate_app" />


			<if>
				<equals arg1="true" arg2="${integrate.catissue.with.cas}" />
				<then>
					<antcall target="integrate_cas" />
				</then>
				<else>
					<replace file="${prop.temp.dir}/catissuecore/WEB-INF/web.xml">
								<replacetoken>@@CASFilter@@</replacetoken>
											<replacevalue><![CDATA[
												<!-- cas is not configured -->
													]]></replacevalue>
										</replace>
				</else>
			</if>
		
					
			<antcall target="build_war" />
			<antcall target="jboss_configuration" />
		    <antcall target="deploy_notification_service" />
			<antcall target="send_mail" />
			<!--<delete failonerror="${delete.failonerror}" dir="${prop.temp.dir}" />-->
		</target>


	<!--Integration of Bulk Operations starts-->
	<target name="integrate_bulkoperation_app">
		<antcall target="unzip_bulkoperation_installable" />
		<ant dir="${prop.temp.dir}/bulkoperation" inheritAll="false"
			antfile="bulkoperationintegration.xml" target="replace-tiles-properties">
			<property name="parent.base.dir" value="${caTissue-webapp.dir.dist}" />
			<property name="deploy.temp.dir" value="${caTissue-webapp.dir.dist}/deploytempCatissuecore" />
			<property name="war.dir" value="catissuecore" />
		</ant>
	</target>

	<!--Integration of Bulk Operations ends-->

	<target name="de_check_prerequisite" description="prerequisite checking for DE zip before Integrating it with catissue">
		<!-- Check dynamicextensions.zip file exists or not in base directory. -->
		<available file="${caTissue-webapp.dir.dist}/modules/dynamic_extensions/lib/dynamicextensions.zip" property="file.exists" value="false" />
		<if>
			<not>
			   <isset property="file.exists"/>
			</not>
			<then>
			   <echo message="dynamicextensions.zip file not found. It should be in base directory to deploy DynamicExtensions." level="error" />
			</then>
			<else>
			   <echo message="DynamicExtensions is ready to use."/>
			</else>
		</if>
	</target>

	<target name="upgrade_db_for_de_single_API">
		<echo message="Upgrading DB for de_models_single_API..." />
				<if>
					<equals arg1="oracle" arg2="${database.type}" />
					<then>
						<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" onerror="continue" rdbms="oracle">
							<transaction src="${common.sql.dir}/de_upgrade_for_single_api.sql" />
							<transaction>commit;</transaction>
							<classpath>
								<fileset dir="${lib.dir}">
									<include name="*.jar" />
								</fileset>
							</classpath>
						</sql>
					</then>
				<elseif >
					<equals arg1="mysql" arg2="${database.type}" />
					<then>
						<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}" onerror="continue">
							<transaction src="${common.sql.dir}/de_upgrade_for_single_api.sql" />
							<transaction>commit;</transaction>
							<classpath>
								<fileset dir="${lib.dir}">
									<include name="*.jar" />
								</fileset>
							</classpath>
						</sql>
					</then>
				</elseif>
				</if>
	</target>
	<!-- =================================
          target: generate.cacore.for.xmi
         ================================= -->
	<target name="generate.cacore.for.xmi" depends="" description="description">

		<delete failonerror="${delete.failonerror}" dir="${tempcacore.dir}" />
		<mkdir dir="${tempcacore.dir}" />

		<delete failonerror="${delete.failonerror}" dir="${export.dir}" />
		<mkdir dir="${export.dir}" />

		<!-- <unwar src="${base.dir}/catissuecore.war" dest="${prop.temp.dir}/catissuecore" overwrite="true" /> -->
		<!--<unzip src="dynamicextensions.zip" dest="${prop.temp.dir}/dynamicextensions" overwrite="true" />-->

		<!-- <mkdir dir="${cacaore.deployables}" />  -->
		<if>
			<equals arg1="true" arg2="${generate.single.xmi}" />
			<then>
				<antcall target="upgrade_db_for_de_single_API"/>
				<ant antfile="${caTissue-webapp.dir.dist}/modules/dynamic_extensions/conf/DEDeploy.xml" dir="." target="export.xmi.and.generate.cacore_for_all">
					<property name="entityGroup.jar.location" value="${prop.temp.dir}/catissuecore/WEB-INF/lib" />
					<property name="cacore.deployable.dir" value="${cacaore.deployables}" />
					<property name="de.zip.location" value="${prop.temp.dir}/dynamicextensions" />
					<property name="import.xmi" value="True" />
				</ant>
			</then>
			<else>

				<ant antfile="${caTissue-webapp.dir.dist}/modules/dynamic_extensions/conf/DEDeploy.xml" dir="." target="setupClassExecutionEnvironment" />

				<property name="temp.dir" value="./tempClinPortal" />
				<ant antfile="${caTissue-webapp.dir.dist}/modules/dynamic_extensions/conf/DEDeploy.xml" dir="." target="generate.cacore.for.imported.xmis">
					<property name="de.zip.location" value="${prop.temp.dir}/dynamicextensions" />
					<property name="entityGroup.jar.location" value="${prop.temp.dir}/catissuecore/WEB-INF/lib" />
					<property name="cacore.deployable.dir" value="${cacaore.deployables}" />
					<property name="import.xmi" value="False" />
					<property name="xmi.name" value="${filename}" />
					<property name="jboss.home.dir" value="${jboss.home}" />
					<property name="default.prifix.war" value="${default.prefix.war}" />
					<property name="database.type" value="${database.type}" />
				</ant>
		</else>
	</if>
		<delete failonerror="${delete.failonerror}" file="${caTissue-webapp.dir.dist}/log4j.properties" />
		<delete failonerror="${delete.failonerror}" dir="${tempcacore.dir}" />
	</target>

	<!-- - - - - - - - - - - - - - - - - -
          target: build.catissuecore.war
     - - - - - - - - - - - - - - - - - -->
    <target name="build.catissuecore.war">
    	<echo message=" "/>
  		<echo message="----------------------------------"/>
   		<echo message=" Now creating catissuecore.war file "/>
   		<echo message="----------------------------------"/>
   		<echo message=" "/>

   		<!-- Create catissuecore.war file. -->
   		<antcall target="build_war"/>
    	<copy todir="${caTissue-webapp.dir.dist}/" file="${prop.temp.dir}/catissuecore.war" overwrite="true" />
    </target>

	<target name="upgrade_DB_for_cacore">
		<echo message="Upgrading DB for cacore generation..." />
		<if>
			<equals arg1="oracle" arg2="${database.type}" />
			<then>
				<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" onerror="continue" rdbms="oracle">
					<transaction src="${common.sql.dir}/caModelUpgradeForCacore.sql" />
					<transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
				</sql>
			</then>
		<elseif >
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}" onerror="continue">
					<transaction src="${common.sql.dir}/caModelUpgradeForCacore.sql" />
					<transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
				</sql>
			</then>
		</elseif>
		</if>

	</target>

	<target name="upgrade_dump_cacore">
		<echo message="Upgrading dump for cacore generation..." />

		<if>
			<equals arg1="oracle" arg2="${database.type}" />
			<then>
				<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" onerror="continue" rdbms="oracle">
					<transaction src="${common.sql.dir}/caModelUpgradeForCacore.sql" />
					<transaction src="${dbupgrade.sql.dir}/Oracle/caModelUpgradeForCacore_upgradedb.sql" />
					<transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
				</sql>
			</then>
		<elseif >
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}" onerror="continue">
					<transaction src="${common.sql.dir}/caModelUpgradeForCacore.sql" />
					<transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
				</sql>
			</then>
		</elseif>
		</if>
	</target>

	<!-- Modify dynamicExtensions configuration For MySQL -->
	<target name="de_mysql_config" description="Modify dynamicExtensions configuration For MySQL">
		<replace file="${prop.temp.dir}/catissuecore/WEB-INF/classes/DynamicExtensionsHibernate.cfg.xml">
			<replacefilter token="${oracle.dialect.string}" value="${mysql.dialect.string}" />
			<replacefilter token="${mssqlserver.dialect.string}" value="${mysql.dialect.string}" />
			<replacefilter token="@@datasource@@" value="java:/catissuecore" />
		</replace>
	</target>

	<!-- Modify dynamicextensions configuration For ORACLE -->
	<target name="de_oracle_config" description="Modify dynamicextensions configuration For ORACLE">
		<replace file="${prop.temp.dir}/catissuecore/WEB-INF/classes/DynamicExtensionsHibernate.cfg.xml">
			<replacefilter token="${mysql.dialect.string}" value="${oracle.dialect.string}" />
			<replacefilter token="${mssqlserver.dialect.string}" value="${oracle.dialect.string}" />
			<replacefilter token="@@datasource@@" value="java:/catissuecore" />
		</replace>
	</target>

	<!-- Modify dynamicextensions configuration For MsSQLServer -->
	<target name="de_mssqlserver_config" description="Modify dynamicextensions configuration For MsSQLServer">
		<replace file="${prop.temp.dir}/catissuecore/WEB-INF/classes/DynamicExtensionsHibernate.cfg.xml">
			<replacefilter token="${mysql.dialect.string}" value="${mssqlserver.dialect.string}" />
			<replacefilter token="${oracle.dialect.string}" value="${mssqlserver.dialect.string}" />
			<replacefilter token="@@datasource@@" value="java:/catissuecore" />
		</replace>
	</target>

	<!-- Integrating DynamicExtensions application with catissue -->
	<target name="de_integrate_app" depends="de_check_prerequisite" if="file.exists" description="Integrating DynamicExtensions application with catissue">
		<echo message="Integrating DynamicExtensions app ...." />
		<!--<unzip src="dynamicextensions.zip" dest="${prop.temp.dir}/dynamicextensions" overwrite="true" />-->
		<unjar src="${prop.temp.dir}/dynamicextensions/binaries/DynamicExtensionsInterface/DynamicExtensions.jar" dest="${prop.temp.dir}/dynamicextensions/DynamicExtensions" />
				<replace dir="${prop.temp.dir}/dynamicextensions/DynamicExtensions" >
							<include name="DynamicExtensionDAO.properties" />
							<replacefilter token="@@host.app.name@@" value="caTissue Suite" />
						</replace>
				<jar destfile="${prop.temp.dir}/dynamicExtensions.jar" basedir="${prop.temp.dir}/dynamicextensions/DynamicExtensions" />
				<copy file="${prop.temp.dir}/dynamicExtensions.jar" todir="${prop.temp.dir}/dynamicextensions/binaries/DynamicExtensionsInterface" overwrite="true" />
		<unjar src="${prop.temp.dir}/dynamicextensions/binaries/DynamicExtensionsInterface/DynamicExtensions.jar" dest="${prop.temp.dir}/dynamicextensions/WEB-INF/classes" />
		
		<copy file="${prop.temp.dir}/dynamicextensions/conf/DynamicExtensionsHibernateWeb.cfg.xml" tofile="${prop.temp.dir}/catissuecore/WEB-INF/classes/DynamicExtensionsHibernate.cfg.xml" overwrite="true" />
		<copy file="${prop.temp.dir}/dynamicextensions/conf/DynamicExtensionsAuditMetadata.xml" tofile="${prop.temp.dir}/catissuecore/WEB-INF/classes/DynamicExtensionsAuditMetadata.xml" overwrite="true" />
		

		<!-- Inject db specific information to configuration files -->
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="de_mysql_config" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="de_oracle_config" />
				</then>
			</elseif>
			<elseif>
				<equals arg1="mssqlserver" arg2="${database.type}" />
				<then>
					<antcall target="de_mssqlserver_config" />
				</then>
			</elseif>
		</if>

		<!-- 1) Copy DynamicExtensions.jar -> copy it to catissue/WEB-INF/Lib -->
		<copy file="${prop.temp.dir}/dynamicextensions/binaries/DynamicExtensionsInterface/DynamicExtensions.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" overwrite="true" />
		<copy file="${prop.temp.dir}/dynamicextensions/binaries/DynamicExtensionsInterface/DynamicExtensions.jar" todir="${prop.temp.dir}/catissuecore/Applet" overwrite="true" />
		<copy file="${prop.temp.dir}/dynamicextensions/binaries/DynamicExtensionsInterface/DynamicExtensions.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/Applet" overwrite="true" />

		<!-- 2) Copy *.properties, st*.cfg.xml, *.jsp, *.css, *.images, st*-struts-config.xml to respective folders -->
		<copy todir="${prop.temp.dir}/catissuecore/WEB-INF/classes" overwrite="true">
			<fileset dir="${prop.temp.dir}/dynamicextensions/WEB-INF/classes">
	    		<include name="**/hbm/**/*.*"/>
				<include name="DynamicExtensionsErrorsMessages.properties"/>
	    		<include name="DynamicExtensionsFileFormats.properties"/>
				<include name="DynamicExtensionsAuditMetadata.xml" />
				<include name="DynamicExtensionsApplicationResources.properties" />
				<include name="uicontrols-captions.properties" />
				<include name="displaytype-classname-mapping.properties" />
				<include name="ControlConfigurations.xml" />
				<include name="EAVValidationRules.xml" />
				<include name="PrimitiveAttributeDataTypes_MSSQLSERVER.xml" />
				<include name="PrimitiveAttributeDataTypes_MYSQL.xml" />
				<include name="PrimitiveAttributeDataTypes_ORACLE.xml" />
				<include name="RuleConfigurations.xml" />
				<include name="XMI_1.4-1.3Transformer.xsl" />
				<include name="DynamicExtension.properties" />
				<exclude name="dbutil.properties" />
				<exclude name="DynamicExtensionsHibernate.cfg.xml" />
				<exclude name="hibernate.properties" />
				<exclude name="log4j.properties" />
			</fileset>
		</copy>

		<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
			<include name="DynamicExtension.properties" />
			<replacefilter token="@@Application.url@@" value="${Application.url}" />
			<replacefilter token="@@default.prifix.war@@" value="${default.prefix.war}" />
		</replace>
		<copy todir="${prop.temp.dir}/catissuecore/WEB-INF" overwrite="true">
					<fileset dir="${prop.temp.dir}/dynamicextensions/web/conf">
						<include name="dynamicextensions-struts-config.xml" />
					</fileset>
				</copy>
				<copy todir="${prop.temp.dir}/catissuecore/WEB-INF" overwrite="true">
					<fileset dir="${prop.temp.dir}/dynamicextensions/web/taglibs">
						<include name="dynamicExtensions.tld" />
					</fileset>
				</copy>

				<copy todir="${prop.temp.dir}/catissuecore/" overwrite="true">
					<fileset dir="${prop.temp.dir}/dynamicextensions/web">
						<include name="dhtml/**/*" />
						<include name="images/**/*" />
						<include name="javascripts/**/*" />
						<include name="stylesheets/**/*" />
						<include name="pages/**/*" />
						<exclude name="taglibs/**/*" />
						<exclude name="conf/**/*" />
					</fileset>
				</copy>

		<!-- 3) Inject de-struts-config.xml entry in catisssue -> web.xml -->

		<!-- start -->
		<replace file="${prop.temp.dir}/catissuecore/WEB-INF/web.xml">
			<replacefilter token="/WEB-INF/${catissue.struts.config.file}" value="/WEB-INF/${catissue.struts.config.file}, /WEB-INF/dynamicextensions-struts-config.xml" />
			<replacetoken>@@listener@@</replacetoken>
			<replacevalue><![CDATA[
				<listener>
						<listener-class>edu.common.dynamicextensions.util.listener.DynamicExtensionsServletContextListener</listener-class>
					</listener>
					]]></replacevalue>
		</replace>


		<replace file="${prop.temp.dir}/catissuecore/WEB-INF/web.xml">
			<replacefilter token="/WEB-INF/${catissue.struts.config.file}" value="/WEB-INF/${catissue.struts.config.file}, /WEB-INF/dynamicextensions-struts-config.xml" />
			<replacetoken>@@servlet@@</replacetoken>
			<replacevalue><![CDATA[
							<servlet>
								<servlet-name>UpdateCache</servlet-name>
								<servlet-class>edu.common.dynamicextensions.ui.webui.action.UpdateCache</servlet-class>
							</servlet>
							<servlet>
								<servlet-name>DynamicExtensionsInterfaceAction</servlet-name>
								<servlet-class>edu.common.dynamicextensions.interfaceactions.DynamicExtensionsInterfaceAction</servlet-class>
							</servlet>
							<servlet>
								<servlet-name>DownloadFileAction</servlet-name>
								<servlet-class>edu.common.dynamicextensions.ui.webui.action.DownloadFileAction</servlet-class>
							</servlet>
					]]></replacevalue>
		</replace>

		<replace file="${prop.temp.dir}/catissuecore/WEB-INF/web.xml">
			<replacefilter token="/WEB-INF/${catissue.struts.config.file}" value="/WEB-INF/${catissue.struts.config.file}, /WEB-INF/dynamicextensions-struts-config.xml" />
			<replacetoken>@@servlet-mapping@@</replacetoken>
			<replacevalue><![CDATA[
							<servlet-mapping>
								<servlet-name>UpdateCache</servlet-name>
								<url-pattern>/UpdateCache</url-pattern>
							</servlet-mapping>
							<servlet-mapping>
								<servlet-name>DynamicExtensionsInterfaceAction</servlet-name>
								<url-pattern>/DynamicExtensionsInterfaceAction</url-pattern>
							</servlet-mapping>
							<servlet-mapping>
								<servlet-name>DownloadFileAction</servlet-name>
								<url-pattern>/DownloadFileAction</url-pattern>
							</servlet-mapping>
					]]></replacevalue>
		</replace>

		<replace file="${prop.temp.dir}/catissuecore/WEB-INF/web.xml">
			<replacefilter token="/WEB-INF/${catissue.struts.config.file}" value="/WEB-INF/${catissue.struts.config.file}, /WEB-INF/dynamicextensions-struts-config.xml" />
			<replacetoken>@@taglib@@</replacetoken>
			<replacevalue><![CDATA[
								<taglib>
									<taglib-uri>/WEB-INF/dynamicExtensions.tld</taglib-uri>
									<taglib-location>/WEB-INF/dynamicExtensions.tld</taglib-location>
								</taglib>
					]]></replacevalue>
		</replace>

		<replace file="${prop.temp.dir}/catissuecore/WEB-INF/web.xml">
			<replacefilter token="/WEB-INF/${catissue.struts.config.file}" value="/WEB-INF/${catissue.struts.config.file}, /WEB-INF/dynamicextensions-struts-config.xml" />
			<replacetoken>@@context-param@@</replacetoken>
			<replacevalue><![CDATA[
								<context-param>
									<param-name>ResourceBundleParamName</param-name>
									<param-value>resourcebundleclass</param-value>
								</context-param>
					]]></replacevalue>
		</replace>

		<!-- ends -->
		<!-- 4) Inject db-util.properties entry in catissue -> db-util.properties -->
		<replace file="${prop.temp.dir}/catissuecore/WEB-INF/classes/dbutil.properties">
			<replacefilter token="${catissue.hibernate.config.file}" value="${catissue.hibernate.config.file}, DynamicExtensionsHibernate.cfg.xml" />
		</replace>

		<!-- 5) updating the application name in properties file  -->
		<propertyfile  file="${prop.temp.dir}/dynamicextensions/WEB-INF/classes/ApplicationResources.properties">
			 <entry  key="app.name" value="caTissue Suite"/>
		</propertyfile>

		<!--
		6) Concatenating the AppplicationResource.properties file from
			DE to caTissue AppplicationResource.properties file
		-->
		<echo message="Concatenating the Application Resource Properties file" />
		<concat
			destfile="${prop.temp.dir}/dynamicextensions/WEB-INF/classes/ApplicationResources.properties"
			append="true" >
			<fileset file="${prop.temp.dir}/catissuecore/WEB-INF/classes/ApplicationResources.properties" />
		</concat>
		<copy file="${prop.temp.dir}/dynamicextensions/WEB-INF/classes/ApplicationResources.properties" todir="${prop.temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />
	</target>

	<target name="CopyCAModelWars" description="copy the CA Model wars">
		<antcall target="assert" />
		<antcall target="modifyDEWars">
			<param name="warName" value="CA"/>
		</antcall>
		<antcall target="modifyDEWars">
			<param name="warName" value="pathologySCG"/>
		</antcall>
		<antcall target="modifyDEWars">
			<param name="warName" value="pathologySpecimen"/>
		</antcall>
	</target>

	<target name="modifyDEWars" description="Modify the DE war">
		<echo>Modifying ${warName}.war....</echo>
			<unwar src="${basedir}/${warName}.war" dest="${prop.temp.dir}/${warName}" />
			<copy file="${basedir}/DE_conf/hibernate.properties" todir="${prop.temp.dir}/${warName}/WEB-INF/classes" overwrite="true" verbose="true"/>
			<if>
				<equals arg1="mysql" arg2="${database.type}" />
				<then>
					<replace dir="${prop.temp.dir}/${warName}/WEB-INF/classes">
						<include name="hibernate.properties" />
						<replacefilter token="@@DIALECT@@" value="${mysql.dialect.string}" />
						<replacefilter token="@@DRIVER@@" value="com.mysql.jdbc.Driver" />
						<replacefilter token="@@URL@@" value="jdbc:mysql://${database.server}:${database.port}/${database.name}" />
					</replace>
				</then>

				<elseif>
					<equals arg1="oracle" arg2="${database.type}" />
					<then>
						<replace dir="${prop.temp.dir}/${warName}/WEB-INF/classes">
							<include name="hibernate.properties" />
							<replacefilter token="@@DIALECT@@" value="${oracle.dialect.string}" />
							<replacefilter token="@@DRIVER@@" value="${oracle.driver.string}" />
							<replacefilter token="@@URL@@" value="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" />
						</replace>
					</then>
				</elseif>
				<elseif>
					<equals arg1="mssqlserver" arg2="${database.type}" />
					<then>
						<replace dir="${prop.temp.dir}/${warName}/WEB-INF/classes">
							<include name="hibernate.properties" />
							<replacefilter token="@@DIALECT@@" value="${mssqlserver.dialect.string}"/>
							<replacefilter token="@@DRIVER@@" value="${mssqlserver.driver.string}"/>
							<replacefilter token="@@URL@@" value="jdbc:sqlserver://${database.server}:${database.port};databaseName=${database.name};" />
						</replace>
					</then>
				</elseif>
			</if>
			<replace dir="${prop.temp.dir}/${warName}/WEB-INF/classes">
				<include name="hibernate.properties" />
				<replacefilter token="@@DATABASE_USERNAME@@" value="${database.user}" />
				<replacefilter token="${token.database.password}" value="${database.password}" />

			</replace>

			<war destfile="${prop.temp.dir}/${warName}.war" webxml="${prop.temp.dir}/${warName}/WEB-INF/web.xml">
				<fileset dir="${prop.temp.dir}/${warName}">
					<include name="**/**/**.*" />
				</fileset>
			</war>
		<echo>Copying ${warName}.war....</echo>

		<copy todir="${jboss.server.url}/deploy" file="${prop.temp.dir}/${warName}.war" overwrite="true" />
			<delete failonerror="${delete.failonerror}" file="${prop.temp.dir}/${warName}.war" />
			<delete failonerror="${delete.failonerror}" includeemptydirs="true">
				<fileset dir="${prop.temp.dir}/${warName}">
					<include name="**/*" />
				</fileset>
			</delete>
		<delete failonerror="${delete.failonerror}" dir="${prop.temp.dir}/${warName}" />
		</target>

	<!--Target for deployment with jboss config-->
	<target name="config_jboss_files" description="Target for deployment with jboss config">
		<copy todir="${jboss.server.url}/conf" overwrite="true">
			<fileset dir="${prop.temp.dir}">
				<include name="login-config.xml" />
			</fileset>
		</copy>

		<replace dir="${prop.temp.dir}">
			<include name="properties-service.xml" />
			<replacefilter token="@@app-security-file@@" value="${jboss.server.url}/catissuecore-properties/ApplicationSecurityConfig.xml" />
			<replacefilter token="@@app-properties-file@@" value="${jboss.server.url}/catissuecore-properties/caTissueCore_Properties.xml" />
			<replacefilter token="@@app-dynamicuixml-file@@" value="${jboss.server.url}/catissuecore-properties/dynamicUI.xml" />
			<replacefilter token="@@auth-properties-file@@" value="${jboss.server.url}/catissuecore-properties/IDPAuthentication.xml" />
			<replacefilter token="@@service-urls-properties-file@@" value="${jboss.server.url}/certificates/${target.grid}/service_urls-${target.grid}.properties" />
			<replacefilter token="@@bulk-operation-properties-file@@" value="${jboss.server.url}/catissuecore-properties/bulkOperation.properties" />
			<replacefilter token="@@catissue-cdms-integration-properties-file@@" value="${jboss.server.url}/catissuecore-properties/caTissueCdmsIntegration.properties" />
		</replace>

		<copy todir="${jboss.server.url}/deploy" overwrite="true">
			<fileset dir="${prop.temp.dir}">
				<include name="properties-service.xml" />
			</fileset>
		</copy>
		<delete file="${jboss.server.url}/lib/hibernate2.jar" />
	</target>

	<!--Target for fresh Database Creation-->
	<target name = "deploy_db" description="Target for Database Creation">
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="deploy_db_mysql" />

			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="deploy_db_oracle" />
				</then>
			</elseif>
			<!-- mssqlserver db -->
			<elseif>
				<equals arg1="mssqlserver" arg2="${database.type}" />
				<then>
					<antcall target="deploy_db_mssqlserver" />
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>

		<antcall target="firstUser" />

		<!-- shippingtracking db -->
		<antcall target="st_deploy_db" />

		<tstamp>
			<format property="time" pattern="MM/dd/yyyy hh:mm:ss aa"/>
		</tstamp>
		<echo>before DE_Starts: ${time}</echo>

		<!-- <antcall target="upgrade_metadata_for_constraintproperties"/>  -->
		<antcall target="upgrade_db_from_DE_1.2.0_to_DE_1.3.0" />

		<!-- <antcall target="upgrade_db_from_DE_1.3.0_to_DE_1.3.1" />  -->
		<antcall target="upgrade_db_from_DE_1.3.0_to_DE_1.4.0" />

		<antcall target="upgrade_db_from_DE_1.4.0.1_to_DE_1.4.0.2" />

		<antcall target="upgrade_db_from_DE_1.4.0_to_DE_1.4.2" />

		<antcall target="upgrade_de_integration_restructure_metadata"/>

		<antcall target="update_metadata_for_tagged_values"/>
		<antcall target="upgrade_DB_for_cacore"/>
		<antcall target="insertCuratedPathForRecordEntry"/>
		<antcall target="upgrade_query_metadata_for_1.2"/>
		<antcall target="install_ccts_integration"/>
		<antcall target="install_ctrp_integration"/>
		<antcall target="install_or_upgrade_gsid_integration"/>


		<antcall target="update_dynamic_event_tables"/>

		<antcall target="upgrade.old.schema.task" />

		<!-- This target will update the SPP metadata by importing metadata XML-->
		<antcall target="update_static_metadata"/>

		<if>
			<equals arg1="oracle" arg2="${database.type}" />
			<then>
				<antcall target="reset_DE_sequences" />
			</then>
		</if>

        <antcall target="import_xmi">
			<param name="filename" value="${resources.dir}/xmi/SpecimenEvents.xmi"/>
			<param name="mainContainerList" value="${resources.dir}/csv/SpecimenEvents.csv"/>
			<param name="package" value="sop"/>
			<param name="hookentity" value="edu.wustl.catissuecore.domain.processingprocedure.SpecimenProcessingProcedure" />
			<param name="addQueryPaths" value="true"/>
			<param name="generate.cacore" value="true"/>
			<param name="jboss.home" value="${jboss.home}"/>
			<param name="pv.file.name" value="${resources.dir}/csv/SpecimenEvents_PVs.csv"/>
		</antcall>

		<antcall target="upgrade_existingEvents_to_sppEvents"/>

		<tstamp>
			<format property="DEtime" pattern="MM/dd/yyyy hh:mm:ss aa"/>
		</tstamp>
		<echo>After DE_Starts: ${DEtime}</echo>
		<antcall target="insertPaths"/>
		<antcall target="upgrade_db_for_de_single_API"></antcall>
		<tstamp>
			<format property="pathtime" pattern="MM/dd/yyyy hh:mm:ss aa"/>
		</tstamp>
		<echo>After Insert paths: ${pathtime}</echo>
	</target>

	<target name="update_dynamic_event_tables">
			<echo message="Upgrading DB for dynamic events..." />
			<if>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" onerror="continue" rdbms="oracle">
						<transaction src="${common.sql.dir}/Oracle/updateDynamicEvent.sql" />
						<transaction>commit;</transaction>
						<classpath>
							<fileset dir="${lib.dir}">
								<include name="*.jar" />
							</fileset>
						</classpath>
					</sql>
				</then>
			<elseif >
				<equals arg1="mysql" arg2="${database.type}" />
				<then>
					<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}" onerror="continue">
						<transaction src="${common.sql.dir}/MySql/updateDynamicEvent.sql" />
						<transaction>commit;</transaction>
						<classpath>
							<fileset dir="${lib.dir}">
								<include name="*.jar" />
							</fileset>
						</classpath>
					</sql>
				</then>
			</elseif>
			</if>

		</target>

	<target name="update_static_metadata_for_model_changes_mysql">
		<unwar src="${caTissue-webapp.dir.dist}/modules/caTissue/lib/catissuecore.war" dest="${prop.temp.dir}/catissuecore" />
		<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/mysql-connector-java-5.0.8-bin.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />

		<java classname="edu.wustl.catissuecore.querysuite.metadata.AddStaticMetaData"  fork="true" maxmemory="512m" failonerror="true">
			<classpath location="${prop.temp.dir}/catissuecore/WEB-INF/classes" />
			<classpath refid="temp.classpath" />
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="**/*.jar" />
				</fileset>
				<fileset dir="${caTissue-webapp.dir.dist}/modules/caTissue/resources/xml">
					<include name="StaticModelMetaData.xsd" />
					<include name="StaticModelMetaData.xml" />
				</fileset>

			</classpath>
			<arg value="${database.server}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.user}"/>
			<arg value="${database.password}"/>
			<arg value="com.mysql.jdbc.Driver"/>
			<arg value="${caTissue-webapp.dir.dist}/modules/caTissue/resources/xml"/>
		</java>

	</target>

	<target name="update_static_metadata_for_model_changes_oracle">
		<unwar src="${caTissue-webapp.dir.dist}/modules/caTissue/lib/catissuecore.war" dest="${prop.temp.dir}/catissuecore" />
		<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/ojdbc14.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />

		<java classname="edu.wustl.catissuecore.querysuite.metadata.AddStaticMetaData"  fork="true" maxmemory="512m" failonerror="true">
			<classpath location="${prop.temp.dir}/catissuecore/WEB-INF/classes" />
			<classpath refid="temp.classpath" />
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
				<fileset dir="${caTissue-webapp.dir.dist}/modules/caTissue/resources/xml">
					<include name="StaticModelMetaData.xsd" />
					<include name="StaticModelMetaData.xml" />
				</fileset>
			</classpath>
			<arg value="${database.server}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.user}"/>
			<arg value="${database.password}"/>
			<arg value="${oracle.driver.string}"/>
			<arg value="${caTissue-webapp.dir.dist}/modules/caTissue/resources/xml"/>
		</java>

	</target>

	<!--MySQL Database Creation -->
	<target name="deploy_db_mysql" description="MySQL Database Creation">
		<echo message="Initializing MySQL Database for caTissue Suite v1.2. Application..." />
		<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}">
			<transaction src="${mysql.sql.dir}/catissuecore.sql" />
			<transaction src="${mysql.sql.dir}/InitDB_CreateTable.sql" />
			<transaction src="${common.sql.dir}/initDB_Insert_Common.sql" />
			<transaction src="${common.sql.dir}/AlterTable.sql" />
			<transaction src="${common.sql.dir}/CDE_DummyData_Common.sql" />
			<transaction src="${mysql.sql.dir}/csm_catissuecore.sql" />
			<transaction src="${common.sql.dir}/insert_default_data.sql" />
			<transaction src="${common.sql.dir}/indexes.sql" />
			<transaction src="${mysql.sql.dir}/dynamicextension.sql" />
			<transaction src="${mysql.sql.dir}/query/metadata_schema_script.sql" />
			<transaction src="${mysql.sql.dir}/query/caB2B Table Generation Script.sql" />
			<transaction src="${mysql.sql.dir}/CAModel.sql"/>
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>

		<antcall target="integrate_bulk_operation_mysql" />

		<antcall target="unzip_aq_installable" />
		<ant dir="${prop.temp.dir}/AdvanceQuery" inheritAll="false" antfile="queryintegration.xml" target="create_query_tables">
			<property name="database.type" value="${database.type}" />
			<property name="database.driver" value="com.mysql.jdbc.Driver" />
			<property name="database.url" value="jdbc:mysql://${database.server}:${database.port}/${database.name}" />
			<property name="database.username" value="${database.user}" />
			<property name="database.password" value="${database.password}" />
			<property name="lib.dir" value="${lib.dir}" />
		</ant>

		<antcall  target="Export_Clinical_diagnosis_mysql"/>
		<antcall target="CAModel_import_data" />
		<antcall target="temp_update_metadata_for_clob_support_mysql" />
		<antcall target="insert_entity_group_metadata_mysql" />
		<antcall target="upgrade_db_demodel_mysql" />
		<sql driver="${mysql.driver.string}"
		url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}" >
			<transaction src="${mysql.sql.dir}/Upgrade_DE_Schema.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>

		<antcall target="upgrade_db_from_DE_1.4.2_to_DE_1.5.0" />

		<antcall target="upgrade_db_from_DE_1.5.0_to_DE_1.5.1" />


		<antcall target="upgrade_metadata_for_constraintproperties"/>
		<antcall target="update_metadata_for_model_changes">
			 <param name="isUpgrade" value="false"/>
		</antcall>
		<antcall target="update_metadata_for_CA_model_changes" />
		<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}" >
			<transaction src="${common.sql.dir}/DBUpgrade_v1.1p2_to_v1.1p4_indexes.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<echo message="Upgrading MySQL Database." />
			<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}" >
				<transaction src="${mysql.sql.dir}/DBUpgrade_QueryMetadata.sql" />
				<transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
			</sql>
		<antcall target="update_metadata_for_model_changes_mysql_post_P5" />
	</target>
	<target name="insert_entity_group_metadata_mysql" description="insert entity group metadata for mysql">
		<echo message="Inserting entity group metadata for Mysql" />
		<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}">
			<transaction src="${mysql.sql.dir}/query/entity_group_metadata.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>
	<target name="insert_entity_group_metadata_oracle" description="insert entity group metadata for oracle">
		<echo message="Inserting entity group metadata for Oracle" />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle">
			<transaction src="${oracle.sql.dir}/query/entity_group_metadata.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>
	<target name="temp_update_metadata_for_clob_support_mysql" description="temp update metadata for clob support for mysql">
		<echo message="Upgrading MySQL Database for supporting query on clob type attributes..." />
		<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}">
			<transaction src="${mysql.sql.dir}/query/temp_update_metadata.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>

	<target name="temp_update_metadata_for_clob_support_oracle" description="temp update metadata for clob support for oracle">
		<echo message="Upgrading Oracle Database for supporting query on clob type attributes..." />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle">
			<transaction src="${oracle.sql.dir}/query/temp_update_metadata.sql" />
			<transaction>commit;</transaction>
			<classpath>
					<fileset dir="${lib.dir}">
						<include name="*.jar" />
					</fileset>
			</classpath>
		</sql>
		</target>

	<!--Oracle Database Creation -->


	<target name="deploy_db_oracle" description="Oracle Database Creation" depends="assert">
		<echo message="Initializing Oracle Database for caTissue Suite v1.1.p5. Application..." />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle">
			<transaction src="${oracle.sql.dir}/catissuecore.sql" />
			<transaction src="${common.sql.dir}/Oracle/DEIntegrationRestructure.sql" />
			<transaction src="${oracle.sql.dir}/InitDB_CreateTable.sql" />
			<transaction src="${common.sql.dir}/initDB_Insert_Common.sql" />
			<transaction src="${oracle.sql.dir}/AlterTable.sql" />
			<transaction src="${common.sql.dir}/CDE_DummyData_Common.sql" />
			<transaction src="${oracle.sql.dir}/CSM_Create_Oracle.sql" />
			<transaction src="${oracle.sql.dir}/insert_default_data.sql" />
			<transaction src="${common.sql.dir}/indexes.sql" />
			<transaction src="${oracle.sql.dir}/dynamicextension.sql" />
			<transaction src="${oracle.sql.dir}/query/caB2B Table Generation Script.sql" />
			<transaction src="${oracle.sql.dir}/query/metadata_schema_script.sql" />
		<!--	<transaction src="${oracle.sql.dir}/query/query_schema_script.sql" />  -->
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>

		<antcall target="integrate_bulk_operation_oracle"/>

		<antcall target="unzip_aq_installable" />
		<ant dir="${prop.temp.dir}/AdvanceQuery" inheritAll="false" antfile="queryintegration.xml" target="create_query_tables">
			<property name="database.type" value="${database.type}" />
			<property name="database.driver" value="${oracle.driver.string}" />
			<property name="database.url" value="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" />
			<property name="database.username" value="${database.user}" />
			<property name="database.password" value="${database.password}" />
			<property name="rdbms" value="oracle" />
			<property name="lib.dir" value="${lib.dir}" />
		</ant>

		<antcall target="insertQueryMetadata" />

		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle" delimiter="/" delimitertype="row">
			<transaction src="${oracle.sql.dir}/CSM_Trigger_Oracle.sql" />
			<transaction src="${oracle.sql.dir}/DBUtility.sql" />
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle">
			<transaction src="${oracle.sql.dir}/CSM_InsertData_Oracle.sql" />
			<transaction src="${oracle.sql.dir}/CSM_AddConstraints_Oracle.sql" />
			<transaction src="${oracle.sql.dir}/AlterCSMTable.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<antcall target="temp_update_metadata_for_clob_support_oracle" />
		<antcall target="insert_entity_group_metadata_oracle" />
		<antcall target="upgrade_db_demodel_oracle" />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle">
			<transaction src="${oracle.sql.dir}/Upgrade_DE_Schema.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>

		<antcall target="upgrade_db_from_DE_1.4.2_to_DE_1.5.0" />

		<antcall target="upgrade_db_from_DE_1.5.0_to_DE_1.5.1" />

		<antcall target="upgrade_metadata_for_constraintproperties"/>

		<antcall target="update_metadata_for_model_changes" >
			 <param name="isUpgrade" value="false"/>
		</antcall>
		<antcall target="update_metadata_for_CA_model_changes" />
		<antcall target="alter_CA_model_Tables" />
    	<antcall target="reset_sequences" />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle">
			<transaction src="${common.sql.dir}/DBUpgrade_v1.1p2_to_v1.1p4_indexes.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<echo message="Upgrading Oracle Database p5 to p5.1" />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle">
			<transaction src="${oracle.sql.dir}/DBUpgrade_QueryMetadata.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<antcall target="update_metadata_for_model_changes_oracle_post_P5" />
	</target>

	<target name="reset_sequences" description="Resetting the sequences...">
		<echo message=" Resetting the sequences..." />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle">
					<transaction src="${common.sql.dir}/Oracle/query/dropDESequence.SQL" />
					<transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
				</sql>
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" delimiter="/" delimitertype="row" keepformat="yes" rdbms="oracle">
					<transaction src="${common.sql.dir}/Oracle/query/resetDESequence.SQL" />
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
		</sql>
	</target>

	<target name="drop_and_create_sequences" description="Recreating the sequences...">
		<echo message="Recreating the sequences..." />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle">
					<transaction>
					DROP SEQUENCE DE_ATTR_REC_SEQ ;
					DROP SEQUENCE DE_COLL_ATTR_REC_VALUES_SEQ ;
					DROP SEQUENCE DE_FILE_ATTR_REC_VALUES_SEQ ;
					DROP SEQUENCE DE_OBJECT_ATTR_REC_VALUES_SEQ ;
					DROP SEQUENCE DYEXTN_ABSTRACT_METADATA_SEQ ;
					DROP SEQUENCE DYEXTN_ASSO_DISPLAY_ATTR_SEQ ;
					DROP SEQUENCE DYEXTN_ATTRIBUTE_TYPE_INFO_SEQ ;
					DROP SEQUENCE DYEXTN_CONTAINER_SEQ ;
					DROP SEQUENCE DYEXTN_CONTROL_SEQ ;
					DROP SEQUENCE DYEXTN_DATABASE_PROPERTIES_SEQ ;
					DROP SEQUENCE DYEXTN_DATA_ELEMENT_SEQ ;
					DROP SEQUENCE DYEXTN_ENTITY_MAP_CONDN_SEQ ;
					DROP SEQUENCE DYEXTN_ENTITY_MAP_SEQ ;
					DROP SEQUENCE DYEXTN_ENTITY_RECORD_SEQ ;
					DROP SEQUENCE DYEXTN_FILE_EXTN_SEQ ;
					DROP SEQUENCE DYEXTN_FORM_CONTEXT_SEQ ;
					DROP SEQUENCE DYEXTN_PERMISSIBLEVAL_SEQ ;
					DROP SEQUENCE DYEXTN_ROLE_SEQ ;
					DROP SEQUENCE DYEXTN_RULE_PARAMETER_SEQ ;
					DROP SEQUENCE DYEXTN_RULE_SEQ ;
					DROP SEQUENCE DYEXTN_SEMANTIC_PROPERTY_SEQ ;
					DROP SEQUENCE DYEXTN_TAGGED_VALUE_SEQ ;
					DROP SEQUENCE DYEXTN_VALUE_DOMAIN_SEQ ;
					DROP SEQUENCE DYEXTN_VIEW_SEQ ;
					</transaction>
					<transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
				</sql>
				<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" delimiter="/" delimitertype="row" keepformat="yes" rdbms="oracle">
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
					<transaction src="${oracle.sql.dir}/query/createDESequence.SQL" />
				</sql>

	</target>
	<target name="insertQueryMetadata" description="Inserting the Query Metadata">
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle">
			<transaction  src="${oracle.sql.dir}/CAModel.sql"/>
			<transaction src="${oracle.sql.dir}/query/DisableConstraints.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>

		<delete includeemptydirs="true">
			<fileset dir="${oracle.sql.dir}/CAModelCTLs">
				<include name="**/*" />
			</fileset>
		</delete>

		<antcall  target="Export_Clinical_diagnosis_oracle"/>
		<antcall target="CAModel_import_data" />

		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle">
			<transaction src="${oracle.sql.dir}/query/enableCons.sql" />
			<transaction src="${oracle.sql.dir}/query/UpdateTable.sql" />
			<!-- <transaction src="${oracle.sql.dir}/query/csm_oracle.sql" /> -->
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>

	    <antcall target="drop_and_create_sequences" />
	</target>


	<!--Target for Application and Database Upgrade from Suite 1.1 to Suite 1.2-->
	<target name="upgrade_all" depends="assert, upgrade_db, upgrade_app" description="Target for Application and Database Upgrade from v1.1  to V1.2">
	</target>

	<!--Target for Application and Database Upgrade from caTissueCore v1.2.2  to Suite 1.1-->
	<!--<target name="upgrade_all_from_core_1.2.2" depends="core_1.2.2_upgrade_check">
		<antcall target="upgrade_app" />
		<antcall target="upgrade_db_from_core_1.2.2_to_suite_1.1" />
	</target>
 	-->

	<!--Target for Application Upgrade from Suite 1.1 to Suite 1.2-->
	<target name="upgrade_app" depends="deploy_app" description="this target urgrades the catissue application only from the current version.">
	</target>
<!--
	<target name="upgrade_db">
		<antcall target="upgrade_from_Suite1.0_to_1.1" />
		<antcall target="upgrade_clinicalDiagnosis_values"/>
		<antcall  target="Export_Clinical_diagnosis"/>
		<antcall target="update_metadata_for_model_changes" />
		<antcall target="update_metadata_for_CA_model_changes" />
		<antcall target="runMigration" />
		<antcall target="create_category">
			<param name="categoryDefinitionFilePath" value="${dbupgrade.sql.dir}/Common/CAModelCSVs/smoking.csv"/>
		</antcall>
		<antcall target="create_category">
			<param name="categoryDefinitionFilePath" value="${dbupgrade.sql.dir}/Common/CAModelCSVs/radiation.csv"/>
		</antcall>
		<antcall target="create_category">
			<param name="categoryDefinitionFilePath" value="${dbupgrade.sql.dir}/Common/CAModelCSVs/chemotherapy.csv"/>
		</antcall>
		<antcall target="create_category">
			<param name="categoryDefinitionFilePath" value="${dbupgrade.sql.dir}/Common/CAModelCSVs/alcohol.csv"/>
		</antcall>
		<antcall target="import_permissible_values">
			<param name="permissibleValuesFile" value="${dbupgrade.sql.dir}/Common/CAModelCSVs/LOINC_PV.csv"/>
		</antcall>
		<antcall target="show_hide_forms">
		</antcall>
		<antcall target="show_hide_forms_based_on_CPs">
		</antcall>
	</target>
-->
	<target name="show_hide_forms" description="set the values for show_hide_forms">
		<if>
			<equals arg1="${show.hide.forms}" arg2="true" />
			<then>
				<echo message="Value of show_hide_forms is set to true" />
				<antcall target="Associate_forms">
					<param name="entitiesFormsCSVFile" value="${base.dir}/Show_Hide_Forms.csv"/>
				</antcall>
				<echo message="Associated selected Forms..." />
			</then>
			<else>
				<echo message="Value of show_hide_forms is set to false" />
			</else>
		</if>
	</target>

	<!--Target for Database Upgrade from Suite 1.1 to Suite 1.2-->
	<target name="upgrade_db" description="Upgrading Database from v1.1 to v2.0.">
		<!--echo message="Upgrading Database v1.1 to v1.2" />
		<antcall target="upgrade_db_from_v1.1_to_v1.2"/-->
		<echo message="Upgrading Database v1.2 to v2.0" />
		<antcall target="upgrade_db_from_v1.2_to_v2.0"/>

		<antcall target="upgrade_db_from_DE_1.4.2_to_DE_1.5.0" />

		<antcall target="upgrade_db_from_DE_1.5.0_to_DE_1.5.1" />

		<antcall target="upgrade.old.schema.task" />

		<antcall target="update_static_metadata"/>
		<!-- This target will update the SPP metadata using import XMI-->

		<if>
			<equals arg1="oracle" arg2="${database.type}" />
			<then>
				<antcall target="reset_DE_sequences" />
			</then>
		</if>
		<antcall target="import_xmi">
			<param name="filename" value="${resources.dir}/xmi/SpecimenEvents.xmi"/>
			<param name="mainContainerList" value="${resources.dir}/csv/SpecimenEvents.csv"/>
			<param name="package" value="sop"/>
			<param name="hookentity" value="edu.wustl.catissuecore.domain.processingprocedure.SpecimenProcessingProcedure" />
			<param name="addQueryPaths" value="true"/>
			<param name="generate.cacore" value="true"/>
			<param name="jboss.home" value="${jboss.home}"/>
			<param name="pv.file.name" value="${resources.dir}/csv/SpecimenEvents_PVs.csv"/>
		</antcall>
		<antcall target="upgrade_existingEvents_to_sppEvents"/>
		<antcall target="insertPaths"/>
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="migrate_events_mysql"></antcall>
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="migrate_events_oracle"></antcall>
				</then>
			</elseif>
		</if>
	
	<antcall target="upgrade_db_for_de_single_API"></antcall>
	</target>

	<target name="update_static_metadata">
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="update_static_metadata_for_model_changes_mysql">
				</antcall>
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="update_static_metadata_for_model_changes_oracle">
					</antcall>
					<echo message="Not supported for oracle"/>
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
	</target>

	<target name="upgrade_db_from_v1.1_to_p4" description="Target for Application and Database Upgrade from caTissue v1.1 to p4">
	<echo message="Upgrading Database v1.1 to v1.1p4" />
	   <if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="upgrade_mysql_from_v1.1_to_v1.1p2" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="update_sequences" />
					<antcall target="upgrade_oracle_from_v1.1_to_v1.1p2" />
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
		<antcall target="update_metadata_for_model_changes">
			<param name="isUpgrade" value="true"/>
			<param name="buildVersion" value="1.1_to_p2"/>
		</antcall>
		<antcall target="upgrade_db_from_p2_to_p4"/>
	</target>

	<!--Target for Application and Database Upgrade from caTissue p2 to p4 -->
	<target name="upgrade_all_from_p2_to_p4" description="Target for Application and Database Upgrade from caTissue p2 to p4">
		<antcall target="upgrade_app"/>
		<antcall target="upgrade_db_from_p2_to_p4"/>
	</target>

	<target name="upgrade_db_from_p2_to_p4" description="Target for Database Upgrade from caTissue p2 to p4">
		<echo message="Upgrading Database v1.1p2 to v1.1p4" />
			        <if>
					<equals arg1="mysql" arg2="${database.type}" />
					<then>
						<antcall target="upgrade_mysql_from_v1.1p2_to_v1.1p4" />
					</then>
					<elseif>
						<equals arg1="oracle" arg2="${database.type}" />
						<then>
							<antcall target="upgrade_oracle_from_v1.1p2_to_v1.1p4" />
						</then>
					</elseif>
					<else>
						<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
					</else>
				</if>
				<antcall target="upgrade_category_entity_names">
				</antcall>
				<antcall target="update_metadata_for_model_changes">
					<param name="isUpgrade" value="true"/>
					<param name="buildVersion" value="p2top4"/>
				</antcall>

				<antcall target="update_metaPhone_data_for_participant"/>
		</target>

	<target name="upgrade_all_from_p4_to_p5" description="Target for Application and Database Upgrade from caTissue p4 to p5">
		<antcall target="assert"/>
		<antcall target="upgrade_db_from_p4_to_p5"/>
		<antcall target="upgrade_app"/>
	</target>

	<target name="upgrade_db_from_p4_to_p5" description="Target for Database Upgrade from caTissue p4 to p5">
		<echo message="Upgrading Database v1.1p4 to v1.1p5" />
		<antcall target="upgrade_db_from_DE_1.2.0_to_DE_1.3.0"/>
		<!-- <antcall target="upgrade_db_from_DE_1.3.0_to_DE_1.3.1" />  -->
		<antcall target="upgrade_db_from_DE_1.3.0_to_DE_1.4.0"/>
		<antcall target="update_metadata_for_tagged_values"/>
	    <if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="upgrade_mysql_from_v1.1p4_to_v1.1p5" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="upgrade_oracle_from_v1.1p4_to_v1.1p5" />
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
		<antcall target="upgrade_de_integration_restructure_metadata"/>
		<antcall target="upgrade_de_integration_restructure_data"/>
		<antcall target="upgrade_dump_cacore" />
		<antcall target="insertCuratedPathForRecordEntry" />
	</target>




	<!-- Removing unnecessary PE Mysql-->
	<target name="upgrade_mysql_from_v1.1_to_v1.1p2" description="Upgrading MySQL Database and removing unused Protection Element">
		<echo message="Upgrading MySQL Database and removing unused Protection Element" />
		<echo message="db is ${database.name}. username is ${database.user} password is ${database.password}"/>
		<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}" >
			<transaction src="${dbupgrade.sql.dir}/MySql/DBUpgrade_v1.1_to_v1.1p2.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>

	<!-- Target to re-set the sequence when upgrading from V1.1 to V1.2-->
	<target name="update_sequences" description="Updating sequence in case of upgrade from V1.1 to V1.2">
			<echo message="Updating the sequence"></echo>
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" delimiter="/" delimitertype="row" keepformat="yes" rdbms="oracle">
					<transaction src="${dbupgrade.sql.dir}/Oracle/DBSeqUpdate_v1.1_to_v1.2.sql" />
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
				</sql>


	</target>
	<!-- Removing unnecessary PE Oracle-->
	<target name="upgrade_oracle_from_v1.1_to_v1.1p2" description="Upgrading Oracle Database and removing unused Protection Element">
		<echo message="Upgrading Oracle Database and removing unused Protection Element" />
			<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle">
					<transaction src="${dbupgrade.sql.dir}/Oracle/DBUpgrade_v1.1_to_v1.1p2.sql" />
				    <transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
			</sql>
   </target>

	<!-- Upgrading from Suite1.1 p2 to p4 - MySQL -->
	<target name="upgrade_mysql_from_v1.1p2_to_v1.1p4" description="Upgrading from Suite1.1 p2 to p4 - MySQL">
		<!-- Modifying catissue_container table by changing 'FULL' column name with 'CONT_FULL'. As 'FULL' is a keyword in some dbs. -->
		<echo message="Upgrading MySQL Database. Modifying catissue_container table by changing 'FULL' column name with 'CONT_FULL'." />
		<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}" >
			<transaction src="${dbupgrade.sql.dir}/MySql/DBUpgrade_v1.1p2_to_v1.1p4.sql" />
			<transaction src="${dbupgrade.sql.dir}/DEDBUpgrade/MySql/deupgrade_to_v1.2.0.rc1.sql" />
			<transaction src="${common.sql.dir}/DBUpgrade_v1.1p2_to_v1.1p4_indexes.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<antcall target="upgrade_metadata_for_constraintproperties" />
	</target>

	<!-- Upgrading from Suite1.1 p4 to p5 - MySQL -->
	<target name="upgrade_mysql_from_v1.1p4_to_v1.1p5" description="Upgrading from Suite1.1 p4 to p5 - MySQL">
		<echo message="Upgrading MySQL Database." />
		<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}" >
			<transaction src="${dbupgrade.sql.dir}/MySql/DBUpgrade_v1.1p4_to_v1.1p5.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>

		<antcall target="integrate_bulk_operation_mysql" />

	</target>

	<!-- Upgrading from Suite1.1 p2 to p4 - Oracle -->
	<target name="upgrade_oracle_from_v1.1p2_to_v1.1p4" description="Upgrading from Suite1.1 p2 to p4 - Oracle">
		<!-- Modifying catissue_container table by changing 'FULL' column name with 'CONT_FULL'. As 'FULL' is a keyword in some dbs. -->
		<echo message="Upgrading Oracle Database. Modifying catissue_container table by changing 'FULL' column name with 'CONT_FULL'." />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle">
			<transaction src="${dbupgrade.sql.dir}/Oracle/DBUpgrade_v1.1p2_to_v1.1p4.sql" />
			<transaction src="${dbupgrade.sql.dir}/DEDBUpgrade/Oracle/deupgrade_to_v1.2.0.rc1.sql" />
			<transaction src="${common.sql.dir}/DBUpgrade_v1.1p2_to_v1.1p4_indexes.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<antcall target="upgrade_metadata_for_constraintproperties" />

   </target>

	<!-- Upgrading from Suite1.1 p4 to p5 - Oracle -->
	<target name="upgrade_oracle_from_v1.1p4_to_v1.1p5" description=" Upgrading Oracle Database. Upgrading from Suite1.1 p4 to p5 - Oracle">
		<echo message="Upgrading Oracle Database p4 to p5." />
		<antcall target="audit_upgrade_oracle_from_v1.1p4_to_v1.1p5" />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle">
			<transaction src="${dbupgrade.sql.dir}/Oracle/DBUpgrade_v1.1p4_to_v1.1p5.sql" />
			<transaction src="${common.sql.dir}/Oracle/DEIntegrationRestructure.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<antcall target="checkIndexCreation" />
		<antcall target="integrate_bulk_operation_oracle" />
   </target>
	<target name="checkIndexCreation" description="This target checks index, if it alredy exists" >
			<echo message="Upgrade audit changes." />
				<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle" delimiter="/" delimitertype="row" keepformat="yes" >
						<transaction src="${dbupgrade.sql.dir}/Oracle/checkIndexCreation.sql" />
						<classpath>
							<fileset dir="${lib.dir}">
								<include name="*.jar" />
							</fileset>
						</classpath>
				</sql>
	 </target>


   <target name="audit_upgrade_oracle_from_v1.1p4_to_v1.1p5" description="this target ugrades the audit feature from v1.1.P4 to v1.1.P5" >
			<echo message="Upgrade audit changes.">
			</echo>
			<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}"  rdbms="oracle">
				<transaction>
						ALTER TABLE CATISSUE_AUDIT_EVENT ADD EVENT_TYPE VARCHAR(20) ;
				</transaction>
				<transaction>commit;</transaction>
				<classpath>
					<fileset dir="${lib.dir}">
						<include name="*.jar" />
					</fileset>
				</classpath>
			</sql>
			<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle" delimiter="/" delimitertype="row" keepformat="yes" >
				<transaction src="${dbupgrade.sql.dir}/Oracle/auditUpgrade_v1.1p4_to_v1.1p5.sql" />
				<classpath>
					<fileset dir="${lib.dir}">
						<include name="*.jar" />
					</fileset>
				</classpath>
			</sql>

	</target>


	<!-- DE Metadata Upgradation -->
	<target name="update_metadata_for_model_changes" description="DE Metadata Upgradation">
		<unwar src="${caTissue-webapp.dir.dist}/modules/caTissue/lib/catissuecore.war" dest="${prop.temp.dir}/catissuecore"/>
		<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/mysql-connector-java-5.0.8-bin.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />
		<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/ojdbc14.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />
		<delete failonerror="${delete.failonerror}" file="${prop.temp.dir}/catissuecore/WEB-INF/lib/mmtxProject.jar" />
		<antcall target="replacecfgfiles"></antcall>
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="update_metadata_for_model_changes_mysql">
				 <param name="isUpgrade" value="${isUpgrade}"/>
				 <param name="buildVersion" value="${buildVersion}"/>
				</antcall>
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="update_metadata_for_model_changes_oracle">
						 <param name="isUpgrade" value="${isUpgrade}"/>
						 <param name="buildVersion" value="${buildVersion}"/>
					</antcall>
				</then>
			</elseif>
			<elseif>
				<equals arg1="mssqlserver" arg2="${database.type}" />
				<then>
					<antcall target="update_metadata_for_model_changes_mssqlserver">
						 <param name="isUpgrade" value="${isUpgrade}"/>
						 <param name="buildVersion" value="${buildVersion}"/>
					</antcall>
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
		<delete failonerror="${delete.failonerror}" dir="${prop.temp.dir}" />
	</target>

	<!-- DE Metadata Upgradation -->
	<target name="update_metadata_for_CA_model_changes" description=" update medtadata for CA model changes">
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<echo message="Upgrading MySQL Database for CA models metadata ..." />
				<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}">
					<transaction src="${mysql.sql.dir}/updateCAModels.sql" />
					<transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
				</sql>
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<echo message="Upgrading Oracle Database for CA models metadata ..." />
					<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" onerror="continue" rdbms="oracle">
						<transaction src="${oracle.sql.dir}/updateCAModels.sql" />
						<transaction>commit;</transaction>
						<classpath>
							<fileset dir="${lib.dir}">
								<include name="*.jar" />
							</fileset>
						</classpath>
					</sql>
				</then>
			</elseif>
			<elseif>
				<equals arg1="mssqlserver" arg2="${database.type}" />
				<then>
					<echo message="Upgrading MsSqlServer Database for CA models metadata ..." />
					<sql driver="${mssqlserver.driver.string}" url="jdbc:sqlserver://${database.server}:${database.port};databaseName=${database.name};" userid="${database.user}" password="${database.password}">
					<transaction src="${dbupgrade.sql.dir}/DEDBUpgrade/MsSqlServer/updateCAModels.sql" />
					<!--<transaction>commit;</transaction> -->
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
				</sql>
			</then>
			</elseif>

			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
	</target>

	<target name="update_metadata_for_model_changes_mysql" description="Updating DE Metadata for model changes (mysql).....">
		<pathconvert targetos="windows" property="temp.classpath.win" refid="temp.classpath"/>
		<echo message="Updating DE Metadata for model changes (mysql)....." />
		<echo message="prop.temp.dir is ${prop.temp.dir}"></echo>
		<echo message="lib.dir is ${lib.dir}"></echo>
		<echo message="temp.classpath is ${temp.classpath.win}"></echo>

		<java classname="edu.wustl.catissuecore.querysuite.metadata.UpdateMetadata"  fork="true" maxmemory="512m" failonerror="true">
			<classpath location="${prop.temp.dir}/catissuecore/WEB-INF/classes" />
			<classpath refid="temp.classpath" />
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>

			<arg value="${database.server}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.user}"/>
			<arg value="${database.password}"/>
			<arg value="${mysql.driver.string}"/>
			<arg value="${isUpgrade}"/>
			<arg value="${buildVersion}"/>
		</java>
	</target>

	<target name="update_metadata_for_model_changes_mysql_post_P5" description="Updating DE Metadata for model changes (mysql).....">
		<echo message="Updating DE Metadata for model changes (mysql) post P5....." />
		<unwar src="${caTissue-webapp.dir.dist}/modules/caTissue/lib/catissuecore.war" dest="${prop.temp.dir}/catissuecore"/>
		<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/mysql-connector-java-5.0.8-bin.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />
		<delete failonerror="${delete.failonerror}" file="${prop.temp.dir}/catissuecore/WEB-INF/lib/mmtxProject.jar" />
		<java classname="edu.wustl.catissuecore.querysuite.metadata.UpdateQueryMetadata"  fork="true" maxmemory="512m" failonerror="true">
			<classpath location="${prop.temp.dir}/catissuecore/WEB-INF/classes" />
			<classpath refid="temp.classpath" />
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>

			<arg value="${database.server}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.user}"/>
			<arg value="${database.password}"/>
			<arg value="${mysql.driver.string}"/>
			<arg value="${isUpgrade}"/>
			<arg value="${buildVersion}"/>
		</java>
	</target>

	<target name="update_metadata_for_model_changes_oracle" description="Updating DE Metadata for model changes (oracle).....">
		<echo message="Updating DE Metadata for model changes (oracle)....." />
		<java classname="edu.wustl.catissuecore.querysuite.metadata.UpdateMetadata"  fork="true" maxmemory="512m" failonerror="true">
			<classpath location="${prop.temp.dir}/catissuecore/WEB-INF/classes" />
			<classpath refid="temp.classpath" />
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
			<arg value="${database.server}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.user}"/>
			<arg value="${database.password}"/>
			<arg value="${oracle.driver.string}"/>
			<arg value="${isUpgrade}"/>
			<arg value="${buildVersion}"/>
		</java>
		<antcall target="reset_sequences" />
	</target>

	<target name="update_metadata_for_model_changes_oracle_post_P5" description="Updating DE Metadata for model changes (oracle).....">
			<echo message="Updating DE Metadata for model changes (oracle) post P5....." />
				<unwar src="${caTissue-webapp.dir.dist}/modules/caTissue/lib/catissuecore.war" dest="${prop.temp.dir}/catissuecore"/>
				<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/ojdbc14.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />
				<delete failonerror="${delete.failonerror}" file="${prop.temp.dir}/catissuecore/WEB-INF/lib/mmtxProject.jar" />
			<java classname="edu.wustl.catissuecore.querysuite.metadata.UpdateQueryMetadata"  fork="true" maxmemory="512m" failonerror="true">
				<classpath location="${prop.temp.dir}/catissuecore/WEB-INF/classes" />
				<classpath refid="temp.classpath" />
				<classpath>
					<fileset dir="${lib.dir}">
						<include name="*.jar" />
					</fileset>
				</classpath>
				<arg value="${database.server}"/>
				<arg value="${database.port}"/>
				<arg value="${database.type}"/>
				<arg value="${database.name}"/>
				<arg value="${database.user}"/>
				<arg value="${database.password}"/>
				<arg value="${oracle.driver.string}"/>
				<arg value="${isUpgrade}"/>
				<arg value="${buildVersion}"/>
			</java>
		</target>

	<!-- Start : DE Integration Restructure for p5 -->

	<target name="insertCuratedPathForRecordEntry">
		<unwar src="${caTissue-webapp.dir.dist}/modules/caTissue/lib/catissuecore.war" dest="${prop.temp.dir}/catissuecore"/>
		<antcall target="replacecfgfiles"/>
		<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/conf/catissuecore-properties/log4j.properties" todir="${caTissue-webapp.dir.dist}" overwrite="true"/>
		<java classname="edu.wustl.catissuecore.querysuite.metadata.AddCuratedPathsForRecordEntry" fork="true" maxmemory="1024M" failonerror="false">
			<classpath location="${prop.temp.dir}/catissuecore/WEB-INF/classes" />
			<classpath refid="temp.classpath" />
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="**/*.jar" />
				</fileset>
			</classpath>
		</java>
		<delete failonerror="${delete.failonerror}" dir="${prop.temp.dir}" />
		<delete failonerror="${delete.failonerror}" file="${caTissue-webapp.dir.dist}/log4j.properties" />
	</target>

	<target name="upgrade_de_integration_restructure_metadata" description="Start : DE Integration Restructure for p5 ">
		<unwar src="${caTissue-webapp.dir.dist}/modules/caTissue/lib/catissuecore.war" dest="${prop.temp.dir}/catissuecore"/>
		<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/mysql-connector-java-5.0.8-bin.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />
		<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/ojdbc14.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="upgrade_de_integration_restructure_metadata_mysql" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="upgrade_de_integration_restructure_metadata_oracle" />
				</then>
			</elseif>
			<!-- mssqlserver db -->
			<elseif>
				<equals arg1="mssqlserver" arg2="${database.type}" />
				<then>
					<antcall target="upgrade_de_integration_restructure_metadata_mssqlserver" />
				</then>
			</elseif>
		</if>
		<delete failonerror="${delete.failonerror}" dir="${prop.temp.dir}" />
	</target>

	<target name="upgrade_de_integration_restructure_metadata_mysql" description="Updating DE integration metadata (mysql).....">
	<echo message="Updating DE integration metadata (mysql)....." />

	<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}">
		<transaction src="${common.sql.dir}/MySql/DEIntegrationRestructure.sql" />
		<transaction>commit;</transaction>
		<classpath>
			<fileset dir="${lib.dir}">
				<include name="*.jar" />
			</fileset>
		</classpath>
	</sql>

	<java classname="edu.wustl.catissuecore.querysuite.metadata.AddDEIntegrationMetadata" fork="true" maxmemory="1024M" failonerror="true">
		<classpath location="${prop.temp.dir}/catissuecore/WEB-INF/classes" />
		<classpath refid="temp.classpath" />
		<classpath>
			<fileset dir="${lib.dir}">
				<include name="*.jar" />
			</fileset>
		</classpath>
		<arg value="${database.server}"/>
		<arg value="${database.port}"/>
		<arg value="${database.type}"/>
		<arg value="${database.name}"/>
		<arg value="${database.user}"/>
		<arg value="${database.password}"/>
		<arg value="com.mysql.jdbc.Driver"/>
	</java>

	<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}">
		<transaction src="${common.sql.dir}/MySql/DEIntegrationRestructure_Data.sql" />
		<transaction>commit;</transaction>
		<classpath>
			<fileset dir="${lib.dir}">
				<include name="*.jar" />
			</fileset>
		</classpath>
	</sql>
	</target>

	<target name="upgrade_de_integration_restructure_metadata_oracle" description="Updating DE integration metadata (oracle).....">
		<echo message="Updating DE integration metadata (oracle)....." />

		<java classname="edu.wustl.catissuecore.querysuite.metadata.AddDEIntegrationMetadata" fork="true" maxmemory="1024M" failonerror="true">
			<classpath location="${prop.temp.dir}/catissuecore/WEB-INF/classes" />
			<classpath refid="temp.classpath" />
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
			<arg value="${database.server}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.user}"/>
			<arg value="${database.password}"/>
			<arg value="${oracle.driver.string}"/>
		</java>
		<antcall target="reset_DE_sequences" />

		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle">
			<transaction src="${common.sql.dir}/Oracle/DEIntegrationRestructure_Data.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>

	<target name="upgrade_de_integration_restructure_data" depends="commondbconfig" description="Updating data as per restructured DE integration.....">

		<echo message="Updating data as per restructured DE integration....." />

		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="upgrade_de_integration_restructure_data_mysql" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="upgrade_de_integration_restructure_data_oracle" />
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
	</target>

	<target name="upgrade_de_integration_restructure_data_mysql" description="upgrade DE integrationrestructure data for mysql">
		<java classname="edu.wustl.catissuecore.querysuite.metadata.DERestructureDataUtil" fork="true" failonerror="true" maxmemory="512m">
			<classpath location="${prop.temp.dir}/catissuecore/WEB-INF/classes" />
			<classpath refid="temp.classpath" />
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
			<arg value="${database.server}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.user}"/>
			<arg value="${database.password}"/>
			<arg value="com.mysql.jdbc.Driver"/>
		</java>
	</target>

	<target name="upgrade_de_integration_restructure_data_oracle" description="upgrade DE integration restructure data for oracle">
		<java classname="edu.wustl.catissuecore.querysuite.metadata.DERestructureDataUtil" fork="true" failonerror="true" maxmemory="512m">
			<classpath location="${prop.temp.dir}/catissuecore/WEB-INF/classes" />
			<classpath refid="temp.classpath" />
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
			<arg value="${database.server}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.user}"/>
			<arg value="${database.password}"/>
			<arg value="${oracle.driver.string}"/>
		</java>
		<antcall target="reset_record_entry_sequence"></antcall>
	</target>

	<!-- End : DE Integration Restructure for p5 -->

	<target name="Export_Clinical_diagnosis" description="Exporting clinical diagnosis data">
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="Export_Clinical_diagnosis_mysql" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="Export_Clinical_diagnosis_oracle" />
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
		<delete failonerror="${delete.failonerror}" dir="${prop.temp.dir}" />
	</target>

	<target name="Export_Clinical_diagnosis_mysql" description="Exporting data of Clinical diagnosis ... for Mysql">
		<echo message="Exporting data of Clinical diagnosis ..." />
		<unwar src="${caTissue-webapp.dir.dist}/modules/caTissue/lib/catissuecore.war" dest="${prop.temp.dir}/catissuecore"/>
		<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/mysql-connector-java-5.0.8-bin.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib"/>
		<java classname="edu.wustl.common.util.impexp.AutomateImport" fork="true">
			<classpath refid="temp.classpath" />
			<arg value="${database.server}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.user}"/>
			<arg value="${database.password}"/>
			<arg value="com.mysql.jdbc.Driver"/>
			<arg value="import"/>
			<arg value="${caTissue-webapp.dir.dist}/db/Permissible_values/dumpFileColumnInfo.txt"/>
			<arg value="${caTissue-webapp.dir.dist}/db/Permissible_values/"/>
		</java>
		<delete failonerror="${delete.failonerror}" dir="${prop.temp.dir}" />
	</target>

	<target name="Export_Clinical_diagnosis_oracle" description="Exporting data of Clinical diagnosis ... for Oracle">
		<echo message="Exporting data of Clinical diagnosis ..." />
		<unwar src="${caTissue-webapp.dir.dist}/modules/caTissue/lib/catissuecore.war" dest="${prop.temp.dir}/catissuecore"/>
		<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/ojdbc14.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />
		<java classname="edu.wustl.common.util.impexp.AutomateImport" fork="true">
			<classpath refid="temp.classpath" />
			<arg value="${database.server}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.user}"/>
			<arg value="${database.password}"/>
			<arg value="${oracle.driver.string}"/>
			<arg value="import"/>
			<arg value="${caTissue-webapp.dir.dist}/db/Permissible_values/dumpFileColumnInfo.txt"/>
			<arg value="${caTissue-webapp.dir.dist}/db/Permissible_values/"/>
			<arg value="${caTissue-webapp.dir.dist}/db/Permissible_values/"/>
			<arg value="${oracle.tns.name}"/>
		</java>
		<delete failonerror="${delete.failonerror}" dir="${prop.temp.dir}" />
	</target>


	<!--Data import for CAModel -->
	<target name="CAModel_import_data" description="Importing CA model data">
		<unwar src="${caTissue-webapp.dir.dist}/modules/caTissue/lib/catissuecore.war" dest="${prop.temp.dir}/catissuecore"/>
		<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/mysql-connector-java-5.0.8-bin.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />
		<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/ojdbc14.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />
		<delete failonerror="${delete.failonerror}" file="${prop.temp.dir}/catissuecore/WEB-INF/lib/mmtxProject.jar" />
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="CAModel_import_data_mysql" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="CAModel_import_data_oracle" />
				</then>
			</elseif>
			<elseif>
				<equals arg1="mssqlserver" arg2="${database.type}" />
				<then>
					<antcall target="CAModel_import_data_mssqlserver" />
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
		<delete failonerror="${delete.failonerror}" dir="${prop.temp.dir}" />
	</target>

	<target name="CAModel_import_data_mysql" description="Importing CA models data for caTISSUE Suite Application to MySQL Database ..">
		<echo message="Importing CA models data for caTISSUE Suite Application to MySQL Database ..." />
		<java classname="edu.wustl.common.util.impexp.AutomateImport"  fork="true" maxmemory="512m">
			<classpath refid="temp.classpath" />
			<arg value="${database.server}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.user}"/>
			<arg value="${database.password}"/>
			<arg value="${mysql.driver.string}"/>
			<arg value="import"/>
			<arg value="${install.common.sql.dir}/dumpFileColumnInfo.txt"/>
			<arg value="${install.common.sql.dir}/CAModelCSVs/"/>
		</java>
	</target>

	<target name="CAModel_import_data_oracle" description="Importing CA models data for caTISSUE Suite Application to Oracle Database ...">
		<echo message="Importing CA models data for caTISSUE Suite Application to Oracle Database ..." />
		<java classname="edu.wustl.common.util.impexp.AutomateImport"  fork="true" >

			<classpath refid="temp.classpath" />

			<arg value="${database.server}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.user}"/>
			<arg value="${database.password}"/>
			<arg value="${oracle.driver.string}"/>
			<arg value="import"/>
			<arg value="${install.common.sql.dir}/dumpFileColumnInfo.txt"/>
			<arg value="${install.common.sql.dir}/CAModelCSVs/"/>
			<arg value="${oracle.sql.dir}/CAModelCTLs/"/>
			<arg value="${oracle.tns.name}"/>
		</java>
	</target>

	<!--Data export for CAModel -->
	<target name="CAModel_export_data" description="Data export for CAModel">
		<unwar src="${caTissue-webapp.dir.dist}/modules/caTissue/lib/catissuecore.war" dest="${prop.temp.dir}/catissuecore"/>
		<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/mysql-connector-java-5.0.8-bin.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />
		<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/ojdbc14.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />
		<delete failonerror="${delete.failonerror}" file="${prop.temp.dir}/catissuecore/WEB-INF/lib/mmtxProject.jar" />
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="CAModel_export_data_mysql" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="CAModel_export_data_oracle" />
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
		<delete failonerror="${delete.failonerror}" dir="${prop.temp.dir}" />
	</target>

	<target name="CAModel_export_data_mysql" description="Exporting data of CA models for MySQL Database...">
		<echo message="Exporting data of CA models for MySQL Database..." />
		<java classname="edu.wustl.common.util.impexp.AutomateImport" fork="true">
			<classpath refid="temp.classpath" />
			<arg value="${database.server}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.user}"/>
			<arg value="${database.password}"/>
			<arg value="${mysql.driver.string}"/>
			<arg value="export"/>
			<arg value="${dbupgrade.sql.dir}/Common/dumpFileColumnInfo.txt"/>
			<arg value="${basedir}/SQL/DBUpgrade/Common/CAModelCSVs/"/>
		</java>
		<delete failonerror="${delete.failonerror}" dir="${prop.temp.dir}" />
	</target>

	<target name="metadata_cleanup" description="To remove the corrupted path from the database.">
			<echo message="Cleaning up Corrupted paths...." />
			<delete dir="${prop.temp.dir}" failonerror="false"/>
	 		<mkdir dir="${prop.temp.dir}" />
			<unwar src="${caTissue-webapp.dir.dist}/modules/caTissue/lib/catissuecore.war" dest="${prop.temp.dir}/catissuecore"/>
			<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/mysql-connector-java-5.0.8-bin.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />
			<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/ojdbc14.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />
			<delete failonerror="${delete.failonerror}" file="${prop.temp.dir}/catissuecore/WEB-INF/lib/mmtxProject.jar" />
			<if>
				<equals arg1="mysql" arg2="${database.type}" />
				<then>
					<java classname="edu.wustl.common.util.global.QueryMetadataCleanup" fork="true">
						<classpath refid="temp.classpath" />
						<arg value="${database.user}"/>
						<arg value="${database.password}"/>
						<arg value="${mysql.driver.string}"/>
						<arg value="jdbc:mysql://${database.server}:${database.port}/${database.name}"/>
					</java>
				</then>
				<elseif>
					<equals arg1="oracle" arg2="${database.type}" />
					<then>
						<java classname="edu.wustl.common.util.global.QueryMetadataCleanup" fork="true">
							<classpath refid="temp.classpath" />
							<arg value="${database.user}"/>
							<arg value="${database.password}"/>
							<arg value="${oracle.driver.string}"/>
							<arg value="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}"/>
						</java>
					</then>
				</elseif>
				<else>
					<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
				</else>
			</if>
			<delete failonerror="${delete.failonerror}" dir="${prop.temp.dir}" />
	</target>
	<target name="CAModel_export_data_oracle" description="Exporting data of CA models for Oracle Database...">
		<echo message="Exporting data of CA models for Oracle Database..." />
		<java classname="edu.wustl.common.util.impexp.AutomateImport" fork="false">
			<classpath refid="temp.classpath" />
			<arg value="${database.server}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.user}"/>
			<arg value="${database.password}"/>
			<arg value="${oracle.driver.string}"/>
			<arg value="export"/>
			<arg value="${dbupgrade.sql.dir}/Common/dumpFileColumnInfo.txt"/>
			<arg value="${basedir}/SQL/DBUpgrade/Common/CAModelCSVs/"/>
			<arg value="${basedir}/SQL/DBUpgrade/Oracle/CAModelCTLs/"/>
			<arg value="${oracle.tns.name}"/>
		</java>
	</target>

	<!--Send mail to user-->
	<target name="send_mail" description="Send mail to user">
	    <condition property="protocol" value="https" else="http">
			<equals arg1="${jboss.container.secure}" arg2="yes" />
		</condition>
		<condition property="jbossServerHost" value="localhost" else="${jboss.server.hostname}">
			<equals arg1="${jboss.server.hostname}" arg2="" />
		</condition>
		<echo message="jboss.container.secure property is set to: ${jboss.container.secure} protocol set to: ${protocol}" />
		<echo message="Sending mail to: ${email.administrative.emailAddress}" />
		<echo message="Sending mail from: ${email.sendEmailFrom.emailAddress}" />
		<mail mailhost="${email.mailServer}" subject="caTissueSuite v2.0 Successfully Deployed" encoding="plain" failonerror="false">
			<from address="${email.sendEmailFrom.emailAddress}" />
			<to address="${email.administrative.emailAddress}" />
			<message>
Dear caTissueSuite Administrator,

	This is to validate that caTissueSuite application has been installed at
the following location: ${jboss.home.dir}

	To complete the deployment, you have to now perform the post installation
steps described in section "Post Installation Configuration" in the deployment
guide (caTissueSuite v1.1.p5 Deployment Guide.doc).

	Once you have completed deployment, you should be able to login with the following
details:
URL: ${protocol}://${jbossServerHost}:${jboss.server.port}/catissuecore
Username:${first.admin.emailAddress}
Password:${first.admin.password}

Thanking You,
-caTissue Suite
			</message>
		</mail>
		<echo>
			Please check the Email of ${first.admin.emailAddress}.
			If the Deployment mail is not received please check your
			email.administrative.emailAddress and email.sendEmailFrom.emailAddress
			properties in install.properties and Re-deploy the Application.
		</echo>
	</target>

	<!--First User Creation. Mandar : 02-May-2006 -->
	<path id="temp.classpath">
		<fileset dir="${prop.temp.dir}/catissuecore/WEB-INF/lib">
			<include name="*.jar" />
		</fileset>
	</path>

	<target name="firstUser" description="Inserting the first user mentioned in the install.properties file">
		<if>
			<equals arg1="mysql" arg2="${database.type}"/>
			<then>
				<antcall target="firstUser_mysql"/>
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}"/>
				<then>
					<antcall target="firstUser_oracle"/>
				</then>
			</elseif>
			<elseif>
				<equals arg1="mssqlserver" arg2="${database.type}"/>
				<then>
					<antcall target="firstUser_mssqlserver"/>
				</then>
			</elseif>
		</if>
	</target>

	<target name="firstUser_oracle" description="Inserting the first user mentioned in the install.properties file For Oracle">
		<echo message="Encoding Password..."/>
		<unwar src="${caTissue-webapp.dir.dist}/modules/caTissue/lib/catissuecore.war" dest="${prop.temp.dir}/catissuecore"/>
		<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/ojdbc14.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />
		<java classname="edu.wustl.common.util.global.PasswordManager" fork="true">

			<classpath refid="temp.classpath" />

			<arg value="${caTissue-webapp.dir.dist}/catissuetmp.txt"/>
			<arg value="${first.admin.password}"/>
		</java>

		<property file="${caTissue-webapp.dir.dist}/catissuetmp.txt"/>
			<echo>
					Encoded Password ${first.admin.encodedPassword}
			</echo>

		<echo message="Modifying caTissue Suite SQL file for user information..."/>
			<copy file="${oracle.sql.dir}/createUser.sql" todir="${prop.temp.dir}" overwrite="true"/>

			<replace dir="${prop.temp.dir}" propertyfile="${caTissue-webapp.dir.dist}/install.properties">
				<include name="createUser.sql"/>
				<replacefilter token="@@first.admin.department@@" value="${first.admin.department}"/>
				<replacefilter token="@@first.admin.institution@@" value="${first.admin.institution}"/>
				<replacefilter token="@@first.admin.cancerresearchgroup@@" value="${first.admin.cancerresearchgroup}"/>
				<replacefilter token="@@first.admin.emailAddress@@" value="${first.admin.emailAddress}"/>
				<replacefilter token="@@first.admin.encodedPassword@@" value="${first.admin.encodedPassword}"/>
			</replace>
			<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle">
					<transaction src="${prop.temp.dir}/createUser.sql" />
					<transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
			</sql>
		<delete failonerror="${delete.failonerror}" dir="${prop.temp.dir}"/>
	</target>

	<target name="firstUser_mysql" description="Inserting the first user mentioned in the install.properties file For Mysql">
		<echo message="Encoding Password..."/>
		<unwar src="${caTissue-webapp.dir.dist}/modules/caTissue/lib/catissuecore.war" dest="${prop.temp.dir}/catissuecore"/>
		<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/mysql-connector-java-5.0.8-bin.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />
		<java classname="edu.wustl.common.util.global.PasswordManager" fork="true">

			<classpath refid="temp.classpath" />

			<arg value="${caTissue-webapp.dir.dist}/catissuetmp.txt"/>
			<arg value="${first.admin.password}"/>
		</java>

		<property file="${caTissue-webapp.dir.dist}/catissuetmp.txt"/>
			<echo>
					Encoded Password ${first.admin.encodedPassword}
			</echo>

		<echo message="Modifying caTissue Suite SQL file for user information..."/>
		<copy file="${mysql.sql.dir}/createUser.sql" todir="${prop.temp.dir}" overwrite="true"/>

			<replace dir="${prop.temp.dir}" propertyfile="${caTissue-webapp.dir.dist}/install.properties">
				<include name="createUser.sql"/>
				<replacefilter token="@@first.admin.department@@" value="${first.admin.department}"/>
				<replacefilter token="@@first.admin.institution@@" value="${first.admin.institution}"/>
				<replacefilter token="@@first.admin.cancerresearchgroup@@" value="${first.admin.cancerresearchgroup}"/>
				<replacefilter token="@@first.admin.emailAddress@@" value="${first.admin.emailAddress}"/>
				<replacefilter token="@@first.admin.encodedPassword@@" value="${first.admin.encodedPassword}"/>
			</replace>
			<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}" >
							<transaction src="${prop.temp.dir}/createUser.sql" />
							<transaction>commit;</transaction>
							<classpath>
								<fileset dir="${lib.dir}">
									<include name="*.jar" />
								</fileset>
							</classpath>
			</sql>
		<delete failonerror="${delete.failonerror}" dir="${prop.temp.dir}" />
	</target>

	<!-- Configure titli.properties according to properties in install.properties and other set properties -->
	<target name="configure_keyword_search" description="Configures titli.properties according to properties in install.properties and other set properties">
		<echo message="the value of ${tempPath}"/>
		<replace dir="${tempPath}" propertyfile="${catissue.deploy.config.file}">
			<include name="titli.properties" />
			<replacefilter token="@@username@@" value="${database.user}" />
			<replacefilter token="@@password@@" value="${database.password}" />
			<replacefilter token="@@titliindexlocation@@" value="${jboss.server.url}/catissuecore-properties/titli-index" />
			<replacefilter token="@@databasename@@" value="${database.name}" />
			<replacefilter token="@@databasetype@@" value="${database.type}" />
		</replace>
		<!-- conditional configuration of database url and driver names -->
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<replace dir="${tempPath}" propertyfile="${catissue.deploy.config.file}">
					<include name="titli.properties" />
					<replacefilter token="@@databasedriver@@" value="${mysqlDriver}" />
					<replacefilter token="@@databaseurl@@" value="jdbc:mysql://${database.server}:${database.port}/${database.name}" />
				</replace>
				<echo message="${database.type} ${database.name}" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<replace dir="${tempPath}" propertyfile="${catissue.deploy.config.file}">
						<include name="titli.properties" />
						<replacefilter token="@@databaseurl@@" value="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" />
						<replacefilter token="@@databasedriver@@" value="${oracle.driver.string}" />
					</replace>
					<echo message="${database.type} ${database.name}" />
				</then>
			</elseif>
			<elseif>
				<equals arg1="mssqlserver" arg2="${database.type}" />
				<then>
					<replace dir="${tempPath}" propertyfile="${catissue.deploy.config.file}">
						<include name="titli.properties" />
						<replacefilter token="@@databaseurl@@" value="jdbc:sqlserver://${database.server}:${database.port};databaseName=${database.name};" />
						<replacefilter token="@@databasedriver@@" value="${mssqlserver.driver.string}" />
					</replace>
					<echo message="${database.type} ${database.name}" />
				</then>
			</elseif>
		</if>
	</target>

	<target name="configure_gsid_properties" description="Configures gsid.properties according to properties in install.properties/upgrade.properties and other set of properties. In addition, it also copies the sync desc file to appropriate location">
		<property name="gsid.propsFolder" value="${prop.temp.dir}/catissuecore/WEB-INF/classes"/>
		<replace dir="${gsid.propsFolder}" propertyFile="${catissue.deploy.config.file}">
			<include name="gsid.properties"  />
			<replacefilter token="@@gsid.isEnabled@@" value="${gsid.isEnabled}"/>
			<!--<replacefilter token="@@gsid.dorianURL@@" value="${gsid.dorianURL}"/> -->
			<replacefilter token="@@gsid.serviceURL@@" value="${gsid.serviceURL}"/> 
			<replacefilter token="@@gsid.assignEnabled@@" value="${gsid.assignEnabled}"/>
			<replacefilter token="@@gsid.userName@@" value="${gsid.userName}"/>
			<replacefilter token="@@gsid.password@@" value="${gsid.password}"/>
			<replacefilter token="@@gsid.registerSite.applicationName@@" value="${gsid.registerSite.applicationName}"/>
			<replacefilter token="@@gsid.registerSite.applicationURL@@" value="${gsid.registerSite.applicationURL}"/>
			<replacefilter token="@@gsid.registerSite.applicationVersionNumber@@" value="${gsid.registerSite.applicationVersionNumber}"/>
			<replacefilter token="@@gsid.regsiterSite.contactName@@" value="${gsid.regsiterSite.contactName}"/>
			<replacefilter token="@@gsid.registerSite.contactEmail@@" value="${gsid.registerSite.contactEmail}"/>
			<replacefilter token="@@gsid.registerSite.phoneNumber@@" value="${gsid.registerSite.phoneNumber}"/>
			<replacefilter token="@@gsid.registerSite.organizationName@@" value="${gsid.registerSite.organizationName}"/>
			<replacefilter token="@@gsid.target.grid@@" value="${target.grid}"/>
			<!--<replacefilter token="@@gsid.synDescriptionFileLocation@@" value="${jboss.server.url}/catissuecore-properties/sync-description-gsid.xml"/>-->
			<replacefilter token="@@jboss.home@@" value="${jboss.server.url}"/>
			<replacefilter token="@@enable.gsid.assign.button@@" value="${enable.gsid.assign.button}"/>

		</replace>
		<!--<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/conf/sync-description.xml" todir="${jboss.server.url}/catissuecore-properties/" />-->
	</target>

	<target name="configure_gridgrouper_properties" description="Configures gridgrouper.properties according to properties in install.properties/upgrade.properties and other set of properties. In addition, it also copies the sync desc file to appropriate location">
		<property name="gridgrouper.propsFolder" value="${prop.temp.dir}/catissuecore/WEB-INF/classes"/>
		<replace dir="${gridgrouper.propsFolder}" propertyFile="${catissue.deploy.config.file}">
			<include name="gridgrouper.properties"  />
			<replacefilter token="@@gridgrouper.isEnabled@@" value="${gridgrouper.isEnabled}"/>
			<!--<replacefilter token="@@gridgrouper.dorianURL@@" value="${gridgrouper.dorianURL}"/>
			<replacefilter token="@@gridgrouper.serviceURL@@" value="${gridgrouper.serviceURL}"/>-->
			<replacefilter token="@@gridgrouper.userName@@" value="${gridgrouper.userName}"/>
			<replacefilter token="@@gridgrouper.password@@" value="${gridgrouper.password}"/>
			<replacefilter token="@@gridgrouper.stems@@" value="${gridgrouper.stems}"/>
			<replacefilter token="@@gridgrouper.target.grid@@" value="${target.grid}"/>
			<!--<replacefilter token="@@gridgrouper.synDescriptionFileLocation@@" value="${jboss.server.url}/catissuecore-properties/sync-description-gridgrouper.xml"/>-->
			<replacefilter token="@@jboss.home@@" value="${jboss.server.url}"/>
		</replace>
		<!--<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/conf/sync-description-gridgrouper.xml" todir="${jboss.server.url}/catissuecore-properties/" />-->
	</target>

	<target name="configure_magetab_properties" description="Configures gsid.properties according to properties in install.properties and other set of properties. In addition, it also copies the magetab.idf file to appropriate location">
		<property name="magetab.propsFolder" value="${prop.temp.dir}/catissuecore/WEB-INF/classes"/>
		<replace dir="${magetab.propsFolder}" propertyFile="${catissue.deploy.config.file}">
					<include name="magetab.properties"  />
					<replacefilter token="@@magetab.idfFileLocation@@" value="${jboss.server.url}/catissuecore-properties/magetab.idf"/>
					<replacefilter token="@@magetab.outputFolderLocation@@" value="${jboss.server.url}/catissuecore-properties/mageTabOutput/"/>
		</replace>
		<mkdir dir="${jboss.server.url}/catissuecore-properties/mageTabOutput" description="creating a directory for magetabe output"/>
		<copy file="magetab.idf" todir="${jboss.server.url}/catissuecore-properties/" />
	</target>

	<target name="configure_ctrp_properties" description="Configures ctrp.properties according to properties in install.properties/upgrade.properties and other set of properties. In addition, it also copies the sync desc file to appropriate location">
		<property name="ctrp.propsFolder" value="${prop.temp.dir}/catissuecore/WEB-INF/classes"/>
		<replace dir="${ctrp.propsFolder}" propertyFile="${catissue.deploy.config.file}">
			<include name="ctrp.properties"  />
			<replacefilter token="@@ctrp.isEnabled@@" value="${ctrp.isEnabled}"/>
			<replacefilter token="@@ctrp.dorian.targetGridEnv@@" value="${target.grid}"/>
			<!--<replacefilter token="@@ctrp.dorian.loginURL@@" value="${ctrp.dorian.loginURL}"/>-->
			<!--<replacefilter token="@@ctrp.dorian.syncDescFile@@" value="${jboss.server.url}/catissuecore-properties/sync-description-ctrp.xml"/>-->
			<replacefilter token="@@ctrp.userName@@" value="${ctrp.userName}"/>
			<replacefilter token="@@ctrp.password@@" value="${ctrp.password}"/>
			<replacefilter token="@@ctrp.person.serviceURL@@" value="${ctrp.person.serviceURL}"/>
			<replacefilter token="@@ctrp.organization.serviceURL@@" value="${ctrp.organization.serviceURL}"/>
			<replacefilter token="@@ctrp.po.business.serviceURL@@" value="${ctrp.po.business.serviceURL}"/>
			<replacefilter token="@@ctrp.po.clinicalResearchStaff.serviceURL@@" value="${ctrp.po.clinicalResearchStaff.serviceURL}"/>
			<replacefilter token="@@ctrp.pa.studyProtocol.serviceURL@@" value="${ctrp.pa.studyProtocol.serviceURL}"/>
			<replacefilter token="@@ctrp.pa.studyContact.serviceURL@@" value="${ctrp.pa.studyContact.serviceURL}"/>
		</replace>
		<!--<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/conf/sync-description-ctrp.xml" todir="${jboss.server.url}/catissuecore-properties/" />-->
	</target>

	<target name="configure_services_properties" description="Configures services.properties">
		<property name="services.propsFolder" value="${prop.temp.dir}/catissuecore/WEB-INF/classes"/>
		<copy file="${catissue.deploy.config.file}" tofile="${services.propsFolder}/services.properties" overwrite="true" verbose="true" ></copy>
		<!--
		<replace dir="${services.propsFolder}" propertyFile="${catissue.deploy.config.file}">
			<include name="services.properties"  />
			<replacefilter token="@@ccts.integration.isEnabled@@" value="${ccts.integration.isEnabled}"/>
			<replacefilter token="@@sts.serviceName@@" value="${sts.serviceName}"/>
			<replacefilter token="@@sts.servicePortName@@" value="${sts.servicePortName}"/>
			<replacefilter token="@@sts.serviceURL@@" value="${sts.serviceURL}"/>
			<replacefilter token="@@sts.service.wsdlLocation@@" value="${sts.service.wsdlLocation}"/>
			<replacefilter token="@@ccts.subjectManagementService.URL@@" value="${ccts.subjectManagementService.URL}"/>
			<replacefilter token="@@ccts.subjectManagementService.wsdlLocation@@" value="${ccts.subjectManagementService.wsdlLocation}"/>
			<replacefilter token="@@ccts.subjectManagementService.serviceClass@@" value="${ccts.subjectManagementService.serviceClass}"/>
			<replacefilter token="@@ccts.subjectRegistrationService.URL@@" value="${ccts.subjectRegistrationService.URL}"/>
			<replacefilter token="@@ccts.subjectRegistrationService.wsdlLocation@@" value="${ccts.subjectRegistrationService.wsdlLocation}"/>
			<replacefilter token="@@ccts.subjectRegistrationService.serviceClass@@" value="${ccts.subjectRegistrationService.serviceClass}"/>
			<replacefilter token="@@sts.userName@@" value="${sts.userName}"/>
			<replacefilter token="@@sts.password@@" value="${sts.password}"/>
		</replace>
		-->
	</target>


	<property name="filename" value=" " />
	<property name="hookentity" value=" " />
	<property name="mainContainerList" value=" " />
	<property name="condition" value=" " />
	<property name="package" value=" " />
	<property name="addQueryPaths" value=" " />
	<property name="pv.file.name" value="" />

	<target name="import_xmi" description="Import XMI">
        <echo message=">>> IMPORTING XMI (deploy.xml) ..." />
		<delete quiet="true" includeemptydirs="true">
			<fileset dir="${prop.temp.dir}/catissuecore">
				<include name="**/*" />
			</fileset>
		</delete>
		
		<property name="xmi.file.path" location="${filename}"/>
		<available file="${xmi.file.path}" property="is.xmi.present"/>
		<if>
			<not>
			   <isset property="is.xmi.present"/>
			</not>
			<then>
				<property name="new.xmi.file.path" location="../../../${filename}"/>
				<available file="${new.xmi.file.path}" property="is.newxmi.present"/>
				<if>
					<isset property="is.newxmi.present"/>
					<then>
						<property name="xmi.file.name" value="${new.xmi.file.path}"/>
					</then>
					<else>
						<property name="xmi.file.name" value="${filename}"/>
					</else>
				</if>
			</then>
			<else>
				<property name="xmi.file.name" value="${filename}"/>
			</else>
		</if>
		
		<property name="container.file.path" location="${mainContainerList}"/>
		<available file="${container.file.path}" property="is.container.file.present"/>
		<if>
			<not>
			   <isset property="is.container.file.present"/>
			</not>
			<then>
				<property name="new.container.file.path" location="../../../${mainContainerList}"/>
				<available file="${new.container.file.path}" property="is.new.container.file.present"/>
				<if>
					<isset property="is.new.container.file.present"/>
					<then>
						<property name="container.file.name" value="${new.container.file.path}"/>
					</then>
					<else>
						<property name="container.file.name" value="${mainContainerList}"/>
					</else>
				</if>
			</then>
			<else>
				<property name="container.file.name" value="${mainContainerList}"/>
			</else>
		</if>

		<if>
			<equals arg1="" arg2="${condition}" />
			<then>
				<property name="condition.file.name" value="${condition}"/>
			</then>
			<else>
				<property name="condition.file.path" location="${condition}"/>
				<available file="${condition.file.path}" property="is.condition.file.present"/>
				<if>
					<not>
					   <isset property="is.condition.file.present"/>
					</not>
					<then>
						<property name="new.condition.file.path" location="../../../${condition}"/>
						<available file="${new.condition.file.path}" property="is.new.condition.file.present"/>
						<if>
							<isset property="is.new.condition.file.present"/>
							<then>
								<property name="condition.file.name" value="${new.condition.file.path}"/>
							</then>
							<else>
								<property name="condition.file.name" value="${condition}"/>
							</else>
						</if>
					</then>
					<else>
						<property name="condition.file.name" value="${condition}"/>
					</else>
				</if>
			</else>
		</if>

		<echo message="XMI file path : ${xmi.file.name}"/>
		<echo message="Container file path : ${container.file.name}"/>
		<echo message="Condition file path : ${condition.file.name}"/>
		
		<unwar src="${caTissue-webapp.dir.dist}/modules/caTissue/lib/catissuecore.war" dest="${prop.temp.dir}/catissuecore" />
		<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/mysql-connector-java-5.0.8-bin.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />
		<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/ojdbc14.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />
		<antcall target="replace_app_dao_prop_file"/>
		<unzip src="${caTissue-webapp.dir.dist}/modules/dynamic_extensions/lib/dynamicextensions.zip" dest="${prop.temp.dir}/dynamicextensions" overwrite="true" />

		<copy todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" overwrite="true">
			<fileset dir="${prop.temp.dir}/dynamicextensions/lib">
				<include name="openide-util*.jar" />
				<include name="nbmdr*.jar" />
				<include name="jmiutils*.jar" />
			</fileset>
		</copy>

		<copy file="${caTissue-webapp.dir.dist}/modules/dynamic_extensions/conf/hibernate.cfg.xml" todir="${prop.temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />
		<copy file="${prop.temp.dir}/dynamicextensions/conf/DynamicExtensionsHibernate.cfg.xml" tofile="${prop.temp.dir}/catissuecore/WEB-INF/classes/DynamicExtensionsHibernate.cfg.xml" overwrite="true" />
		<copy file="${prop.temp.dir}/dynamicextensions/conf/DynamicExtensionsAuditMetadata.xml" tofile="${prop.temp.dir}/catissuecore/WEB-INF/classes/DynamicExtensionsAuditMetadata.xml" overwrite="true" />

		<unjar src="${prop.temp.dir}/dynamicextensions/binaries/DynamicExtensionsInterface/DynamicExtensions.jar" dest="${prop.temp.dir}/dynamicextensions/WEB-INF/classes" />
		<echo message="Concatenating the Application Resource Properties file" />
		<concat destfile="${prop.temp.dir}/dynamicextensions/WEB-INF/classes/ApplicationResources.properties" append="true">
			<fileset file="${prop.temp.dir}/catissuecore/WEB-INF/classes/ApplicationResources.properties" />
		</concat>
		<copy file="${prop.temp.dir}/dynamicextensions/WEB-INF/classes/ApplicationResources.properties" todir="${prop.temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />
		<!--<echo>Configuring logger ...</echo>
		<antcall target="configure_log4j" />-->
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
					<include name="*.cfg.xml" />
					<replacefilter token="@@DIALECT@@" value="${mysql.dialect.string}" />
					<replacefilter token="@@DRIVER@@" value="com.mysql.jdbc.Driver" />
					<replacefilter token="@@URL@@" value="jdbc:mysql://${database.server}:${database.port}/${database.name}" />
				</replace>
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
						<include name="*.cfg.xml" />
						<replacefilter token="@@DIALECT@@" value="${oracle.dialect.string}" />
						<replacefilter token="@@DRIVER@@" value="${oracle.driver.string}" />
						<replacefilter token="@@URL@@" value="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" />
					</replace>
				</then>
			</elseif>
			<elseif>
				<equals arg1="mssqlserver" arg2="${database.type}"/>
				<then>
					<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
						<include name="*.cfg.xml" />
						<replacefilter token="@@DIALECT@@" value="${mssqlserver.dialect.string}"/>
						<replacefilter token="@@DRIVER@@" value="${mssqlserver.driver.string}"/>
						<replacefilter token="@@URL@@" value="jdbc:sqlserver://${database.server}:${database.port};databaseName=${database.name};" />
					</replace>
				</then>
			</elseif>
		</if>
		<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
			<include name="*.cfg.xml" />
			<replacefilter token="@@DATABASE_USERNAME@@" value="${database.user}" />
			<replacefilter token="${token.database.password}" value="${database.password}" />
		</replace>

		<delete failonerror="${delete.failonerror}" dir="${tempcacore.dir}" />
		<mkdir dir="${tempcacore.dir}" />

		<delete failonerror="${delete.failonerror}" dir="${export.dir}" />
		<mkdir dir="${export.dir}" />

		<java classname="edu.wustl.catissuecore.annotations.xmi.ImportXmi" fork="true" maxmemory="1024m" failonerror="true">
			<arg value="${xmi.file.name}" />
			<arg value="${container.file.name}" />
			<arg value="${package}" />
			<arg value="${hookentity}" />
			<arg value="${addQueryPaths}" />
			<arg value="${condition.file.name}" />
			<arg value="${generate.cacore}" />
			<arg value="${Application.url}/"/>
			<arg value="${pv.file.name}"/>
			<classpath>
				<pathelement location="${prop.temp.dir}/catissuecore/WEB-INF/classes" />
				<fileset dir="${prop.temp.dir}/catissuecore/WEB-INF/lib">
					<include name="*.jar" />
					<exclude name="uml-1.3.jar" />
				</fileset>
				<fileset dir="${lib.dir}">
						<include name="**/*.jar" />
				</fileset>
			</classpath>
		</java>
		
		<if>
			<or>
				<equals casesensitive="false" arg1="true" arg2="${generate.cacore}" />
				<equals casesensitive="false"  arg1="yes" arg2="${generate.cacore}" />
				<equals casesensitive="false"  arg1="y" arg2="${generate.cacore}" />
				<equals casesensitive="false"  arg1="t" arg2="${generate.cacore}" />
				<equals casesensitive="false"  arg1="1" arg2="${generate.cacore}" />
			</or>							
			
			<then>
				<basename property="groupName"  suffix="xmi" file="${filename}"/>
				<antcall target="generate:cacore">
					<param name="entity.group.name" value = "${groupName}"/>
				</antcall>
			</then>
		</if>
		
	</target>

	<!--Generate caCORE for the specified entity group-->
	<target name="generate:cacore">
		
		<ant antfile="${caTissue-webapp.dir.dist}/modules/dynamic_extensions/conf/DEDeploy.xml" dir="." target="handle.cacore.generation.for.import.xmi">
			<property name="de.zip.location" value="${prop.temp.dir}/dynamicextensions" />
			<property name="entityGroup.jar.location" value="${prop.temp.dir}/catissuecore/WEB-INF/lib" />
			<property name="cacore.deployable.dir" value="${cacaore.deployables}" />
			<property name="entity.name" value="${entity.group.name}" />
			<property name="jboss.home.dir" value="${jboss.home}" />
			<property name="default.prifix.war" value="${default.prefix.war}" />
			<property name="database.type" value="${database.type}" />
		</ant>
		<delete failonerror="${delete.failonerror}" dir="${export.dir}" />
		<delete failonerror="${delete.failonerror}" dir="${tempcacore.dir}" />
	</target>
	
	<property name="categoryFormNamesFile" value=" " />
	<property name="isPersistMetadataOnly" value=" " />
	<property name="categoryFileDir" value=" " />
	<property name="bulkXMLTemplateFile" value="${base.dir}/Participant.xml"/>
	<property name="mappingXMLFile" value="${base.dir}/bulkoperator/mapping.xml" />
	<property name="importBulkTemplate" value="" />
	<target name="create_category" description="Target used to create the Category">
		
		<property name="category.fileDir.path" location="${categoryFileDir}"/>
		<available file="${category.fileDir.path}" property="is.category.dir.present"/>
		<if>
			<not>
			   <isset property="is.category.dir.present"/>
			</not>
			<then>
				<property name="new.category.filesDir.path" location="../../../${categoryFileDir}"/>
				<available file="${new.category.filesDir.path}" property="is.new.category.dir.present"/>
				<if>
					<isset property="is.new.category.dir.present"/>
					<then>
						<property name="category.files.dir.name" value="${new.category.filesDir.path}"/>
					</then>
					<else>
						<property name="category.files.dir.name" value="${categoryFileDir}"/>
					</else>
				</if>
			</then>
			<else>
				<property name="category.files.dir.name" value="${categoryFileDir}"/>
			</else>
		</if>
		
		<property name="formNames.file.path" location="${categoryFormNamesFile}"/>
		<available file="${formNames.file.path}" property="is.formNames.file.present"/>
		<if>
			<not>
			   <isset property="is.formNames.file.present"/>
			</not>
			<then>
				<property name="new.formName.file.path" location="../../../${categoryFormNamesFile}"/>
				<available file="${new.formName.file.path}" property="is.new.formName.file.present"/>
				<if>
					<isset property="is.new.formName.file.present"/>
					<then>
						<property name="formNames.file.name" value="${new.formName.file.path}"/>
					</then>
					<else>
						<property name="formNames.file.name" value="${categoryFormNamesFile}"/>
					</else>
				</if>
			</then>
			<else>
				<property name="formNames.file.name" value="${categoryFormNamesFile}"/>
			</else>
		</if>
		
		<echo message="Category directory path :: ${category.files.dir.name}"/>
		<echo message="Category formNames file :: ${formNames.file.name}"/>

		<unzip src="${dynamic.extensions.location}/../../bulk_operations/lib/bulkoperator.zip" dest="bulkoperator" />
		<delete dir="${de.temp.dir}" failonerror="no" />
		<mkdir dir="${de.temp.dir}" />
		<unzip src="${dynamic.extensions.location}/clientFormCreator.zip" dest="${de.temp.dir}" overwrite="true" />
		<copy file="./${de.temp.dir}/log4j.properties.template" tofile="./log4j.properties" overwrite="true" />
		<copy file="${dynamic.extensions.location}/../../bulk_operations/lib/log4j.jar" tofile="${de.temp.dir}/log4j.jar" overwrite="true" />
		<mkdir dir="./log" />
		<replace file="./log4j.properties">
			<replacefilter token="@@jbosshome@@" value="." />
		</replace>
		<echo message="Creating Categories" />
		<java classname="edu.common.dynamicextensions.client.CategoryClient" fork="true" maxmemory="1024M">
			<arg value="${category.files.dir.name}" />
			<arg value="${Application.url}" />
			<arg value="${formNames.file.name}" />
			<arg value="${isPersistMetadataOnly}" />
			<arg value="${bulkXMLTemplateFile}"/>
			<arg value="${mappingXMLFile}"/>
			<arg value="${importBulkTemplate}"/>

			<classpath>
				<fileset dir="${de.temp.dir}">
					<include name="*.jar" />
					<exclude name="uml-1.3*.jar" />
				</fileset>
			</classpath>
		</java>
	</target>
	
	<property name="pv.dir" value=" " />
	<target name="import_permissible_values" description="Import permissible values">
		<echo message="Importing Permissible Values" />
		
		<property name="permissibleValues.dir" location="${pv.dir}"/>
		<available file="${permissibleValues.dir}" property="is.permissibleValues.dir.present"/>
		<if>
			<not>
			   <isset property="is.permissibleValues.dir.present"/>
			</not>
			<then>
				<property name="new.permissibleValues.dir.path" location="../../../${pv.dir}"/>
				<available file="${new.permissibleValues.dir.path}" property="is.new.permissibleValues.dir.present"/>
				<if>
					<isset property="is.new.permissibleValues.dir.present"/>
					<then>
						<property name="permissibleValues.dir.name" value="${new.permissibleValues.dir.path}"/>
					</then>
					<else>
						<property name="permissibleValues.dir.name" value="${pv.dir}"/>
					</else>
				</if>
			</then>
			<else>
				<property name="permissibleValues.dir.name" value="${pv.dir}"/>
			</else>
		</if>
		<property name="is.category.pv.import" value="false"/>
		<property name="pv.file" value="${permissibleValuesFile}"/>
		<echo message="Permissible Values Dir :: ${permissibleValues.dir.name}"/>
		<delete dir="${de.temp.dir}" failonerror="no" />
		<mkdir dir="${de.temp.dir}" />
		<unzip src="${dynamic.extensions.location}/clientFormCreator.zip" dest="${de.temp.dir}" overwrite="true" />
		<copy file="./${de.temp.dir}/log4j.properties.template" tofile="./log4j.properties" overwrite="true" />
		<copy file="${dynamic.extensions.location}/../../bulk_operations/lib/log4j.jar" tofile="${de.temp.dir}/log4j.jar" overwrite="true" />
		<mkdir dir="./log" />
		<replace file="./log4j.properties">
			<replacefilter token="@@jbosshome@@" value="." />
		</replace>
		<java classname="edu.common.dynamicextensions.client.PermissibleValuesClient" fork="true" maxmemory="1024M">
			<arg value="${permissibleValues.dir.name}" />
			<arg value="${Application.url}" />
			<arg value="${pv.file}" />
			<arg value="${is.category.pv.import}" />
			<classpath>
				<fileset dir="${de.temp.dir}">
					<include name="*.jar" />
					<exclude name="uml-1.3*.jar" />
				</fileset>
			</classpath>
		</java>

		<delete dir="${base.dir}/tempPVDir" />
		<delete file="${base.dir}/ImportPVDir.zip" />
	</target>

	<target name="Associate_forms" description="Associating forms with catissue">
		<delete quiet="true" includeemptydirs="true">
			<fileset dir="${prop.temp.dir}/catissuecore">
				<include name="**/*" />
			</fileset>
		</delete>

		<unwar src="${caTissue-webapp.dir.dist}/modules/caTissue/lib/catissuecore.war" dest="${prop.temp.dir}/catissuecore" />
		<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/mysql-connector-java-5.0.8-bin.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />
		<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/ojdbc14.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />

		<!-- Inject db-util.properties entry in catissue -> db-util.properties -->
		<replace file="${prop.temp.dir}/catissuecore/WEB-INF/classes/dbutil.properties">
			<replacefilter token="${catissue.hibernate.config.file}" value="${catissue.hibernate.config.file}, DynamicExtensionsHibernate.cfg.xml" />
		</replace>

		<copy file="${caTissue-webapp.dir.dist}/modules/dynamic_extensions/conf/hibernate.cfg.xml" todir="${prop.temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />
		<copy file="${caTissue-webapp.dir.dist}/modules/dynamic_extensions/conf/DynamicExtensionsHibernate.cfg.xml" todir="${prop.temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />

		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
					<include name="*.cfg.xml" />
					<replacefilter token="@@DIALECT@@" value="${mysql.dialect.string}" />
					<replacefilter token="@@DRIVER@@" value="com.mysql.jdbc.Driver" />
					<replacefilter token="@@URL@@" value="jdbc:mysql://${database.server}:${database.port}/${database.name}" />
				</replace>
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
						<include name="*.cfg.xml" />
						<replacefilter token="@@DIALECT@@" value="${oracle.dialect.string}" />
						<replacefilter token="@@DRIVER@@" value="${oracle.driver.string}" />
						<replacefilter token="@@URL@@" value="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" />
					</replace>
				</then>
			</elseif>
			<elseif>
				<equals arg1="mssqlserver" arg2="${database.type}"/>
				<then>
					<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
					<include name="*.cfg.xml" />
					<replacefilter token="@@DIALECT@@" value="${mssqlserver.dialect.string}"/>
						<replacefilter token="@@DRIVER@@" value="${mssqlserver.driver.string}"/>
						<replacefilter token="@@URL@@" value="jdbc:sqlserver://${database.server}:${database.port};databaseName=${database.name};" />
					</replace>
				</then>
			</elseif>
		</if>
		<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
			<include name="*.cfg.xml" />
			<replacefilter token="@@DATABASE_USERNAME@@" value="${database.user}" />
			<replacefilter token="${token.database.password}" value="${database.password}" />
		</replace>
		<java classname="edu.wustl.catissuecore.util.AssociatesForms" fork="true" maxmemory="512m">
			<arg value="${entitiesFormsCSVFile}"/>
			<classpath>
				<pathelement location="${prop.temp.dir}/catissuecore/WEB-INF/classes" />
				<fileset dir="${prop.temp.dir}/catissuecore/WEB-INF/lib">
					<include name="*.jar" />
					<exclude name="uml-1.3.jar" />
				</fileset>
				<fileset dir="${lib.dir}">
						<include name="*.jar" />
				</fileset>
			</classpath>
		</java>
		<delete failonerror="${delete.failonerror}" includeemptydirs="true">
			<fileset dir="${prop.temp.dir}/catissuecore">
				<include name="**/*" />
			</fileset>
		</delete>
	</target>

	<macrodef name="assertforgate" description="check for required properties for deploying gate">
		<sequential>
		<if>
			<equals arg1="" arg2="${caties.mmtx.home}" />
			<then>
				<fail message="The property 'caties.mmtx.home' can not be empty" />
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${jboss.home.dir}" />
			<then>
				<fail message="The property 'jboss.home.dir' can not be empty" />
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${jboss.server.hostname}" />
			<then>
				<fail message="The property 'jboss.server.hostname' can not be empty" />
			</then>
		</if>
		<!--<if>
			<equals arg1="" arg2="${jboss.server.port}" />
			<then>
				<fail message="The property 'jboss.server.port' can not be empty" />
			</then>
		</if>-->
		</sequential>
	</macrodef>
	<target name="upgrade_db_demodel" description="upgrade the db model">
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="upgrade_db_demodel_mysql" />
			</then>
		<elseif>
			<equals arg1="oracle" arg2="${database.type}" />
			<then>
				<antcall target="upgrade_db_demodel_oracle" />
			</then>
		</elseif>
		<else>
			<echo message="DATABASE UPGRADATION FOR DYNAMIC EXTENSIONS FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
		</else>
		</if>
	</target>

	<!--MySQL Database Upgradation -->
	<target name="upgrade_db_demodel_mysql" description="Upgared DE db model for Mysql">
		<echo message="Upgrading MySQL Database for DE model Application ..." />
		<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}" >
			<transaction src="${mysql.sql.dir}/dropdeconstraints.sql" />
			<transaction src="${mysql.sql.dir}/createnewtable.sql" />
			<transaction src="${mysql.sql.dir}/alterqueries.sql" />
			<transaction src="${mysql.sql.dir}/addconstraints.sql" />
			<transaction src="${mysql.sql.dir}/deupgrade_to_v1.2.0.rc1.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>
	<!--Oracle Database Upgradation -->
	<target name="upgrade_db_demodel_oracle" description="Upgared DE db model for Oracle">
		<echo message="Upgrading Oracle Database for DE model Application ..." />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle">
			<transaction src="${oracle.sql.dir}/dropdeconstraints.sql" />
			<transaction src="${oracle.sql.dir}/createnewtable.sql" />
			<transaction src="${oracle.sql.dir}/alterqueries.sql" />
			<transaction src="${oracle.sql.dir}/addconstraints.sql" />
			<transaction src="${oracle.sql.dir}/deupgrade_to_v1.2.0.rc1.sql" />
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" delimiter="/" delimitertype="row" keepformat="yes" rdbms="oracle">
			<transaction src="${oracle.sql.dir}/addsequence.sql" />
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>





	<!--  ShippingTracking - start -->
	<!-- Check user selected deploy.shippingtracking to true and shippingtracking.zip exists
	<target name="st_check_prerequisite"> -->
		<!-- Check shippingtracking.zip file exists or not in base directory.
		<available file="${base.dir}/shippingtracking.zip" property="file.exists" value="false" />
		<if>
			<not>
			   <isset property="file.exists"/>
			</not>
			<then> -->
			   <!-- <fail message="ShippingTracking.zip file not found. It should be in base directory to deploy shippingtracking." />
			   <echo message="ShippingTracking.zip file not found. It should be in base directory to deploy shippingtracking." level="error" />
			</then>
			<else>
			   <echo message="ShippingTracking is ready to use."/>
			</else>
		</if>
	</target>
	-->
	<!-- Integrating shipping tracking application with catissue
	<target name="st_integrate_app" depends="st_check_prerequisite" if="file.exists" >
		<echo message="Integrating shippingtracking app ...." />
		<unzip src="shippingtracking.zip" dest="${prop.temp.dir}/shippingtracking" overwrite="true" />
	-->
		<!-- Inject db specific information to configuration files
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="st_mysql_config" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="st_oracle_config" />
				</then>
			</elseif>
			<elseif>
				<equals arg1="mssqlserver" arg2="${database.type}" />
				<then>
					<antcall target="st_mssqlserver_config" />
				</then>
			</elseif>
		</if>
	 	-->
		<!-- 1) Copy shippingtracking.jar -> copy it to catissue/WEB-INF/Lib
		<copy file="${prop.temp.dir}/shippingtracking/shippingtracking.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" overwrite="true" />
		-->
		<!-- 2) Copy *.properties, st*.cfg.xml, *.jsp, *.css, *.images, st*-struts-config.xml to respective folders
		<copy todir="${prop.temp.dir}/catissuecore/WEB-INF/classes" overwrite="true">
			<fileset dir="${prop.temp.dir}/shippingtracking">
				<include name="ShippingTrackingApplicationResources.properties" />
				<include name="ShippingTrackingHibernate.cfg.xml" />
			</fileset>
		</copy>
		<copy todir="${prop.temp.dir}/catissuecore/WEB-INF" overwrite="true">
			<fileset dir="${prop.temp.dir}/shippingtracking">
				<include name="shippingtracking-struts-config.xml" />
				<include name="ShippingTracking-tiles-defs.xml" />
			</fileset>
		</copy>

		<copy todir="${prop.temp.dir}/catissuecore/css" overwrite="true">
			<fileset dir="${prop.temp.dir}/shippingtracking/css" />
		</copy>
		<copy todir="${prop.temp.dir}/catissuecore/jss" overwrite="true">
			<fileset dir="${prop.temp.dir}/shippingtracking/jss" />
		</copy>
		<copy todir="${prop.temp.dir}/catissuecore/pages" overwrite="true">
			<fileset dir="${prop.temp.dir}/shippingtracking/pages" />
		</copy>
		<copy todir="${prop.temp.dir}/catissuecore/images" overwrite="true">
			<fileset dir="${prop.temp.dir}/shippingtracking/images" />
		</copy>
		 -->
		<!-- 3) Inject st-struts-config.xml entry in catisssue -> web.xml
		<replace file="${prop.temp.dir}/catissuecore/WEB-INF/web.xml">
			<replacefilter token="/WEB-INF/${catissue.struts.config.file}" value="/WEB-INF/${catissue.struts.config.file}, /WEB-INF/shippingtracking-struts-config.xml" />
		</replace>
		-->
		<!-- 4) Inject db-util.properties entry in catissue -> db-util.properties
		<replace file="${prop.temp.dir}/catissuecore/WEB-INF/classes/dbutil.properties">
			<replacefilter token="${catissue.hibernate.config.file}" value="${catissue.hibernate.config.file}, ShippingTrackingHibernate.cfg.xml" />
		</replace>
		-->
		<!-- 5) Inject "/WEB-INF/ShippingTracking-tiles-defs.xml" entry in catisssue -> struts-config.xml
		<replace file="${prop.temp.dir}/catissuecore/WEB-INF/${catissue.struts.config.file}">
			<replacefilter token="/WEB-INF/${catissue.tiles.def.file}" value="/WEB-INF/${catissue.tiles.def.file}, /WEB-INF/ShippingTracking-tiles-defs.xml" />
		</replace>

	</target>
	-->
	<!-- Modify shippingtracking configuration For MySQL
	<target name="st_mysql_config">
		<replace file="${prop.temp.dir}/shippingtracking/ShippingTrackingHibernate.cfg.xml">
			<replacefilter token="${mysql.dialect.string}" value="${mysql.dialect.string}" />
		</replace>
	</target>
	-->

	<!-- Deploying shippingtracking db -->
	<target name="st_deploy_db" description="Deploying shippingtracking db ....">
		<echo message="Deploying shippingtracking db ...." />
	<!--	<unzip src="shippingtracking.zip" dest="${prop.temp.dir}/shippingtracking" overwrite="true" /> -->

		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="st_deploy_db_mysql" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="st_deploy_db_oracle" />
				</then>
			</elseif>
			<elseif>
				<equals arg1="mssqlserver" arg2="${database.type}" />
				<then>
					<antcall target="st_deploy_db_mssqlserver" />
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>

	<!--	<delete failonerror="${delete.failonerror}" dir="${prop.temp.dir}"/> -->
	</target>

	<!-- Deploying shippingtracking db for mysql -->
	<target name="st_deploy_db_mysql" description="Deploying shippingtracking db for mysql">
		<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}" onerror="continue">
			<transaction src="${mysql.sql.dir}/shippingtracking.sql"  />

			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>

	<!-- Deploying shippingtracking db for oracle -->
	<target name="st_deploy_db_oracle" description="Deploying shippingtracking db for oracle">
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle" onerror="continue">
			<transaction src="${oracle.sql.dir}/shippingtracking.sql"/>

			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>

	<!-- Deploying shippingtracking db for mssqlserver -->
	<target name="st_deploy_db_mssqlserver" description="Deploying shippingtracking db for mysqlServer">
		<sql driver="${mssqlserver.driver.string}" url="jdbc:sqlserver://${database.server}:${database.port};databaseName=${database.name};" userid="${database.user}" password="${database.password}" onerror="continue">
			<transaction src="${base.dir}/SQL/MsSqlServer/shippingtracking.sql"/>

			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>
	<!--  ShippingTracking - end -->

	<target name="alter_CA_model_Tables" description="Upgrading Oracle Database for DE model Application ...">
		<echo message="Upgrading Oracle Database for DE model Application ..." />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" onerror="continue" rdbms="oracle">
			<transaction src="${oracle.sql.dir}/modify_annotation_PV.sql" />

			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>

	<!-- ACORN - mssqlserver migration - start -->

	<!--MsSQLServer Database Creation -->
	<target name="deploy_db_mssqlserver" description="Initializing MsSQLServer Database for caTissue Suite v1.1p4. Application...">

		<echo message="Initializing MsSQLServer Database for caTissue Suite v1.1p4. Application..." />

		<replace file="${mssqlserver.sql.dir}/UniqueKey_Constraint.sql">
			<replacefilter token="@@schema@@" value="${database.schemaname}" />
		</replace>

		<sql driver="${mssqlserver.driver.string}" url="jdbc:sqlserver://${database.server}:${database.port};databaseName=${database.name};" userid="${database.user}" password="${database.password}">
			<transaction src="${mssqlserver.sql.dir}/catissuecore.sql" />
			<transaction src="${mssqlserver.sql.dir}/InitDB_CreateTable.sql" />
			<transaction src="${mssqlserver.sql.dir}/Common/initDB_Insert_Common.sql" />
			<transaction src="${mssqlserver.sql.dir}/Common/AlterTable.sql" />
			<transaction src="${mssqlserver.sql.dir}/Common/CDE_DummyData_Common.sql" />
			<transaction src="${mssqlserver.sql.dir}/csm_catissuecore.sql" />
			<transaction src="${mssqlserver.sql.dir}/Common/insert_default_data.sql" />
			<transaction src="${mssqlserver.sql.dir}/Common/indexes.sql" />
			<transaction src="${mssqlserver.sql.dir}/dynamicextension.sql" />
			<transaction src="${mssqlserver.sql.dir}/query/metadata_schema_script.sql" />
			<transaction src="${mssqlserver.sql.dir}/query/caB2B Table Generation Script.sql" />
			<transaction src="${dbupgrade.sql.dir}/MsSqlServer/CAModel.sql"/>
			<transaction src="${mssqlserver.sql.dir}/UniqueKey_Constraint.sql" />

			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>

		<replace file="${mssqlserver.sql.dir}/UniqueKey_Constraint.sql">
			<replacefilter token="${database.schemaname}" value="@@schema@@" />
		</replace>

		<antcall target="unzip_aq_installable" />
		<ant dir="${prop.temp.dir}/AdvanceQuery" inheritAll="false" antfile="queryintegration.xml" target="create_query_tables">
			<property name="database.type" value="${database.type}" />
			<property name="database.driver" value="${oracle.driver.string}" />
			<property name="database.url" value="jdbc:sqlserver://${database.server}:${database.port};databaseName=${database.name};" />
			<property name="database.username" value="${database.user}" />
			<property name="database.password" value="${database.password}" />
			<property name="lib.dir" value="${lib.dir}" />
		</ant>

		<antcall  target="Export_Clinical_diagnosis_mssqlserver"/>
		<antcall target="CAModel_import_data" />
		<antcall target="temp_update_metadata_for_clob_support_mssqlserver" />
		<antcall target="insert_entity_group_metadata_mssqlserver" />
		<antcall target="upgrade_db_demodel_mssqlserver" />
		<antcall target="update_metadata_for_model_changes" >
			 <param name="isUpgrade" value="false"/>
	    </antcall>
		<antcall target="update_metadata_for_CA_model_changes" />

	</target>

	<target name="Export_Clinical_diagnosis_mssqlserver" description="Exporting data of Clinical diagnosis ... for mssqlserver">
		<echo message="Exporting data of Clinical diagnosis ..." />
		<unwar src="${caTissue-webapp.dir.dist}/modules/caTissue/lib/catissuecore.war" dest="${prop.temp.dir}/catissuecore"/>
		<java classname="edu.wustl.catissuecore.util.global.AutomateImportSS" fork="true">
			<classpath refid="temp.classpath" />
			<classpath>
				<pathelement location="${prop.temp.dir}/catissuecore/WEB-INF/classes/"/>
			</classpath>
			<arg value="${database.server}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.user}"/>
			<arg value="${database.password}"/>
			<arg value="${mssqlserver.driver.string}"/>
			<arg value="import"/>
			<arg value="${basedir}/db/Permissible_values/MsSqlServer/dumpFileColumnInfo.txt" />
			<arg value="\\${env.COMPUTERNAME}/db/Permissible_values/" />
		</java>
		<delete failonerror="${delete.failonerror}" dir="${prop.temp.dir}" />
	</target>

	<!--MsSQL server Database Upgradation -->
	<target name="upgrade_db_demodel_mssqlserver" description="MsSQL server Database Upgradation">
		<echo message="Upgrading MsSQLServer Database for DE model Application ..." />
		<sql driver="${mssqlserver.driver.string}" url="jdbc:sqlserver://${database.server}:${database.port};databaseName=${database.name};" userid="${database.user}" password="${database.password}">
			<transaction src="${dbupgrade.sql.dir}/DEDBUpgrade/MsSqlServer/dropdeconstraints.sql" />
			<transaction src="${dbupgrade.sql.dir}/DEDBUpgrade/MsSqlServer/createnewtable.sql" />
			<transaction src="${dbupgrade.sql.dir}/DEDBUpgrade/MsSqlServer/alterqueries.sql" />
			<transaction src="${dbupgrade.sql.dir}/DEDBUpgrade/MsSqlServer/addconstraints.sql" />
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>

	<target name="CAModel_import_data_mssqlserver" description="Importing CA models data for caTISSUE Suite Application to MsSQLSever Database ...">
		<echo message="Importing CA models data for caTISSUE Suite Application to MsSQLSever Database ..." />
		<java classname="edu.wustl.catissuecore.util.global.AutomateImportSS"  fork="true" maxmemory="512m">
			<classpath refid="temp.classpath" />
			<classpath>
				<pathelement location="${prop.temp.dir}/catissuecore/WEB-INF/classes/"/>
			</classpath>
			<arg value="${database.server}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.user}"/>
			<arg value="${database.password}"/>
			<arg value="${mssqlserver.driver.string}"/>
			<arg value="import"/>
			<arg value="${dbupgrade.sql.dir}/Common/MsSqlServer/dumpFileColumnInfo.txt" />
			<arg value="\\${env.COMPUTERNAME}/SQL/DBUpgrade/Common/MsSqlServer/CAModelCSVs/" />
		</java>
	</target>

	<target name="update_metadata_for_model_changes_mssqlserver" description="Updating DE Metadata for model changes (mssqlserver).....">
		<echo message="Updating DE Metadata for model changes (mssqlserver)....." />
		<java classname="edu.wustl.catissuecore.querysuite.metadata.UpdateMetadata"  fork="true" maxmemory="512m">
			<classpath location="${prop.temp.dir}/catissuecore/WEB-INF/classes" />
			<classpath refid="temp.classpath" />
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
			<arg value="${database.server}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.user}"/>
			<arg value="${database.password}"/>
			<arg value="${mssqlserver.driver.string}"/>
			<arg value="${isUpgrade}"/>
			<arg value="${buildVersion}"/>
		</java>
	</target>

	<target name="temp_update_metadata_for_clob_support_mssqlserver" description="Upgrading MsSQLServer Database for supporting query on clob type attributes...">
		<echo message="Upgrading MsSQLServer Database for supporting query on clob type attributes..." />
		<sql driver="${mssqlserver.driver.string}" url="jdbc:sqlserver://${database.server}:${database.port};databaseName=${database.name};" userid="${database.user}" password="${database.password}">
			<transaction src="${mssqlserver.sql.dir}/query/temp_update_metadata.sql" />
			<!-- <transaction>commit;</transaction> -->
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>

	<target name="insert_entity_group_metadata_mssqlserver" description="Inserting entity group metadata for MsSqlServer...">
		<echo message="Inserting entity group metadata for MsSqlServer..." />
		<sql driver="${mssqlserver.driver.string}" url="jdbc:sqlserver://${database.server}:${database.port};databaseName=${database.name};" userid="${database.user}" password="${database.password}">
			<transaction src="${mssqlserver.sql.dir}/query/entity_group_metadata.sql" />
			<!-- <transaction>commit;</transaction> -->
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>

	<target name="firstUser_mssqlserver" description="Inserting first user for mysql">
		<echo message="Encoding Password..."/>
		<unwar src="${caTissue-webapp.dir.dist}/modules/caTissue/lib/catissuecore.war" dest="${prop.temp.dir}/catissuecore"/>
		<copy file="${base.dir}/lib/j2ee.jar" tofile="${prop.temp.dir}/catissuecore/WEB-INF/lib/j2ee.jar"/>
		<java classname="edu.wustl.common.util.global.PasswordManager" fork="false" >
	   	 <classpath refid="temp.classpath" />
			<arg value="${base.dir}/catissuetmp.txt"/>
			<arg value="${first.admin.password}"/>
		</java>

		<property file="${base.dir}/catissuetmp.txt"/>
		<echo>
			Encoded Password ${first.admin.encodedPassword}
		</echo>

		<echo message="Modifying caTissue Suite SQL file for user information..."/>
		<copy file="${mssqlserver.sql.dir}/createUser.sql" todir="${prop.temp.dir}" overwrite="true"/>

		<replace dir="${prop.temp.dir}" propertyfile="install.properties">
			<include name="createUser.sql"/>
			<replacefilter token="@@first.admin.department@@" value="${first.admin.department}"/>
			<replacefilter token="@@first.admin.institution@@" value="${first.admin.institution}"/>
			<replacefilter token="@@first.admin.cancerresearchgroup@@" value="${first.admin.cancerresearchgroup}"/>
			<replacefilter token="@@first.admin.emailAddress@@" value="${first.admin.emailAddress}"/>
			<replacefilter token="@@first.admin.encodedPassword@@" value="${first.admin.encodedPassword}"/>
		</replace>

		<sql driver="${mssqlserver.driver.string}" url="jdbc:sqlserver://${database.server}:${database.port};databaseName=${database.name};" userid="${database.user}" password="${database.password}">
			<transaction src="${prop.temp.dir}/createUser.sql" />
			<!--<transaction>commit;</transaction> -->
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<delete failonerror="${delete.failonerror}" dir="${prop.temp.dir}" />

	</target>

	<!--Modify Configuration For MsSqlServer-->
	<target name="mssqlserver_config" description="Modify Configuration For MsSqlServer">
			<echo message="Modifying caTissue Suite MsSqlServer specific Configuration File..." />
			<replace dir="${prop.temp.dir}/catissuecore-properties" propertyfile="install.properties">
				<include name="upt.hibernate.cfg.xml" />
				<include name="catissuecore.hibernate.cfg.xml" />
				<replacefilter token="@@dialect@@" value="${mssqlserver.dialect.string}" />
			</replace>

			<!-- added for csm orm1.cfg.xml file-->
			<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes" propertyfile="install.properties">
				<include name="orm1.cfg.xml" />
				<replacefilter token="@@dialect@@" value="${mssqlserver.dialect.h3.string}" />
			</replace>

			<!-- Configuring Data Source File-->
			<replace dir="${prop.temp.dir}" propertyfile="install.properties">
				<include name="catissuecore-ds.xml" />
				<include name="login-config.xml" />
				<replacefilter token="@@databaseurl@@" value="jdbc:sqlserver://${database.server}:${database.port};databaseName=${database.name};" />
				<replacefilter token="@@username@@" value="${database.user}" />
				<replacefilter token="@@pasword@@" value="${database.password}" />
				<replacefilter token="@@databasedriver@@" value="${mssqlserver.driver.string}" />
			</replace>


			<replace file="${prop.temp.dir}/catissuecore/WEB-INF/classes/hibernate.cfg.xml">
				<replacefilter token="${mysql.dialect.string}" value="${mssqlserver.dialect.string}" />
			</replace>

			<replace file="${prop.temp.dir}/catissuecore/WEB-INF/classes/DynamicExtensionsHibernate.cfg.xml">
				<replacefilter token="${mysql.dialect.string}" value="${mssqlserver.dialect.string}" />
				<replacefilter token="&lt;!-- My sql settings -->" value="&lt;!-- My sql settings " />
				<replacefilter token="&lt;!-- My sql settings end -->" value="My sql settings end -->" />
			</replace>

			<replace file="${prop.temp.dir}/dynamicExtensionsjar/DynamicExtensionsHibernate.cfg.xml">
				<replacefilter token="${mysql.dialect.string}" value="${mssqlserver.dialect.string}" />
				<replacefilter token="${dynamicextensions.datasource}" value="${catissue.datasource}" />
				<replacefilter token="&lt;!-- My sql settings -->" value="&lt;!-- My sql settings " />
				<replacefilter token="&lt;!-- My sql settings end -->" value="My sql settings end -->" />
			</replace>


		</target>

	<!-- ACORN - mssqlserver migration - end -->
	<macrodef name="show_hide_forms_based_on_CPs" description="set the show_hide_forms_based_on_CPs property">
	<sequential>
		<if>
			<equals arg1="${show.hide.forms.based.on.CPs}" arg2="true" />
			<then>
				<echo message="Value of show_hide_forms_based_on_CPs is set to true" />
				<antcall target="Associate_forms_to_CPs">
					<param name="cpsEntitiesXMLFile" value="${caTissue-webapp.dir.dist}/modules/dynamic_extensions/conf/Show_Hide_Forms.xml"/>
				</antcall>
				<echo message="Associated selected Forms with Cps..." />
			</then>
			<else>
				<echo message="Value of show_hide_forms_based_on_CPs is set to false" />
			</else>
		</if>
		</sequential>
	</macrodef>

	<!-- Associating forms/entities with CPs  - start -->
	<target name="Associate_forms_to_CPs" description="Associating forms/entities with CPs">
		<delete quiet="true" includeemptydirs="true">
			<fileset dir="${prop.temp.dir}/catissuecore">
				<include name="**/*" />
			</fileset>
		</delete>

		<unwar src="${caTissue-webapp.dir.dist}/modules/caTissue/lib/catissuecore.war" dest="${prop.temp.dir}/catissuecore" />
		<copy todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" overwrite="true">
			<fileset dir="${caTissue-webapp.dir.dist}/modules/caTissue/lib/common_lib" />
		</copy>
		<!-- Inject db-util.properties entry in catissue -> db-util.properties -->
		<replace file="${prop.temp.dir}/catissuecore/WEB-INF/classes/dbutil.properties">
			<replacefilter token="${catissue.hibernate.config.file}" value="${catissue.hibernate.config.file}, DynamicExtensionsHibernate.cfg.xml" />
		</replace>

		<copy file="${caTissue-webapp.dir.dist}/modules/dynamic_extensions/conf/hibernate.cfg.xml" todir="${prop.temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />
		<copy file="${caTissue-webapp.dir.dist}/modules/dynamic_extensions/conf/DynamicExtensionsHibernate.cfg.xml" todir="${prop.temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />

		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
				<include name="*.cfg.xml" />
				<replacefilter token="@@DIALECT@@" value="${mysql.dialect.string}" />
				<replacefilter token="@@DRIVER@@" value="com.mysql.jdbc.Driver" />
				<replacefilter token="@@URL@@" value="jdbc:mysql://${database.server}:${database.port}/${database.name}" />
				</replace>
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
					<include name="*.cfg.xml" />
					<replacefilter token="@@DIALECT@@" value="${oracle.dialect.string}" />
						<replacefilter token="@@DRIVER@@" value="${oracle.driver.string}" />
						<replacefilter token="@@URL@@" value="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" />
					</replace>
				</then>
			</elseif>
			<elseif>
				<equals arg1="mssqlserver" arg2="${database.type}" />
				<then>
					<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
					<include name="*.cfg.xml" />
						<replacefilter token="@@DIALECT@@" value="${mssqlserver.dialect.string}"/>
						<replacefilter token="@@DRIVER@@" value="${mssqlserver.driver.string}"/>
						<replacefilter token="@@URL@@" value="jdbc:sqlserver://${database.server}:${database.port};databaseName=${database.name};" />
					</replace>
				</then>
			</elseif>
		</if>
		<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
			<include name="*.cfg.xml" />
			<replacefilter token="@@DATABASE_USERNAME@@" value="${database.user}" />
			<replacefilter token="@@DATABASE_PASSWORD@@" value="${database.password}" />
		</replace>
		<java classname="edu.wustl.catissuecore.util.AssociatesCps" fork="true" maxmemory="512m">
			<arg value="${cpsEntitiesXMLFile}"/>
			<jvmarg value="-server"/>
			<classpath>
				<pathelement location="${prop.temp.dir}/catissuecore/WEB-INF/classes" />
				<fileset dir="${prop.temp.dir}/catissuecore/WEB-INF/lib">
					<include name="*.jar" />
					<exclude name="uml-1.3.jar" />
				</fileset>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</java>
		<delete failonerror="${delete.failonerror}" includeemptydirs="true">
			<fileset dir="${prop.temp.dir}/catissuecore">
				<include name="**/*" />
			</fileset>
		</delete>
	</target>

		<!-- Associating forms/entities with CPs  - end -->

		<!-- Indexing tables for Keyword Search - start-->
	<macrodef name="runKeywordSearchIndexer" description="Indexing tables for Keyword Search">
				<attribute name="mysql.driver" default="com.mysql.jdbc.Driver" />
				<attribute name="tempKeywordSearch" default="${caTissue-webapp.dir.dist}/tempKeywordSearch"/>
				<attribute name="jboss.server.url"/>
			<sequential>
				<echo message="Indexing tables for Keyword Search....." />

				<unwar src="${caTissue-webapp.dir.dist}/modules/caTissue/lib/catissuecore.war" dest="@{tempKeywordSearch}" />
				<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/mysql-connector-java-5.0.8-bin.jar" todir="@{tempKeywordSearch}/WEB-INF/lib" />
				<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/ojdbc14.jar" todir="@{tempKeywordSearch}/WEB-INF/lib" />
				<antcall target="configure_keyword_search" >
					<param name="tempPath" value="@{tempKeywordSearch}/WEB-INF/classes" />
					<param name="mysqlDriver" value="@{mysql.driver}" />
					<param name="jboss.server.url" value="@{jboss.server.url}" />
				</antcall>

				<java classname="TitliIndexer"  fork="true" maxmemory="512m">
						<classpath>
							<pathelement location="@{tempKeywordSearch}/WEB-INF/classes"/>
							<fileset dir="@{tempKeywordSearch}/WEB-INF/lib">
									<include name="**/*.jar"/>
							</fileset>
						</classpath>
				</java>
				<delete dir="@{tempKeywordSearch}"></delete>
			</sequential>
		</macrodef>
	<!-- Indexing tables for Keyword Search - end-->

	<!--Target for validation of database schema name for MsSqlServer-->
	<target name="validate_schema_name" description="Target for validation of database schema name for MsSqlServer">
		<trycatch>
	      	<try>
				<sql driver="${mssqlserver.driver.string}" url="jdbc:sqlserver://${database.server}:${database.port};databaseName=${database.name};" userid="${database.user}" password="${database.password}">
					<transaction>IF NOT EXISTS (SELECT * FROM sys.schemas WHERE name = '${database.schemaname}')
							     RAISERROR('Error is occured while validating schema name', 16, 1);</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
				  			<include name="*.jar" />
						</fileset>
					</classpath>
				</sql>
			</try>
			<catch>
				<fail message="Database schema name validation fails.Please enter a valid database.schemaname property" />
			</catch>
		</trycatch>
	</target>

	<!-- IIS properties configuration -->
	<target name="configure_IIS_properties" description="Configuring IIS properties...">
		<echo message="Configuring IIS properties..." />

		<!-- Check whether JAVA_HOME environment variable is set or not -->
		<if>
			<contains string="${env.JAVA_HOME}" substring="env.JAVA_HOME"/>
			<then>
				<fail message="JAVA_HOME is not set. Please make sure to set JAVA_HOME environment variable to the directory of your local JDK." />
			</then>
		</if>

		<!-- Modify registry file -->
		<pathconvert property="IISSettings.home.registry" dirsep="\\">
			<path path="${basedir}\IISSettings"/>
		</pathconvert>
		<echo>${IISSettings.home.registry}</echo>
		<replace file="${base.dir}/IISSettings/iis_redirect.reg">
			<replacefilter token="@@IISSettings_HOME@@" value="${IISSettings.home.registry}" />
		</replace>

		<!-- Modify property file -->
		<pathconvert property="IISSettings.home">
			<path path="${basedir}\IISSettings"/>
		</pathconvert>
		<echo>${IISSettings.home}</echo>
		<replace file="${base.dir}/IISSettings/worker.properties">
			<replacefilter token="@@IISSettings_HOME@@" value="${IISSettings.home}" />
		</replace>

		<!-- Replace java home -->
		<echo>${env.JAVA_HOME}</echo>
		<replace file="${base.dir}/IISSettings/worker.properties">
			<replacefilter token="@@JAVA_HOME@@" value="${env.JAVA_HOME}" />
		</replace>
	</target>
	<!-- Query Integration targets start -->
	<target name="unzip_aq_installable" depends="aq_check_prerequisite" description="unzip the advance query zip">
		<unzip src="${caTissue-webapp.dir.dist}/modules/query/lib/AdvanceQuery_Installable.zip" dest="${prop.temp.dir}/AdvanceQuery"
		overwrite="true" />
	</target>
	<target name="aq_check_prerequisite" description="Check AdvanceQueryInstallable.zip file exists or not in base directory">
		<!--
			Check AdvanceQueryInstallable.zip file exists or not in base
			directory.
		-->
		<available file="${caTissue-webapp.dir.dist}/modules/query/lib/AdvanceQuery_Installable.zip" property="file.exists" value="false" />
		<if>
			<not>
				<isset property="file.exists" />
			</not>
			<then>
				<echo
					message="AdvanceQuery_Installable.zip file not found. It should be in base directory to deploy Advance Query."
					level="error" />
			</then>
		</if>
	</target>

	<!-- Query Integration targets End -->

	<target name="commondbconfig" description="database configuration">
	<delete failonerror="${delete.failonerror}" quiet="true" includeemptydirs="true">
			<fileset dir="${prop.temp.dir}/catissuecore">
				<include name="**/*" />
			</fileset>
		</delete>
		<unwar src="${caTissue-webapp.dir.dist}/modules/caTissue/lib/catissuecore.war" dest="${prop.temp.dir}/catissuecore" />
		<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/mysql-connector-java-5.0.8-bin.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />
		<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/ojdbc14.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />

		<copy file="${caTissue-webapp.dir.dist}/modules/dynamic_extensions/conf/hibernate.cfg.xml" todir="${prop.temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />
		<copy file="${caTissue-webapp.dir.dist}/modules/dynamic_extensions/conf/DynamicExtensionsHibernate.cfg.xml" todir="${prop.temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
					<include name="*.cfg.xml" />
					<replacefilter token="@@DIALECT@@" value="${mysql.dialect.string}" />
					<replacefilter token="@@DRIVER@@" value="com.mysql.jdbc.Driver" />
					<replacefilter token="@@URL@@" value="jdbc:mysql://${database.server}:${database.port}/${database.name}" />
				</replace>
			</then>

			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
						<include name="*.cfg.xml" />
						<replacefilter token="@@DIALECT@@" value="${oracle.dialect.string}" />
						<replacefilter token="@@DRIVER@@" value="${oracle.driver.string}" />
						<replacefilter token="@@URL@@" value="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" />
					</replace>
				</then>
			</elseif>
			<elseif>
				<equals arg1="mssqlserver" arg2="${database.type}" />
				<then>
					<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
						<include name="*.cfg.xml" />
						<replacefilter token="@@DIALECT@@" value="${mssqlserver.dialect.string}"/>
						<replacefilter token="@@DRIVER@@" value="${mssqlserver.driver.string}"/>
						<replacefilter token="@@URL@@" value="jdbc:sqlserver://${database.server}:${database.port};databaseName=${database.name};" />
					</replace>
				</then>
			</elseif>
		</if>
		<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
			<include name="*.cfg.xml" />
			<replacefilter token="@@DATABASE_USERNAME@@" value="${database.user}" />
			<replacefilter token="${token.database.password}" value="${database.password}" />

		</replace>
	</target>

	<!-- call this task in Feb End release while upgrading Db -->
	<target name="upgrade_metadata_for_constraintproperties" depends="commondbconfig" description="upgrade_metadata_for_constraintproperties">

		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="upgrade_metadata_for_constraintproperties_mysql" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="upgrade_metadata_for_constraintproperties_oracle" />
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
	</target>

	<target name="upgrade_metadata_for_constraintproperties_mysql" description="upgrade_metadata_for_constraintproperties for Mysql">
		<echo message="Updating DE Model changes..." />
		<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}">
			<transaction src="${common.sql.dir}/MySql/upgrade_metadata_cnstrProp.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="**/*.jar" />
				</fileset>
			</classpath>
		</sql>
		<java classname="edu.wustl.catissuecore.querysuite.metadata.UpdateSchemaForConstraintProperties" fork="true">
			<classpath>
				<pathelement location="${prop.temp.dir}/catissuecore/WEB-INF/classes" />
				<fileset dir="${prop.temp.dir}/catissuecore/WEB-INF/lib">
					<include name="*.jar" />
					<exclude name="uml-1.3.jar" />
				</fileset>
				<fileset dir="${lib.dir}">
					<include name="**/*.jar" />
				</fileset>
			</classpath>
		</java>
	</target>

	<target name="upgrade_metadata_for_constraintproperties_oracle" description="upgrade_metadata_for_constraintproperties for oracle">
		<echo message="Updating DE Model changes..." />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" onerror="continue" rdbms="oracle">
			<transaction src="${common.sql.dir}/Oracle/upgrade_metadata_cnstrProp.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="**/*.jar" />
				</fileset>
			</classpath>
		</sql>
		<java classname="edu.wustl.catissuecore.querysuite.metadata.UpdateSchemaForConstraintProperties" fork="true">
			<classpath>
				<pathelement location="${prop.temp.dir}/catissuecore/WEB-INF/classes" />
				<fileset dir="${prop.temp.dir}/catissuecore/WEB-INF/lib">
					<include name="*.jar" />
					<exclude name="uml-1.3.jar" />
				</fileset>
				<fileset dir="${lib.dir}">
					<include name="**/*.jar" />
				</fileset>
			</classpath>
		</java>
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" onerror="continue" delimiter="/" delimitertype="row" keepformat="yes" rdbms="oracle">

			<!--<transaction  src="${dbupgrade.sql.dir}/Oracle/upgrade_cnstrProp_dropColumn.sql"/>-->
			<transaction src="${common.sql.dir}/Oracle/upgrade_cnstrProp_createSeq.sql" />
			<transaction src="${common.sql.dir}/Oracle/upgrade_cnstrProp_resetDESequences.sql" />
			<transaction>commit</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="**/*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>

	<!-- upgrade category entity names from RC4 or from suite v1.1 to suite v1.1p-->
	<target name="upgrade_category_entity_names" description="pgrade category entity names from RC4 or from suite v1.1 to suite v1.1p-">
		<delete failonerror="${delete.failonerror}" quiet="true" includeemptydirs="true">
			<fileset dir="${prop.temp.dir}/catissuecore">
				<include name="**/*" />
			</fileset>
		</delete>
		<unwar src="${caTissue-webapp.dir.dist}/modules/caTissue/lib/catissuecore.war" dest="${prop.temp.dir}/catissuecore" />
		<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/mysql-connector-java-5.0.8-bin.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />
		<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/ojdbc14.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />
		<unzip src="${caTissue-webapp.dir.dist}/modules/dynamic_extensions/lib/dynamicextensions.zip" dest="${prop.temp.dir}/dynamicextensions" overwrite="true" />
		<unjar src="${prop.temp.dir}/dynamicextensions/binaries/DynamicExtensionsInterface/DynamicExtensions.jar" dest="${prop.temp.dir}/catissuecore/WEB-INF/classes" overwrite="true"/>
		<copy file="${prop.temp.dir}/dynamicextensions/binaries/DynamicExtensionsInterface/DynamicExtensions.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" overwrite="true" />
		<copy file="${caTissue-webapp.dir.dist}/modules/dynamic_extensions/conf/hibernate.cfg.xml" todir="${prop.temp.dir}/catissuecore/WEB-INF/classes" overwrite="true"/>
		<copy file="${caTissue-webapp.dir.dist}/modules/dynamic_extensions/conf/DynamicExtensionsHibernate.cfg.xml" todir="${prop.temp.dir}/catissuecore/WEB-INF/classes" overwrite="true"/>

		<!--<echo>Configuring logger ...</echo>
		<antcall target="configure_log4j" />-->
		<if>
			<equals arg1="mysql" arg2="${database.type}"/>
			<then>
				<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
				<include name="*.cfg.xml" />
				<replacefilter token="@@DIALECT@@" value="${mysql.dialect.string}"/>
				<replacefilter token="@@DRIVER@@" value="com.mysql.jdbc.Driver"/>
				<replacefilter token="@@URL@@" value="jdbc:mysql://${database.server}:${database.port}/${database.name}" />
				</replace>
			</then>
		<elseif>
			<equals arg1="oracle" arg2="${database.type}"/>
			<then>
				<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
				<include name="*.cfg.xml" />
				<replacefilter token="@@DIALECT@@" value="${oracle.dialect.string}"/>
				<replacefilter token="@@DRIVER@@" value="${oracle.driver.string}"/>
				<replacefilter token="@@URL@@" value="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" />
				</replace>
			</then>
		</elseif>
		<elseif>
			<equals arg1="mssqlserver" arg2="${database.type}"/>
			<then>
				<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
				<include name="*.cfg.xml" />
				<replacefilter token="@@DIALECT@@" value="${mssqlserver.dialect.string}"/>
				<replacefilter token="@@DRIVER@@" value="${mssqlserver.driver.string}"/>
				<replacefilter token="@@URL@@" value="jdbc:sqlserver://${database.server}:${database.port};databaseName=${database.name};" />
				</replace>
			</then>
		</elseif>
		</if>
		<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
			<include name="*.cfg.xml" />
			<replacefilter token="@@DATABASE_USERNAME@@" value="${database.user}"/>
			<replacefilter token="${token.database.password}" value="${database.password}"/>
		</replace>

		<java classname="edu.common.dynamicextensions.util.UpgradeCategoryEntityName" fork="true" maxmemory="1024M">
			<arg value="${categoryDefinitionFilePath}"/>
				<classpath>
					<pathelement location="${prop.temp.dir}/catissuecore/WEB-INF/classes"/>
		            <fileset dir="${prop.temp.dir}/catissuecore/WEB-INF/lib">
			          	<include name="*.jar"/>
			           		<exclude name="uml-1.3.jar"/>
			         </fileset>
					<fileset dir="${lib.dir}">
							<include name="*.jar" />
					</fileset>
			    </classpath>
		</java>

		<delete failonerror="${delete.failonerror}" includeemptydirs="true">
			<fileset dir="${prop.temp.dir}/catissuecore">
				<include name="**/*" />
			</fileset>
		</delete>
	</target>

	<!-- This target replaces databases properties properties in hibernate cfg file
		based on database configuration in install.properties file.-->
	<target name="replacecfgfiles" description="This target replaces databases properties properties in hibernate cfg file based on database configuration in install.properties file">
		<copy file="${caTissue-webapp.dir.dist}/modules/dynamic_extensions/conf/hibernate.cfg.xml" todir="${prop.temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />
		<copy file="${caTissue-webapp.dir.dist}/modules/dynamic_extensions/conf/DynamicExtensionsHibernate.cfg.xml" todir="${prop.temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
					<include name="*.cfg.xml" />
					<replacefilter token="@@DIALECT@@" value="${mysql.dialect.string}" />
					<replacefilter token="@@DRIVER@@" value="com.mysql.jdbc.Driver" />
					<replacefilter token="@@URL@@" value="jdbc:mysql://${database.server}:${database.port}/${database.name}" />
				</replace>
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
						<include name="*.cfg.xml" />
						<replacefilter token="@@DIALECT@@" value="${oracle.dialect.string}" />
						<replacefilter token="@@DRIVER@@" value="${oracle.driver.string}" />
						<replacefilter token="@@URL@@" value="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" />
					</replace>
				</then>
			</elseif>
		</if>
		<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
			<include name="*.cfg.xml" />
			<replacefilter token="@@DATABASE_USERNAME@@" value="${database.user}" />
			<replacefilter token="${token.database.password}" value="${database.password}" />
		</replace>
	</target>

	<!-- This target replaces proper application dao properties file in ApplicationDAOProperties.xml
		based on database configuration in install.properties file.-->
	<target name="replace_app_dao_prop_file" description="This target replaces proper application dao properties file in ApplicationDAOProperties.xml based on database configuration in install.properties file">
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<replace file="${prop.temp.dir}/catissuecore/WEB-INF/classes/ApplicationDAOProperties.xml">
					<replacefilter token="${oracle.dao.prop.filename}" value="${mysql.dao.prop.filename}" />
				</replace>
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<replace file="${prop.temp.dir}/catissuecore/WEB-INF/classes/ApplicationDAOProperties.xml">
						<replacefilter token="${mysql.dao.prop.filename}" value="${oracle.dao.prop.filename}" />
					</replace>
				</then>
			</elseif>
		</if>
	</target>


	<target name="update_metadata_for_tagged_values" depends="commondbconfig" description="update metadata for tagged values">
		<echo message="Updating Tagged Values....." />
			<java classname="edu.wustl.catissuecore.querysuite.metadata.UpdateMetadataTagPath" fork="true" maxmemory="1024M" failonerror="true">
				<arg value="${caTissue-webapp.dir.dist}/modules/caTissue/conf/taggedvalues.xml" />
				<classpath location="${prop.temp.dir}/catissuecore/WEB-INF/classes" />
				<classpath refid="temp.classpath" />
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="**/*.jar" />
						</fileset>
						<fileset dir="${prop.temp.dir}/catissuecore/WEB-INF/lib">
							<include name="*.jar" />
						</fileset>
				</classpath>
			</java>
		<delete failonerror="${delete.failonerror}" dir="${prop.temp.dir}" />
	</target>

	<target name="update_metaPhone_data_for_participant" description="update metaPhone data for participant">
				<unwar src="${caTissue-webapp.dir.dist}/modules/caTissue/lib/catissuecore.war" dest="${prop.temp.dir}/catissuecore"/>
				<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/mysql-connector-java-5.0.8-bin.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />
				<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/ojdbc14.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />
		 	    <delete failonerror="${delete.failonerror}" file="${prop.temp.dir}/catissuecore/WEB-INF/lib/mmtxProject.jar" />
				<if>
					<equals arg1="mysql" arg2="${database.type}" />
					<then>
						<antcall target="update_metaPhoneData_for_participant_mysql" />
					</then>
					<elseif>
						<equals arg1="oracle" arg2="${database.type}" />
						<then>
							<antcall target="update_metaPhoneData_for_participant_oracle" />
						</then>
					</elseif>
					<else>
						<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
					</else>
				</if>
				<delete failonerror="${delete.failonerror}" dir="${prop.temp.dir}" />
		</target>

   <target name="update_metaPhoneData_for_participant_mysql" description="Updating metaPhone information for participant last name (mysql).....">

		<echo message="Updating metaPhone information for participant last name (mysql)....." />
		<java classname="UpdateParticipantMetaPhoneInfo"  fork="true" maxmemory="512m">
			<classpath location="${prop.temp.dir}/catissuecore/WEB-INF/classes" />
			<classpath refid="temp.classpath" />
 			<arg value="${database.server}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.user}"/>
			<arg value="${database.password}"/>
			<arg value="${mysql.driver.string}"/>
		</java>
  </target>


	<target name="update_metaPhoneData_for_participant_oracle" description="Updating metaPhone information for participant last name (oracle).....">

		<echo message="Updating metaPhone information for participant last name (oracle)....." />
		<java classname="UpdateParticipantMetaPhoneInfo"  fork="true" maxmemory="512m">
			<classpath location="${prop.temp.dir}/catissuecore/WEB-INF/classes" />
			<classpath refid="temp.classpath" />
			<arg value="${database.server}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.user}"/>
			<arg value="${database.password}"/>
			<arg value="${oracle.driver.string}"/>
		</java>
	</target>

	<target name="replaceQuerycfgfile" description="Replacing query configuration files">
		<copy file="${caTissue-webapp.dir.dist}/modules/dynamic_extensions/conf/QueryHibernate.cfg.xml" todir="${prop.temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
					<include name="*.cfg.xml" />
					<replacefilter token="@@DIALECT@@" value="${mysql.dialect.string}" />
					<replacefilter token="@@DRIVER@@" value="com.mysql.jdbc.Driver" />
				</replace>
			<var name="databaseurl" value="jdbc:mysql://"/>
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
						<include name="*.cfg.xml" />
						<replacefilter token="@@DIALECT@@" value="${oracle.dialect.string}" />
						<replacefilter token="@@DRIVER@@" value="${oracle.driver.string}" />
					</replace>
					<var name="databaseurl" value="jdbc:oracle:thin:@" />
				</then>
			</elseif>
			</if>
			<echo message="Database url is  ${databaseurl}......" />
		<!--	<if>
				<equals arg1="true" arg2="${idp.enabled}" />
			<then>
				<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
				<include name="*.cfg.xml" />
					<replacefilter token="@@URL@@" value="${databaseurl}${csm.database.host}:${csm.database.port}:${csm.database.name}" />
					<replacefilter token="@@DATABASE_USERNAME@@" value="${csm.database.username}" />
					<replacefilter token="@@DATABASE_PASSWORD@@" value="${csm.database.password}" />
			</replace>
			</then>
			<else> -->
				<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
					<include name="*.cfg.xml" />
					<replacefilter token="@@URL@@" value="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" />
					<replacefilter token="@@DATABASE_USERNAME@@" value="${database.user}" />
					<replacefilter token="@@DATABASE_PASSWORD@@" value="${database.password}" />
				</replace>
		<!--	</else>
			</if> -->
	</target>
	<target name="upgrade_saved_queries" description="Upgrading saved queries....">
          <echo message="Upgrading saved queries...."/>
          <unwar src="${caTissue-webapp.dir.dist}/modules/caTissue/lib/catissuecore.war" dest="${prop.temp.dir}/catissuecore"/>
		  <copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/mysql-connector-java-5.0.8-bin.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />
		  <copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/ojdbc14.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />
          <copy file="${caTissue-webapp.dir.dist}/modules/caTissue/conf/catissuecore-properties/ApplicationSecurityConfig.xml" todir="${prop.temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />
          <antcall target="replacecfgfiles" />
		  <antcall target="replaceQuerycfgfile" />
          <replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
                <include name="ApplicationSecurityConfig.xml" />
                <replacefilter token="@@hibernate-config-file@@" value="${prop.temp.dir}/catissuecore/WEB-INF/classes/QueryHibernate.cfg.xml" />
          </replace>
          <java classname="edu.wustl.query.upgrade.UpgradeSavedQueries" fork="true" maxmemory="1024M">
                <classpath location="${prop.temp.dir}/catissuecore/WEB-INF/classes" />
                <classpath refid="temp.classpath" />
                <classpath>
                      <fileset dir="${lib.dir}">
                            <include name="*.jar" />
                      </fileset>
                </classpath>
                <arg value="${prop.temp.dir}/catissuecore/WEB-INF/classes/ApplicationSecurityConfig.xml"/>
          		<arg value="${saved.query.owner}"/>
          </java>
		<delete failonerror="${delete.failonerror}" dir="${prop.temp.dir}" />
    </target>

	<macrodef name="add_bulk_operation_template" description="This macro adds the bulk operation XML and CSV template in the database">
			<attribute name="operationName"/>
			<attribute name="dropdownName"/>
			<attribute name="csvFile"/>
			<attribute name="xmlFile"/>
			<attribute name="caTissue-webapp.dir.dist"/>
			<sequential>
				<copy file="@{caTissue-webapp.dir.dist}/modules/bulk_operations/conf/log4j.properties" todir="${base.dir}/BulkOperations/conf" overwrite="true" />
				<echo message="...................................................................................." />
				<java classname="edu.wustl.bulkoperator.templateImport.ImportBulkOperationTemplate"
								fork="true" maxmemory="1024m">
							<arg value="@{operationName}" />
							<arg value="@{dropdownName}" />
							<arg value="@{csvFile}" />
							<arg value="@{xmlFile}" />
							<classpath>
								<fileset dir="@{caTissue-webapp.dir.dist}/modules/bulk_operations/lib/"/>
								<fileset dir="@{caTissue-webapp.dir.dist}/modules/caTissue/lib">
									<include name="**/*.jar" />
									<exclude name="AdvanceQuery*.jar" />
								</fileset>
							</classpath>
							<sysproperty key="config.dir" value="modules/bulk_operations/conf" />
				</java>
			</sequential>
		</macrodef>

		<macrodef name="runBulkOperation" description="this macro runs the bulk operation module through API client">
			<attribute name="operationName"/>
			<attribute name="csvFile"/>
			<attribute name="url"/>
			<attribute name="applicationUserName"/>
			<attribute name="applicationUserPassword"/>
			<attribute name="templateFile"/>
			<attribute name="keyStoreLocation"/>
			<attribute name="bulkArtifactsLocation"/>
			<attribute name="caTissue-webapp.dir.dist"/>
			<sequential>
				<copy file="@{caTissue-webapp.dir.dist}/modules/bulk_operations/conf/log4j.properties" todir="${base.dir}/BulkOperations/conf" overwrite="true" />
				<echo message="...................................................................................." />
				<echo message="Starting to run Bulk Operation... " />
						<java classname="edu.wustl.bulkoperator.client.BulkOperationCommand"
								fork="true" maxmemory="1024m">
							<arg value="@{operationName}" />
							<arg value="@{csvFile}" />
							<arg value="@{url}" />
							<arg value="@{applicationUserName}" />
							<arg value="@{applicationUserPassword}" />
							<arg value="@{templateFile}"/>
							<arg value="@{keyStoreLocation}" />
							<arg value="@{bulkArtifactsLocation}" />
							<classpath>
								<fileset dir="@{caTissue-webapp.dir.dist}/modules/bulk_operations/lib/"/>
								<fileset dir="@{caTissue-webapp.dir.dist}/modules/caTissue/lib">
									<include name="*.jar" />
									<exclude name="AdvanceQuery*.jar" />
								</fileset>
							</classpath>
							<sysproperty key="config.dir" value="modules/bulk_operations/conf" />
						</java>
						<echo message="...................................................................................." />
						<delete dir="@{caTissue-webapp.dir.dist}/BulkOperations" />
						<move todir="@{caTissue-webapp.dir.dist}/modules/bulk_operations/log" overwrite="true">
							<fileset dir="${caTissue-webapp.dir.dist}">
								<include name="bulkoperator*.log*" />
							</fileset>
						</move>
			</sequential>
		</macrodef>

	<macrodef name="deployGATE" description="Deploy GATE">
		<attribute name="properties.file"/>
		<attribute name="jboss.home.bda"/>
		<attribute name="jboss.server.url"/>
		<sequential>
			<assertforgate />
		<property name="jboss.server.host.jboss.server.port" value="${jboss.server.hostname}:${jboss.server.port}" />
		<unzip src="${caTissue-webapp.dir.dist}/modules/caTIES/lib/gate.zip" dest="@{jboss.server.url}/deploy/gate.war" />
		<if>
			<equals arg1="" arg2="${jboss.server.port}" />
			<then>
				<var name="jboss.server.host.jboss.server.port" unset="true"/>
				<property name="jboss.server.host.jboss.server.port" value="${jboss.server.hostname}" />
			</then>
		</if>
		<if>
			<equals arg1="${jboss.container.secure}" arg2="yes" />
			<then>
				<replace file="@{jboss.server.url}/deploy/gate.war/gate_3_1/application/plugins/caTIES/creole.xml">
					<replacefilter token="@@@HOST:PORT@@@" value="https://${jboss.server.host.jboss.server.port}" />
					<replacefilter token="@@@MMTX_HOME@@@" value="${caties.mmtx.home}" />
				</replace>
			</then>
			<else>
				<replace file="@{jboss.server.url}/deploy/gate.war/gate_3_1/application/plugins/caTIES/creole.xml">
					<replacefilter token="@@@HOST:PORT@@@" value="http://${jboss.server.host.jboss.server.port}" />
					<replacefilter token="@@@MMTX_HOME@@@" value="${caties.mmtx.home}" />
				</replace>
			</else>
		</if>
		</sequential>
	</macrodef>

	<target name="insertPaths">
			<antcall target="unzip_aq_installable" />
			<property name="tempInsertPaths" value="${caTissue-webapp.dir.dist}/tempInsertPaths"></property>
			<unwar src="${caTissue-webapp.dir.dist}/modules/caTissue/lib/catissuecore.war" dest="${tempInsertPaths}" />
			<copy todir="${tempInsertPaths}/WEB-INF/lib" overwrite="true">
				<fileset dir="${caTissue-webapp.dir.dist}/modules/caTissue/lib/common_lib" />
			</copy>
			<antcall target="replacecfgfilesForInsertPaths"/>
			<ant dir="${prop.temp.dir}/AdvanceQuery" inheritAll="false" antfile="queryintegration.xml" target="insertPaths">
				<property name="parent.base.dir" value="${caTissue-webapp.dir.dist}/modules/query/conf" />
				<property name="deploy.temp.dir" value="${caTissue-webapp.dir.dist}" />
				<property name="war.dir" value="tempInsertPaths" />
				<property name="lib.dir" value="${caTissue-webapp.dir.dist}/modules/caTissue/lib" />
				<property name="property.file" value="${catissue.deploy.config.file}" />
			</ant>
			<delete dir="${tempInsertPaths}" quiet="true"/>
		</target>

	<target name="replacecfgfilesForInsertPaths" description="This target replaces databases properties properties in hibernate cfg file based on database configuration in install.properties file">
			<copy file="${caTissue-webapp.dir.dist}/modules/dynamic_extensions/conf/hibernate.cfg.xml" todir="${tempInsertPaths}/WEB-INF/classes" overwrite="true" />
			<copy file="${caTissue-webapp.dir.dist}/modules/dynamic_extensions/conf/DynamicExtensionsHibernate.cfg.xml" todir="${tempInsertPaths}/WEB-INF/classes" overwrite="true" />
			<if>
				<equals arg1="mysql" arg2="${database.type}" />
				<then>
					<replace dir="${tempInsertPaths}/WEB-INF/classes">
						<include name="*.cfg.xml" />
						<replacefilter token="@@DIALECT@@" value="${mysql.dialect.string}" />
						<replacefilter token="@@DRIVER@@" value="com.mysql.jdbc.Driver" />
						<replacefilter token="@@URL@@" value="jdbc:mysql://${database.server}:${database.port}/${database.name}" />
					</replace>
				</then>
				<elseif>
					<equals arg1="oracle" arg2="${database.type}" />
					<then>
						<replace dir="${tempInsertPaths}/WEB-INF/classes">
							<include name="*.cfg.xml" />
							<replacefilter token="@@DIALECT@@" value="${oracle.dialect.string}" />
							<replacefilter token="@@DRIVER@@" value="${oracle.driver.string}" />
							<replacefilter token="@@URL@@" value="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" />
						</replace>
					</then>
				</elseif>
			</if>
			<replace dir="${tempInsertPaths}/WEB-INF/classes">
				<include name="*.cfg.xml" />
				<replacefilter token="@@DATABASE_USERNAME@@" value="${database.user}" />
				<replacefilter token="${token.database.password}" value="${database.password}" />
			</replace>
		</target>

	<target name="upgrade_db_from_p5_to_p5.1" description="Target for Database Upgrade from caTissue p5 to p5.1">
			<echo message="Upgrading Database v1.1p5 to v1.1p5.1" />
		    <if>
				<equals arg1="mysql" arg2="${database.type}" />
				<then>
					<antcall target="upgrade_mysql_from_v1.1p5_to_v1.1p5.1" />
				</then>
				<elseif>
					<equals arg1="oracle" arg2="${database.type}" />
					<then>
						<antcall target="upgrade_oracle_from_v1.1p5_to_v1.1p5.1" />
					</then>
				</elseif>
				<else>
					<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
				</else>
			</if>
		</target>

	<!-- Upgrading from Suite1.1 p5 to p5.1 - MySQL -->
		<target name="upgrade_mysql_from_v1.1p5_to_v1.1p5.1" description="Upgrading from Suite1.1 p5 to p5.1 - MySQL">
			<echo message="Upgrading MySQL Database." />
			<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}" >
				<transaction src="${dbupgrade.sql.dir}/MySql/DBUpgrade_v1.1p5_to_v1.1p5.1.sql" />
				<transaction>commit;</transaction>
				<classpath>
					<fileset dir="${lib.dir}">
						<include name="*.jar" />
					</fileset>
				</classpath>
			</sql>

			<echo message="Upgrading MSSQL Metadata from p5 to p5.1" />
			<antcall target="update_metadata_for_model_changes_mysql_post_P5" />

		</target>

	<target name="upgrade_oracle_from_v1.1p5_to_v1.1p5.1" description=" Upgrading Oracle Database. Upgrading from Suite1.1 p5 to p5.1 - Oracle">
			<echo message="Upgrading Oracle Database p5 to p5.1" />
			<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle">
				<transaction src="${dbupgrade.sql.dir}/Oracle/DBUpgrade_v1.1p5_to_v1.1p5.1.sql" />
				<transaction>commit;</transaction>
				<classpath>
					<fileset dir="${lib.dir}">
						<include name="*.jar" />
					</fileset>
				</classpath>
			</sql>
			<echo message="Upgrading Oracle Metadata from p5 to p5.1" />
		    <antcall target="update_metadata_for_model_changes_oracle_post_P5" />
	   </target>

		<target name="upgrade_query_metadata_for_1.2" description="Upgrading database for query metadata">
			<echo message="Upgrading Database" />
			<if>
				<equals arg1="mysql" arg2="${database.type}" />
				<then>
					<antcall target="upgrade_query_metadata_for_1.2_mysql" />
				</then>
				<elseif>
					<equals arg1="oracle" arg2="${database.type}" />
					<then>
						<antcall target="upgrade_query_metadata_for_1.2_oracle" />
					</then>
				</elseif>
				<else>
					<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
				</else>
			</if>
		</target>

		<target name="upgrade_query_metadata_for_1.2_mysql" description="Upgrading MySQL Metadata">
			<echo message="Upgrading MySQL Database." />
			<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}" >
				<transaction src="${common.sql.dir}/MySql/DBUpgrade_query_metadata.sql" />
				<transaction>commit;</transaction>
				<classpath>
					<fileset dir="${lib.dir}">
						<include name="*.jar" />
					</fileset>
				</classpath>
			</sql>
			<echo message="Upgrading MSSQL Metadata" />
		</target>

		<target name="upgrade_query_metadata_for_1.2_oracle" description="Upgrading Oracle metadata">
			<echo message="Upgrading Oracle Database."/>
			<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle" delimiter="/" delimitertype="row">
				<transaction src="${common.sql.dir}/Oracle/UpdateMetadata.sql" />
				<classpath>
					<fileset dir="${lib.dir}">
						<include name="*.jar" />
					</fileset>
				</classpath>
			</sql>
			<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle">
				<transaction src="${common.sql.dir}/Oracle/DBUpgrade_query_metadata.sql" />
				<transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
			</sql>
			<echo message="Upgrading Oracle Metadata" />
		</target>

	<target name="upgrade_db_for_1.2" description="Upgrading database for all changes required for v1.2">
				<echo message="Upgrading Database" />
				<if>
					<equals arg1="mysql" arg2="${database.type}" />
					<then>
						<antcall target="upgrade_db_for_v1.2_mysql" />
					</then>
					<elseif>
						<equals arg1="oracle" arg2="${database.type}" />
						<then>
							<antcall target="upgrade_db_for_v1.2_oracle" />
						</then>
					</elseif>
					<else>
						<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
					</else>
				</if>
			</target>

			<target name="upgrade_db_for_v1.2_mysql" description="Upgrading mysql database for all changes required for v1.2 ">
				<echo message="Upgrading MySQL Database." />
				<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}" >
					<transaction src="${dbupgrade.sql.dir}/MySql/UpgradeDB_To_v1.2.sql" />
					<transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
				</sql>
				<echo message="Upgrading mysql database for all changes required for v1.2" />
			</target>

			<target name="upgrade_db_for_v1.2_oracle" description="Upgrading oracle database for all changes required for v1.2">
				<echo message="Upgrading Oracle Database."/>
				<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle">
					<transaction src="${dbupgrade.sql.dir}/Oracle/UpgradeDB_To_v1.2.sql" />
					<transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
				</sql>
				<echo message="Upgrading oracle database for all changes required for v1.2" />
			</target>

		<target name="upgrade_db_from_v1.1_to_v1.2" description="Target for Application and Database Upgrade from caTissue v1.1 to v1.2">
			<echo message="Upgrading Database v1.1 to v1.2" />
			<antcall target="upgrade_db_from_v1.1_to_p4" />
			<antcall target="upgrade_db_from_p4_to_p5" />
			<antcall target="upgrade_db_from_p5_to_p5.1" />
			<antcall target="upgrade_de_from_v1.1_to_1.2"/>
			<antcall target="upgrade_query_metadata_for_1.2"/>
			<antcall target="upgrade_db_for_1.2"/>
			<antcall target="insertPaths"/>
			<!--<antcall target="upgrade_csm_from_3.2_to_4.2"/>-->
		</target>

	<!-- Target to upgrade database from v1.2 to v2.0-->
		<target name="upgrade_db_from_v1.2_to_v2.0" description="Target for Application and Database Upgrade from caTissue v1.2 to v2.0">
			<antcall target="upgrade_app_db_from_v1.2_to_v2.0" />
			<antcall target="upgrade_csm_from_3.2_to_4.2"/>
			<antcall target="upgrade_ccts_integration"/>
			<antcall target="upgrade_ctrp_integration"/>
			<antcall target="install_or_upgrade_gsid_integration"/>
		</target>

	<target name="upgrade_app_db_from_v1.2_to_v2.0" description="Target for Application and Database Upgrade from caTissue v1.2 to v2.0">
		<echo message="Upgrading Database v1.2 to v2.0" />
		   <if>
				<equals arg1="mysql" arg2="${database.type}" />
				<then>
					<antcall target="upgrade_mysql_db_from_v1.2_to_v2.0" />
				</then>
				<elseif>
					<equals arg1="oracle" arg2="${database.type}" />
					<then>
						<antcall target="upgrade_oracle_db_from_v1.2_to_v2.0" />
					</then>
				</elseif>
				<else>
					<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
				</else>
			</if>
	</target>


		<target name="upgrade_mysql_db_from_v1.2_to_v2.0" description="Target for Database Upgrade from caTissue v1.2 to v2.0">
			<echo message="Upgrading MySQL Database." />
			<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}" delimiter="/" delimitertype="row" rdbms="mysql"  >
				<transaction src="${dbupgrade.sql.dir}/MySql/DBUpgrade_v1.2_to_v2.0.sql" />
				<transaction>commit;</transaction>
				<classpath>
					<fileset dir="${lib.dir}">
						<include name="*.jar" />
					</fileset>
				</classpath>
			</sql>
		</target>
	
	<target name="migrate_events_mysql" description="Target for migrating events from static to DE">
		<echo message="Migrating events.." />
		<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}" delimiter="//" delimitertype="row"  keepformat="yes" rdbms="mysql">
			<transaction src="${dbupgrade.sql.dir}/MySql/functions/query3col.sql" />
			<transaction src="${dbupgrade.sql.dir}/MySql/functions/queryfor_sin.sql" />
			<transaction src="${dbupgrade.sql.dir}/MySql/functions/QueryForm.sql" />
			<transaction src="${dbupgrade.sql.dir}/MySql/functions/queryformation_mole.sql" />
			<transaction src="${dbupgrade.sql.dir}/MySql/functions/queryformation_tis.sql" />
			
			<transaction src="${dbupgrade.sql.dir}/MySql/procedures/cellSpecimenEvent.sql" />
			<transaction src="${dbupgrade.sql.dir}/MySql/procedures/collectionEvent.sql" />
			<transaction src="${dbupgrade.sql.dir}/MySql/procedures/embeddedEvent.sql" />
			<transaction src="${dbupgrade.sql.dir}/MySql/procedures/fixedEvent.sql" />
			<transaction src="${dbupgrade.sql.dir}/MySql/procedures/fluidSpecimenEvent.sql" />
			<transaction src="${dbupgrade.sql.dir}/MySql/procedures/frozenEvent.sql" />
			<transaction src="${dbupgrade.sql.dir}/MySql/procedures/checkinCheckoutEvent.sql" />					
			<transaction src="${dbupgrade.sql.dir}/MySql/procedures/molecularSpecimenEvent.sql" />
			<transaction src="${dbupgrade.sql.dir}/MySql/procedures/procedureEvent.sql" />
			<transaction src="${dbupgrade.sql.dir}/MySql/procedures/receivedEvent.sql" />
			<transaction src="${dbupgrade.sql.dir}/MySql/procedures/spunEvent.sql" />
			<transaction src="${dbupgrade.sql.dir}/MySql/procedures/thawEvent.sql" />
			<transaction src="${dbupgrade.sql.dir}/MySql/procedures/tissueSpecimenEvent.sql" />
			
			<transaction src="${dbupgrade.sql.dir}/MySql/procedures/callsToProcedures.sql" />	
			<transaction>call caller();</transaction>
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>
	
	<target name="migrate_events_oracle" description="Target for migrating events from static to DE">
			<echo message="Migrating events.." />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}"  rdbms="oracle" >
				<transaction src="${dbupgrade.sql.dir}/Oracle/functions/query3col.sql" />
				<transaction src="${dbupgrade.sql.dir}/Oracle/functions/queryfor_sin.sql" />
				<transaction src="${dbupgrade.sql.dir}/Oracle/functions/QueryForm.sql" />
				<transaction src="${dbupgrade.sql.dir}/Oracle/functions/queryformation_mole.sql" />
				<transaction src="${dbupgrade.sql.dir}/Oracle/functions/queryformation_tis.sql" />
				
				<transaction src="${dbupgrade.sql.dir}/Oracle/procedures/cellSpecimenEvent.sql" />
				<transaction src="${dbupgrade.sql.dir}/Oracle/procedures/collectionEvent.sql" />
				<transaction src="${dbupgrade.sql.dir}/Oracle/procedures/embeddedEvent.sql" />
				<transaction src="${dbupgrade.sql.dir}/Oracle/procedures/fixedEvent.sql" />
				<transaction src="${dbupgrade.sql.dir}/Oracle/procedures/fluidSpecimenEvent.sql" />
				<transaction src="${dbupgrade.sql.dir}/Oracle/procedures/frozenEvent.sql" />
				<transaction src="${dbupgrade.sql.dir}/Oracle/procedures/checkinCheckoutEvent.sql" />					
				<transaction src="${dbupgrade.sql.dir}/Oracle/procedures/molecularSpecimenEvent.sql" />
				<transaction src="${dbupgrade.sql.dir}/Oracle/procedures/procedureEvent.sql" />
				<transaction src="${dbupgrade.sql.dir}/Oracle/procedures/receivedEvent.sql" />
				<transaction src="${dbupgrade.sql.dir}/Oracle/procedures/spunEvent.sql" />
				<transaction src="${dbupgrade.sql.dir}/Oracle/procedures/thawEvent.sql" />
				<transaction src="${dbupgrade.sql.dir}/Oracle/procedures/tissueSpecimenEvent.sql" />
				
				<transaction src="${dbupgrade.sql.dir}/Oracle/procedures/callsToProcedures.sql" />	
				<transaction>call caller();</transaction>
				<transaction>commit;</transaction>
				<classpath>
					<fileset dir="${lib.dir}">
						<include name="*.jar" />
					</fileset>
				</classpath>
			</sql>
		</target>

	<target name="upgrade_oracle_db_from_v1.2_to_v2.0" description="Upgrading Oracle Database from v1.2 to v2.0">
			<echo message="Upgrading Oracle Database." />
				<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" delimiter="/" delimitertype="row" rdbms="oracle" >
						<transaction src="${dbupgrade.sql.dir}/Oracle/DBUpgrade_v1.2_to_v2.0.sql" />
					    <transaction>commit</transaction>
						<classpath>
							<fileset dir="${lib.dir}">
								<include name="*.jar" />
							</fileset>
						</classpath>
				</sql>
	</target>

	<target name="upgrade_spp_related_static_metadata" description="Target for Database Upgrade from caTissue v1.2 to v2.0">
		<echo message="Upgrading Database." />
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}" >
					<transaction src="${common.sql.dir}/spp_metadata.sql" />
					<transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
				</sql>
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}">
						<transaction src="${common.sql.dir}/spp_metadata.sql" />
						<transaction>commit;</transaction>
						<classpath>
							<fileset dir="${lib.dir}">
								<include name="*.jar" />
							</fileset>
						</classpath>
					</sql>
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
</target>


		<target name="upgrade_de_from_v1.1_to_1.2" description="Target for upgrading the database for DE from v1.1 to v1.2">
			<antcall target="upgrade_db_from_DE_1.4.0.1_to_DE_1.4.0.2" />
			<antcall target="upgrade_db_from_DE_1.4.0_to_DE_1.4.2"/>
			<antcall target="upgrade_db_maincontainer_data_fixes"/>
		</target>


	<target name="integrate_cas" description="Target to integrate cas with the application">
		<echo message="Integrating CAS with the application...." />
			<replace file="${prop.temp.dir}/catissuecore/WEB-INF/web.xml">
				<replacefilter token="@@cas-server-url-login@@" value="${cas.url}" />
			</replace>
			<replace file="${prop.temp.dir}/catissuecore/WEB-INF/web.xml">
				<replacefilter token="@@cas-server-url-validateUrl@@" value="${cas.url}" />
			</replace>
			<replace file="${prop.temp.dir}/catissuecore/WEB-INF/web.xml">
				<replacefilter token="@@catissue-cas-login-serverName@@" value="${jboss.server.host.port}" />
			</replace>
		
					<replace file="${prop.temp.dir}/catissuecore/WEB-INF/web.xml">
							<replacetoken>@@CASFilter@@</replacetoken>
										<replacevalue><![CDATA[
											<filter-mapping>
													<filter-name>CASFilter</filter-name>
													<url-pattern>*.do</url-pattern>
												</filter-mapping>
												]]></replacevalue>
									</replace>
		
			
				
	</target>

	<!--Target call for both fresh deployment of caTissue-->
	<target name="deploy_app" depends="deploy_app_catissue">
			<if>
				<equals arg1="mysql" arg2="${csm.database.type}" />
			<then>
					<antcall target="mysql_csm_config_with_idp"/>
			</then>
			<elseif>
					<equals arg1="oracle" arg2="${csm.database.type}" />
			<then>
					<antcall target="oracle_csm_config_with_idp"/>
			</then>
			</elseif>
			</if>
		 	<antcall target="jboss_configuration" />
		</target>


		 <target name="mysql_csm_config_with_idp" >
		  	<copy file="${caTissue-webapp.dir.dist}/modules/identity_provider_support/conf/idp_catissuecore-ds.xml" tofile="${prop.temp.dir}/catissuecore-ds.xml" overwrite="true"/>
			<copy file="${caTissue-webapp.dir.dist}/modules/identity_provider_support/conf/idp_login-config.xml" tofile="${prop.temp.dir}/login-config.xml" overwrite="true"/>
			<copy file="${caTissue-webapp.dir.dist}/modules/identity_provider_support/conf/idp_upt.hibernate.cfg.xml" tofile="${prop.temp.dir}/catissuecore-properties/upt.hibernate.cfg.xml" overwrite="true"/>
			<copy file="${caTissue-webapp.dir.dist}/modules/identity_provider_support/conf/idp_catissuecore.hibernate.cfg.xml" tofile="${prop.temp.dir}/catissuecore-properties/catissuecore.hibernate.cfg.xml" overwrite="true"/>
			<replace dir="${prop.temp.dir}" propertyfile="${catissue.deploy.config.file}">
				<include name="catissuecore-ds.xml" />
				<include name="login-config.xml" />
				<replacefilter token="@@CSMdatabaseurl@@" value="jdbc:mysql://${csm.database.host}:${csm.database.port}/${csm.database.name}"/>

				<replacefilter token="@@CSMusername@@" value="${csm.database.username}"/>
				<replacefilter token="@@CSMpasword@@" value="${csm.database.password}"/>
			</replace>

		 	<antcall target="mysql_config" />
		</target>

		<target name="oracle_csm_config_with_idp">
			<copy file="${caTissue-webapp.dir.dist}/modules/identity_provider_support/conf/idp_catissuecore-ds.xml" tofile="${prop.temp.dir}/catissuecore-ds.xml" overwrite="true"/>
			<copy file="${caTissue-webapp.dir.dist}/modules/identity_provider_support/conf/idp_login-config.xml" tofile="${prop.temp.dir}/login-config.xml" overwrite="true"/>
			<copy file="${caTissue-webapp.dir.dist}/modules/identity_provider_support/conf/idp_upt.hibernate.cfg.xml" tofile="${prop.temp.dir}/catissuecore-properties/upt.hibernate.cfg.xml" overwrite="true"/>
			<copy file="${caTissue-webapp.dir.dist}/modules/identity_provider_support/conf/idp_catissuecore.hibernate.cfg.xml" tofile="${prop.temp.dir}/catissuecore-properties/catissuecore.hibernate.cfg.xml" overwrite="true"/>
			<replace dir="${prop.temp.dir}" propertyfile="${catissue.deploy.config.file}">
						<include name="catissuecore-ds.xml" />
						<include name="login-config.xml" />
					<replacefilter token="@@CSMdatabaseurl@@" value="jdbc:oracle:thin:@${csm.database.host}:${csm.database.port}:${csm.database.name}"/>
					<replacefilter token="@@CSMusername@@" value="${csm.database.username}"/>
					<replacefilter token="@@CSMpasword@@" value="${csm.database.password}"/>
			</replace>
			<antcall target="oracle_config" />
		</target>

	<target name="upgrade_csm_from_3.2_to_4.2">
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="upgrade_csm_from_3.2_to_4.2_mysql" />
			</then>
		<elseif>
			<equals arg1="oracle" arg2="${database.type}" />
			<then>
				<antcall target="upgrade_csm_from_3.2_to_4.2_oracle" />
			</then>
		</elseif>
		<else>
			<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
		</else>
		</if>
	</target>

	<target name="upgrade_csm_from_3.2_to_4.2_mysql">
		<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}" >
					<transaction src="${dbupgrade.sql.dir}/MySql/CSMUpgrade_3.2_to_4.2.sql" />
					<transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
				</sql>
	</target>

	<target name="upgrade_csm_from_3.2_to_4.2_oracle">
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle">
			<transaction src="${dbupgrade.sql.dir}/Oracle/CSMUpgrade_3.2_to_4.2.sql"/>
			<transaction>commit;</transaction>
				<classpath>
					<fileset dir="${lib.dir}">
						<include name="*.jar" />
					</fileset>
				</classpath>
		</sql>
		<antcall target="upgrade_saved_queries"></antcall>
	</target>

	<!-- CCTS Integration -->
	<target name="install_ccts_integration" description="Adds tables needed for C3PR/PSC integration: notification processing, data queue.">
		<echo message="Adding tables needed for C3PR/PSC integration: notification processing, data queue. Suite v2.0 only." />
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<echo message="Adding tables needed for C3PR/PSC integration: notification processing, data queue. Suite v2.0 only. MYSQL VERSION." />
				<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}">
					<transaction src="${mysql.sql.dir}/DBUpgrade_v2.0_CCTS.sql" />
					<transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
				</sql>
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<echo message="Adding tables needed for C3PR/PSC integration: notification processing, data queue. Suite v2.0 only. ORACLE VERSION." />
					<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle">
						<transaction src="${oracle.sql.dir}/DBUpgrade_v2.0_CCTS.sql"/>
						<transaction>commit;</transaction>
							<classpath>
								<fileset dir="${lib.dir}">
									<include name="*.jar" />
								</fileset>
							</classpath>
					</sql>
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
	</target>
	<target name="upgrade_ccts_integration" description="Adds tables needed for C3PR/PSC integration: notification processing, data queue.">
		<echo message="Adding tables needed for C3PR/PSC integration: notification processing, data queue. Suite v2.0 only." />
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<echo message="Adding tables needed for C3PR/PSC integration: notification processing, data queue. Suite v2.0 only. MYSQL VERSION." />
				<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}">
					<transaction src="${dbupgrade.sql.dir}/MySql/DBUpgrade_v2.0_CCTS.sql" />
					<transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
				</sql>
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<echo message="Adding tables needed for C3PR/PSC integration: notification processing, data queue. Suite v2.0 only. ORACLE VERSION." />
					<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle">
						<transaction src="${dbupgrade.sql.dir}/Oracle/DBUpgrade_v2.0_CCTS.sql"/>
						<transaction>commit;</transaction>
							<classpath>
								<fileset dir="${lib.dir}">
									<include name="*.jar" />
								</fileset>
							</classpath>
					</sql>
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
	</target>

	<!-- CTRP Integration -->
	<target name="install_ctrp_integration" description="Making schema changes needed for CTRP integration.">
		<echo message="Making schema changes needed for CTRP integration. Suite v2.0 only." />
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<echo message="Making schema changes needed for CTRP integration. Suite v2.0 only. MYSQL VERSION." />
				<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}">
					<transaction src="${mysql.sql.dir}/DBUpgrade_v2.0_CTRP.sql" />
					<transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
				</sql>
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<echo message="Making schema changes needed for CTRP integration. Suite v2.0 only. Suite v2.0 only. ORACLE VERSION." />
					<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle">
						<transaction src="${oracle.sql.dir}/DBUpgrade_v2.0_CTRP.sql"/>
						<transaction>commit;</transaction>
							<classpath>
								<fileset dir="${lib.dir}">
									<include name="*.jar" />
								</fileset>
							</classpath>
					</sql>
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
	</target>

	<target name="upgrade_ctrp_integration" description="Making schema changes needed for CTRP integration.">
		<echo message="Making schema changes needed for CTRP integration. Suite v2.0 only." />
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<echo message="Making schema changes needed for CTRP integration.` Suite v2.0 only. MYSQL VERSION." />
				<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}">
					<transaction src="${dbupgrade.sql.dir}/MySql/DBUpgrade_v2.0_CTRP.sql" />
					<transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
				</sql>
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<echo message="Making schema changes needed for CTRP integration. Suite v2.0 only. ORACLE VERSION." />
					<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle">
						<transaction src="${dbupgrade.sql.dir}/Oracle/DBUpgrade_v2.0_CTRP.sql"/>
						<transaction>commit;</transaction>
							<classpath>
								<fileset dir="${lib.dir}">
									<include name="*.jar" />
								</fileset>
							</classpath>
					</sql>
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
	</target>

	<!-- GSID Integration -->
	<target name="install_or_upgrade_gsid_integration" description="Adds columns needed for GSID integration in the Specimen table: GLOBAL_SPECIMEN_IDENTIFIER ">
			<echo message="Adding columns needed for GSID integration in the Specimen table: GLOBAL_SPECIMEN_IDENTIFIER. Suite v2.0 only" />
			<if>
				<equals arg1="mysql" arg2="${database.type}" />
				<then>
					<echo message="Adding columns needed for GSID integration in the Specimen table: GLOBAL_SPECIMEN_IDENTIFIER. Suite v2.0 only. MYSQL VERSION." />
					<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.server}:${database.port}/${database.name}" userid="${database.user}" password="${database.password}">
						<transaction src="${common.sql.dir}/DBUpgrade_v2.0_GSID.sql" />
						<transaction>commit;</transaction>
						<classpath>
							<fileset dir="${lib.dir}">
								<include name="*.jar" />
							</fileset>
						</classpath>
					</sql>
				</then>
				<elseif>
					<equals arg1="oracle" arg2="${database.type}" />
					<then>
						<echo message="Adding columns needed for GSID integration in the Specimen table: GLOBAL_SPECIMEN_IDENTIFIER. Suite v2.0 only. ORACLE VERSION." />
						<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" userid="${database.user}" password="${database.password}" rdbms="oracle">
							<transaction src="${common.sql.dir}/DBUpgrade_v2.0_GSID.sql"/>
							<transaction>commit;</transaction>
								<classpath>
									<fileset dir="${lib.dir}">
										<include name="*.jar" />
									</fileset>
								</classpath>
						</sql>
					</then>
				</elseif>
				<else>
					<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
				</else>
			</if>
		</target>

	<target name="upgrade_existingEvents_to_sppEvents" description="Upgrades Existing Events To SppEvents">

		<!--unwar src="${caTissue-webapp.dir.dist}/modules/caTissue/lib/catissuecore.war" dest="${prop.temp.dir}/catissuecore" />
		<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/mysql-connector-java-5.0.8-bin.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />
		<copy file="${caTissue-webapp.dir.dist}/modules/caTissue/lib/ojdbc14.jar" todir="${prop.temp.dir}/catissuecore/WEB-INF/lib" />
		<antcall target="replace_app_dao_prop_file"/>
		<unzip src="${caTissue-webapp.dir.dist}/modules/dynamic_extensions/lib/dynamicextensions.zip" dest="${prop.temp.dir}/dynamicextensions" overwrite="true" />


		<copy file="${caTissue-webapp.dir.dist}/modules/dynamic_extensions/conf/hibernate.cfg.xml" todir="${prop.temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />
		<copy file="${prop.temp.dir}/dynamicextensions/conf/DynamicExtensionsHibernate.cfg.xml" tofile="${prop.temp.dir}/catissuecore/WEB-INF/classes/DynamicExtensionsHibernate.cfg.xml" overwrite="true" />
		<copy file="${prop.temp.dir}/dynamicextensions/conf/DynamicExtensionsAuditMetadata.xml" tofile="${prop.temp.dir}/catissuecore/WEB-INF/classes/DynamicExtensionsAuditMetadata.xml" overwrite="true" />

		<unjar src="${prop.temp.dir}/dynamicextensions/binaries/DynamicExtensionsInterface/DynamicExtensions.jar" dest="${prop.temp.dir}/dynamicextensions/WEB-INF/classes" />
		<echo message="Concatenating the Application Resource Properties file" />
		<concat destfile="${prop.temp.dir}/dynamicextensions/WEB-INF/classes/ApplicationResources.properties" append="true">
			<fileset file="${prop.temp.dir}/catissuecore/WEB-INF/classes/ApplicationResources.properties" />
		</concat>
		<copy file="${prop.temp.dir}/dynamicextensions/WEB-INF/classes/ApplicationResources.properties" todir="${prop.temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />

		<property name="ORM1CfgFile" value="${cacaore.deployables}/SpecimenEvents.war/orm1.cfg.xml" />
		<property name="WebCfgFile" value="${prop.temp.dir}/catissuecore/WEB-INF/classes/hibernate.cfg.xml" />
		<property name="DEWebCfgFile" value="${prop.temp.dir}/catissuecore/WEB-INF/classes/DynamicExtensionsHibernate.cfg.xml" />

		<java classname="edu.wustl.metadata.util.CacoreDEMetadataAppender" fork="true" maxmemory="1024M">
			<arg value="${WebCfgFile}" />
			<arg value="${ORM1CfgFile}" />
			<classpath>
				<pathelement location="${prop.temp.dir}/dynamicextensions/WEB-INF/classes" />
				<fileset dir="${prop.temp.dir}/dynamicextensions/lib/server">
					<include name="*.jar" />
					<exclude name="uml-1.3.jar" />
				</fileset>
				<fileset dir="${prop.temp.dir}/dynamicextensions/lib/extra">
					<include name="jboss-j2ee.jar" />
					<include name="jta.jar" />
				</fileset>
			</classpath>
		</java>

		<java classname="edu.wustl.metadata.util.CacoreDEMetadataAppender" fork="true" maxmemory="1024M">
			<arg value="${DEWebCfgFile}" />
			<arg value="${ORM1CfgFile}" />
			<classpath>
				<pathelement location="${prop.temp.dir}/dynamicextensions/WEB-INF/classes" />
				<fileset dir="${prop.temp.dir}/dynamicextensions/lib/server">
					<include name="*.jar" />
					<exclude name="uml-1.3.jar" />
				</fileset>
				<fileset dir="${prop.temp.dir}/dynamicextensions/lib/extra">
					<include name="jboss-j2ee.jar" />
					<include name="jta.jar" />
				</fileset>
			</classpath>
		</java>

		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
					<include name="*.cfg.xml" />
					<replacefilter token="@@DIALECT@@" value="${mysql.dialect.string}" />
					<replacefilter token="@@DRIVER@@" value="com.mysql.jdbc.Driver" />
					<replacefilter token="@@URL@@" value="jdbc:mysql://${database.server}:${database.port}/${database.name}" />
				</replace>
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
						<include name="*.cfg.xml" />
						<replacefilter token="@@DIALECT@@" value="${oracle.dialect.string}" />
						<replacefilter token="@@DRIVER@@" value="${oracle.driver.string}" />
						<replacefilter token="@@URL@@" value="jdbc:oracle:thin:@${database.server}:${database.port}:${database.name}" />
					</replace>
				</then>
			</elseif>
			<elseif>
				<equals arg1="mssqlserver" arg2="${database.type}"/>
				<then>
					<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
						<include name="*.cfg.xml" />
						<replacefilter token="@@DIALECT@@" value="${mssqlserver.dialect.string}"/>
						<replacefilter token="@@DRIVER@@" value="${mssqlserver.driver.string}"/>
						<replacefilter token="@@URL@@" value="jdbc:sqlserver://${database.server}:${database.port};databaseName=${database.name};" />
					</replace>
				</then>
			</elseif>
		</if>
		<replace dir="${prop.temp.dir}/catissuecore/WEB-INF/classes">
			<include name="*.cfg.xml" />
			<replacefilter token="@@DATABASE_USERNAME@@" value="${database.user}" />
			<replacefilter token="${token.database.password}" value="${database.password}" />
		</replace>
		<java classname="edu.wustl.catissuecore.upgrade.UpgradeExistingEventsToSppEvents" fork="true" maxmemory="1024m" failonerror="true">
			<classpath>
				<pathelement location="${prop.temp.dir}/catissuecore/WEB-INF/classes" />
				<fileset dir="${prop.temp.dir}/catissuecore/WEB-INF/lib">
					<include name="*.jar" />
					<exclude name="uml-1.3.jar" />
				</fileset>
				<fileset dir="${lib.dir}">
						<include name="**/*.jar" />
				</fileset>
				<fileset dir="${cacaore.deployables}/SpecimenEvents.war/WEB-INF/lib">
						<include name="**/*.jar" />
				</fileset>
			</classpath>
		</java-->
	</target>

	<target name="deploy_notification_service">
        <echo>About to deploy Notification Grid Service...</echo>
        <echo>Service location: ${notificationservice.dir}</echo>
        <echo>JBoss location: ${jboss.home}</echo>
        <if>
            <not><isset property="env.GLOBUS_LOCATION"/></not>
            <then>
                <echo>Getting Globus from the Net...</echo>
                <mkdir dir="${globus.download.dir}"/>
                <get dest="${globus.download.dir}/globus.zip" src="${globus.download.url}"/>
                <unzip dest="${globus.download.dir}" src="${globus.download.dir}/globus.zip"></unzip>
                <property name="globus.location" value="${globus.download.dir}/ws-core-4.0.3"></property>
                <echo>Globus location now is: ${globus.location}</echo>
            </then>
            <else>
                <echo message="GLOBUS_LOCATION (${env.GLOBUS_LOCATION}) found."/>
                <property name="globus.location" value="${env.GLOBUS_LOCATION}" />
            </else>
        </if>

        <echo>Invoking another Ant build to deploy the service...</echo>
        <ant dir="${notificationservice.dir}" target="deployJBoss" inheritAll="false">
            <property name="env.GLOBUS_LOCATION" value="${globus.location}"/>
            <property name="jboss.dir" value="${jboss.home}"/>
        </ant>
        <echo>Notification Grid Service has been deployed!</echo>
    </target>
</project>