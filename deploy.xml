<?xml version ="1.0"?>
<!--Ant Script for create Build for caTISSUE Core-->

<project name="caTissue Suite Installation" default="deploy_app">
	
	<!--define require dir and Properties -->	
	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
	<classpath>
	    <pathelement location="./lib/ant-contrib.jar"/>
	  </classpath>
	</taskdef>

	<property file="caTissueInstall.properties"/>
	
	<property name="base.dir" value="."/>
	<property name="temp.dir" value="./tempCatissuecore"/>
	<property name="csm.dir" value="${temp.dir}/tempcsm"/>
	<property name="lib.dir" value="${base.dir}/lib"/>
	
    <property name="mysql.sql.dir" value="${base.dir}/SQL/MySql"/>
    <property name="dbupgrade.sql.dir" value="${base.dir}/SQL/DBUpgrade"/>
	<property name="oracle.sql.dir" value="${base.dir}/SQL/Oracle"/>
	<property name="common.sql.dir" value="${base.dir}/SQL/Common"/>
	<property name="oracle.dialect.string" value="net.sf.hibernate.dialect.Oracle9Dialect"/>
	<property name="mysql.dialect.string" value="net.sf.hibernate.dialect.MySQLDialect"/>
	
	<property name="oracle.dialect.h3.string" value="org.hibernate.dialect.Oracle9Dialect"/>
	<property name="mysql.dialect.h3.string" value="org.hibernate.dialect.MySQLDialect"/>
	
	<property name="oracle.driver.string" value="oracle.jdbc.driver.OracleDriver"/>
	<property name="mysql.driver.string" value="org.gjt.mm.mysql.Driver"/>
	
	<property name="mysql.lib" value="mysql-connector-java-3.0.16-ga-bin.jar"/>
	<property name="oracle.lib" value="oracleDriver.jar"/>

	
	<!-- Check for required properties -->
	<target name="assert">
		<if>
			<equals arg1="" arg2="${jboss.home.dir}"/>
			<then>
				<fail message="The property 'jboss.home.dir' can not be empty"/>
			</then>
		</if>
	</target>
	<target name="assertfordb">
		<if>
				<or>
					<equals arg1="mysql" arg2="${database.type}"/>
					<equals arg1="oracle" arg2="${database.type}"/>	
				</or>
				<then/>
				<else>
					<fail message="The value of property 'database.type' must be mysql or oracle"/>
				</else>	
				</if>
				<if>
					<equals arg1="" arg2="${database.host}"/>
					<then>
						<fail message="The property 'database.host' can not be empty"/>
					</then>
				</if>
				<if>
					<equals arg1="" arg2="${database.port}"/>
					<then>
						<fail message="The property 'database.port' can not be empty. Default port for MySQL:3306 and for Oracle: 1521"/>
					</then>
				</if>
				<if>
					<equals arg1="" arg2="${database.name}"/>
					<then>
						<fail message="The property 'database.name' can not be empty"/>
					</then>
				</if>
				<if>
					<equals arg1="" arg2="${database.username}"/>
					<then>
						<fail message="The property 'database.username' can not be empty"/>
					</then>
				</if>			
				<!-- Mandar 17May06 check for first user -->
				<if>
					<equals arg1="" arg2="${first.admin.department}"/>
					<then>
						<fail message="The property 'first.admin.department' can not be empty"/>
					</then>
				</if>
				<if>
					<equals arg1="" arg2="${first.admin.institution}"/>
					<then>
						<fail message="The property 'first.admin.institution' can not be empty"/>
					</then>
				</if>
				<if>
					<equals arg1="" arg2="${first.admin.cancerresearchgroup}"/>
					<then>
						<fail message="The property 'first.admin.cancerresearchgroup' can not be empty"/>
					</then>
				</if>
				<if>
					<equals arg1="" arg2="${first.admin.emailAddress}"/>
					<then>
						<fail message="The property 'first.admin.emailAddress' can not be empty"/>
					</then>
				</if>
				<if>
					<equals arg1="" arg2="${first.admin.password}"/>
					<then>
						<fail message="The property 'first.admin.password' can not be empty"/>
					</then>
				</if>
		</target>
	<target name="assertforcaties">
		<if>
			<equals arg1="" arg2="${caties.installation.dir}"/>
			<then>
				<fail message="The property 'caties.installation.dir' can not be empty"/>
			</then>
		</if>
	</target>
	<!--Extrct WAR and copy Configuration files to temp directory--> 
	<target name="init">
		<echo message="Initializing installation..."/>

		<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore"/>

		<unwar src="${base.dir}/dynamicExtensions.war" dest="${temp.dir}/dynamicExtensions"/>

		<!-- <unwar src="${base.dir}/catissuecorecsm.war" dest="${temp.dir}/tempcsm"/> -->
		<copy todir="${temp.dir}/catissuecore-properties" overwrite="true">
			<fileset dir="${base.dir}/catissuecore-properties"/>
		</copy>
		
		<copy file="catissuecore-ds.xml" todir="${temp.dir}" overwrite="true"/>
		
		<copy file="${temp.dir}/catissuecore/WEB-INF/classes/DAOConfig.xml" todir="${temp.dir}"/>
		<!--Kapil V 1.0.1 Changes-->
		<copy file="login-config.xml" todir="${temp.dir}" overwrite="true"/>
		<copy file="properties-service.xml" todir="${temp.dir}" overwrite="true"/>
		<copy file="log4j.xml" todir="${temp.dir}" overwrite="true"/>
 	</target>
	
	<!--Modify Configuration such as Session Timeout, Admin details and JBoss server port-->
	<target name="configure_war">
		<echo message="Modifying caTissueCore Configuration File..."/>
		
		<replace file="${temp.dir}/catissuecore/WEB-INF/web.xml"> 
			<replacefilter token="&lt;session-timeout>10&lt;/session-timeout>" 
			  	value="&lt;session-timeout>${session.timeout}&lt;/session-timeout>"/>
		</replace>
		
		<!--<replace file="${temp.dir}/catissuecore/WEB-INF/classes/remoteService.xml"> 
			<replacefilter token="@@server.port@@" value="${jboss.server.port}"/>
		</replace>-->
	</target>
	
	
	<!--Modify Adopter's Institution images, URL of Institution website and Contact Us, Privacy Notice, Disclaimer, Accessibility Text Files-->
	<target name="adopter_configuration">
		<echo message="Updating Site Images"/>
		<copy todir="${temp.dir}/catissuecore/images" overwrite="true">
			<fileset dir="${base.dir}/images"/>
		</copy>
	</target>
	
	
	
	<!--Modify Configuration For MySQL-->
	<target name="mysql_config">
		<echo message="Modifying caTISSUECore MySQL specific Configuration File..."/>
		
		<replace dir="${temp.dir}/catissuecore-properties" propertyfile="caTissueInstall.properties"> 
	  		<include name="upt.hibernate.cfg.xml"/>
			<include name="catissuecore.hibernate.cfg.xml"/>
			<replacefilter token="@@dialect@@" value="${mysql.dialect.string}"/>
		</replace>
		<!-- added for csm orm1.cfg.xml file-->
		<replace dir="${temp.dir}/catissuecore/WEB-INF/classes" propertyfile="caTissueInstall.properties"> 
			<include name ="orm1.cfg.xml"/>
			<replacefilter token="@@dialect@@" value="${mysql.dialect.h3.string}"/>
		</replace>
		
		<replace dir="${temp.dir}" propertyfile="caTissueInstall.properties"> 
			<include name="catissuecore-ds.xml"/>
			<include name="login-config.xml"/>
			<replacefilter token="@@databaseurl@@" value="jdbc:mysql://${database.host}:${database.port}/${database.name}"/>
			<replacefilter token="@@username@@" value="${database.username}"/>
			<replacefilter token="@@pasword@@" value="${database.password}"/>
			<replacefilter token="@@databasedriver@@" value="${mysql.driver.string}"/>
		</replace>
		
		<!-- change ${csm.dir} to {catissuecore} because using one war only -->
		<!-- Configuring CSM hibernate property File-->
		<!--
		<replace dir="${temp.dir}/catissuecore/WEB-INF" propertyfile="caTissueInstall.properties"> 
			<include name="classes/hibernate.properties"/>
			<include name="conf/hibernate.properties"/>
			<replacefilter 
				token="hibernate.dialect org.hibernate.dialect.MySQLDialect" 
			  	value="hibernate.dialect ${mysql.dialect.h3.string}"/>
			<replacefilter 
				token="hibernate.connection.driver_class com.mysql.jdbc.Driver" 
			  	value="hibernate.connection.driver_class ${mysql.driver.string}"/>
			
			<replacefilter 
				token="hibernate.connection.url jdbc:mysql://ps0154:3306/catissuecore_mysql" 
			  	value="hibernate.connection.url jdbc:mysql://${database.host}:${database.port}/${database.name}"/>
			<replacefilter 
				token="hibernate.connection.username catissue_core" 
			  	value="hibernate.connection.username ${database.username}"/>
			<replacefilter 
				token="hibernate.connection.password catissue_core" 
			  	value="hibernate.connection.password ${database.password}"/>
		</replace>
		-->
		<replace file="${temp.dir}/catissuecore/WEB-INF/classes/hibernate.cfg.xml">
			<replacefilter token="${mysql.dialect.string}" value="${mysql.dialect.string}"/>
		</replace>
		<replace file="${temp.dir}/catissuecore/WEB-INF/classes/DynamicExtensionsHibernate.cfg.xml">
			<replacefilter token="${mysql.dialect.string}" value="${mysql.dialect.string}"/>
		</replace>
	</target>
	
	<!--Modify Configuration For Oracle-->
	<target name="oracle_config">
		<echo message="Modifying caTISSUECore Oracle specific Configuration File..."/>
		<replace dir="${temp.dir}/catissuecore-properties" propertyfile="caTissueInstall.properties"> 
	  		<include name="upt.hibernate.cfg.xml"/>
			<include name="catissuecore.hibernate.cfg.xml"/>
			<replacefilter token="@@dialect@@" value="${oracle.dialect.string}"/>
		</replace>
		
		<!-- added for csm orm1.cfg.xml file-->
		<replace dir="${temp.dir}/catissuecore/WEB-INF/classes" propertyfile="caTissueInstall.properties"> 
			<include name ="orm1.cfg.xml"/>
			<replacefilter token="@@dialect@@" value="${oracle.dialect.h3.string}"/>
		</replace>
			
		<!-- Configuring Data Source File-->
		<replace dir="${temp.dir}" propertyfile="caTissueInstall.properties"> 
			<include name="catissuecore-ds.xml"/>
			<include name="login-config.xml"/>
			<replacefilter token="@@databaseurl@@" value="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}"/>
			<replacefilter token="@@username@@" value="${database.username}"/>
			<replacefilter token="@@pasword@@" value="${database.password}"/>
			<replacefilter token="@@databasedriver@@" value="${oracle.driver.string}"/>
		</replace>
		<!-- change ${csm.dir} to {catissuecore} because using one war only -->
		<!-- Configuring CSM hibernate property File-->
		<!--
		<replace dir="${temp.dir}/catissuecore/WEB-INF" propertyfile="caTissueInstall.properties"> 
			<include name="classes/hibernate.properties"/>
			<include name="conf/hibernate.properties"/>
			<replacefilter 
				token="hibernate.dialect org.hibernate.dialect.MySQLDialect" 
			  	value="hibernate.dialect ${oracle.dialect.h3.string}"/>
			<replacefilter 
				token="hibernate.connection.driver_class com.mysql.jdbc.Driver" 
			  	value="hibernate.connection.driver_class ${oracle.driver.string}"/>
			
			<replacefilter 
				token="hibernate.connection.url jdbc:mysql://ps0154:3306/catissuecore_mysql" 
			  	value="hibernate.connection.url jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}"/>
			<replacefilter 
				token="hibernate.connection.username catissue_core" 
			  	value="hibernate.connection.username ${database.username}"/>
			<replacefilter 
				token="hibernate.connection.password catissue_core" 
			  	value="hibernate.connection.password ${database.password}"/>
		</replace>
		-->
		<replace file="${temp.dir}/catissuecore/WEB-INF/classes/hibernate.cfg.xml">
			<replacefilter 
				token="${mysql.dialect.string}" 
			  	value="${oracle.dialect.string}"/>
		</replace>
		<replace file="${temp.dir}/catissuecore/WEB-INF/classes/DynamicExtensionsHibernate.cfg.xml">
			<replacefilter token="${mysql.dialect.string}" value="${oracle.dialect.string}"/>
	        <replacefilter token="&lt;!--MySQL c3p properties start-->" value="&lt;!--MySQL c3p properties start"/>
	        <replacefilter token="&lt;!--MySQL c3p properties end-->" value="MySQL c3p properties end-->"/>
		</replace>

	</target>
	<!--Server clean-up-->
	<target name="clean_server" description="deletes the WAR file and cache from server ">		
		<delete file="${jboss.home.dir}/server/default/deploy/catissuecore.war" />
		<delete file="${jboss.home.dir}/server/default/deploy/dynamicExtensions.war" />
		
		<delete includeemptydirs="true">
			<fileset dir="${jboss.home.dir}/server/default/work">
				<include name="**/*" />					
			</fileset>
		</delete>
		<delete includeemptydirs="true">
			<fileset dir="${jboss.home.dir}/server/default/tmp">
				<include name="**/*" />					
			</fileset>
		</delete>
	</target>
	
	<!--Buid New WAR File-->
	<target name="build_war">
		<echo message="Creating New Web Application Archieve File..."/>
		<delete file="${temp.dir}/catissuecore.war"/>
		<delete file="${temp.dir}/dynamicExtensions.war"/>

		<war destfile="${temp.dir}/catissuecore.war" webxml="${temp.dir}/catissuecore/WEB-INF/web.xml">
			<fileset dir="${temp.dir}/catissuecore">
				<exclude name="**/*build*"/>
				<exclude name="**/*WEB-INF*"/>
				<exclude name="**/*servlet.jar*"/>
				<exclude name="**/WEB-INF/lib/log4j-1.2.9.jar*"/>
				<exclude name="**/*hibernate2.jar*"/>
				<exclude name="**/*jta.jar*"/>
				<exclude name="**/.*"/>
				<exclude name="**/*.sql"/>
				<exclude name="**/CVS*"/>	
			</fileset>
		</war>
		
		<copy file="${temp.dir}/catissuecore/WEB-INF/classes/DynamicExtensionsHibernate.cfg.xml" todir="${temp.dir}/dynamicExtensions/WEB-INF/classes" overwrite="true"/>
		
		<war destfile="${temp.dir}/dynamicExtensions.war" webxml="${temp.dir}/dynamicExtensions/WEB-INF/web.xml">
			<fileset dir="${temp.dir}/dynamicExtensions">
				<include name="**/**/**.*"/>
			</fileset>
		</war>
		
		<!-- change because using one war only -->
		<!--
		<delete file="${temp.dir}/catissuecorecsm.war"/>
		<war destfile="${temp.dir}/catissuecorecsm.war" webxml="${csm.dir}/WEB-INF/web.xml">
			<fileset dir="${csm.dir}"/>
		</war>
		-->
	</target>
	
	<!--Copy WAR and Configuration Files to JBOSS Directory-->
	<target name="copy_files">
		<echo message="Copying caTISSUECore Application Components..."/>

		<copy todir="${jboss.home.dir}/server/default/catissuecore-properties" overwrite="true">
			<fileset dir="${temp.dir}/catissuecore-properties">
				<include name="**/*"/>
			</fileset>	
		</copy>
		<copy todir="${jboss.home.dir}/server/default/deploy" overwrite="true">
  			<fileset dir="${temp.dir}">
  				<include name="catissuecore.war"/>
  				<include name="catissuecore-ds.xml"/>
  				<include name="catissuecorecsm.war"/>
  				<include name="dynamicExtensions.war"/>
   			</fileset>
  		</copy>
		<replace dir="${jboss.home.dir}/server/default/catissuecore-properties"> 
	  		<include name="ApplicationSecurityConfig.xml"/>
			<replacefilter token="@@hibernate-config-file@@" 
				  	value="${jboss.home.dir}/server/default/catissuecore-properties/catissuecore.hibernate.cfg.xml"/>
		</replace>
		<copy todir="${jboss.home.dir}/server/default/lib" >
			<fileset dir="${lib.dir}">
				<include name="${mysql.lib}"/>
				<include name="${oracle.lib}"/>
			</fileset>
		</copy>
		<copy todir="${jboss.home.dir}/bin" overwrite="true">
			<fileset dir="${temp.dir}">
				<include name="DAOConfig.xml"/>
			</fileset>
		</copy>	
  	</target>
	<!--Changes for v 1.0.1 - Start-->
	<target name="config_jboss_files">
		<copy todir="${jboss.home.dir}/server/default/conf" overwrite="true">
  			<fileset dir="${temp.dir}">
  				<include name="login-config.xml"/>
  				<include name="log4j.xml"/>
   			</fileset>
  		</copy>

		<replace dir="${temp.dir}"> 
	  		<include name="properties-service.xml"/>
			<replacefilter token="@@app-security-file@@" 
				  	value="${jboss.home.dir}/server/default/catissuecore-properties/ApplicationSecurityConfig.xml"/>
		<replacefilter token="@@app-properties-file@@" 
				  	value="${jboss.home.dir}/server/default/catissuecore-properties/caTissueCore_Properties.xml"/>
		<replacefilter token="@@app-dynamicuixml-file@@" 
				  	value="${jboss.home.dir}/server/default/catissuecore-properties/dynamicUI.xml"/>

		</replace>


		<copy todir="${jboss.home.dir}/server/default/deploy" overwrite="true">
  			<fileset dir="${temp.dir}">
  				<include name="properties-service.xml"/>
   			</fileset>
  		</copy>
		<delete file="${jboss.home.dir}/server/default/lib/hibernate2.jar"/>
	</target>
	<!--Target call for both Deployment of Core -->
	<target name="deploy_app">
		<antcall target="assert"/>
		<antcall target="assertfordb"/>
		<delete dir="${temp.dir}"/>
		<antcall target="init"/>
		<antcall target="configure_war"/>
		<antcall target="adopter_configuration"/>
		<if>
			<equals arg1="mysql" arg2="${database.type}"/>		
			<then>
				<antcall target="mysql_config"/>
			</then>
			<elseif>	
				<equals arg1="oracle" arg2="${database.type}"/>		
				<then>
					<antcall target="oracle_config"/>
				</then>
			</elseif>
		</if>
		<!-- configure titli.properties -->
		<antcall target="configure_titli"/>
		<antcall target="build_war"/>
		<antcall target="copy_files"/>
		<antcall target="send_mail"/>
	</target>
	
	<!--Target call for both Deployment of caTIES -->
	<target name="deploy_caties" >
		<antcall target="assertforcaties"/>
		<antcall target="init"/>
		<antcall target="deploy_caties_internal"/>
		<delete dir="${temp.dir}" />
	</target>
	
	<!--Target call for both Deployment of Core and  caTIES and Database Creation-->
		<target name="deploy_all">
			<antcall target="assert"/>
			<antcall target="assertfordb"/>
			<antcall target="assertforcaties"/>
			<antcall target="deploy_app"/>
			<antcall target="deploy_caties"/>
			<antcall target="db_initialize"/>
			<ant dir="${caties.installation.dir}" inheritAll="false" antfile="build.xml" target="addcp" />
		</target>

	<!--Target for Deployment with jboss config-->
	<target name="deploy_app_with_config" >
		<antcall target="deploy_app"/>
		<antcall target="config_jboss_files"/>
		<delete dir="${temp.dir}"/>
	</target>
	<!--Target call for both Deployment of Core and Database Creation-->
	<target name="deploy_app_with_db" >
			<antcall target="deploy_app"/>
		<antcall target="db_initialize"/>
			<delete dir="${temp.dir}"/>
		</target>
	<!--Target call for both Deployment of  caTIES and Database Creation-->
	<target name="deploy_caties_with_db" >
		<antcall target="assertfordb"/>
		<antcall target="assertforcaties"/>
		<antcall target="init"/>	
		<antcall target="deploy_caties_internal"/>
		<antcall target="db_initialize"/>
		<ant dir="${caties.installation.dir}" inheritAll="false" antfile="build.xml" target="addcp" />
	</target>

	<!--Target call for both Deployment of Core and  caTIES with jboss config-->
	<target name="deploy_all_with_config">
		<antcall target="deploy_app_with_config"/>
		<antcall target="deploy_caties_internal"/>
		<antcall target="db_initialize"/>
		<ant dir="${caties.installation.dir}" inheritAll="false" antfile="build.xml" target="addcp" />
	</target>
	<!--Target for Database Creation-->
	<target name="db_initialize">
		<antcall target="firstUser"/>
		
		<if>
			<equals arg1="mysql" arg2="${database.type}"/>		
			<then>
				<antcall target="db_initialize_mysql"/>
			</then>
			<elseif>	
				<equals arg1="oracle" arg2="${database.type}"/>		
				<then>
					<antcall target="db_initialize_oracle"/>
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error"/>
			</else>
		</if>
	</target>
	<!--Changes for v 1.0.1 - End-->

	
	<!--MySQL Database Creation -->
	<target name="db_initialize_mysql">
		<echo message="Initializing MySQL Database for caTISSUECore Application..."/>
		<sql
			driver="${mysql.driver.string}"
		    url="jdbc:mysql://${database.host}:${database.port}/${database.name}"
		    userid="${database.username}"
		    password="${database.password}" 
			onerror="continue">
			<transaction  src="${mysql.sql.dir}/catissuecore.sql"/>
			<transaction  src="${mysql.sql.dir}/InitDB_CreateTable.sql"/>
			<transaction  src="${common.sql.dir}/initDB_Insert_Common.sql"/>
			<transaction  src="${common.sql.dir}/AlterTable.sql"/>
			<transaction  src="${common.sql.dir}/CDE_DummyData_Common.sql"/>
			<transaction  src="${mysql.sql.dir}/csm_catissuecore.sql"/>
			<transaction  src="${common.sql.dir}/createUser.sql"/>
			<transaction  src="${common.sql.dir}/insert_default_data.sql"/>
			<transaction  src="${common.sql.dir}/indexes.sql"/>
			<transaction  src="${mysql.sql.dir}/SuiteQueryMetadataInsertScript.sql"/>	
			<transaction>commit;</transaction>
			<classpath>
			<fileset dir="${lib.dir}">
			  <include name="*.jar"/>
			  </fileset>
			</classpath> 
		</sql>
  	</target>
  	<!--Target for Database Upgrade from 1.0 to 1.1-->
	<target name="db_upgrade">
		<if>
			<equals arg1="mysql" arg2="${database.type}"/>		
			<then>
				<antcall target="db_upgrade_mysql"/>
			</then>
			<elseif>	
				<equals arg1="oracle" arg2="${database.type}"/>		
				<then>
					<antcall target="db_upgrade_oracle"/>
				</then>
			</elseif>
			<else>
				<echo message="DATABASE UPGRADATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error"/>
			</else>
		</if>
	</target>
		<!--MySQL Database Upgradation -->
	<target name="db_upgrade_mysql">
		<echo message="Upgrading MySQL Database for caTISSUECore Application 1.1..."/>
		<sql
			driver="${mysql.driver.string}"
		    url="jdbc:mysql://${database.host}:${database.port}/${database.name}"
		    userid="${database.username}"
		    password="${database.password}" 
			onerror="continue">
			<transaction  src="${dbupgrade.sql.dir}/MySql/DBUpgrade_1.0_to_1.1.sql"/>
			<transaction  src="${common.sql.dir}/initDB_Insert_Common.sql"/>
			<transaction  src="${common.sql.dir}/indexes.sql"/>
			<transaction>commit;</transaction>
			<classpath>
			<fileset dir="${lib.dir}">
			  <include name="*.jar"/>
			  </fileset>
			</classpath> 
		</sql>
  	</target>
  	<target name="db_upgrade_1.1_to_CatissueSuite_mysql">
		<echo message="Upgrading MySQL Database for caTISSUECore Application 1.1 to CatissueSuite..."/>
		<sql
			driver="${mysql.driver.string}"
		    url="jdbc:mysql://${database.host}:${database.port}/${database.name}"
		    userid="${database.username}"
		    password="${database.password}" 
			onerror="continue">		
			<transaction  src="${dbupgrade.sql.dir}/MySql/DBUpgrade_1.1 to CatissueSuite.sql"/>	
			<transaction  src="${mysql.sql.dir}/caB2B Table Generation Script.sql"/>
			<transaction  src="${mysql.sql.dir}/dynamicextension.sql"/>		
			<transaction  src="${mysql.sql.dir}/SuiteQueryMetadataInsertScript.sql"/>	
			<transaction>commit;</transaction>
			<classpath>
			<fileset dir="${lib.dir}">
			  <include name="*.jar"/>
			  </fileset>
			</classpath> 
		</sql>
  	</target>
  	<!--MySQL Database Upgradation -->
	<target name="db_upgrade_oracle">
		<echo message="Upgrading Oracle Database for caTISSUECore Application 1.1..."/>
		<sql 
			driver="${oracle.driver.string}"
		    url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}"
		    userid="${database.username}"
		    password="${database.password}" 
    		onerror="continue"
    		rdbms="oracle">
			<transaction  src="${dbupgrade.sql.dir}/Oracle/DBUpgrade_1.0_to_1.1.sql"/>
			<transaction  src="${common.sql.dir}/initDB_Insert_Common.sql"/>
			<transaction  src="${common.sql.dir}/indexes.sql"/>
			<transaction>commit;</transaction>
			<classpath>
			<fileset dir="${lib.dir}">
			  <include name="*.jar"/>
			  </fileset>
			</classpath> 
		</sql>
  	</target>
	<!--Oracle Database Creation -->
	<target name="db_initialize_oracle">
		<echo message="Initializing Oracle Database for caTISSUECore Application..."/>
		<sql 
			driver="${oracle.driver.string}"
		    url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}"
		    userid="${database.username}"
		    password="${database.password}" 
    		onerror="continue"
    		rdbms="oracle">
		  <transaction  src="${oracle.sql.dir}/catissuecore.sql"/>
		  <transaction  src="${oracle.sql.dir}/InitDB_CreateTable.sql"/>
		  <transaction  src="${common.sql.dir}/initDB_Insert_Common.sql"/>
		  <transaction  src="${oracle.sql.dir}/AlterTable.sql"/>
		  <transaction  src="${common.sql.dir}/CDE_DummyData_Common.sql"/>
		  <transaction  src="${oracle.sql.dir}/CSM_Create_Oracle.sql"/>
		  <transaction  src="${oracle.sql.dir}/createUser.sql"/>
	      <transaction  src="${oracle.sql.dir}/insert_default_data.sql"/>	
	      <transaction  src="${common.sql.dir}/indexes.sql"/>
		  <transaction  src="${oracle.sql.dir}/cab2b_CreateTable.sql"/>	
		  <transaction  src="${oracle.sql.dir}/dynamicextension_CreateTable.sql"/>	
		  <transaction  src="${oracle.sql.dir}/SuiteQueryMetadataInsertScript.sql"/>	
		  <transaction  src="${oracle.sql.dir}/cab2b_AddConstraints.sql"/>	
		  <transaction  src="${oracle.sql.dir}/dynamicextension_AddConstraints.sql"/>				
		  <transaction>commit;</transaction>	
    	  <classpath>
            <fileset dir="${lib.dir}">
                  <include name="*.jar"/>
              </fileset>
            </classpath> 
		</sql>
		<sql
			driver="${oracle.driver.string}"
		    url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}"
		    userid="${database.username}"
		    password="${database.password}" 
    		onerror="continue"
    		rdbms="oracle" 
			delimiter="/"
		    delimitertype="row">
		  <transaction  src="${oracle.sql.dir}/CSM_Trigger_Oracle.sql"/>
		  <classpath>
            <fileset dir="${lib.dir}">
                  <include name="*.jar"/>
              </fileset>
            </classpath> 
		</sql>
		<sql
			driver="${oracle.driver.string}"
		    url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}"
		    userid="${database.username}"
		    password="${database.password}" 
    		onerror="continue"
    		rdbms="oracle">
		  <transaction  src="${oracle.sql.dir}/CSM_InsertData_Oracle.sql"/>	
   		  <transaction  src="${oracle.sql.dir}/CSM_AddConstraints_Oracle.sql"/>
   		  <transaction  src="${oracle.sql.dir}/createUser.sql"/>
		  <transaction>commit;</transaction>	
		  <classpath>
            <fileset dir="${lib.dir}">
                  <include name="*.jar"/>
              </fileset>
            </classpath> 
		</sql>
	</target>
	
	<target name="send_mail">
		<echo message="Sending mail to: ${email.administrative.emailAddress}"/>
		<echo message="Sending mail from: ${email.sendEmailFrom.emailAddress}"/>
		<mail mailhost="${email.mailServer}" subject="caTissue Core Successfully Deployed" encoding="plain"
			failonerror="false">
			<from address="${email.sendEmailFrom.emailAddress}"/>
			<to address="${email.administrative.emailAddress}"/>
			<message>
Dear caTissue Core Administrator,
	
	This is to validate that caTissue Core application has been installed at 
the following location: ${jboss.home.dir}		
    
	To complete the deployment, you have to now perform the post installation 
steps described in section "Post Installation Configuration" in the deployment 
guide (caTissue Core Deployment Guide.doc). 

	Once you have completed deployment, you should be able to login with the following 
details:			
URL: http://localhost:${jboss.server.port}/catissuecore 
Username:${first.admin.emailAddress}
Password:${first.admin.password}

Thanking You,
-caTissue Core				
			</message>
		</mail>
		<echo>
			Please check the Email of ${first.admin.emailAddress}.
			If the Deployment mail is not received please check your 
			email.administrative.emailAddress and email.sendEmailFrom.emailAddress 
			properties in caTissueInstall.properties and Re-deploy the Application.
		</echo>	
	</target>
	
	<!--First User Creation. Mandar : 02-May-2006 -->
		<target name="firstUser">
		<if>
			<equals arg1="mysql" arg2="${database.type}"/>		
			<then>
				<antcall target="mysqlFirstUser"/>
			</then>
			<elseif>	
				<equals arg1="oracle" arg2="${database.type}"/>		
				<then>
					<antcall target="oracleFirstUser"/>
				</then>
			</elseif>
		</if>
	</target>
	<target name="oracleFirstUser">
		<echo message="Encoding Password..."/>
		<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore"/>
	
		<java classname="edu.wustl.common.util.global.PasswordManager" fork="true">
			<classpath>
				<pathelement path="${temp.dir}/catissuecore/WEB-INF/lib"/>
				<pathelement location="${temp.dir}/catissuecore/WEB-INF/lib/commonpackage.jar"/>
			</classpath>
			<arg value="${base.dir}/catissuetmp.txt"/>
			<arg value="${first.admin.password}"/>
		</java>
		
		<property file="${base.dir}/catissuetmp.txt"/>
			<echo>
					Encoded Password ${first.admin.encodedPassword}
			</echo>

		<echo message="Modifying caTISSUECore SQL file for user information..."/>
			<copy file="${oracle.sql.dir}/createUser.sql" todir="${temp.dir}" overwrite="true"/>

			<replace dir="${temp.dir}" propertyfile="caTissueInstall.properties"> 
				<include name="createUser.sql"/>
				<replacefilter token="@@first.admin.department@@" value="${first.admin.department}"/>
				<replacefilter token="@@first.admin.institution@@" value="${first.admin.institution}"/>
				<replacefilter token="@@first.admin.cancerresearchgroup@@" value="${first.admin.cancerresearchgroup}"/>
				<replacefilter token="@@first.admin.emailAddress@@" value="${first.admin.emailAddress}"/>
				<replacefilter token="@@first.admin.encodedPassword@@" value="${first.admin.encodedPassword}"/>
			</replace>
			
			<copy todir="${oracle.sql.dir}" overwrite="true">
				<fileset dir="${temp.dir}">
					<include name="createUser.sql"/>
				</fileset>
			</copy>	
		<delete dir="${temp.dir}"/>
	</target>
		<target name="mysqlFirstUser">
		<echo message="Encoding Password..."/>
		<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore"/>
	
		<java classname="edu.wustl.common.util.global.PasswordManager" fork="true">
			<classpath>
				<pathelement path="${temp.dir}/catissuecore/WEB-INF/lib"/>
				<pathelement location="${temp.dir}/catissuecore/WEB-INF/lib/commonpackage.jar"/>
			</classpath>
			<arg value="${base.dir}/catissuetmp.txt"/>
			<arg value="${first.admin.password}"/>
		</java>
		
		<property file="${base.dir}/catissuetmp.txt"/>
			<echo>
					Encoded Password ${first.admin.encodedPassword}
			</echo>

		<echo message="Modifying caTISSUECore SQL file for user information..."/>
		<copy file="${common.sql.dir}/createUser.sql" todir="${temp.dir}" overwrite="true"/>

			<replace dir="${temp.dir}" propertyfile="caTissueInstall.properties"> 
				<include name="createUser.sql"/>
				<replacefilter token="@@first.admin.department@@" value="${first.admin.department}"/>
				<replacefilter token="@@first.admin.institution@@" value="${first.admin.institution}"/>
				<replacefilter token="@@first.admin.cancerresearchgroup@@" value="${first.admin.cancerresearchgroup}"/>
				<replacefilter token="@@first.admin.emailAddress@@" value="${first.admin.emailAddress}"/>
				<replacefilter token="@@first.admin.encodedPassword@@" value="${first.admin.encodedPassword}"/>
			</replace>
			
			<copy todir="${common.sql.dir}" overwrite="true">
				<fileset dir="${temp.dir}">
					<include name="createUser.sql"/>
				</fileset>
			</copy>	
		<delete dir="${temp.dir}"/>
	</target>
	
	<target name="deploy_caties_internal" >
		<antcall target="assertforcaties"/>
						<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore"/>
				<copy todir="${caties.installation.dir}/classes">
					<fileset dir="${temp.dir}/catissuecore/WEB-INF/classes" />
				</copy>
				<copy todir="${caties.installation.dir}/catissuecore-properties">
					<fileset dir="${base.dir}/catissuecore-properties" />
				</copy>
				<replace file="${caties.installation.dir}/catissuecore-properties/ApplicationSecurityConfig.xml" propertyfile="${basedir}/caTissueInstall.properties">
					<replacefilter token="@@hibernate-config-file@@" value="./catissuecore-properties/catissuecore.hibernate.cfg.xml"/>	
				</replace>
				<copy file="${base.dir}/CaTIES_conf/hibernate.cfg.xml" todir="${caties.installation.dir}/classes" overwrite="true"/>
				<copy file="${base.dir}/CaTIES_conf/dbutil.properties" todir="${caties.installation.dir}/classes" overwrite="true"/>
				<copy file="${base.dir}/CaTIES_conf/catissuecore.hibernate.cfg.xml" todir="${caties.installation.dir}/catissuecore-properties" overwrite="true"/>
				<if>
					<equals arg1="mysql" arg2="${database.type}"/>
					<then>
						<replace dir="${caties.installation.dir}" propertyfile="${basedir}/caTissueInstall.properties">
							<include name="**/*.cfg.xml" />
							<replacefilter token="@@DRIVER@@" value="${mysql.driver.string}"/>
							<replacefilter token="@@URL@@" value="jdbc:mysql://${database.host}/${database.name}" />
						</replace>
					</then>
				<elseif>
					<equals arg1="oracle" arg2="${database.type}"/>
					<then>
						<replace dir="${caties.installation.dir}" propertyfile="${basedir}/caTissueInstall.properties">
							<include name="**/*.cfg.xml" />
							<replacefilter token="${mysql.dialect.string}" value="${oracle.dialect.string}"/>
							<replacefilter token="@@DRIVER@@" value="${oracle.driver.string}"/>
							<replacefilter token="@@URL@@" value="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" />
						</replace>
					</then>
				</elseif>
				</if>
				<replace dir="${caties.installation.dir}" propertyfile="${basedir}/caTissueInstall.properties">
					<include name="**/*.cfg.xml" />
					<replacefilter token="@@DATABASE_USERNAME@@" value="${database.username}"/>
					<replacefilter token="@@DATABSE_PASSWORD@@" value="${database.password}"/>
					<replacefilter token="@@DATABASE_NAME@@" value="${database.name}"/>
				</replace>
		
				<jar destfile="${caties.installation.dir}/caties.jar" basedir="${caties.installation.dir}/classes" />	
				<delete dir="${caties.installation.dir}/classes" />
				
				<copy todir="${caties.installation.dir}/lib">
					<fileset dir="${temp.dir}/catissuecore/WEB-INF/lib">
						<exclude name="**/*client.jar*"/>
						<exclude name="**/*caTies.jar*"/>
					</fileset>
				</copy>
				<copy file="${temp.dir}/catissuecore/WEB-INF/classes/ApplicationResources.properties" todir="${caties.installation.dir}" overwrite="true"/>
				<copy file="logger.properties" todir="${caties.installation.dir}" overwrite="true"/>
				<copy file="${temp.dir}/catissuecore/CDEConfig.xml" todir="${caties.installation.dir}" overwrite="true"/>
				<copy file="Dataset.dtd" todir="${caties.installation.dir}" overwrite="true"/>
				<copy file="JniDeID.dll" todir="${caties.installation.dir}" overwrite="true"/>
				<copy file="${basedir}/CaTIES_conf/build.xml" todir="${caties.installation.dir}" overwrite="true"/>
				<copy file="${basedir}/CaTIES_conf/sites_configuration.xml" todir="${caties.installation.dir}/CaTIES_conf" overwrite="true"/>	
	</target>
	
	<!-- Configure titli.properties according to caTissueInstall.properties and other set properties -->
	<target name="configure_titli">
		<replace dir="${temp.dir}/catissuecore/WEB-INF/classes" propertyfile="caTissueInstall.properties"> 
			<include name="titli.properties"/>
			<replacefilter token="@@username@@" value="${database.username}"/>
			<replacefilter token="@@password@@" value="${database.password}"/>
			<replacefilter token="@@titliindexlocation@@" value="${jboss.home.dir}/server/default/data/titli-index"/>
			<replacefilter token="@@databasename@@" value="${database.name}"/>
		</replace>
		<!-- conditional configuration of database url and driver names -->
		<if>
			<equals arg1="mysql" arg2="${database.type}"/>		
			<then>
				<replace dir="${temp.dir}/catissuecore/WEB-INF/classes" propertyfile="caTissueInstall.properties"> 
					<include name="titli.properties"/>
					<replacefilter token="@@databasedriver@@" value="${mysql.driver.string}"/>
					<replacefilter token="@@databaseurl@@" value="jdbc:mysql://${database.host}:${database.port}/${database.name}"/>
				</replace>
			</then>
			<elseif>	
				<equals arg1="oracle" arg2="${database.type}"/>		
				<then>
					<replace dir="${temp.dir}/catissuecore/WEB-INF/classes" propertyfile="caTissueInstall.properties"> 
						<include name="titli.properties"/>
						<replacefilter token="@@databaseurl@@" value="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}"/>
						<replacefilter token="@@databasedriver@@" value="${oracle.driver.string}"/>
					</replace>
				</then>
			</elseif>
		</if>
	</target>
	
</project>