<?xml version ="1.0"?>
<!--Ant Script for create Build for caTissue Suite-->

<project name="caTissue Suite v1.2 Installation" default="deploy_app">

	<!--define require dir and Properties -->
	<taskdef resource="net/sf/antcontrib/antcontrib.properties">
		<classpath>
			<pathelement location="./lib/ant-contrib.jar" />
		</classpath>
	</taskdef>
	
	<property environment="env" />
	<import file="build-properties.xml"/>

	<property name="base.dir" value="." />
	<property name="mail.file.dir" value="${base.dir}" />
	<property name="temp.dir" value="./deploytempCatissuecore" />
	<property name="camodel.dir" value="${base.dir}/ca_model" />
	<property name="csm.dir" value="${temp.dir}/tempcsm" />
	<property name="lib.dir" value="${base.dir}/lib" />
	<property name="mysql.sql.dir" value="${base.dir}/SQL/MySql" />
	<property name="dbupgrade.sql.dir" value="${base.dir}/SQL/DBUpgrade" />
	<property name="oracle.sql.dir" value="${base.dir}/SQL/Oracle" />
	<property name="common.sql.dir" value="${base.dir}/SQL/Common" />
	<property name="mssqlserver.sql.dir" value="${base.dir}/SQL/MsSqlServer" />
	<property name="oracle.dialect.string" value="org.hibernate.dialect.Oracle9Dialect" />
	<property name="mysql.dialect.string" value="edu.wustl.catissuecore.hibernate.dialect.MySqlCustomDialect" />
	<property name="catissue.datasource" value="java:/catissuecore" />
	<property name="dynamicextensions.datasource" value="java:/dynamicextensions" />
	<property name="oracle.dialect.h3.string" value="org.hibernate.dialect.Oracle9Dialect" />
	<property name="mysql.dialect.h3.string" value="org.hibernate.dialect.MySqlCustomDialect" />
	<property name="mssqlserver.dialect.string" value="org.hibernate.dialect.SQLServerDialect" />

	<property name="oracle.driver.string" value="oracle.jdbc.driver.OracleDriver" />
	<property name="mysql.driver.string" value="org.gjt.mm.mysql.Driver" />
	<property name="mssqlserver.driver.string" value="com.microsoft.sqlserver.jdbc.SQLServerDriver" />
	<!-- Added for eMPI integration -->
	<property name="db2.driver.string" value="com.ibm.db2.jcc.DB2Driver" />
	<!-- end -->

	<property name="mysql.lib" value="mysql-connector-java-5.0.8-bin.jar" />
	<property name="oracle.lib" value="ojdbc14.jar" />
	<property name="mssqlserver.lib" value="sqljdbc.jar" />

	<property name="catissue.struts.config.file" value="struts-config.xml" />	
	<property name="catissue.hibernate.config.file" value="hibernate.cfg.xml" />
	<property name="catissue.tiles.def.file" value="tiles-defs.xml" />

	
	<property name="oracle_home" value="${env.ORACLE_HOME}"/>
	<property name="jboss.bin.run.jar" value="${rel.jboss.home}/bin/run.jar"/>
	<property name="env.COMPUTERNAME" value="${env.HOSTNAME}"/>

	<property name="mysql.dao.prop.filename" value="MySQLDAOProperties.xml" />
	<property name="oracle.dao.prop.filename" value="OracleDAOProperties.xml" />
	<property name="oracle.dao.datasource.prop.filename" value="OracleDataSourceDAOProperties.xml"/>
	<property name="mysql.dao.datasource.prop.filename" value="MysqlDataSourceDAOProperties.xml"/>
	
	<var name="databaseurl" value="" />

	<property name="tempcacore.dir" value="${base.dir}/temp_deaudit_related_files" />
	<property name="export.dir" value="${tempcacore.dir}/temp_exported_xmi" />
	
	<property name="csm.database.type" value="${database.type}"/>
	<property name="csm.database.host" value="${database.host}"/>
	<property name="csm.database.port" value="${database.port}"/>
	<property name="csm.database.name" value="${database.name}"/>
	<property name="csm.database.username" value="${database.username}"/>
	<property name="csm.database.password" value="${database.password}"/>
	
	<property name="jboss.server.host.port" value="${jboss.server.host}:${jboss.server.port}" />
	<if>
		<equals arg1="" arg2="${jboss.server.port}" />
		<then>
			<var name="jboss.server.host.port" unset="true"/>
			<property name="jboss.server.host.port" value="${jboss.server.host}" />
		</then>
	</if>
	
	<echo message="Setting Global DRIVER and URL Property" />
	<if>
		<equals arg1="mysql" arg2="${database.type}" />
		<then>
			<property name ="final.database.driver" value="${mysql.driver.string}"/>
			<property name="final.database.url" value="jdbc:mysql://${database.host}:${database.port}/${database.name}" />
			<property name="final.csm.database.url" value="jdbc:mysql://${csm.database.host}:${csm.database.port}/${csm.database.name}" />
		</then>

		<elseif>
			<equals arg1="oracle" arg2="${database.type}" />
			<then>
				<property name ="final.database.driver" value="${oracle.driver.string}"/>
				<property name="final.database.url" value="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" />
				<property name="final.csm.database.url" value="jdbc:oracle:thin:@${csm.database.host}:${csm.database.port}:${csm.database.name}" />
			</then>
		</elseif>
	</if>
				
	<!--import file="dbunitbuild.xml"/>
	<target name="dbunit_testcases">
		<antcall target="RundbUnit" />
	</target -->

	<!-- Check for required properties -->
	<target name="assert" description="Check for required properties">
		<if>
			<equals arg1="" arg2="${jboss.home.dir}" />
			<then>
				<fail message="The property 'jboss.home.dir' can not be empty" />
			</then>
			<else>
				<available file="${jboss.bin.run.jar}" property="isJbossValid"/>
				<if>
					<not>
						<equals arg1="true" arg2="${isJbossValid}" />
					</not>
					<then>
						<fail message="'${jboss.home.dir}' is not valid jboss home. Please set valid path for jboss server." />
					</then>
				</if>
			</else>
		</if>
		<if>
			<equals arg1="" arg2="${jboss.server.name}" />
			<then>
				<fail message="The property 'jboss.server.name' can not be empty" />
			</then>
		</if>

		<if>
			<or>
				<equals arg1="mysql" arg2="${database.type}" />
				<equals arg1="oracle" arg2="${database.type}" />
			</or>
			<then />
			<else>
				<fail message="The value of property 'database.type' must be mysql ,oracle" />
			</else>
		</if>

		<!-- Validation for ORACLE_HOME ,tns name and sqlldr if database is oracle-->
		<if>
		<equals arg1="oracle" arg2="${database.type}" />
			<then>
				<available file="${oracle_home}" type="dir" property="IsOracleHomeBlank" />
				<if>
					<not>
					<equals arg1="true" arg2="${IsOracleHomeBlank}" />
					</not>
					<then>
						<fail message="ORACLE_HOME is not set on your server. For windows set oracle_home as environment variable or in linux set in .bash_profile file." />
					</then>
				</if>

				<if>
					<equals arg1="" arg2="${oracle.tns.name}" />
					<then>
						<fail message="The property 'oracle.tns.name' can not be empty" />
					</then>
				</if>
				<trycatch>
					<try>
						<exec executable="tnsping" failonerror="true" >
							<arg value="${oracle.tns.name}"/>
						</exec>
					</try>
					<catch>
						<fail message="'${oracle.tns.name}' is not a valid tns name. Please set valid tns name for property 'oracle.tns.name'." />
					</catch>
				</trycatch>
				<trycatch>
					<try>
						<exec executable="sqlldr" failonerror="true"/>
				 	</try>
					<catch>
						<fail message="'sqlldr' file not found in path. Please make sure this file must be in path." />
					</catch>
				</trycatch>
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${database.host}" />
			<then>
				<fail message="The property 'database.host' can not be empty" />
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${database.port}" />
			<then>
				<fail message="The property 'database.port' can not be empty. Default port for MySQL:3306 ,for Oracle: 1521" />
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${database.name}" />
			<then>
				<fail message="The property 'database.name' can not be empty" />
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${database.username}" />
			<then>
				<fail message="The property 'database.username' can not be empty" />
			</then>
		</if>
		<!-- Mandar 17May06 check for first user -->
		<if>
			<equals arg1="" arg2="${first.admin.department}" />
			<then>
				<fail message="The property 'first.admin.department' can not be empty" />
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${first.admin.institution}" />
			<then>
				<fail message="The property 'first.admin.institution' can not be empty" />
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${first.admin.cancerresearchgroup}" />
			<then>
				<fail message="The property 'first.admin.cancerresearchgroup' can not be empty" />
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${first.admin.emailAddress}" />
			<then>
				<fail message="The property 'first.admin.emailAddress' can not be empty" />
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${first.admin.password}" />
			<then>
				<fail message="The property 'first.admin.password' can not be empty" />
			</then>
		</if>

		<if>
			<equals arg1="" arg2="${email.administrative.emailAddress}" />
			<then>
				<echo>email.adminstartive.emailaddress can be left blank.</echo>
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${email.sendEmailFrom.emailAddress}" />
			<then>
				<echo>email.sendEmailFrom.emailAddress can be left blank.</echo>
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${email.mailServer}" />
			<then>
				<echo>email.mailServer can be left blank.</echo>
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${email.sendEmailFrom.emailPassword}" />
			<then>
				<echo>email.sendEmailFrom.emailPassword can be left blank.</echo>
			</then>
			<else>
				<if>
					<equals arg1="" arg2="${email.mailServer.port}" />
					<then>
						<echo>email.mailServer.port cannot be left blank.</echo>
					</then>
				</if>
				<if>
					<equals arg1="" arg2="${email.smtp.auth.enabled}" />
					<then>
						<echo>email.smtp.auth.enabled cannot be left blank.</echo>
					</then>
				</if>
				<if>
					<equals arg1="" arg2="${email.smtp.starttls.enabled}" />
					<then>
						<echo>email.smtp.starttls.enabled cannot be left blank.</echo>
					</then>
				</if>
			</else>
		</if>
		


		<!-- Check whether JAVA_HOME environment variable set or not -->
		<if>
			<contains string="${env.JAVA_HOME}" substring="env.JAVA_HOME"/>
			<then>
				<fail message="JAVA_HOME is not set. Please make sure to set JAVA_HOME environment variable to the directory of your local JDK." />
			</then>
		</if>
		
		<if>
			<equals arg1="true" arg2="${cider.integration.enabled}" casesensitive="false" />
			<then>
				<if>
							<equals arg1="" arg2="${cider.outbound.queue}" />
							<then>
								<fail message="The property 'cider.outbound.queue' can not be empty" />
							</then>
						</if>
						<if>
							<equals arg1="" arg2="${cider.wmq.channel}" />
							<then>
								<fail message="The property 'cider.wmq.channel' can not be empty" />
							</then>
						</if>

						<if>
							<equals arg1="" arg2="${cider.wmq.mgr.name}" />
							<then>
								<fail message="The property 'cider.wmq.mgr.name' can not be empty" />
							</then>
						</if>
						<if>
							<equals arg1="" arg2="${cider.wmq.port}" />
							<then>
								<fail message="The property 'cider.wmq.port' can not be empty" />
							</then>
						</if>
						<if>
							<equals arg1="" arg2="${cider.wmq.server.name}" />
							<then>
								<fail message="The property 'cider.wmq.server.name' can not be empty" />
							</then>
						</if>
				
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${load.balancer.url}" />
			<then>
				<fail message="The property 'load.balancer.url' can not be empty" />
			</then>
		</if>
	</target>

	<!--Target for validation of connection parameters-->
	<target name="validate_database_connection" description="Target for validation of connection parameters">
		<!-- validation for database connection -->
		<trycatch>
        	<try>
					<if>
						<equals arg1="mysql" arg2="${database.type}" />
						<then>
							<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" password="${database.password}">
									<transaction>select 1;</transaction>
									<transaction>commit;</transaction>
									<classpath>
									  <fileset dir="${lib.dir}">
									 	<include name="*.jar" />
									  </fileset>
									</classpath>
							</sql>
						</then>
						<elseif >
							<equals arg1="oracle" arg2="${database.type}" />
							<then>
								<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle">
									<transaction>select sysdate from dual;</transaction>
									<transaction>commit;</transaction>
										<classpath>
											<fileset dir="${lib.dir}">
												<include name="*.jar" />
											</fileset>
										</classpath>
								</sql>
							</then>
						</elseif>

				</if>
		</try>
		<catch>
			<fail message="Connection fails.Please check the database configuration parameters like database.host,database.port,database.name etc.  " />
		</catch>
	</trycatch>
	</target>
	<target name="configure_contactus" description="configure email address for contactus property">
		<replace dir="${temp.dir}/catissuecore-properties" propertyfile="caTissueInstall.properties">
			<include name ="ContactUs.txt"/>
			<replacefilter token="@@SUPPORTEMAIL@@" value="${email.administrative.emailAddress}"/>
		</replace>
	</target>
	<!--Extrct WAR and copy Configuration files to temp directory-->
	<target name="init" description="Extrct WAR and copy Configuration files to temp directory">
		<echo message="Initializing installation..." />

		<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore" />
		<unjar src="${temp.dir}/catissuecore/WEB-INF/lib/DynamicExtensions.jar" dest="${temp.dir}/dynamicExtensionsjar" />
		<unzip src="${base.dir}/dynamicextensions.zip" dest="${temp.dir}/dynamicextensions" overwrite="true" />
		<echo message="Copying email-templates to WEB-INF/classes" />	
		
		<copy todir="${temp.dir}/catissuecore-properties/ng-email-templates" overwrite="true">
			<fileset dir="${base.dir}/WEB-INF/resources/email-templates"/>
		</copy>
		
		<antcall target="configure_log4j" />
		<antcall target="configure_appResources" />

		<antcall target="configure_contactus" />
		<copy file="openspecimen-ds.xml" todir="${temp.dir}" overwrite="true" />

		<if>
		   <not>
				<equals arg1="" arg2="${theam.css.path}" />
			</not>
			<then>
				<copy file="${theam.css.path}" tofile="${temp.dir}/catissuecore/css/login-theam.css" overwrite="true" />
			</then>
		</if>
		
		<!-- if>
			<not>
				<equals arg1="" arg2="${institute.logo.path}" />
			</not>
			<then>
				<copy file="${institute.logo.path}" todir="${temp.dir}/catissuecore/images" overwrite="true" />
			</then>
		</if -->
		
	</target>
	<target name="configure_appResources" description="Configure ApplicationResources.properties">
		<replace dir="${temp.dir}/catissuecore/WEB-INF/classes" propertyfile="caTissueInstall.properties">
			<include name ="ApplicationResources.properties"/>
			<replacefilter token="@@institute.logo.path@@" value="${institute.logo.path}"/>
		</replace>
	</target>

	<target name="configure_log4j" description="Configure log4j.properties">
		<replace dir="${temp.dir}/catissuecore-properties" propertyfile="caTissueInstall.properties">
			<include name ="log4j.properties"/>
			<replacefilter token="@@jbosshome@@" value="${jboss.server.url}"/>
		</replace>
	</target>

	<!--Modify Configuration such as Session Timeout, Admin details and JBoss server port-->
	<target name="configure_war" description="Modify Configuration such as Session Timeout, Admin details and JBoss server port">
		<echo message="Modifying caTissueCore Configuration File..." />

		<replace file="${temp.dir}/catissuecore/WEB-INF/web.xml">
			<replacefilter token="&lt;session-timeout>30&lt;/session-timeout>" value="&lt;session-timeout>${session.timeout}&lt;/session-timeout>" />
		</replace>

		<!--<replace file="${temp.dir}/catissuecore/WEB-INF/classes/remoteService.xml">
			<replacefilter token="@@server.port@@" value="${jboss.server.port}"/>
		</replace>-->

	</target>


	<!--Modify Adopter's Institution images, URL of Institution website and Contact Us, Privacy Notice, Disclaimer, Accessibility Text Files-->
	<target name="adopter_configuration" description="Modify Adopter's Institution images, URL of Institution website and Contact Us, Privacy Notice, Disclaimer, Accessibility Text Files">
		<echo message="Updating Site Images" />
	</target>

	<!--Modify Configuration For MySQL-->
	<target name="mysql_config" description="Modify Configuration For MySQL">
		<echo message="Modifying caTissue Suite MySQL specific Configuration File..." />

		<replace dir="${temp.dir}/catissuecore-properties" propertyfile="caTissueInstall.properties">
			<include name="upt.hibernate.cfg.xml" />
			<include name="catissuecore.hibernate.cfg.xml" />
			<replacefilter token="@@dialect@@" value="${mysql.dialect.string}" />
		</replace>
		<!-- added for csm orm1.cfg.xml file-->
		<replace dir="${temp.dir}/catissuecore/WEB-INF/classes" propertyfile="caTissueInstall.properties">
			<include name="orm1.cfg.xml" />
			<replacefilter token="@@dialect@@" value="${mysql.dialect.h3.string}" />
		</replace>
		
		<replace dir="${temp.dir}" propertyfile="caTissueInstall.properties">
		        <include name="openspecimen-ds.xml" />
		        <replacefilter token="@@databaseurl@@" value="jdbc:mysql://${database.host}:${database.port}/${database.name}" />
		        <replacefilter token="@@username@@" value="${database.username}" />
		        <replacefilter token="@@pasword@@" value="${database.password}" />
		        <replacefilter token="@@databasedriver@@" value="${mysql.driver.string}" />
		</replace>

		<replace file="${temp.dir}/catissuecore/WEB-INF/classes/hibernate.cfg.xml">
			<replacefilter token="${mysql.dialect.string}" value="${mysql.dialect.string}" />
		</replace>



	</target>

	<!--Modify Configuration For Oracle-->
	<target name="oracle_config" description="Modify Configuration For Oracle">
		<echo message="Modifying caTissue Suite Oracle specific Configuration File..." />
		<replace dir="${temp.dir}/catissuecore-properties" propertyfile="caTissueInstall.properties">
			<include name="upt.hibernate.cfg.xml" />
			<include name="catissuecore.hibernate.cfg.xml" />
			<replacefilter token="@@dialect@@" value="${oracle.dialect.string}" />
		</replace>


		<!-- added for csm orm1.cfg.xml file-->
		<replace dir="${temp.dir}/catissuecore/WEB-INF/classes" propertyfile="caTissueInstall.properties">
			<include name="orm1.cfg.xml" />
			<replacefilter token="@@dialect@@" value="${oracle.dialect.h3.string}" />
		</replace>
		
		<replace dir="${temp.dir}" propertyfile="caTissueInstall.properties">
		        <include name="openspecimen-ds.xml" />
		        <replacefilter token="@@databaseurl@@" value="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" />
		        <replacefilter token="@@username@@" value="${database.username}" />
		        <replacefilter token="@@pasword@@" value="${database.password}" />
		        <replacefilter token="@@databasedriver@@" value="${oracle.driver.string}" />
		</replace>

		<replace file="${temp.dir}/catissuecore/WEB-INF/classes/hibernate.cfg.xml">
			<replacefilter token="${mysql.dialect.string}" value="${oracle.dialect.string}" />
		</replace>

	</target>

	<!--Server clean-up-->

	<target name="clean_server" description="deletes the WAR file and cache from server, clean-up the server ">
		<delete file="${jboss.server.url}/deploy/catissuecore.war" />
		<delete file="${jboss.server.url}/deploy/openspecimen.war" />
		<delete file="${jboss.server.url}/deploy/cas.war" quiet="true"/>
		<delete file="${jboss.server.url}/deploy/dynamicExtensions.war" />
		<delete file="${jboss.server.url}/deploy/pathologySCG.war" />
		<delete file="${jboss.server.url}/deploy/pathologySpecimen.war" />
		<delete file="${jboss.server.url}/deploy/CA.war" />
		<delete file="${jboss.server.url}/deploy/deintegration.war" />
		<mkdir dir="${jboss.server.url}/work"/>
		<mkdir dir="${jboss.server.url}/tmp"/>
		<delete includeemptydirs="true">
			<fileset dir="${jboss.server.url}/work">
				<include name="**/*" />
			</fileset>
		</delete>
		<delete includeemptydirs="true">
			<fileset dir="${jboss.server.url}/tmp">
				<include name="**/*" />
			</fileset>
		</delete>
	</target>

	<!--Buid New WAR File-->
	<target name="build_war" description="Buid New WAR File">
		<echo message="Creating New Web Application Archieve File..." />
		<delete file="${temp.dir}/catissuecore.war" />
		<delete file="${temp.dir}/dynamicExtensions.jar" />

		<antcall target="copydeletedjars">
			<param name="delPath" value="${temp.dir}/catissuecore/WEB-INF/lib"/>
		</antcall>
		<copy file="${base.dir}/lib/liquibase.jar" todir="${temp.dir}/catissuecore/WEB-INF/lib"/>
		<copy file="${base.dir}/WEB-INF/resources/application.properties" todir="${temp.dir}/catissuecore/WEB-INF/classes"/>
		<replace file="${temp.dir}/catissuecore/WEB-INF/classes/application.properties">
			<replacefilter token="@@datasourcejndi@@" value="${datasource.jndi}" />
			<replacefilter token="@@datasourcetype@@" value="${datasource.type}" />
		</replace>
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<replace file="${temp.dir}/catissuecore/WEB-INF/classes/application.properties">
					<replacefilter token="@@datasource.dialect@@" value="${mysql.dialect.string}" />
				</replace>
			</then>

			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<replace file="${temp.dir}/catissuecore/WEB-INF/classes/application.properties">
						<replacefilter token="@@datasource.dialect@@" value="${oracle.dialect.string}" />
					</replace>
				</then>
			</elseif>
		</if>

		<war destfile="${temp.dir}/catissuecore.war"
			webxml="${temp.dir}/catissuecore/WEB-INF/web.xml" manifest="${base.dir}/MANIFEST.MF">
			<fileset dir="${temp.dir}/catissuecore">
				<exclude name="**/*build*" />
				<exclude name="**/*WEB-INF*" />
				<exclude name="**/*servlet.jar*" />
				<exclude name="**/*jta.jar*" />
				<exclude name="**/WEB-INF/lib/log4j-1.2.9.jar*" />
				<exclude name="**/*hibernate2.jar*" />
				<exclude name="**/.*" />
				<exclude name="**/*.sql" />
				<exclude name="**/CVS*" />
				<exclude name="**/jta.jar" />
				<!--excluded for jboss-5.1.0.GA upgrade-->				
								<exclude name="**/WEB-INF/lib/xalan.jar" />
								<exclude name="**/WEB-INF/lib/xbean.jar" />
								<exclude name="**/WEB-INF/lib/xercesImpl-1.0.jar" />
								<exclude name="**/WEB-INF/lib/xercesImpl.jar" />
								<exclude name="**/WEB-INF/lib/xml-apis.jar" />
								<exclude name="**/WEB-INF/lib/xmlrpc-2.0.jar" />
								<exclude name="**/WEB-INF/lib/scrubber-runtime.jar" />
								<exclude name="**/WEB-INF/lib/jax-qname.jar" />
								<exclude name="**/WEB-INF/lib/dom4j-1.6.jar" />
								<exclude name="**/WEB-INF/lib/jce-jdk13-125.jar" />
								<exclude name="**/WEB-INF/lib/jaas.jar" />
								<exclude name="**/WEB-INF/lib/jsr173_api.jar" />
								<exclude name="**/WEB-INF/lib/namespace.jar" />
								<exclude name="**/WEB-INF/lib/${mysql.lib}" />
								<exclude name="**/WEB-INF/lib/${oracle.lib}" />
								<exclude name="**/WEB-INF/lib/serializer.jar" />
				<exclude name="**/WEB-INF/lib/j2ee-1.0.jar" />
			</fileset>
		</war>


		<!-- <war destfile="${temp.dir}/caTissuePrintWebService.war" webxml="${temp.dir}/caTissuePrintWebService/WEB-INF/web.xml">
					<fileset dir="${temp.dir}/caTissuePrintWebService">
						<include name="**/**/**.*" />
					</fileset>
		</war>  -->

	</target>


	<target name="copydeletedjars" description="this will delete the unneccessary jar files">
	<delete >

		<fileset dir="${delPath}">
			<include name="backport-util-concurrent-3.0.jar" />
			<include name="c3p0-0.8.4.5.jar" />
			<include name="c3p0-0.8.5.2.jar" />
			<include name="castor-1.0.2.jar" />
			<include name="cglib-2.1.jar" />
			<include name="commons-collections-2.1.1.jar" />
			<include name="commons-collections-3.1.jar" />
			<include name="commons-discovery-0.2.jar" />
			<include name="commons-fileupload.jar" />
			<include name="commons-lang-2.1.jar" />
			<include name="commons-logging-1.0.4.jar" />
			<!--<include name="dom4*.jar" />-->
			<include name="freemarker.jar" />
			<include name="jakarta-oro.jar" />
			<include name="uml-1.3.jar" />
			<include name="wsdl4j-1.5.1.jar" />
			<include name="xalan-2.4.0.jar" />
			<include name="p6spy.jar" />
			<include name="sdkClient.jar" />
			<include name="uuid-key-generator.jar" />
			<include name="wsdl4j.jar" />
			<include name="j2ee.jar" />
			<include name="caGrid-1.0-caDSR-client.jar" />
			<include name="caGrid-1.0-caDSR-common.jar" />
			<include name="caGrid-1.0-caDSR-stubs.jar" />
			<include name="caGrid-1.0-core.jar" />
			<include name="caGrid-1.0-data-common.jar" />
			<include name="caGrid-1.0-data-stubs.jar" />
			<include name="caGrid-1.0-data-utils.jar" />
			<include name="caGrid-1.0-fqp-client.jar" />
			<include name="caGrid-1.0-fqp-common.jar" />
			<include name="caGrid-1.0-fqp-stubs.jar" />
			<include name="caGrid-1.0-metadata-common.jar" />
			<include name="caGrid-1.0-metadata-security.jar" />
			<include name="caGrid-1.0-sdkQuery.jar" />
			<include name="caGrid-1.0-ServiceSecurityProvider-client.jar" />
			<include name="caGrid-1.0-ServiceSecurityProvider-common.jar" />
			<include name="jboss-common-jdbc-wrapper.jar"/>
			<include name="mysql-connector-java-3.1.13-bin.jar"/>
			<include name="oracleDriver.jar"/>
			<include name="boot.jar" />
			<!--<include name="c3p0-0.9.0.jar" />-->
			<include name="catissuecore-client.jar" />
			<include name="experiment-client.jar" />
			<!-- include name="jboss-client.jar" /
			<include name="junit-4.1.jar" />-->
			<include name="mockobjects-core-0.09.jar" />
			<include name="mysql-connector-java-5.0.8-bin.jar" />
			<include name="ojdbc14.jar" />
			<include name="openide-util.jar" />
			<include name="acrobat-core.jar" />
			<!-- removed to work printwebservice -->
			<include name="jaxrpc.jar" />
			<include name="saaj.jar" />
			<include name="jboss-jaxws.jar" />

		</fileset>

	</delete>
</target>
	<!--Copy WAR and Configuration Files to JBOSS Directory-->
	<target name="Configure_Printservice" description="Copy WAR and Configuration Files to JBOSS Directory">
	 <if>
	   <and>
		 <equals arg1="" arg2="${jboss.server.host}" />
		 <equals arg1="" arg2="${jboss.container.secure}"/>
		 <equals arg1="" arg2="${jboss.server.port}"/>
		</and>
	 <then>
	 	<replace file="${temp.dir}/catissuecore-properties/PrintServiceImplementor.properties">
		<replacefilter token="http://localhost:8080/" value="https://${jboss.server.host}:${jboss.server.port}/" />
		</replace>
	</then>
	</if>
	</target>

	<target name="copy_files" description="copy Configuration Files to JBOSS Directory">
		<echo message="Copying caTissue Suite Application Components..." />
		<copy todir="${jboss.server.url}/deploy" overwrite="true">
			<fileset dir="${temp.dir}">
				<include name="openspecimen-ds.xml" />
			</fileset>
		</copy>
		
		<copy todir="${jboss.server.url}/deploy" overwrite="true">
			<fileset dir="${temp.dir}"/>
				<globmapper from="catissuecore.war" to="openspecimen.war"/>
		</copy>

		<if>
					<equals arg1="true" arg2="${install.db.driver}" />
						<then>
							<copy todir="${jboss.server.url}/lib" overwrite="true">
										<fileset dir="${lib.dir}">
											<include name="${mysql.lib}" />
											<include name="${oracle.lib}" />
										</fileset>
									</copy>							
						</then>
		</if>
		
		<delete file="${jboss.server.url}/lib/oracleDriver.jar" casesensitive="false"/>
		<!-- added for printwebservice -->
		<copy todir="${rel.jboss.home}/server/default/lib" overwrite="true">
		   <fileset dir="${rel.jboss.home}/client">
				<include name="policy.jar" />
				<include name="jbossws-client.jar" />
				<include name="wsdl4j.jar" />
		        <include name="jboss-common-client.jar" />
		   </fileset>
		</copy>
		
	</target>
	<target name="deploy_ca_model_war" description="deploy the ca_model_war">
		<antcall target="CopyCAModelWars"/>
	</target>

	<path id="liquibaseClasspath">
		<fileset dir="${lib.dir}" includes="*.jar" />
	</path>
	<path id="deLiquibaseClasspath">
		<fileset dir="${lib.dir}" includes="*.jar" />
                <pathelement path="${temp.dir}/dynamicextensions/db/liquibase"/>
	</path>
	<taskdef resource="liquibasetasks.properties">
		<classpath>
			<pathelement location="${lib.dir}/liquibase.jar" />
		</classpath>
	</taskdef>

	<target name="upgrade_db_to_plus_v10">
		<echo message="Upgrading DataBase with URL ${final.database.url}" />	
		<updateDatabase changeLogFile="${base.dir}/SQL/liquibase_xml/DBUpgrade_v10.xml" driver="${final.database.driver}" url="${final.database.url}" username="${database.username}" password="${database.password}" dropFirst="false" classpathref="liquibaseClasspath" />
	</target>
	<target name="upgrade_db_to_plus_v20">
			<echo message="Upgrading DataBase with URL ${final.database.url}" />	
			<updateDatabase changeLogFile="${base.dir}/SQL/liquibase_xml/DBUpgrade_v20.xml" driver="${final.database.driver}" url="${final.database.url}" username="${database.username}" password="${database.password}" dropFirst="false" classpathref="liquibaseClasspath" />
	</target>
	<target name="liquibase_upgrade_target">
		<echo message="Upgrading DB using Liquibase Targets"/>
		<antcall target="upgrade_db_to_plus_v10"/>
		<antcall target="upgrade_db_to_plus_v20"/>
	</target>
	<target name="upgrade_db_plusv3.1">
		<echo message="Upgrading DataBase with URL ${final.database.url}" />	
		<updateDatabase changeLogFile="${base.dir}/SQL/liquibase_xml/DBUpgrade_v31.xml" driver="${final.database.driver}" url="${final.database.url}" username="${database.username}" password="${database.password}" dropFirst="false" classpathref="liquibaseClasspath" />
	</target>
	<target name="upgrade_db_plusv3.2">
           <echo message="Upgrading DataBase with URL ${final.database.url}" />    
           <updateDatabase changeLogFile="${base.dir}/SQL/liquibase_xml/DBUpgrade_v32.xml" driver="${final.database.driver}" url="${final.database.url}" username="${database.username}" password="${database.password}" dropFirst="false" classpathref="liquibaseClasspath" />
   </target>
   <target name="upgrade_db_plusv3.3">
                        <echo message="Upgrading DataBase with URL ${final.database.url}" /> 
                        <updateDatabase changeLogFile="${base.dir}/SQL/liquibase_xml/DBUpgrade_v33.xml" driver="${final.database.driver}" url="${final.database.url}" username="${database.username}" password="${database.password}" dropFirst="false" classpathref="liquibaseClasspath" />
    </target>
       <target name="upgrade_db_plusv4.0">
               <echo message="Upgrading DataBase with URL ${final.database.url}" />    
               <antcall target="upgrade_de_db"/>
               <updateDatabase changeLogFile="${base.dir}/SQL/liquibase_xml/DBUpgrade_v40.xml" driver="${final.database.driver}" url="${final.database.url}" username="${database.username}" password="${database.password}" dropFirst="false" classpathref="liquibaseClasspath" />
               <antcall target="import_queries"/>
	       <antcall target="migrate_forms"/>
       </target>

    <target name="upgrade_db_os_v1.1">
      <updateDatabase 
        changeLogFile="${base.dir}/SQL/liquibase_xml/db-os-changelog-1.1.xml" 
        driver="${final.database.driver}" 
        url="${final.database.url}" 
        username="${database.username}" 
        password="${database.password}" 
        dropFirst="false" 
        classpathref="liquibaseClasspath" />

      <antcall target="migrate_specimen_events"/>
    </target>

    <target name="upgrade_db_os_v2.0">
    	<updateDatabase
    	changeLogFile="${base.dir}/WEB-INF/resources/db/db-os-changelog-2.0.xml"
    	driver="${final.database.driver}"
    	url="${final.database.url}"
    	username="${database.username}"
    	password="${database.password}"
    	dropFirst="false"
    	classpathref="liquibaseClasspath" />

      <updateDatabase 
        changeLogFile="${base.dir}/WEB-INF/resources/db/db-os-config-2.0.xml"
        driver="${final.database.driver}" 
        url="${final.database.url}" 
        username="${database.username}" 
        password="${database.password}" 
        dropFirst="false" 
        classpathref="liquibaseClasspath" />
    	
      <updateDatabase 
        changeLogFile="${base.dir}/WEB-INF/resources/db/db-os-seed-data-2.0.xml"
        driver="${final.database.driver}" 
        url="${final.database.url}" 
        username="${database.username}" 
        password="${database.password}" 
        dropFirst="false" 
        classpathref="liquibaseClasspath" />
    </target>
	
       <target name="upgrade_de_db">
           <delete dir="${temp.dir}/dynamicextensions" failonerror="no"/>
           <mkdir dir="${temp.dir}/dynamicextensions"/>
           <unzip src="dynamicextensions.zip" dest="${temp.dir}/dynamicextensions"/>
           <updateDatabase 
               changeLogFile="${temp.dir}/dynamicextensions/db/liquibase/db.changelog-master.xml" 
               driver="${final.database.driver}" 
               url="${final.database.url}" 
               username="${database.username}"
               password="${database.password}"
               dropFirst="false"
               classpathref="deLiquibaseClasspath"/>
       </target>

	<target name="liquibase_upgrade_from_plusv1.0_to_plusv2.0">
			<echo message="Upgrading DB using Liquibase Targets"/>
			<antcall target="upgrade_db_to_plus_v20"/>
	</target>
	<!--Target call for both fresh deployment and database creation-->
	<target name="deploy_all" description="Target call for both fresh deployment and database creation">
		<antcall target="assert" />
		<tstamp>
		      <format property="time" pattern="MM/dd/yyyy hh:mm:ss aa"
		          />
		    </tstamp>
		    <echo>before deploy_db: ${time}</echo>

		<antcall target="deploy_db" /> 
		<tstamp>
		      <format property="time2" pattern="MM/dd/yyyy hh:mm:ss aa"
		            />
		    </tstamp>
		    <echo>after deploy_db: ${time2}</echo>

		<tstamp>
				      <format property="time_deploy_app" pattern="MM/dd/yyyy hh:mm:ss aa"
				          />
				    </tstamp>
				    <echo>before deploy_app: ${time_deploy_app}</echo>
		<antcall target="deploy_app" />

		<tstamp>
						      <format property="time_deploy_app_after" pattern="MM/dd/yyyy hh:mm:ss aa"
						         />
						    </tstamp>
						    <echo>after deploy_app: ${time_deploy_app_after}</echo>

		<antcall target="server_security" />
		<!-- Configure the IIS properties, if configure.IIS.properties is 'true'. -->
		<if>
			<equals arg1="${configure.IIS.properties}" arg2="true" />
			<then>
				<antcall target="configure_IIS_properties" />
			</then>
		</if>
	</target>

	<!--Target for checking server security -->
		<target name="server_security" description="Target for checking server security">
			<copy file="${rel.jboss.home}/server/default/deploy/jmx-console.war/WEB-INF/web.xml"
						tofile="${temp.dir}/web.xml" >
			</copy>
				<concat destfile="${temp.dir}/web1.xml" >
					<filelist dir="${temp.dir}" files="web.xml"/>
						<filterchain>
							<headfilter lines="98"/>
						</filterchain>
				</concat>
				<concat destfile="${temp.dir}/web2.xml" >
					<filelist dir="${temp.dir}" files="web.xml"/>
						<filterchain>
							<headfilter lines="27" skip="98"/>
								<tokenfilter>
								 	<replacestring from="-->" to=""/>
								</tokenfilter>
								<tokenfilter>
								 	<replacestring from="console." to="console.-->"/>
								</tokenfilter>
						</filterchain>
			     </concat>
				 <concat destfile="${temp.dir}/web1.xml" append="true">
					 <filelist dir="${temp.dir}" files="web2.xml"/>
				 </concat>
			<copy file="${temp.dir}/web1.xml" tofile="${temp.dir}/web.xml" overwrite="true"/>
			<copy file="${temp.dir}/web.xml"
						tofile="${rel.jboss.home}/server/default/deploy/jmx-console.war/WEB-INF/web.xml" overwrite="true"/>

			<copy file="${rel.jboss.home}/server/default/deploy/jmx-console.war/WEB-INF/jboss-web.xml"
						tofile="${temp.dir}/jboss-web.xml" >
			</copy>
				<concat destfile="${temp.dir}/web3.xml" >
					<filelist dir="${temp.dir}" files="jboss-web.xml"/>
						<filterchain>
							<headfilter lines="7" />
								<tokenfilter>
									<replacestring from="-->" to=""/>
								</tokenfilter>
								<tokenfilter>
									<replacestring from="users." to="users.-->"/>
								</tokenfilter>
						</filterchain>
				</concat>
			<copy file="${temp.dir}/web3.xml" tofile="${temp.dir}/jboss-web.xml" overwrite="true"/>
			<copy file="${temp.dir}/jboss-web.xml"
						tofile="${rel.jboss.home}/server/default/deploy/jmx-console.war/WEB-INF/jboss-web.xml" overwrite="true"/>
		</target>

	<target name="pre_initialization" description="initialisation prior to deploying application">
		<antcall target="clean_server" />
		<antcall target="assert" />
		<delete dir="${temp.dir}" />
		<antcall target="init" />
		<antcall target="configure_war" />
		<antcall target="adopter_configuration" />
	</target>

	<target name="db_configuration" description="for database configuration">
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="mysql_config" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="oracle_config" />

				</then>
			</elseif>

		</if>
		<if>
			<equals arg1="${idp.enabled}" arg2="true" />
			<then>
				<antcall target="IdPWarConfig" />
			</then>
			<else>
				<echo message="IdP is not enabled" />
			</else>
		</if>
			
	</target>
	
	<target name="IdPWarConfig">
			<antcall target="configure_log4j">
			</antcall>

			<delete file="${temp.dir}/PasswordManger.properties">
			</delete>
			<copy file="${base.dir}/catissuecore-properties/IdPConfigure.xml"
				tofile="${temp.dir}/catissuecore-properties/IdPConfigure.xml"
				overwrite="true" />
			<antcall target="encode_pwd_For_IDPConfigureXML">
				<param name="pwd_file" value="${temp.dir}/encode_catissu_Pwd.txt" />
				<param name="pwd_key" value="catissue_db_pwd" />
				<param name="pwd_value" value="${database.password}" />
			</antcall>
			<delete file="${temp.dir}/encode_catissue_Pwd.txt">
			</delete>
			<antcall target="encode_pwd_For_IDPConfigureXML">
				<param name="pwd_file" value="${temp.dir}/encode_clin_Pwd.txt" />
				<param name="pwd_key" value="clinportal_db_pwd" />
				<param name="pwd_value" value="${clinportal.database.password}" />
			</antcall>
			<delete file="${temp.dir}/encode_clin_Pwd.txt">
			</delete>
			<antcall target="encode_pwd_For_IDPConfigureXML">
				<param name="pwd_file" value="${temp.dir}/encode_CSM_Pwd.txt" />
				<param name="pwd_key" value="csm_db_pwd" />
				<param name="pwd_value" value="${csm.database.password}" />
			</antcall>
			<delete file="${temp.dir}/encode_CSM_Pwd.txt">
			</delete>

			<property file="${temp.dir}/PasswordManger.properties" />
			<replace dir="${temp.dir}/catissuecore-properties" propertyfile="caTissueInstall.properties">
				<include name="IdPConfigure.xml" />

				<replacefilter token="@@clinportal.database.type@@"
					value="${clinportal.database.type}" />
				<replacefilter token="@@clinportal.database.name@@"
					value="${clinportal.database.name}" />
				<replacefilter token="@@clinportal.database.host@@"
					value="${clinportal.database.host}" />
				<replacefilter token="@@clinportal.database.username@@"
					value="${clinportal.database.username}" />
				<replacefilter token="@@clinportal.database.password@@"
					value="${clinportal_db_pwd}" />
				<replacefilter token="@@clinportal.database.port@@"
					value="${clinportal.database.port}" />

				<replacefilter token="@@catissuecore.database.type@@"
					value="${database.type}" />
				<replacefilter token="@@catissuecore.database.name@@"
					value="${database.name}" />
				<replacefilter token="@@catissuecore.database.host@@"
					value="${database.host}" />
				<replacefilter token="@@catissuecore.database.username@@"
					value="${database.username}" />
				<replacefilter token="@@catissuecore.database.password@@"
					value="${catissue_db_pwd}" />
				<replacefilter token="@@catissuecore.database.port@@"
					value="${database.port}" />

				<replacefilter token="@@csm.database.type@@" value="${csm.database.type}" />
				<replacefilter token="@@csm.database.name@@" value="${csm.database.name}" />
				<replacefilter token="@@csm.database.host@@" value="${csm.database.host}" />
				<replacefilter token="@@csm.database.username@@" value="${csm.database.username}" />
				<replacefilter token="@@csm.database.password@@" value="${csm_db_pwd}" />
				<replacefilter token="@@csm.database.port@@" value="${csm.database.port}" />
			</replace>

			<if>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<replace dir="${temp.dir}/catissuecore-properties"
						propertyfile="caTissueInstall.properties">
						<include name="IdPConfigure.xml" />
						<replacefilter token="@@clinportal.database.driverURL@@"
							value="${oracle.driver.string}" />
						<replacefilter token="@@catissuecore.database.driverURL@@"
							value="${oracle.driver.string}" />
						<replacefilter token="@@csm.database.driverURL@@"
							value="${oracle.driver.string}" />
					</replace>
				</then>
				<elseif>
					<equals arg1="mysql" arg2="${database.type}" />
					<then>
						<replace dir="${temp.dir}/catissuecore-properties"
							propertyfile="caTissueInstall.properties">
							<include name="IdPConfigure.xml" />
							<replacefilter token="@@clinportal.database.driverURL@@"
								value="${mysql.driver.string}" />
							<replacefilter token="@@catissuecore.database.driverURL@@"
								value="${mysql.driver.string}" />
							<replacefilter token="@@csm.database.driverURL@@"
								value="${mysql.driver.string}" />
						</replace>
					</then>
				</elseif>
			</if>
			<delete file="${temp.dir}/PasswordManger.properties">
			</delete>
		</target>
	
	<!--
			Encodes given password and write in passwordManager.properties file
		-->
		<target name="encode_pwd_For_IDPConfigureXML">
			<property file="${temp.dir}/PasswordManger.properties" />
			<java classname="edu.wustl.common.util.global.PasswordManager"
				fork="true">
				<classpath>
					<pathelement location="${temp.dir}/catissuecore/WEB-INF/classes" />
					<fileset dir="${temp.dir}/catissuecore/WEB-INF/lib">
						<include name="*.jar" />
					</fileset>
				</classpath>
				<arg value="${pwd_file}" />
				<arg value="${pwd_value}" />
			</java>

			<property file="${pwd_file}" />
			<propertyfile file="${temp.dir}/PasswordManger.properties">
				<entry key="${pwd_key}" value="${first.admin.encodedPassword}" />
			</propertyfile>
		</target>



	<target name="app_configuration" description="configure titli.properties">
		<!-- configure titli.properties -->
		 <antcall target="configure_keyword_search" >
		 	<param name="tempPath" value="${temp.dir}/catissuecore/WEB-INF/classes"/>
			<param name="mysqlDriver" value="org.gjt.mm.mysql.Driver"/>
		</antcall>
		<replace file="${temp.dir}/catissuecore/WEB-INF/classes/ApplicationResources.properties">
							<replacefilter token="@@app.version@@" value="${app.version}" />
						</replace>
   </target>

	<!--Start of Integrating the Bulk Operation Module  -->

	<target name="unzip_bulkoperation_installable" depends="bulkoperation_check_prerequisite" description="unzip the bulk operation zip">
		<unzip src="bulkoperator.zip" dest="${temp.dir}/bulkoperation" overwrite="true" />
	</target>

	<target name="integrate_bulk_operation_mysql" description="Executes the Bulk Operation Mysql commands.">
		<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" 
			password="${database.password}">
			<transaction src="${mysql.sql.dir}/bulkoperator/CREATE_BULK_OPERATION_TABLES_FOR_MYSQL.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>

	<target name="integrate_bulk_operation_oracle" description="Executes the Bulk Operation Oracle commands.">
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" 
			userid="${database.username}" password="${database.password}" rdbms="oracle">
			<transaction src="${oracle.sql.dir}/bulkoperator/CREATE_BULK_OPERATION_TABLES_FOR_ORACLE.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>

	<target name="bulkoperation_check_prerequisite" description="Check bulkoperation.zip file exists or not in base directory">
		<!--
			Check bulkoperation.zip file exists or not in base
			directory.
		-->
		<available file="${base.dir}/bulkoperator.zip" property="file.exists" value="false" />
		<if>
			<not>
				<isset property="file.exists" />
			</not>
			<then>
				<echo
					message="bulkoperation.zip file not found. It should be in base directory to deploy Bulk Operation."
					level="error" />
			</then>
			<else>
			   <echo message="Bulk Operation is ready to use."/>
			</else>
		</if>
	</target>

	<!--End of Integrating the Bulk Operation Module  -->

	<!--Start of Integrating the Advance Query Module  -->
	<target name="integrate_advanced_query" description="Start of Integrating the Advance Query Module">
		
	</target>
	<!--End of Integrating the Advance Query Module  -->
	
	<target name="jboss_configuration" description="configuring jboss">
		<antcall target="copy_files" />
	</target>

		<!--Target for fresh deployment of caTissue application-->
	<target name="deploy_app_catissue" description="Target for fresh deployment of caTissue application">
			<antcall target="pre_initialization" />
			<antcall target="db_configuration" />
			<!-- antcall target="integrate_advanced_query"/ -->
		
			<antcall target="app_configuration"/>
			<antcall target="de_integrate_app" />
			<antcall target="build_war" />
			<antcall target="jboss_configuration" />
			<antcall target="copyMailjar"/>
			<!--<antcall target="send_mail" />-->
			<!--<delete dir="${temp.dir}" />-->
		</target>

	<target name="de_check_prerequisite" description="prerequisite checking for DE zip before Integrating it with catissue">
		<!-- Check dynamicextensions.zip file exists or not in base directory. -->
		<available file="${base.dir}/dynamicextensions.zip" property="file.exists" value="false" />
		<if>
			<not>
			   <isset property="file.exists"/>
			</not>
			<then>
			   <echo message="dynamicextensions.zip file not found. It should be in base directory to deploy DynamicExtensions." level="error" />
			</then>
			<else>
			   <echo message="DynamicExtensions is ready to use."/>
			</else>
		</if>
	</target>


	<!-- - - - - - - - - - - - - - - - - -
          target: build.catissuecore.war
     - - - - - - - - - - - - - - - - - -->
    <target name="build.catissuecore.war">
    	<echo message=" "/>
  		<echo message="----------------------------------"/>
   		<echo message=" Now creating catissuecore.war file "/>
   		<echo message="----------------------------------"/>
   		<echo message=" "/>

   		<!-- Create catissuecore.war file. -->
   		<antcall target="build_war"/>
    	<copy todir="${base.dir}/" file="${temp.dir}/catissuecore.war" overwrite="true" />
    </target>

	<target name="upgrade_DB_for_cacore">
		<echo message="Upgrading DB for cacore generation..." />
		<if>
			<equals arg1="oracle" arg2="${database.type}" />
			<then>
				<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" onerror="continue" rdbms="oracle">
					<transaction src="${dbupgrade.sql.dir}/Common/caModelUpgradeForCacore.sql" />
					<transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
				</sql>
			</then>
		<elseif >
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" password="${database.password}" onerror="continue">
					<transaction src="${dbupgrade.sql.dir}/Common/caModelUpgradeForCacore.sql" />
					<transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
				</sql>
			</then>
		</elseif>
		</if>

	</target>

	<target name="upgrade_dump_cacore">
		<echo message="Upgrading dump for cacore generation..." />

		<if>
			<equals arg1="oracle" arg2="${database.type}" />
			<then>
				<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" onerror="continue" rdbms="oracle">
					<transaction src="${dbupgrade.sql.dir}/Common/caModelUpgradeForCacore.sql" />
					<transaction src="${dbupgrade.sql.dir}/Oracle/caModelUpgradeForCacore_upgradedb.sql" />
					<transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
				</sql>
			</then>
		<elseif >
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" password="${database.password}" onerror="continue">
					<transaction src="${dbupgrade.sql.dir}/Common/caModelUpgradeForCacore.sql" />
					<transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
				</sql>
			</then>
		</elseif>
		</if>
	</target>

	<!-- Modify dynamicExtensions configuration For MySQL -->
	<target name="de_mysql_config" description="Modify dynamicExtensions configuration For MySQL">
		<replace file="${temp.dir}/catissuecore/WEB-INF/classes/DynamicExtensionsHibernate.cfg.xml">
			<replacefilter token="${oracle.dialect.string}" value="${mysql.dialect.string}" />
			<replacefilter token="${mssqlserver.dialect.string}" value="${mysql.dialect.string}" />
			<replacefilter token="@@datasource@@" value="java:/catissuecore" />
		</replace>
	</target>

	<!-- Modify dynamicextensions configuration For ORACLE -->
	<target name="de_oracle_config" description="Modify dynamicextensions configuration For ORACLE">
		<replace file="${temp.dir}/catissuecore/WEB-INF/classes/DynamicExtensionsHibernate.cfg.xml">
			<replacefilter token="${mysql.dialect.string}" value="${oracle.dialect.string}" />
			<replacefilter token="${mssqlserver.dialect.string}" value="${oracle.dialect.string}" />
			<replacefilter token="@@datasource@@" value="java:/catissuecore" />
		</replace>
	</target>


	<!-- Integrating DynamicExtensions application with catissue -->
	<target name="de_integrate_app" depends="de_check_prerequisite" if="file.exists" description="Integrating DynamicExtensions application with catissue">
          <echo message="Integrating DynamicExtensions app ...." />
		
          <copy todir="${temp.dir}/catissuecore/" overwrite="true">
            <fileset dir="${temp.dir}/dynamicextensions">
              <include name="csd_web/**" />
            </fileset>
          </copy>

          <mkdir dir="${temp.dir}/catissuecore/ngweb/external/de"/>

          <mkdir dir="${temp.dir}/catissuecore/ngweb/external/de/js"/>
          <copy todir="${temp.dir}/catissuecore/ngweb/external/de/js/" overwrite="true">
            <fileset dir="${temp.dir}/dynamicextensions/ngweb/js">
              <include name="*/**"/>
            </fileset>
          </copy>

          <mkdir dir="${temp.dir}/catissuecore/ngweb/external/de/css"/>
          <copy todir="${temp.dir}/catissuecore/ngweb/external/de/css/" overwrite="true">
            <fileset dir="${temp.dir}/dynamicextensions/ngweb/css">
              <include name="*/**"/>
            </fileset>
          </copy>
		
          <copy file="${temp.dir}/dynamicextensions/binaries/DynamicExtensionsInterface/DynamicExtensions.jar" 
                todir="${temp.dir}/catissuecore/WEB-INF/lib" overwrite="true" />
	</target>

	<target name="CopyCAModelWars" description="copy the CA Model wars">
		<antcall target="assert" />
		<antcall target="modifyDEWars">
			<param name="warName" value="CA"/>
		</antcall>
		<antcall target="modifyDEWars">
			<param name="warName" value="pathologySCG"/>
		</antcall>
		<antcall target="modifyDEWars">
			<param name="warName" value="pathologySpecimen"/>
		</antcall>
	</target>

	<target name="modifyDEWars" description="Modify the DE war">
		<echo>Modifying ${warName}.war....</echo>
			<unwar src="${basedir}/${warName}.war" dest="${temp.dir}/${warName}" />
			<copy file="${basedir}/DE_conf/hibernate.properties" todir="${temp.dir}/${warName}/WEB-INF/classes" overwrite="true" />
			<if>
				<equals arg1="mysql" arg2="${database.type}" />
				<then>
					<replace dir="${temp.dir}/${warName}/WEB-INF/classes">
						<include name="hibernate.properties" />
						<replacefilter token="@@DIALECT@@" value="${mysql.dialect.string}" />
						<replacefilter token="@@DRIVER@@" value="com.mysql.jdbc.Driver" />
						<replacefilter token="@@URL@@" value="jdbc:mysql://${database.host}:${database.port}/${database.name}" />
					</replace>
				</then>

				<elseif>
					<equals arg1="oracle" arg2="${database.type}" />
					<then>
						<replace dir="${temp.dir}/${warName}/WEB-INF/classes">
							<include name="hibernate.properties" />
							<replacefilter token="@@DIALECT@@" value="${oracle.dialect.string}" />
							<replacefilter token="@@DRIVER@@" value="${oracle.driver.string}" />
							<replacefilter token="@@URL@@" value="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" />
						</replace>
					</then>
				</elseif>
			</if>
			<replace dir="${temp.dir}/${warName}/WEB-INF/classes">
				<include name="hibernate.properties" />
				<replacefilter token="@@DATABASE_USERNAME@@" value="${database.username}" />
				<replacefilter token="${token.database.password}" value="${database.password}" />

			</replace>

			<war destfile="${temp.dir}/${warName}.war" webxml="${temp.dir}/${warName}/WEB-INF/web.xml">
				<fileset dir="${temp.dir}/${warName}">
					<include name="**/**/**.*" />
				</fileset>
			</war>
		<echo>Copying ${warName}.war....</echo>

		<copy todir="${jboss.server.url}/deploy" file="${temp.dir}/${warName}.war" overwrite="true" />
			<delete file="${temp.dir}/${warName}.war" />
			<delete includeemptydirs="true">
				<fileset dir="${temp.dir}/${warName}">
					<include name="**/*" />
				</fileset>
			</delete>
		<delete dir="${temp.dir}/${warName}" />
		</target>

	<!--Target for fresh Database Creation-->
	<target name = "deploy_db" description="Target for Database Creation">
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="deploy_db_mysql" />

			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="deploy_db_oracle" />
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>

		<antcall target="firstUser" />

		<!-- shippingtracking db -->
		<antcall target="st_deploy_db" />

		<tstamp>
			<format property="time" pattern="MM/dd/yyyy hh:mm:ss aa"/>
		</tstamp>
		<echo>before DE_Starts: ${time}</echo>
		<!-- <antcall target="upgrade_metadata_for_constraintproperties"/>  -->
		<!--<antcall target="upgrade_db_from_DE_1.2.0_to_DE_1.3.0" />
		<antcall target="upgrade_db_from_DE_1.3.0_to_DE_1.3.1" />  
		<antcall target="upgrade_db_from_DE_1.3.0_to_DE_1.4.0" />
		<antcall target="upgrade_db_from_DE_1.4.0.1_to_DE_1.4.0.2" />
		<antcall target="upgrade_db_from_DE_1.4.0_to_DE_1.4.2"/>
		<antcall target="upgrade_de_integration_restructure_metadata"/>

		<antcall target="update_metadata_for_tagged_values"/>
		<antcall target="upgrade_DB_for_cacore"/>
		<antcall target="insertCuratedPathForRecordEntry"/>
		<antcall target="upgrade_query_metadata_for_1.2"/>
		<tstamp>
					<format property="DEtime" pattern="MM/dd/yyyy hh:mm:ss aa"/>
				</tstamp>
				<echo>After DE_Starts: ${DEtime}</echo>
		<antcall target="insertPaths"/>-->
		<tstamp>
							<format property="pathtime" pattern="MM/dd/yyyy hh:mm:ss aa"/>
						</tstamp>
						<echo>After Insert paths: ${pathtime}</echo>
		<antcall target="liquibase_upgrade_target"/>
		<antcall target="upgrade_db_from_plusv20_plusv2.1"/>
		<antcall target="update_protection_element" />
		<antcall target="upgrade_db_from_plusv2.1_plusv3.0" />
		<antcall target="upgrade_db_plusv3.1" />
		<antcall target="upgrade_db_plusv3.2" />
		<antcall target="upgrade_db_plusv3.3" />
		<antcall target="upgrade_db_plusv4.0" />
        <antcall target="upgrade_db_os_v1.1"/>

	</target>

	<!--MySQL Database Creation -->
	<target name="deploy_db_mysql" description="MySQL Database Creation">
		<echo message="Initializing MySQL Database for caTissue Suite v1.2. Application..." />
		<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" password="${database.password}">
			<transaction src="${mysql.sql.dir}/catissuecore.sql" />
			<transaction src="${mysql.sql.dir}/InitDB_CreateTable.sql" />
			<transaction src="${common.sql.dir}/initDB_Insert_Common.sql" />
			<transaction src="${common.sql.dir}/AlterTable.sql" />
			<transaction src="${common.sql.dir}/CDE_DummyData_Common.sql" />
			<transaction src="${mysql.sql.dir}/csm_catissuecore.sql" />
			<transaction src="${common.sql.dir}/insert_default_data.sql" />
			<transaction src="${common.sql.dir}/indexes.sql" />
			<!--<transaction src="${mysql.sql.dir}/dynamicextension.sql" />
			<transaction src="${mysql.sql.dir}/query/metadata_schema_script.sql" />
			<transaction src="${mysql.sql.dir}/query/caB2B Table Generation Script.sql" />
			<transaction src="${dbupgrade.sql.dir}/MySql/CAModel.sql"/>-->
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<!--Ashraf: Created LabelSQL(CP Dashboard Tables)-->
		<antcall target="add_labelsql_tables_for_cp_dashboard"/>
		
		<antcall target="integrate_bulk_operation_mysql" />
		<antcall target="Export_Clinical_diagnosis_mysql" />
		
		<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" password="${database.password}" >
			<transaction src="${dbupgrade.sql.dir}/Common/DBUpgrade_v1.1p2_to_v1.1p4_indexes.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<antcall target="upgrade_db_from_v1.2.3_to_1.2.4_mysql"/>
		<antcall target="upgrade_db_for_empi_id__mysql"/>
	</target>
	<target name="insert_entity_group_metadata_mysql" description="insert entity group metadata for mysql">
		<echo message="Inserting entity group metadata for Mysql" />
		<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" password="${database.password}">
			<transaction src="${mysql.sql.dir}/query/entity_group_metadata.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>
	<target name="insert_entity_group_metadata_oracle" description="insert entity group metadata for oracle">
		<echo message="Inserting entity group metadata for Oracle" />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle">
			<transaction src="${oracle.sql.dir}/query/entity_group_metadata.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>
	<target name="temp_update_metadata_for_clob_support_mysql" description="temp update metadata for clob support for mysql">
		<echo message="Upgrading MySQL Database for supporting query on clob type attributes..." />
		<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" password="${database.password}">
			<transaction src="${mysql.sql.dir}/query/temp_update_metadata.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>

	<target name="temp_update_metadata_for_clob_support_oracle" description="temp update metadata for clob support for oracle">
		<echo message="Upgrading Oracle Database for supporting query on clob type attributes..." />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle">
			<transaction src="${oracle.sql.dir}/query/temp_update_metadata.sql" />
			<transaction>commit;</transaction>
			<classpath>
					<fileset dir="${lib.dir}">
						<include name="*.jar" />
					</fileset>
			</classpath>
		</sql>
		</target>

	<!--Oracle Database Creation -->


	<target name="deploy_db_oracle" description="Oracle Database Creation">
		<echo message="Initializing Oracle Database for caTissue Suite v1.1.p5. Application..." />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle">
			<transaction src="${oracle.sql.dir}/catissuecore.sql" />
			<!--<transaction src="${dbupgrade.sql.dir}/Oracle/DEIntegrationRestructure.sql" />-->
			<transaction src="${oracle.sql.dir}/InitDB_CreateTable.sql" />
			<transaction src="${common.sql.dir}/initDB_Insert_Common.sql" />
			<transaction src="${oracle.sql.dir}/AlterTable.sql" />
			<transaction src="${common.sql.dir}/CDE_DummyData_Common.sql" />
			<transaction src="${oracle.sql.dir}/CSM_Create_Oracle.sql" />
			<transaction src="${oracle.sql.dir}/insert_default_data.sql" />
			<transaction src="${common.sql.dir}/indexes.sql" />
			<!--<transaction src="${oracle.sql.dir}/dynamicextension.sql" />
			<transaction src="${oracle.sql.dir}/query/caB2B Table Generation Script.sql" />
			<transaction src="${oracle.sql.dir}/query/metadata_schema_script.sql" />-->
		<!--	<transaction src="${oracle.sql.dir}/query/query_schema_script.sql" />  -->
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>

		<!--Ashraf: Created LabelSQL(CP Dashboard Tables)-->
		<antcall target="add_labelsql_tables_for_cp_dashboard"/>
		
		<antcall target="integrate_bulk_operation_oracle"/>

		<!--<antcall target="unzip_aq_installable" />
		<ant dir="${temp.dir}/AdvanceQuery" inheritAll="false" antfile="queryintegration.xml" target="create_query_tables">
			<property name="database.type" value="${database.type}" />
			<property name="database.driver" value="${oracle.driver.string}" />
			<property name="database.url" value="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" />
			<property name="database.username" value="${database.username}" />
			<property name="database.password" value="${database.password}" />
			<property name="rdbms" value="oracle" />
			<property name="lib.dir" value="${lib.dir}" />
		</ant>

		<antcall target="insertQueryMetadata" />-->
		<antcall  target="Export_Clinical_diagnosis_oracle"/>
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle" delimiter="/" delimitertype="row">
			<transaction src="${oracle.sql.dir}/CSM_Trigger_Oracle.sql" />
			<transaction src="${oracle.sql.dir}/DBUtility.sql" />
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle">
			<transaction src="${oracle.sql.dir}/CSM_InsertData_Oracle.sql" />
			<transaction src="${oracle.sql.dir}/CSM_AddConstraints_Oracle.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<!--<antcall target="temp_update_metadata_for_clob_support_oracle" />
		<antcall target="insert_entity_group_metadata_oracle" />
		<antcall target="upgrade_db_demodel_oracle" />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle">
			<transaction src="${dbupgrade.sql.dir}/DEDBUpgrade/Oracle/Upgrade_DE_Schema.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>

		<antcall target="upgrade_metadata_for_constraintproperties"/>
		<antcall target="update_metadata_for_model_changes" >
			 <param name="isUpgrade" value="false"/>
		</antcall>
		<antcall target="update_metadata_for_CA_model_changes" />
		<antcall target="alter_CA_model_Tables" />
    	<antcall target="reset_sequences" />-->
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle">
			<transaction src="${dbupgrade.sql.dir}/Common/DBUpgrade_v1.1p2_to_v1.1p4_indexes.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<!--<echo message="Upgrading Oracle Database p5 to p5.1" />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle">
			<transaction src="${dbupgrade.sql.dir}/Oracle/DBUpgrade_QueryMetadata.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<antcall target="update_metadata_for_model_changes_oracle_post_P5" />-->
		<antcall target="upgrade_db_from_v1.2.3_to_1.2.4_oracle"/>
		<antcall target="upgrade_db_for_empi_id_oracle"/>
	</target>

	<target name="reset_sequences" description="Resetting the sequences...">
		<echo message=" Resetting the sequences..." />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle">
					<transaction src="${oracle.sql.dir}/query/dropDESequence.SQL" />
					<transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
				</sql>
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" delimiter="/" delimitertype="row" keepformat="yes" rdbms="oracle">
					<transaction src="${oracle.sql.dir}/query/resetDESequence.SQL" />
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
		</sql>
	</target>

	<target name="drop_and_create_sequences" description="Recreating the sequences...">
		<echo message="Recreating the sequences..." />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle">
					<transaction>
					DROP SEQUENCE DE_ATTR_REC_SEQ ;
					DROP SEQUENCE DE_COLL_ATTR_REC_VALUES_SEQ ;
					DROP SEQUENCE DE_FILE_ATTR_REC_VALUES_SEQ ;
					DROP SEQUENCE DE_OBJECT_ATTR_REC_VALUES_SEQ ;
					DROP SEQUENCE DYEXTN_ABSTRACT_METADATA_SEQ ;
					DROP SEQUENCE DYEXTN_ASSO_DISPLAY_ATTR_SEQ ;
					DROP SEQUENCE DYEXTN_ATTRIBUTE_TYPE_INFO_SEQ ;
					DROP SEQUENCE DYEXTN_CONTAINER_SEQ ;
					DROP SEQUENCE DYEXTN_CONTROL_SEQ ;
					DROP SEQUENCE DYEXTN_DATABASE_PROPERTIES_SEQ ;
					DROP SEQUENCE DYEXTN_DATA_ELEMENT_SEQ ;
					DROP SEQUENCE DYEXTN_ENTITY_MAP_CONDN_SEQ ;
					DROP SEQUENCE DYEXTN_ENTITY_MAP_SEQ ;
					DROP SEQUENCE DYEXTN_ENTITY_RECORD_SEQ ;
					DROP SEQUENCE DYEXTN_FILE_EXTN_SEQ ;
					DROP SEQUENCE DYEXTN_FORM_CONTEXT_SEQ ;
					DROP SEQUENCE DYEXTN_PERMISSIBLEVAL_SEQ ;
					DROP SEQUENCE DYEXTN_ROLE_SEQ ;
					DROP SEQUENCE DYEXTN_RULE_PARAMETER_SEQ ;
					DROP SEQUENCE DYEXTN_RULE_SEQ ;
					DROP SEQUENCE DYEXTN_SEMANTIC_PROPERTY_SEQ ;
					DROP SEQUENCE DYEXTN_TAGGED_VALUE_SEQ ;
					DROP SEQUENCE DYEXTN_VALUE_DOMAIN_SEQ ;
					DROP SEQUENCE DYEXTN_VIEW_SEQ ;
					</transaction>
					<transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
				</sql>
				<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" delimiter="/" delimitertype="row" keepformat="yes" rdbms="oracle">
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
					<transaction src="${oracle.sql.dir}/query/createDESequence.SQL" />
				</sql>

	</target>
	<target name="insertQueryMetadata" description="Inserting the Query Metadata">
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle">
			<transaction  src="${dbupgrade.sql.dir}/Oracle/CAModel.sql"/>
			<transaction src="${oracle.sql.dir}/query/DisableConstraints.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>

		<delete includeemptydirs="true">
			<fileset dir="${dbupgrade.sql.dir}/Oracle/CAModelCTLs">
				<include name="**/*" />
			</fileset>
		</delete>

		<antcall  target="Export_Clinical_diagnosis_oracle"/>
		<antcall target="CAModel_import_data" />

		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle">
			<transaction src="${oracle.sql.dir}/query/enableCons.sql" />
			<transaction src="${oracle.sql.dir}/query/UpdateTable.sql" />
			<!-- <transaction src="${oracle.sql.dir}/query/csm_oracle.sql" /> -->
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>

	    <antcall target="drop_and_create_sequences" />
	</target>


	<!--Target for Application and Database Upgrade from Suite p5.1 to Suite 1.2.1-->
	<target name="upgrade" depends="assert,upgrade_db,upgrade_app" description="Target for Application and Database Upgrade from Plusv1.0  to Plusv2.0">
	</target>
	
	<!--Target for Application and Database Upgrade from Suite 1.2 to Plus 2.1-->
	<target name="upgrade_NCI_1.2" depends="assert, upgrade_db_from_plusv1.2_to_plusv2.1, upgrade_app" description="Target for Application and Database Upgrade from Suitev1.2  to Plusv2.0">
	</target>
	<!--Target for Application and Database Upgrade from Suite 2.0 to Plus 2.1-->
	<target name="upgrade_Plus_2.0" depends="assert, upgrade_db_from_plusv20_plusv2.1,update_protection_element, upgrade_app" description="Target for Application and Database Upgrade from Suitev1.2  to Plusv2.0">
	</target>

	<!--Target for Application and Database Upgrade from caTissueCore v1.2.2  to Suite 1.1-->
	<!--<target name="upgrade_all_from_core_1.2.2" depends="core_1.2.2_upgrade_check">
		<antcall target="upgrade_app" />
		<antcall target="upgrade_db_from_core_1.2.2_to_suite_1.1" />
	</target>
 	-->

	<!--Target for Application Upgrade from Suite p5.1 to Suite 1.2.1-->
	<target name="upgrade_app" depends="deploy_app" description="this target urgrades the catissue application only from the current version.">
	</target>

	
<!--Target for Database Upgrade from suite v1.2 to plus2.0-->
	<target name="upgrade_db_from_suitev1.2_to_plus20" description="Upgrading Database from Suite v1.2 to Plus2.0">

		<echo message="Upgrading Database v1.2.3 to v1.2.4" />
		<antcall target="upgrade_db_from_v1.2.3_to_1.2.4"/>
		<antcall target="upgrade_db_v1.2.4 to v1.2.5"/>
		<antcall target="liquibase_upgrade_target"/>
		<antcall target="add_labelsql_tables_for_cp_dashboard"/>
		<antcall target="upgrade_db_from_v1.0_to_v2.0"/>
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="upgrade_db_for_empi_id__mysql" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="upgrade_db_for_empi_id_oracle" />
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
	</target>
	
		<target name="upgrade_db" description="Upgrading Database to plus 3.0">
			<echo message="Upgrading Database from ${from.version} to plus3.0" />
			<echo message="${from.version}"/>
			<if>
					<equals arg1="${plus1.0.version}" arg2="${from.version}"/>
					<then>
						<antcall target="liquibase_upgrade_from_plusv1.0_to_plusv2.0"/>
						<antcall target="upgrade_db_from_v1.0_to_v2.0" />
						<antcall target="upgrade_db_from_plusv20_plusv2.1" />
						<antcall target="upgrade_db_from_plusv2.1_plusv3.0" />
						<antcall target="upgrade_db_plusv3.1" />
						<antcall target="upgrade_db_plusv3.2" />
						<antcall target="upgrade_db_plusv3.3" />
						<antcall target="upgrade_db_plusv4.0" />
						<antcall target="upgrade_db_os_v1.1" />
					</then>
				<elseif>
								<equals arg1="${plus2.0.version}" arg2="${from.version}"/>
								<then>
									<antcall target="upgrade_db_from_plusv20_plusv2.1" />
									<antcall target="upgrade_db_from_plusv2.1_plusv3.0" />
									<antcall target="upgrade_db_plusv3.1" />
									<antcall target="upgrade_db_plusv3.2" />
									<antcall target="upgrade_db_plusv3.3" />
									<antcall target="upgrade_db_plusv4.0" />
									<antcall target="upgrade_db_os_v1.1" />
								</then>
					</elseif>
					<elseif>
								<equals arg1="${plus2.1.1.version}" arg2="${from.version}"/>
								<then>
									<antcall target="upgrade_db_from_plusv2.1_plusv3.0" />
									<antcall target="upgrade_db_plusv3.1" />
									<antcall target="upgrade_db_plusv3.2" />
									<antcall target="upgrade_db_plusv3.3" />
									<antcall target="upgrade_db_plusv4.0" />
									<antcall target="upgrade_db_os_v1.1" />
								</then>
						</elseif>
						<elseif>
								<equals arg1="${plus3.0.version}" arg2="${from.version}"/>
								<then>
									<antcall target="upgrade_db_plusv3.1" />
									<antcall target="upgrade_db_plusv3.2" />
									<antcall target="upgrade_db_plusv3.3" />
									<antcall target="upgrade_db_plusv4.0" />
									<antcall target="upgrade_db_os_v1.1" />
								</then>
							</elseif>
                            <elseif>
	                                <equals arg1="${plus3.1.version}" arg2="${from.version}"/>
                    				<then>
                    					<antcall target="upgrade_db_plusv3.2" />
	                                    <antcall target="upgrade_db_plusv3.3" />
	                                    <antcall target="upgrade_db_plusv4.0" />
                    					<antcall target="upgrade_db_os_v1.1" />
                    				</then>
	                        </elseif>
							<elseif>
                                    <equals arg1="${plus3.2.version}" arg2="${from.version}"/>
                                    <then>
                                        <antcall target="upgrade_db_plusv3.2" />
										<antcall target="upgrade_db_plusv3.3" />
                                    	<antcall target="upgrade_db_plusv4.0" />
                                    	<antcall target="upgrade_db_os_v1.1" />
                                    </then>
                            </elseif>
							<elseif>
                                    <equals arg1="${plus3.3.version}" arg2="${from.version}"/>
                                    <then>
                                    	<antcall target="upgrade_db_plusv4.0" />
                                    	<antcall target="upgrade_db_os_v1.1" />
                                    </then>
                            </elseif>
							<elseif>
                                    <equals arg1="${os1.0.version}" arg2="${from.version}"/>
                                    <then>
                                    	<antcall target="upgrade_db_os_v1.1" />
                                    </then>
                            </elseif>
							
							<elseif>
											<equals arg1="${suite-1.2.version}" arg2="${from.version}"/>
											<then>
												<antcall target="upgrade_db_from_plusv1.2_to_plusv3.0" />
												<antcall target="upgrade_db_plusv3.1" />
												<antcall target="upgrade_db_plusv3.2" />
												<antcall target="upgrade_db_plusv3.3" />
												<antcall target="upgrade_db_plusv4.0" />
												<antcall target="upgrade_db_os_v1.1" />
											</then>
								</elseif>
								<else>
									<fail message="Invalid version specified, supported versions are:${plus1.0.version}, ${plus2.0.version}, ${plus2.1.1.version},${plus3.0.version},${plus3.1.version},${plus3.2.version},${plus3.1.version},${os1.0.version}. You entered ${from.version}"/>
								</else>
									</if>
	<!--	<antcall target="liquibase_upgrade_from_plusv1.0_to_plusv2.0"/>
			<antcall target="upgrade_db_from_v1.0_to_v2.0" />-->
		</target>
	
	<target name="upgrade_db_from_v1.0_to_v2.0">
		<antcall target="unzip_aq_installable" />
		<echo message="upgrading database with URL ${final.database.url} username=${database.username} password=${database.password}" />
		<!--upgradations for colums in query and query_parameterized_query table -->
		<updateDatabase
			changeLogFile="${temp.dir}/AdvanceQuery/db/db-upgrade/liquibase_xml/query_Suite1.3_to_Suite1.4.xml"
			driver="${final.database.driver}" url="${final.database.url}"
			username="${database.username}" password="${database.password}"
			dropFirst="false" classpathref="liquibaseClasspath" />
	</target>

	<!--Target for Database Upgrade from Suite 1.2.3 to Suite 1.2.1-->
	<target name="upgrade_db_v1.2.4 to v1.2.5" description="Upgrading Database v1.2.4 to v1.2.5">
		<echo message="Upgrading Database v1.2.4 to v1.2.5" />
	</target>
	
	<target name="upgrade_db_from_v1.1.p1 to v1.1.p2" description="Upgrading Database from v1.1.p1 to v1.1.p2">
				<echo message="Upgrading Database v1.1.p1 to v1.1.p2" />
				<if>
					<equals arg1="mysql" arg2="${database.type}" />
					<then>
				    	<antcall target="upgrade_mysql_from_v1.1_p1_to_v1.1p2" />
					</then>
					<elseif>
					  <equals arg1="oracle" arg2="${database.type}" />
						 <then>
						 	<!--<antcall target="update_sequences" />-->
							<antcall target="upgrade_oracle_from_v1.1_p1_to_v1.1p2" />
						 </then>
					 </elseif>
					 <else>
						<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
					 </else>
				</if>
	</target>

	<target name="upgrade_db_from_v1.1 to v1.1.p2" description="Upgrading Database from v1.1.p1 to v1.1.p2">
			<echo message="Upgrading Database v1.1.p1 to v1.1.p2" />
			<if>
				<equals arg1="mysql" arg2="${database.type}" />
				<then>
			    	<antcall target="upgrade_mysql_from_v1.1_to_v1.1p2" />
				</then>
				<elseif>
				  <equals arg1="oracle" arg2="${database.type}" />
					 <then>
					 	<antcall target="update_sequences" />
						<antcall target="upgrade_oracle_from_v1.1_to_v1.1p2" />
					 </then>
				 </elseif>
				 <else>
					<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
				 </else>
			</if>
			<antcall target="update_metadata_for_model_changes">
				<param name="isUpgrade" value="true"/>
				<param name="buildVersion" value="1.1_to_p2"/>
			</antcall>
		</target>

	<target name="upgrade_db_from_v1.1_to_p4" description="Target for Application and Database Upgrade from caTissue v1.1 to p4">
	<echo message="Upgrading Database v1.1 to v1.1p4" />
		<antcall target="upgrade_db_from_v1.1 to v1.1.p2"/>
		<antcall target="upgrade_db_from_p2_to_p4"/>
	</target>

	<!--Target for Application and Database Upgrade from caTissue p2 to p4 -->
	<target name="upgrade_all_from_p2_to_p4" description="Target for Application and Database Upgrade from caTissue p2 to p4">
		<antcall target="upgrade_app"/>
		<antcall target="upgrade_db_from_p2_to_p4"/>
	</target>

	<target name="upgrade_db_from_p2_to_p4" description="Target for Database Upgrade from caTissue p2 to p4">
		<echo message="Upgrading Database v1.1p2 to v1.1p4" />
			        <if>
					<equals arg1="mysql" arg2="${database.type}" />
					<then>
						<antcall target="upgrade_mysql_from_v1.1p2_to_v1.1p4" />
					</then>
					<elseif>
						<equals arg1="oracle" arg2="${database.type}" />
						<then>
							<antcall target="upgrade_oracle_from_v1.1p2_to_v1.1p4" />
						</then>
					</elseif>
					<else>
						<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
					</else>
				</if>
				<antcall target="upgrade_category_entity_names">
				</antcall>
				<antcall target="update_metadata_for_model_changes">
					<param name="isUpgrade" value="true"/>
					<param name="buildVersion" value="p2top4"/>
				</antcall>

				<antcall target="update_metaPhone_data_for_participant"/>
		</target>

	<target name="upgrade_all_from_p4_to_p5" description="Target for Application and Database Upgrade from caTissue p4 to p5">
		<antcall target="assert"/>
		<antcall target="upgrade_db_from_p4_to_p5"/>
		<antcall target="upgrade_app"/>
	</target>

	<target name="upgrade_db_from_p4_to_p5" description="Target for Database Upgrade from caTissue p4 to p5">
		<echo message="Upgrading Database v1.1p4 to v1.1p5" />
		<antcall target="upgrade_db_from_DE_1.2.0_to_DE_1.3.0"/>
		<!-- <antcall target="upgrade_db_from_DE_1.3.0_to_DE_1.3.1" />  -->
		<antcall target="upgrade_db_from_DE_1.3.0_to_DE_1.4.0"/>
		<antcall target="update_metadata_for_tagged_values"/>
	    <if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="upgrade_mysql_from_v1.1p4_to_v1.1p5" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="upgrade_oracle_from_v1.1p4_to_v1.1p5" />
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
		<antcall target="upgrade_de_integration_restructure_metadata"/>
		<antcall target="upgrade_de_integration_restructure_data"/>
		<antcall target="upgrade_dump_cacore" />
		<antcall target="insertCuratedPathForRecordEntry" />
	</target>




	<!-- Removing unnecessary PE Mysql-->
	<target name="upgrade_mysql_from_v1.1_to_v1.1p2" description="Upgrading MySQL Database and removing unused Protection Element">
		<echo message="Upgrading MySQL Database and removing unused Protection Element" />
		<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" password="${database.password}" >
			<transaction src="${dbupgrade.sql.dir}/MySql/DBUpgrade_v1.1_to_v1.1p2.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>

	<target name="upgrade_mysql_from_v1.1_p1_to_v1.1p2" description="Upgrading MySQL Database and removing unused Protection Element">
			<echo message="Upgrading MySQL Database and removing unused Protection Element" />
			<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" password="${database.password}" >
				<transaction src="${dbupgrade.sql.dir}/MySql/DBUpgrade_v1.1_p1_to_v1.1p2.sql" />
				<transaction>commit;</transaction>
				<classpath>
					<fileset dir="${lib.dir}">
						<include name="*.jar" />
					</fileset>
				</classpath>
			</sql>
	</target>

	<!-- Target to re-set the sequence when upgrading from V1.1 to V1.2-->
	<target name="update_sequences" description="Updating sequence in case of upgrade from V1.1 to V1.2">
			<echo message="Updating the sequence"></echo>
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" delimiter="/" delimitertype="row" keepformat="yes" rdbms="oracle">
					<transaction src="${dbupgrade.sql.dir}/Oracle/DBSeqUpdate_v1.1_to_v1.2.sql" />
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
				</sql>


	</target>
	<!-- Removing unnecessary PE Oracle-->
	<target name="upgrade_oracle_from_v1.1_to_v1.1p2" description="Upgrading Oracle Database and removing unused Protection Element">
		<echo message="Upgrading Oracle Database and removing unused Protection Element" />
			<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle">
					<transaction src="${dbupgrade.sql.dir}/Oracle/DBUpgrade_v1.1_to_v1.1p2.sql" />
				    <transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
			</sql>
   </target>

	<target name="upgrade_oracle_from_v1.1_p1_to_v1.1p2" description="Upgrading Oracle Database and removing unused Protection Element">
		<echo message="Upgrading Oracle Database and removing unused Protection Element" />
				<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle">
						<transaction src="${dbupgrade.sql.dir}/Oracle/DBUpgrade_v1.1_p1_to_v1.1p2.sql" />
					    <transaction>commit;</transaction>
						<classpath>
							<fileset dir="${lib.dir}">
								<include name="*.jar" />
							</fileset>
						</classpath>
				</sql>
	   </target>

	<!-- Upgrading from Suite1.1 p2 to p4 - MySQL -->
	<target name="upgrade_mysql_from_v1.1p2_to_v1.1p4" description="Upgrading from Suite1.1 p2 to p4 - MySQL">
		<!-- Modifying catissue_container table by changing 'FULL' column name with 'CONT_FULL'. As 'FULL' is a keyword in some dbs. -->
		<echo message="Upgrading MySQL Database. Modifying catissue_container table by changing 'FULL' column name with 'CONT_FULL'." />
		<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" password="${database.password}" >
			<transaction src="${dbupgrade.sql.dir}/MySql/DBUpgrade_v1.1p2_to_v1.1p4.sql" />
			<transaction src="${dbupgrade.sql.dir}/DEDBUpgrade/MySql/deupgrade_to_v1.2.0.rc1.sql" />
			<transaction src="${dbupgrade.sql.dir}/Common/DBUpgrade_v1.1p2_to_v1.1p4_indexes.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<antcall target="upgrade_metadata_for_constraintproperties" />
	</target>

	<!-- Upgrading from Suite1.1 p4 to p5 - MySQL -->
	<target name="upgrade_mysql_from_v1.1p4_to_v1.1p5" description="Upgrading from Suite1.1 p4 to p5 - MySQL">
		<echo message="Upgrading MySQL Database." />
		<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" password="${database.password}" >
			<transaction src="${dbupgrade.sql.dir}/MySql/DBUpgrade_v1.1p4_to_v1.1p5.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>

		<antcall target="integrate_bulk_operation_mysql" />

	</target>

	<!-- Upgrading from Suite1.1 p2 to p4 - Oracle -->
	<target name="upgrade_oracle_from_v1.1p2_to_v1.1p4" description="Upgrading from Suite1.1 p2 to p4 - Oracle">
		<!-- Modifying catissue_container table by changing 'FULL' column name with 'CONT_FULL'. As 'FULL' is a keyword in some dbs. -->
		<echo message="Upgrading Oracle Database. Modifying catissue_container table by changing 'FULL' column name with 'CONT_FULL'." />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle">
			<transaction src="${dbupgrade.sql.dir}/Oracle/DBUpgrade_v1.1p2_to_v1.1p4.sql" />
			<transaction src="${dbupgrade.sql.dir}/DEDBUpgrade/Oracle/deupgrade_to_v1.2.0.rc1.sql" />
			<transaction src="${dbupgrade.sql.dir}/Common/DBUpgrade_v1.1p2_to_v1.1p4_indexes.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<antcall target="upgrade_metadata_for_constraintproperties" />
		<antcall target="upgrade_saved_queries"></antcall>
   </target>

	<!-- Upgrading from Suite1.1 p4 to p5 - Oracle -->
	<target name="upgrade_oracle_from_v1.1p4_to_v1.1p5" description=" Upgrading Oracle Database. Upgrading from Suite1.1 p4 to p5 - Oracle">
		<echo message="Upgrading Oracle Database p4 to p5." />
		<antcall target="audit_upgrade_oracle_from_v1.1p4_to_v1.1p5" />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle">
			<transaction src="${dbupgrade.sql.dir}/Oracle/DBUpgrade_v1.1p4_to_v1.1p5.sql" />
			<transaction src="${dbupgrade.sql.dir}/Oracle/DEIntegrationRestructure.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<antcall target="checkIndexCreation" />
		<antcall target="integrate_bulk_operation_oracle" />
   </target>
	<target name="checkIndexCreation" description="This target checks index, if it alredy exists" >
			<echo message="Upgrade audit changes." />
				<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle" delimiter="/" delimitertype="row" keepformat="yes" >
						<transaction src="${dbupgrade.sql.dir}/Oracle/checkIndexCreation.sql" />
						<classpath>
							<fileset dir="${lib.dir}">
								<include name="*.jar" />
							</fileset>
						</classpath>
				</sql>
	 </target>


   <target name="audit_upgrade_oracle_from_v1.1p4_to_v1.1p5" description="this target ugrades the audit feature from v1.1.P4 to v1.1.P5" >
			<echo message="Upgrade audit changes.">
			</echo>
			<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}"  rdbms="oracle">
				<transaction>
						ALTER TABLE CATISSUE_AUDIT_EVENT ADD EVENT_TYPE VARCHAR(20) ;
				</transaction>
				<transaction>commit;</transaction>
				<classpath>
					<fileset dir="${lib.dir}">
						<include name="*.jar" />
					</fileset>
				</classpath>
			</sql>
			<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle" delimiter="/" delimitertype="row" keepformat="yes" >
				<transaction src="${dbupgrade.sql.dir}/Oracle/auditUpgrade_v1.1p4_to_v1.1p5.sql" />
				<classpath>
					<fileset dir="${lib.dir}">
						<include name="*.jar" />
					</fileset>
				</classpath>
			</sql>

	</target>


	<!-- DE Metadata Upgradation -->
	<target name="update_metadata_for_model_changes" description="DE Metadata Upgradation">
		<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore"/>
		<delete file="${temp.dir}/catissuecore/WEB-INF/lib/mmtxProject.jar" />
		<antcall target="replacecfgfiles"></antcall>
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="update_metadata_for_model_changes_mysql">
				 <param name="isUpgrade" value="${isUpgrade}"/>
				 <param name="buildVersion" value="${buildVersion}"/>
				</antcall>
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="update_metadata_for_model_changes_oracle">
						 <param name="isUpgrade" value="${isUpgrade}"/>
						 <param name="buildVersion" value="${buildVersion}"/>
					</antcall>
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
		<delete dir="${temp.dir}" />
	</target>

	<!-- DE Metadata Upgradation -->
	<target name="update_metadata_for_CA_model_changes" description=" update medtadata for CA model changes">
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<echo message="Upgrading MySQL Database for CA models metadata ..." />
				<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" password="${database.password}">
					<transaction src="${dbupgrade.sql.dir}/DEDBUpgrade/MySql/updateCAModels.sql" />
					<transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
				</sql>
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<echo message="Upgrading Oracle Database for CA models metadata ..." />
					<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" onerror="continue" rdbms="oracle">
						<transaction src="${dbupgrade.sql.dir}/DEDBUpgrade/Oracle/updateCAModels.sql" />
						<transaction>commit;</transaction>
						<classpath>
							<fileset dir="${lib.dir}">
								<include name="*.jar" />
							</fileset>
						</classpath>
					</sql>
				</then>
			</elseif>

			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
	</target>

	<target name="update_metadata_for_model_changes_mysql" description="Updating DE Metadata for model changes (mysql).....">
		<echo message="Updating DE Metadata for model changes (mysql)....." />
		<java classname="edu.wustl.catissuecore.querysuite.metadata.UpdateMetadata"  fork="true" maxmemory="512m" failonerror="true">
			<classpath location="${temp.dir}/catissuecore/WEB-INF/classes" />
			<classpath refid="temp.classpath" />
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>

			<arg value="${database.host}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.username}"/>
			<arg value="${database.password}"/>
			<arg value="${mysql.driver.string}"/>
			<arg value="${isUpgrade}"/>
			<arg value="${buildVersion}"/>
		</java>
	</target>

	<target name="update_metadata_for_model_changes_mysql_post_P5" description="Updating DE Metadata for model changes (mysql).....">
		<echo message="Updating DE Metadata for model changes (mysql) post P5....." />
		<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore"/>
		<delete file="${temp.dir}/catissuecore/WEB-INF/lib/mmtxProject.jar" />
		<java classname="edu.wustl.catissuecore.querysuite.metadata.UpdateQueryMetadata"  fork="true" maxmemory="512m" failonerror="true">
			<classpath location="${temp.dir}/catissuecore/WEB-INF/classes" />
			<classpath refid="temp.classpath" />
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>

			<arg value="${database.host}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.username}"/>
			<arg value="${database.password}"/>
			<arg value="${mysql.driver.string}"/>
			<arg value="${isUpgrade}"/>
			<arg value="${buildVersion}"/>
		</java>
	</target>

	<target name="update_metadata_for_model_changes_oracle" description="Updating DE Metadata for model changes (oracle).....">
		<echo message="Updating DE Metadata for model changes (oracle)....." />
		<java classname="edu.wustl.catissuecore.querysuite.metadata.UpdateMetadata"  fork="true" maxmemory="512m" failonerror="true">
			<classpath location="${temp.dir}/catissuecore/WEB-INF/classes" />
			<classpath refid="temp.classpath" />
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
			<arg value="${database.host}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.username}"/>
			<arg value="${database.password}"/>
			<arg value="${oracle.driver.string}"/>
			<arg value="${isUpgrade}"/>
			<arg value="${buildVersion}"/>
		</java>
		<antcall target="reset_sequences" />
	</target>

	<target name="update_metadata_for_model_changes_oracle_post_P5" description="Updating DE Metadata for model changes (oracle).....">
			<echo message="Updating DE Metadata for model changes (oracle) post P5....." />
				<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore"/>
				<delete file="${temp.dir}/catissuecore/WEB-INF/lib/mmtxProject.jar" />
			<java classname="edu.wustl.catissuecore.querysuite.metadata.UpdateQueryMetadata"  fork="true" maxmemory="512m" failonerror="true">
				<classpath location="${temp.dir}/catissuecore/WEB-INF/classes" />
				<classpath refid="temp.classpath" />
				<classpath>
					<fileset dir="${lib.dir}">
						<include name="*.jar" />
					</fileset>
				</classpath>
				<arg value="${database.host}"/>
				<arg value="${database.port}"/>
				<arg value="${database.type}"/>
				<arg value="${database.name}"/>
				<arg value="${database.username}"/>
				<arg value="${database.password}"/>
				<arg value="${oracle.driver.string}"/>
				<arg value="${isUpgrade}"/>
				<arg value="${buildVersion}"/>
			</java>
		</target>

	<!-- Start : DE Integration Restructure for p5 -->

	<target name="insertCuratedPathForRecordEntry">
		<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore"/>
		<antcall target="replacecfgfiles"/>
		<copy file="${base.dir}/catissuecore-properties/log4j.properties" todir="${base.dir}" overwrite="true"/>
		<java classname="edu.wustl.catissuecore.querysuite.metadata.AddCuratedPathsForRecordEntry" fork="true" maxmemory="1024M" failonerror="false">
			<classpath location="${temp.dir}/catissuecore/WEB-INF/classes" />
			<classpath refid="temp.classpath" />
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</java>
		<delete dir="${temp.dir}" />
		<delete file="${base.dir}/log4j.properties" />
	</target>

	<target name="upgrade_de_integration_restructure_metadata" description="Start : DE Integration Restructure for p5 ">
		<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore"/>
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="upgrade_de_integration_restructure_metadata_mysql" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="upgrade_de_integration_restructure_metadata_oracle" />
				</then>
			</elseif>
		</if>
		<delete dir="${temp.dir}" />
	</target>

	<target name="upgrade_de_integration_restructure_metadata_mysql" description="Updating DE integration metadata (mysql).....">
	<echo message="Updating DE integration metadata (mysql)....." />

	<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" password="${database.password}">
		<transaction src="${dbupgrade.sql.dir}/MySql/DEIntegrationRestructure.sql" />
		<transaction>commit;</transaction>
		<classpath>
			<fileset dir="${lib.dir}">
				<include name="*.jar" />
			</fileset>
		</classpath>
	</sql>

	<java classname="edu.wustl.catissuecore.querysuite.metadata.AddDEIntegrationMetadata" fork="true" maxmemory="1024M" failonerror="true">
		<classpath location="${temp.dir}/catissuecore/WEB-INF/classes" />
		<classpath refid="temp.classpath" />
		<classpath>
			<fileset dir="${lib.dir}">
				<include name="*.jar" />
			</fileset>
		</classpath>
		<arg value="${database.host}"/>
		<arg value="${database.port}"/>
		<arg value="${database.type}"/>
		<arg value="${database.name}"/>
		<arg value="${database.username}"/>
		<arg value="${database.password}"/>
		<arg value="com.mysql.jdbc.Driver"/>
	</java>

	<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" password="${database.password}">
		<transaction src="${dbupgrade.sql.dir}/MySql/DEIntegrationRestructure_Data.sql" />
		<transaction>commit;</transaction>
		<classpath>
			<fileset dir="${lib.dir}">
				<include name="*.jar" />
			</fileset>
		</classpath>
	</sql>
	</target>

	<target name="upgrade_de_integration_restructure_metadata_oracle" description="Updating DE integration metadata (oracle).....">
		<echo message="Updating DE integration metadata (oracle)....." />

		<java classname="edu.wustl.catissuecore.querysuite.metadata.AddDEIntegrationMetadata" fork="true" maxmemory="1024M" failonerror="true">
			<classpath location="${temp.dir}/catissuecore/WEB-INF/classes" />
			<classpath refid="temp.classpath" />
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
			<arg value="${database.host}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.username}"/>
			<arg value="${database.password}"/>
			<arg value="${oracle.driver.string}"/>
		</java>
		<antcall target="reset_DE_sequences" />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle">
			<transaction src="${dbupgrade.sql.dir}/Oracle/DEIntegrationRestructure_Data.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>

	<target name="upgrade_de_integration_restructure_data" depends="commondbconfig" description="Updating data as per restructured DE integration.....">

		<echo message="Updating data as per restructured DE integration....." />

		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="upgrade_de_integration_restructure_data_mysql" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="upgrade_de_integration_restructure_data_oracle" />
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
	</target>

	<target name="upgrade_de_integration_restructure_data_mysql" description="upgrade DE integrationrestructure data for mysql">
		<java classname="edu.wustl.catissuecore.querysuite.metadata.DERestructureDataUtil" fork="true" failonerror="true" maxmemory="512m">
			<classpath location="${temp.dir}/catissuecore/WEB-INF/classes" />
			<classpath refid="temp.classpath" />
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
			<arg value="${database.host}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.username}"/>
			<arg value="${database.password}"/>
			<arg value="com.mysql.jdbc.Driver"/>
		</java>
	</target>

	<target name="upgrade_de_integration_restructure_data_oracle" description="upgrade DE integration restructure data for oracle">
		<java classname="edu.wustl.catissuecore.querysuite.metadata.DERestructureDataUtil" fork="true" failonerror="true" maxmemory="512m">
			<classpath location="${temp.dir}/catissuecore/WEB-INF/classes" />
			<classpath refid="temp.classpath" />
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
			<arg value="${database.host}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.username}"/>
			<arg value="${database.password}"/>
			<arg value="${oracle.driver.string}"/>
		</java>
		<antcall target="reset_record_entry_sequence"></antcall>
	</target>

	<!-- End : DE Integration Restructure for p5 -->

	<target name="Export_Clinical_diagnosis" description="Exporting clinical diagnosis data">
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="Export_Clinical_diagnosis_mysql" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="Export_Clinical_diagnosis_oracle" />
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
		<delete dir="${temp.dir}" />
	</target>

	<target name="Export_Clinical_diagnosis_mysql" description="Exporting data of Clinical diagnosis ... for Mysql">
		<echo message="Exporting data of Clinical diagnosis ..." />
		<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore"/>
		<java classname="edu.wustl.common.util.impexp.AutomateImport" fork="true">
			<classpath refid="temp.classpath" />
			<arg value="${database.host}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.username}"/>
			<arg value="${database.password}"/>
			<arg value="com.mysql.jdbc.Driver"/>
			<arg value="import"/>
			<arg value="${basedir}/SQL/Permissible_values/dumpFileColumnInfo.txt"/>
			<arg value="${basedir}/SQL/Permissible_values/"/>
		</java>
		<delete dir="${temp.dir}" />
	</target>

	<target name="Export_Clinical_diagnosis_oracle" description="Exporting data of Clinical diagnosis ... for Oracle">
		<echo message="Exporting data of Clinical diagnosis ..." />
		<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore"/>
		<java classname="edu.wustl.common.util.impexp.AutomateImport" fork="true">
			<classpath refid="temp.classpath" />
			<arg value="${database.host}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.username}"/>
			<arg value="${database.password}"/>
			<arg value="${oracle.driver.string}"/>
			<arg value="import"/>
			<arg value="${basedir}/SQL/Permissible_values/dumpFileColumnInfo.txt"/>
			<arg value="${basedir}/SQL/Permissible_values/"/>
			<arg value="${basedir}/SQL/Permissible_values/"/>
			<arg value="${oracle.tns.name}"/>
		</java>
		<delete dir="${temp.dir}" />
	</target>


	<!--Data import for CAModel -->
	<target name="CAModel_import_data" description="Importing CA model data">
		<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore"/>
		<delete file="${temp.dir}/catissuecore/WEB-INF/lib/mmtxProject.jar" />
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="CAModel_import_data_mysql" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="CAModel_import_data_oracle" />
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
		<delete dir="${temp.dir}" />
	</target>

	<target name="CAModel_import_data_mysql" description="Importing CA models data for caTISSUE Suite Application to MySQL Database ..">
		<echo message="Importing CA models data for caTISSUE Suite Application to MySQL Database ..." />
		<java classname="edu.wustl.common.util.impexp.AutomateImport"  fork="true" maxmemory="512m">
			<classpath refid="temp.classpath" />
			<arg value="${database.host}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.username}"/>
			<arg value="${database.password}"/>
			<arg value="${mysql.driver.string}"/>
			<arg value="import"/>
			<arg value="${dbupgrade.sql.dir}/Common/dumpFileColumnInfo.txt"/>
			<arg value="${basedir}/SQL/DBUpgrade/Common/CAModelCSVs/"/>
		</java>
	</target>

	<target name="CAModel_import_data_oracle" description="Importing CA models data for caTISSUE Suite Application to Oracle Database ...">
		<echo message="Importing CA models data for caTISSUE Suite Application to Oracle Database ..." />
		<java classname="edu.wustl.common.util.impexp.AutomateImport"  fork="true" >

			<classpath refid="temp.classpath" />

			<arg value="${database.host}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.username}"/>
			<arg value="${database.password}"/>
			<arg value="${oracle.driver.string}"/>
			<arg value="import"/>
			<arg value="${dbupgrade.sql.dir}/Common/dumpFileColumnInfo.txt"/>
			<arg value="${basedir}/SQL/DBUpgrade/Common/CAModelCSVs/"/>
			<arg value="${basedir}/SQL/DBUpgrade/Oracle/CAModelCTLs/"/>
			<arg value="${oracle.tns.name}"/>
		</java>
	</target>

	<!--Data export for CAModel -->
	<target name="CAModel_export_data" description="Data export for CAModel">
		<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore"/>
		<delete file="${temp.dir}/catissuecore/WEB-INF/lib/mmtxProject.jar" />
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="CAModel_export_data_mysql" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="CAModel_export_data_oracle" />
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
		<delete dir="${temp.dir}" />
	</target>

	<target name="CAModel_export_data_mysql" description="Exporting data of CA models for MySQL Database...">
		<echo message="Exporting data of CA models for MySQL Database..." />
		<java classname="edu.wustl.common.util.impexp.AutomateImport" fork="true">
			<classpath refid="temp.classpath" />
			<arg value="${database.host}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.username}"/>
			<arg value="${database.password}"/>
			<arg value="${mysql.driver.string}"/>
			<arg value="export"/>
			<arg value="${dbupgrade.sql.dir}/Common/dumpFileColumnInfo.txt"/>
			<arg value="${basedir}/SQL/DBUpgrade/Common/CAModelCSVs/"/>
		</java>
		<delete dir="${temp.dir}" />
	</target>

	<target name="metadata_cleanup" description="To remove the corrupted path from the database.">
			<echo message="Cleaning up Corrupted paths...." />
			<delete dir="${temp.dir}" failonerror="false"/>
	 		<mkdir dir="${temp.dir}" />
			<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore"/>
			<delete file="${temp.dir}/catissuecore/WEB-INF/lib/mmtxProject.jar" />
			<if>
				<equals arg1="mysql" arg2="${database.type}" />
				<then>
					<java classname="edu.wustl.common.util.global.QueryMetadataCleanup" fork="true">
						<classpath refid="temp.classpath" />
						<arg value="${database.username}"/>
						<arg value="${database.password}"/>
						<arg value="${mysql.driver.string}"/>
						<arg value="jdbc:mysql://${database.host}:${database.port}/${database.name}"/>
					</java>
				</then>
				<elseif>
					<equals arg1="oracle" arg2="${database.type}" />
					<then>
						<java classname="edu.wustl.common.util.global.QueryMetadataCleanup" fork="true">
							<classpath refid="temp.classpath" />
							<arg value="${database.username}"/>
							<arg value="${database.password}"/>
							<arg value="${oracle.driver.string}"/>
							<arg value="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}"/>
						</java>
					</then>
				</elseif>
				<else>
					<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
				</else>
			</if>
			<delete dir="${temp.dir}" />
	</target>
	<target name="CAModel_export_data_oracle" description="Exporting data of CA models for Oracle Database...">
		<echo message="Exporting data of CA models for Oracle Database..." />
		<java classname="edu.wustl.common.util.impexp.AutomateImport" fork="false">
			<classpath refid="temp.classpath" />
			<arg value="${database.host}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.username}"/>
			<arg value="${database.password}"/>
			<arg value="${oracle.driver.string}"/>
			<arg value="export"/>
			<arg value="${dbupgrade.sql.dir}/Common/dumpFileColumnInfo.txt"/>
			<arg value="${basedir}/SQL/DBUpgrade/Common/CAModelCSVs/"/>
			<arg value="${basedir}/SQL/DBUpgrade/Oracle/CAModelCTLs/"/>
			<arg value="${oracle.tns.name}"/>
		</java>
	</target>

	<target name="copyMailjar">
		<copy file="WEB-INF/lib/mail.jar" todir="${env.ANT_HOME}/lib" overwrite="true" failonerror="false"/>
	</target>
	
	<!--Send mail to user-->
	<target name="send_mail" description="Send mail to user">
	    <condition property="protocol" value="https" else="http">
			<equals arg1="${jboss.container.secure}" arg2="yes" />
		</condition>
		<condition property="jbossServerHost" value="localhost" else="${jboss.server.host}">
			<equals arg1="${jboss.server.host}" arg2="" />
		</condition>
		<echo message="jboss.container.secure property is set to: ${jboss.container.secure} protocol set to: ${protocol}" />
		<echo message="Sending mail to: ${email.administrative.emailAddress}" />
		<echo message="Sending mail from: ${email.sendEmailFrom.emailAddress}" />
		<if>
						<equals arg1="" arg2="${email.sendEmailFrom.emailPassword}" />
						<then>
							<mail mailhost="${email.mailServer}" messagefile="${mail.file.dir}/mail.txt" subject="OpenSpecimen ${build.version} Successfully Deployed" encoding="mime" ssl="${email.smtp.starttls.enabled}" mailPort="${email.mailServer.port}" failonerror="false">
										<from address="${email.sendEmailFrom.emailAddress}" />
										<to address="${email.administrative.emailAddress}" />
											</mail>
						</then>
					<else>
						<mail mailhost="${email.mailServer}" messagefile="${mail.file.dir}/mail.txt" subject="OpenSpecimen ${build.version} Successfully Deployed" user="${email.sendEmailFrom.emailAddress}" password="${email.sendEmailFrom.emailPassword}"  encoding="mime" ssl="${email.smtp.starttls.enabled}" mailPort="${email.mailServer.port}" failonerror="false">
														<from address="${email.sendEmailFrom.emailAddress}" />
														<to address="${email.administrative.emailAddress}" />
															</mail>
					</else>
				</if>
		<echo>
			Please check the Email of ${first.admin.emailAddress}.
			If the Deployment mail is not received please check your
			email.administrative.emailAddress and email.sendEmailFrom.emailAddress
			properties in caTissueInstall.properties and Re-deploy the Application.
		</echo>
	</target>

	<!--First User Creation. Mandar : 02-May-2006 -->
	<path id="temp.classpath">
		<fileset dir="${temp.dir}/catissuecore/WEB-INF/lib">
			<include name="*.jar" />
		</fileset>
	</path>

	<target name="firstUser" description="Inserting the first user mentioned in the caTissueInstall.properties file">
		<if>
			<equals arg1="mysql" arg2="${database.type}"/>
			<then>
				<antcall target="firstUser_mysql"/>
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}"/>
				<then>
					<antcall target="firstUser_oracle"/>
				</then>
			</elseif>
		</if>
	</target>

	<target name="firstUser_oracle" description="Inserting the first user mentioned in the caTissueInstall.properties file For Oracle">
		<echo message="Encoding Password..."/>
		<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore"/>

		<java classname="edu.wustl.common.util.global.PasswordManager" fork="true">

			<classpath refid="temp.classpath" />

			<arg value="${base.dir}/catissuetmp.txt"/>
			<arg value="${first.admin.password}"/>
		</java>

		<property file="${base.dir}/catissuetmp.txt"/>
			<echo>
					Encoded Password ${first.admin.encodedPassword}
			</echo>

		<echo message="Modifying caTissue Suite SQL file for user information..."/>
			<copy file="${oracle.sql.dir}/createUser.sql" todir="${temp.dir}" overwrite="true"/>

			<replace dir="${temp.dir}" propertyfile="caTissueInstall.properties">
				<include name="createUser.sql"/>
				<replacefilter token="@@first.admin.department@@" value="${first.admin.department}"/>
				<replacefilter token="@@first.admin.institution@@" value="${first.admin.institution}"/>
				<replacefilter token="@@first.admin.cancerresearchgroup@@" value="${first.admin.cancerresearchgroup}"/>
				<replacefilter token="@@first.admin.emailAddress@@" value="${first.admin.emailAddress}"/>
				<replacefilter token="@@first.admin.encodedPassword@@" value="${first.admin.encodedPassword}"/>
			</replace>
			<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle">
					<transaction src="${temp.dir}/createUser.sql" />
					<transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
			</sql>
		<delete dir="${temp.dir}"/>
	</target>

	<target name="firstUser_mysql" description="Inserting the first user mentioned in the caTissueInstall.properties file For Mysql">
		<echo message="Encoding Password..."/>
		<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore"/>

		<java classname="edu.wustl.common.util.global.PasswordManager" fork="true">

			<classpath refid="temp.classpath" />

			<arg value="${base.dir}/catissuetmp.txt"/>
			<arg value="${first.admin.password}"/>
		</java>

		<property file="${base.dir}/catissuetmp.txt"/>
			<echo>
					Encoded Password ${first.admin.encodedPassword}
			</echo>

		<echo message="Modifying caTissue Suite SQL file for user information..."/>
		<copy file="${mysql.sql.dir}/createUser.sql" todir="${temp.dir}" overwrite="true"/>

			<replace dir="${temp.dir}" propertyfile="caTissueInstall.properties">
				<include name="createUser.sql"/>
				<replacefilter token="@@first.admin.department@@" value="${first.admin.department}"/>
				<replacefilter token="@@first.admin.institution@@" value="${first.admin.institution}"/>
				<replacefilter token="@@first.admin.cancerresearchgroup@@" value="${first.admin.cancerresearchgroup}"/>
				<replacefilter token="@@first.admin.emailAddress@@" value="${first.admin.emailAddress}"/>
				<replacefilter token="@@first.admin.encodedPassword@@" value="${first.admin.encodedPassword}"/>
			</replace>
			<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" password="${database.password}" >
							<transaction src="${temp.dir}/createUser.sql" />
							<transaction>commit;</transaction>
							<classpath>
								<fileset dir="${lib.dir}">
									<include name="*.jar" />
								</fileset>
							</classpath>
			</sql>
		<delete dir="${temp.dir}" />
	</target>

	<!-- Configure titli.properties according to properties in caTissueInstall.properties and other set properties -->
	<target name="configure_keyword_search" description="Configures titli.properties according to properties in caTissueInstall.properties and other set properties">
		<replace dir="${tempPath}" propertyfile="caTissueInstall.properties">
			<include name="titli.properties" />
			<replacefilter token="@@username@@" value="${database.username}" />
			<replacefilter token="@@password@@" value="${database.password}" />
			<replacefilter token="@@titliindexlocation@@" value="${jboss.server.url}/catissuecore-properties/titli-index" />
			<replacefilter token="@@databasename@@" value="${database.name}" />
			<replacefilter token="@@databasetype@@" value="${database.type}" />
		</replace>
		<!-- conditional configuration of database url and driver names -->
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<replace dir="${tempPath}" propertyfile="caTissueInstall.properties">
					<include name="titli.properties" />
					<replacefilter token="@@databasedriver@@" value="${mysqlDriver}" />
					<replacefilter token="@@databaseurl@@" value="jdbc:mysql://${database.host}:${database.port}/${database.name}" />
				</replace>
				<echo message="${database.type} ${database.name}" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<replace dir="${tempPath}" propertyfile="caTissueInstall.properties">
						<include name="titli.properties" />
						<replacefilter token="@@databaseurl@@" value="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" />
						<replacefilter token="@@databasedriver@@" value="${oracle.driver.string}" />
					</replace>
					<echo message="${database.type} ${database.name}" />
				</then>
			</elseif>
		</if>
	</target>

	<property name="filename" value=" " />
	<property name="hookentity" value=" " />
	<property name="mainContainerList" value=" " />
	<property name="condition" value=" " />
	<property name="package" value=" " />
	<property name="addQueryPaths" value=" " />

	<target name="import_xmi" description="Import XMI">
		<delete quiet="true" includeemptydirs="true">
			<fileset dir="${temp.dir}/catissuecore">
				<include name="**/*" />
			</fileset>
		</delete>

		<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore" />
		<antcall target="replace_app_dao_prop_file"/>
		<unzip src="dynamicextensions.zip" dest="${temp.dir}/dynamicextensions" overwrite="true" />
		<copy file="${base.dir}/DE_conf/hibernate.cfg.xml" todir="${temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />
		<copy file="${temp.dir}/dynamicextensions/conf/DynamicExtensionsHibernate.cfg.xml" tofile="${temp.dir}/catissuecore/WEB-INF/classes/DynamicExtensionsHibernate.cfg.xml" overwrite="true" />
		<copy file="${temp.dir}/dynamicextensions/conf/DynamicExtensionsAuditMetadata.xml" tofile="${temp.dir}/catissuecore/WEB-INF/classes/DynamicExtensionsAuditMetadata.xml" overwrite="true" />

		<unjar src="${temp.dir}/dynamicextensions/binaries/DynamicExtensionsInterface/DynamicExtensions.jar" dest="${temp.dir}/dynamicextensions/WEB-INF/classes" />
		<echo message="Concatenating the Application Resource Properties file" />
		<concat destfile="${temp.dir}/dynamicextensions/WEB-INF/classes/ApplicationResources.properties" append="true">
			<fileset file="${temp.dir}/catissuecore/WEB-INF/classes/ApplicationResources.properties" />
		</concat>
		<copy file="${temp.dir}/dynamicextensions/WEB-INF/classes/ApplicationResources.properties" todir="${temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />
		<!--<echo>Configuring logger ...</echo>
		<antcall target="configure_log4j" />-->
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
					<include name="*.cfg.xml" />
					<replacefilter token="@@DIALECT@@" value="${mysql.dialect.string}" />
					<replacefilter token="@@DRIVER@@" value="com.mysql.jdbc.Driver" />
					<replacefilter token="@@URL@@" value="jdbc:mysql://${database.host}:${database.port}/${database.name}" />
				</replace>
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
						<include name="*.cfg.xml" />
						<replacefilter token="@@DIALECT@@" value="${oracle.dialect.string}" />
						<replacefilter token="@@DRIVER@@" value="${oracle.driver.string}" />
						<replacefilter token="@@URL@@" value="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" />
					</replace>
				</then>
			</elseif>
		</if>
		<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
			<include name="*.cfg.xml" />
			<replacefilter token="@@DATABASE_USERNAME@@" value="${database.username}" />
			<replacefilter token="${token.database.password}" value="${database.password}" />
		</replace>

		<delete dir="${tempcacore.dir}" />
		<mkdir dir="${tempcacore.dir}" />

		<delete dir="${export.dir}" />
		<mkdir dir="${export.dir}" />

		<java classname="edu.wustl.catissuecore.annotations.xmi.ImportXmi" fork="true" maxmemory="1024m" failonerror="true">
			<arg value="${filename}" />
			<arg value="${mainContainerList}" />
			<arg value="${package}" />
			<arg value="${hookentity}" />
			<arg value="${addQueryPaths}" />
			<arg value="${condition}" />
			<arg value="${generate.cacore}" />

			<classpath>
				<pathelement location="${temp.dir}/catissuecore/WEB-INF/classes" />
				<fileset dir="${temp.dir}/catissuecore/WEB-INF/lib">
					<include name="*.jar" />
					<exclude name="uml-1.3.jar" />
				</fileset>
				<fileset dir="${lib.dir}">
						<include name="*.jar" />
				</fileset>
			</classpath>
		</java>

		<if>
			<equals arg1="${generate.cacore}" arg2="False" casesensitive="false" />
			<then>
				<echo message=" " />
				<echo message="------------------------------------------" />
				<echo message="Skipping cacore generation for ${filename} entity group " />
				<echo message="------------------------------------------" />
				<echo message=" " />
			</then>
			<else>
				<echo message=" " />
				<echo message="------------------------------------------" />
				<echo message="Generating cacore for ${filename} entity group " />
				<echo message="------------------------------------------" />
				<echo message=" " />

				<unzip src="dynamicextensions.zip" dest="${temp.dir}/dynamicextensions" overwrite="true" />

				<ant antfile="DEDeploy.xml" dir="." target="setupClassExecutionEnvironment" />

				<ant antfile="DEDeploy.xml" dir="." target="export.xmi.and.generate.cacore">
					<property name="xmi.name" value="${filename}" />
					<!-- property name="cacore.deployable.dir" value="${cacaore.deployables}" /-->
					<property name="de.zip.location" value="${temp.dir}/dynamicextensions" />
					<property name="import.xmi" value="True" />
				</ant>

				<delete file="${base.dir}/log4j.properties" />
			</else>
		</if>
		<delete dir="${export.dir}" />
		<delete dir="${tempcacore.dir}" />
	</target>


	<target name="Associate_forms" description="Associating forms with catissue">
		<delete quiet="true" includeemptydirs="true">
			<fileset dir="${temp.dir}/catissuecore">
				<include name="**/*" />
			</fileset>
		</delete>

		<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore" />

		<!-- Inject db-util.properties entry in catissue -> db-util.properties -->
		<replace file="${temp.dir}/catissuecore/WEB-INF/classes/dbutil.properties">
			<replacefilter token="${catissue.hibernate.config.file}" value="${catissue.hibernate.config.file}, DynamicExtensionsHibernate.cfg.xml" />
		</replace>

		<copy file="${base.dir}/DE_conf/hibernate.cfg.xml" todir="${temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />
		<copy file="${base.dir}/DE_conf/DynamicExtensionsHibernate.cfg.xml" todir="${temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />

		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
					<include name="*.cfg.xml" />
					<replacefilter token="@@DIALECT@@" value="${mysql.dialect.string}" />
					<replacefilter token="@@DRIVER@@" value="com.mysql.jdbc.Driver" />
					<replacefilter token="@@URL@@" value="jdbc:mysql://${database.host}:${database.port}/${database.name}" />
				</replace>
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
						<include name="*.cfg.xml" />
						<replacefilter token="@@DIALECT@@" value="${oracle.dialect.string}" />
						<replacefilter token="@@DRIVER@@" value="${oracle.driver.string}" />
						<replacefilter token="@@URL@@" value="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" />
					</replace>
				</then>
			</elseif>
		</if>
		<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
			<include name="*.cfg.xml" />
			<replacefilter token="@@DATABASE_USERNAME@@" value="${database.username}" />
			<replacefilter token="${token.database.password}" value="${database.password}" />
		</replace>
		<java classname="edu.wustl.catissuecore.util.AssociatesForms" fork="true" maxmemory="512m">
			<arg value="${entitiesFormsCSVFile}"/>
			<classpath>
				<pathelement location="${temp.dir}/catissuecore/WEB-INF/classes" />
				<fileset dir="${temp.dir}/catissuecore/WEB-INF/lib">
					<include name="*.jar" />
					<exclude name="uml-1.3.jar" />
				</fileset>
				<fileset dir="${lib.dir}">
						<include name="*.jar" />
				</fileset>
			</classpath>
		</java>
		<delete includeemptydirs="true">
			<fileset dir="${temp.dir}/catissuecore">
				<include name="**/*" />
			</fileset>
		</delete>
	</target>

	<target name="deploy_gate" depends="assertforgate" description="deploying gate">
		<echo message="Deploying gate...." />
		<property name="jboss.server.host.jboss.server.port" value="${jboss.server.host}:${jboss.server.port}" />
		<unzip src="gate.zip" dest="${jboss.server.url}/deploy/gate.war" />
		<if>
			<equals arg1="" arg2="${jboss.server.port}" />
			<then>
				<var name="jboss.server.host.jboss.server.port" unset="true"/>
				<property name="jboss.server.host.jboss.server.port" value="${jboss.server.host}" />
			</then>
		</if>
		<if>
			<equals arg1="${jboss.container.secure}" arg2="yes" />
			<then>
				<replace file="${jboss.server.url}/deploy/gate.war/gate_3_1/application/plugins/caTIES/creole.xml">
					<replacefilter token="@@HOST:PORT@@" value="https://${jboss.server.host.jboss.server.port}" />
					<replacefilter token="@@MMTX_HOME@@" value="${caties.mmtx.home}" />
				</replace>
			</then>
			<else>
				<replace file="${jboss.server.url}/deploy/gate.war/gate_3_1/application/plugins/caTIES/creole.xml">
					<replacefilter token="@@HOST:PORT@@" value="http://${jboss.server.host.jboss.server.port}" />
					<replacefilter token="@@MMTX_HOME@@" value="${caties.mmtx.home}" />
				</replace>
			</else>
		</if>
	</target>

	<target name="assertforgate" description="check for required properties for deploying gate">
		<if>
			<equals arg1="" arg2="${caties.mmtx.home}" />
			<then>
				<fail message="The property 'caties.mmtx.home' can not be empty" />
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${jboss.home.dir}" />
			<then>
				<fail message="The property 'jboss.home.dir' can not be empty" />
			</then>
		</if>
		<if>
			<equals arg1="" arg2="${jboss.server.host}" />
			<then>
				<fail message="The property 'jboss.server.host' can not be empty" />
			</then>
		</if>
		<!--<if>
			<equals arg1="" arg2="${jboss.server.port}" />
			<then>
				<fail message="The property 'jboss.server.port' can not be empty" />
			</then>
		</if>-->
	</target>
	<target name="upgrade_db_demodel" description="upgrade the db model">
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="upgrade_db_demodel_mysql" />
			</then>
		<elseif>
			<equals arg1="oracle" arg2="${database.type}" />
			<then>
				<antcall target="upgrade_db_demodel_oracle" />
			</then>
		</elseif>
		<else>
			<echo message="DATABASE UPGRADATION FOR DYNAMIC EXTENSIONS FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
		</else>
		</if>
	</target>

	<!--MySQL Database Upgradation -->
	<target name="upgrade_db_demodel_mysql" description="Upgared DE db model for Mysql">
		<echo message="Upgrading MySQL Database for DE model Application ..." />
		<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" password="${database.password}" >
			<transaction src="${dbupgrade.sql.dir}/DEDBUpgrade/MySql/dropdeconstraints.sql" />
			<transaction src="${dbupgrade.sql.dir}/DEDBUpgrade/MySql/createnewtable.sql" />
			<transaction src="${dbupgrade.sql.dir}/DEDBUpgrade/MySql/alterqueries.sql" />
			<transaction src="${dbupgrade.sql.dir}/DEDBUpgrade/MySql/addconstraints.sql" />
			<transaction src="${dbupgrade.sql.dir}/DEDBUpgrade/MySql/deupgrade_to_v1.2.0.rc1.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>
	<!--Oracle Database Upgradation -->
	<target name="upgrade_db_demodel_oracle" description="Upgared DE db model for Oracle">
		<echo message="Upgrading Oracle Database for DE model Application ..." />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle">
			<transaction src="${dbupgrade.sql.dir}/DEDBUpgrade/Oracle/dropdeconstraints.sql" />
			<transaction src="${dbupgrade.sql.dir}/DEDBUpgrade/Oracle/createnewtable.sql" />
			<transaction src="${dbupgrade.sql.dir}/DEDBUpgrade/Oracle/alterqueries.sql" />
			<transaction src="${dbupgrade.sql.dir}/DEDBUpgrade/Oracle/addconstraints.sql" />
			<transaction src="${dbupgrade.sql.dir}/DEDBUpgrade/Oracle/deupgrade_to_v1.2.0.rc1.sql" />
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" delimiter="/" delimitertype="row" keepformat="yes" rdbms="oracle">
			<transaction src="${dbupgrade.sql.dir}/DEDBUpgrade/Oracle/addsequence.sql" />
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>





	<!--  ShippingTracking - start -->
	<!-- Check user selected deploy.shippingtracking to true and shippingtracking.zip exists
	<target name="st_check_prerequisite"> -->
		<!-- Check shippingtracking.zip file exists or not in base directory.
		<available file="${base.dir}/shippingtracking.zip" property="file.exists" value="false" />
		<if>
			<not>
			   <isset property="file.exists"/>
			</not>
			<then> -->
			   <!-- <fail message="ShippingTracking.zip file not found. It should be in base directory to deploy shippingtracking." />
			   <echo message="ShippingTracking.zip file not found. It should be in base directory to deploy shippingtracking." level="error" />
			</then>
			<else>
			   <echo message="ShippingTracking is ready to use."/>
			</else>
		</if>
	</target>
	-->
	<!-- Integrating shipping tracking application with catissue
	<target name="st_integrate_app" depends="st_check_prerequisite" if="file.exists" >
		<echo message="Integrating shippingtracking app ...." />
		<unzip src="shippingtracking.zip" dest="${temp.dir}/shippingtracking" overwrite="true" />
	-->
		<!-- Inject db specific information to configuration files
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="st_mysql_config" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="st_oracle_config" />
				</then>
			</elseif>
			<elseif>
				<equals arg1="mssqlserver" arg2="${database.type}" />
				<then>
					<antcall target="st_mssqlserver_config" />
				</then>
			</elseif>
		</if>
	 	-->
		<!-- 1) Copy shippingtracking.jar -> copy it to catissue/WEB-INF/Lib
		<copy file="${temp.dir}/shippingtracking/shippingtracking.jar" todir="${temp.dir}/catissuecore/WEB-INF/lib" overwrite="true" />
		-->
		<!-- 2) Copy *.properties, st*.cfg.xml, *.jsp, *.css, *.images, st*-struts-config.xml to respective folders
		<copy todir="${temp.dir}/catissuecore/WEB-INF/classes" overwrite="true">
			<fileset dir="${temp.dir}/shippingtracking">
				<include name="ShippingTrackingApplicationResources.properties" />
				<include name="ShippingTrackingHibernate.cfg.xml" />
			</fileset>
		</copy>
		<copy todir="${temp.dir}/catissuecore/WEB-INF" overwrite="true">
			<fileset dir="${temp.dir}/shippingtracking">
				<include name="shippingtracking-struts-config.xml" />
				<include name="ShippingTracking-tiles-defs.xml" />
			</fileset>
		</copy>

		<copy todir="${temp.dir}/catissuecore/css" overwrite="true">
			<fileset dir="${temp.dir}/shippingtracking/css" />
		</copy>
		<copy todir="${temp.dir}/catissuecore/jss" overwrite="true">
			<fileset dir="${temp.dir}/shippingtracking/jss" />
		</copy>
		<copy todir="${temp.dir}/catissuecore/pages" overwrite="true">
			<fileset dir="${temp.dir}/shippingtracking/pages" />
		</copy>
		<copy todir="${temp.dir}/catissuecore/images" overwrite="true">
			<fileset dir="${temp.dir}/shippingtracking/images" />
		</copy>
		 -->
		<!-- 3) Inject st-struts-config.xml entry in catisssue -> web.xml
		<replace file="${temp.dir}/catissuecore/WEB-INF/web.xml">
			<replacefilter token="/WEB-INF/${catissue.struts.config.file}" value="/WEB-INF/${catissue.struts.config.file}, /WEB-INF/shippingtracking-struts-config.xml" />
		</replace>
		-->
		<!-- 4) Inject db-util.properties entry in catissue -> db-util.properties
		<replace file="${temp.dir}/catissuecore/WEB-INF/classes/dbutil.properties">
			<replacefilter token="${catissue.hibernate.config.file}" value="${catissue.hibernate.config.file}, ShippingTrackingHibernate.cfg.xml" />
		</replace>
		-->
		<!-- 5) Inject "/WEB-INF/ShippingTracking-tiles-defs.xml" entry in catisssue -> struts-config.xml
		<replace file="${temp.dir}/catissuecore/WEB-INF/${catissue.struts.config.file}">
			<replacefilter token="/WEB-INF/${catissue.tiles.def.file}" value="/WEB-INF/${catissue.tiles.def.file}, /WEB-INF/ShippingTracking-tiles-defs.xml" />
		</replace>

	</target>
	-->
	<!-- Modify shippingtracking configuration For MySQL
	<target name="st_mysql_config">
		<replace file="${temp.dir}/shippingtracking/ShippingTrackingHibernate.cfg.xml">
			<replacefilter token="${mysql.dialect.string}" value="${mysql.dialect.string}" />
		</replace>
	</target>
	-->

	<!-- Deploying shippingtracking db -->
	<target name="st_deploy_db" description="Deploying shippingtracking db ....">
		<echo message="Deploying shippingtracking db ...." />
	<!--	<unzip src="shippingtracking.zip" dest="${temp.dir}/shippingtracking" overwrite="true" /> -->

		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="st_deploy_db_mysql" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="st_deploy_db_oracle" />
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>

	<!--	<delete dir="${temp.dir}"/> -->
	</target>

	<!-- Deploying shippingtracking db for mysql -->
	<target name="st_deploy_db_mysql" description="Deploying shippingtracking db for mysql">
		<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" password="${database.password}" onerror="continue">
			<transaction src="${base.dir}/SQL/MySql/shippingtracking.sql"  />

			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>

	<!-- Deploying shippingtracking db for oracle -->
	<target name="st_deploy_db_oracle" description="Deploying shippingtracking db for oracle">
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle" onerror="continue">
			<transaction src="${base.dir}/SQL/Oracle/shippingtracking.sql"/>

			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>

	<!--  ShippingTracking - end -->

	<target name="alter_CA_model_Tables" description="Upgrading Oracle Database for DE model Application ...">
		<echo message="Upgrading Oracle Database for DE model Application ..." />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" onerror="continue" rdbms="oracle">
			<transaction src="${dbupgrade.sql.dir}/DEDBUpgrade/Oracle/modify_annotation_PV.sql" />

			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>


	<!-- Associating forms/entities with CPs  - start -->
	<target name="Associate_forms_to_CPs" description="Associating forms/entities with CPs">
		<delete quiet="true" includeemptydirs="true">
			<fileset dir="${temp.dir}/catissuecore">
				<include name="**/*" />
			</fileset>
		</delete>

		<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore" />
		<!-- Inject db-util.properties entry in catissue -> db-util.properties -->
		<replace file="${temp.dir}/catissuecore/WEB-INF/classes/dbutil.properties">
			<replacefilter token="${catissue.hibernate.config.file}" value="${catissue.hibernate.config.file}, DynamicExtensionsHibernate.cfg.xml" />
		</replace>

		<copy file="${base.dir}/DE_conf/hibernate.cfg.xml" todir="${temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />
		<copy file="${base.dir}/DE_conf/DynamicExtensionsHibernate.cfg.xml" todir="${temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />

		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
				<include name="*.cfg.xml" />
				<replacefilter token="@@DIALECT@@" value="${mysql.dialect.string}" />
				<replacefilter token="@@DRIVER@@" value="com.mysql.jdbc.Driver" />
				<replacefilter token="@@URL@@" value="jdbc:mysql://${database.host}:${database.port}/${database.name}" />
				</replace>
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
					<include name="*.cfg.xml" />
					<replacefilter token="@@DIALECT@@" value="${oracle.dialect.string}" />
						<replacefilter token="@@DRIVER@@" value="${oracle.driver.string}" />
						<replacefilter token="@@URL@@" value="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" />
					</replace>
				</then>
			</elseif>
		</if>
		<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
			<include name="*.cfg.xml" />
			<replacefilter token="@@DATABASE_USERNAME@@" value="${database.username}" />
			<replacefilter token="${token.database.password}" value="${database.password}" />
		</replace>
		<java classname="edu.wustl.catissuecore.util.AssociatesCps" fork="true" maxmemory="512m">
			<arg value="${cpsEntitiesXMLFile}"/>
			<jvmarg value="-server"/>
			<classpath>
				<pathelement location="${temp.dir}/catissuecore/WEB-INF/classes" />
				<fileset dir="${temp.dir}/catissuecore/WEB-INF/lib">
					<include name="*.jar" />
					<exclude name="uml-1.3.jar" />
				</fileset>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</java>
		<delete includeemptydirs="true">
			<fileset dir="${temp.dir}/catissuecore">
				<include name="**/*" />
			</fileset>
		</delete>
	</target>

		<!-- Associating forms/entities with CPs  - end -->

		<!-- Indexing tables for Keyword Search - start-->

	<!-- Removing it since it is done by the scheduler now. Bug Id: PLUS-25
	<target name="runKeywordSearchIndexer" description="Indexing tables for Keyword Search">
		<property name="mysql.driver" value="com.mysql.jdbc.Driver" ></property>
		<echo message="Indexing tables for Keyword Search....." />
		<property name="tempKeywordSearch" value="${basedir}/tempKeywordSearch"></property>
		<unwar src="${base.dir}/catissuecore.war" dest="${tempKeywordSearch}" />

		<antcall target="configure_keyword_search" >
			<param name="tempPath" value="${tempKeywordSearch}/WEB-INF/classes" />
			<param name="mysqlDriver" value="${mysql.driver}" />
		</antcall>

		<java classname="edu.wustl.catissuecore.keywordsearch.TitliIndexer"  fork="true" maxmemory="512m">
				<classpath>
					<pathelement location="${tempKeywordSearch}/WEB-INF/classes"/>
					<fileset dir="${tempKeywordSearch}/WEB-INF/lib">
							<include name="**/*.jar"/>
					</fileset>
				</classpath>
		</java>
		<delete dir="${tempKeywordSearch}"></delete>
	</target>
	-->
	<!-- Indexing tables for Keyword Search - end-->


	<!-- IIS properties configuration -->
	<target name="configure_IIS_properties" description="Configuring IIS properties...">
		<echo message="Configuring IIS properties..." />

		<!-- Check whether JAVA_HOME environment variable is set or not -->
		<if>
			<contains string="${env.JAVA_HOME}" substring="env.JAVA_HOME"/>
			<then>
				<fail message="JAVA_HOME is not set. Please make sure to set JAVA_HOME environment variable to the directory of your local JDK." />
			</then>
		</if>

		<!-- Modify registry file -->
		<pathconvert property="IISSettings.home.registry" dirsep="\\">
			<path path="${basedir}\IISSettings"/>
		</pathconvert>
		<echo>${IISSettings.home.registry}</echo>
		<replace file="${base.dir}/IISSettings/iis_redirect.reg">
			<replacefilter token="@@IISSettings_HOME@@" value="${IISSettings.home.registry}" />
		</replace>

		<!-- Modify property file -->
		<pathconvert property="IISSettings.home">
			<path path="${basedir}\IISSettings"/>
		</pathconvert>
		<echo>${IISSettings.home}</echo>
		<replace file="${base.dir}/IISSettings/worker.properties">
			<replacefilter token="@@IISSettings_HOME@@" value="${IISSettings.home}" />
		</replace>

		<!-- Replace java home -->
		<echo>${env.JAVA_HOME}</echo>
		<replace file="${base.dir}/IISSettings/worker.properties">
			<replacefilter token="@@JAVA_HOME@@" value="${env.JAVA_HOME}" />
		</replace>
	</target>

	<target name="commondbconfig" description="database configuration">
	<delete quiet="true" includeemptydirs="true">
			<fileset dir="${temp.dir}/catissuecore">
				<include name="**/*" />
			</fileset>
		</delete>
		<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore" />

		<copy file="${base.dir}/DE_conf/hibernate.cfg.xml" todir="${temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />
		<copy file="${base.dir}/DE_conf/DynamicExtensionsHibernate.cfg.xml" todir="${temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
					<include name="*.cfg.xml" />
					<replacefilter token="@@DIALECT@@" value="${mysql.dialect.string}" />
					<replacefilter token="@@DRIVER@@" value="com.mysql.jdbc.Driver" />
					<replacefilter token="@@URL@@" value="jdbc:mysql://${database.host}:${database.port}/${database.name}" />
				</replace>
			</then>

			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
						<include name="*.cfg.xml" />
						<replacefilter token="@@DIALECT@@" value="${oracle.dialect.string}" />
						<replacefilter token="@@DRIVER@@" value="${oracle.driver.string}" />
						<replacefilter token="@@URL@@" value="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" />
					</replace>
				</then>
			</elseif>
		</if>
		<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
			<include name="*.cfg.xml" />
			<replacefilter token="@@DATABASE_USERNAME@@" value="${database.username}" />
			<replacefilter token="${token.database.password}" value="${database.password}" />

		</replace>
	</target>

	<!-- call this task in Feb End release while upgrading Db -->
	<target name="upgrade_metadata_for_constraintproperties" depends="commondbconfig" description="upgrade_metadata_for_constraintproperties">

		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="upgrade_metadata_for_constraintproperties_mysql" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="upgrade_metadata_for_constraintproperties_oracle" />
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
	</target>

	<target name="upgrade_metadata_for_constraintproperties_mysql" description="upgrade_metadata_for_constraintproperties for Mysql">
		<echo message="Updating DE Model changes..." />
		<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" password="${database.password}">
			<transaction src="${dbupgrade.sql.dir}/MySql/upgrade_metadata_cnstrProp.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<java classname="edu.wustl.catissuecore.querysuite.metadata.UpdateSchemaForConstraintProperties" fork="true">
			<classpath>
				<pathelement location="${temp.dir}/catissuecore/WEB-INF/classes" />
				<fileset dir="${temp.dir}/catissuecore/WEB-INF/lib">
					<include name="*.jar" />
					<exclude name="uml-1.3.jar" />
				</fileset>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</java>
	</target>

	<target name="upgrade_metadata_for_constraintproperties_oracle" description="upgrade_metadata_for_constraintproperties for oracle">
		<echo message="Updating DE Model changes..." />
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" onerror="continue" rdbms="oracle">
			<transaction src="${dbupgrade.sql.dir}/Oracle/upgrade_metadata_cnstrProp.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<java classname="edu.wustl.catissuecore.querysuite.metadata.UpdateSchemaForConstraintProperties" fork="true">
			<classpath>
				<pathelement location="${temp.dir}/catissuecore/WEB-INF/classes" />
				<fileset dir="${temp.dir}/catissuecore/WEB-INF/lib">
					<include name="*.jar" />
					<exclude name="uml-1.3.jar" />
				</fileset>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</java>
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" onerror="continue" delimiter="/" delimitertype="row" keepformat="yes" rdbms="oracle">

			<!--<transaction  src="${dbupgrade.sql.dir}/Oracle/upgrade_cnstrProp_dropColumn.sql"/>-->
			<transaction src="${dbupgrade.sql.dir}/Oracle/upgrade_cnstrProp_createSeq.sql" />
			<transaction src="${dbupgrade.sql.dir}/Oracle/upgrade_cnstrProp_resetDESequences.sql" />
			<transaction>commit</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>

	<!-- upgrade category entity names from RC4 or from suite v1.1 to suite v1.1p-->
	<target name="upgrade_category_entity_names" description="pgrade category entity names from RC4 or from suite v1.1 to suite v1.1p-">
		<delete quiet="true" includeemptydirs="true">
			<fileset dir="${temp.dir}/catissuecore">
				<include name="**/*" />
			</fileset>
		</delete>
		<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore" />
		<unzip src="${base.dir}/dynamicextensions.zip" dest="${temp.dir}/dynamicextensions" overwrite="true" />
		<unjar src="${temp.dir}/dynamicextensions/binaries/DynamicExtensionsInterface/DynamicExtensions.jar" dest="${temp.dir}/catissuecore/WEB-INF/classes" overwrite="true"/>
		<copy file="${temp.dir}/dynamicextensions/binaries/DynamicExtensionsInterface/DynamicExtensions.jar" todir="${temp.dir}/catissuecore/WEB-INF/lib" overwrite="true" />
		<copy file="${base.dir}/DE_conf/hibernate.cfg.xml" todir="${temp.dir}/catissuecore/WEB-INF/classes" overwrite="true"/>
		<copy file="${base.dir}/DE_conf/DynamicExtensionsHibernate.cfg.xml" todir="${temp.dir}/catissuecore/WEB-INF/classes" overwrite="true"/>

		<!--<echo>Configuring logger ...</echo>
		<antcall target="configure_log4j" />-->
		<if>
			<equals arg1="mysql" arg2="${database.type}"/>
			<then>
				<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
				<include name="*.cfg.xml" />
				<replacefilter token="@@DIALECT@@" value="${mysql.dialect.string}"/>
				<replacefilter token="@@DRIVER@@" value="com.mysql.jdbc.Driver"/>
				<replacefilter token="@@URL@@" value="jdbc:mysql://${database.host}:${database.port}/${database.name}" />
				</replace>
			</then>
		<elseif>
			<equals arg1="oracle" arg2="${database.type}"/>
			<then>
				<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
				<include name="*.cfg.xml" />
				<replacefilter token="@@DIALECT@@" value="${oracle.dialect.string}"/>
				<replacefilter token="@@DRIVER@@" value="${oracle.driver.string}"/>
				<replacefilter token="@@URL@@" value="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" />
				</replace>
			</then>
		</elseif>
		</if>
		<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
			<include name="*.cfg.xml" />
			<replacefilter token="@@DATABASE_USERNAME@@" value="${database.username}"/>
			<replacefilter token="${token.database.password}" value="${database.password}"/>
		</replace>

		<java classname="edu.common.dynamicextensions.util.UpgradeCategoryEntityName" fork="true" maxmemory="1024M">
			<arg value="${categoryDefinitionFilePath}"/>
				<classpath>
					<pathelement location="${temp.dir}/catissuecore/WEB-INF/classes"/>
		            <fileset dir="${temp.dir}/catissuecore/WEB-INF/lib">
			          	<include name="*.jar"/>
			           		<exclude name="uml-1.3.jar"/>
			         </fileset>
					<fileset dir="${lib.dir}">
							<include name="*.jar" />
					</fileset>
			    </classpath>
		</java>

		<delete includeemptydirs="true">
			<fileset dir="${temp.dir}/catissuecore">
				<include name="**/*" />
			</fileset>
		</delete>
	</target>

	<!-- This target replaces databases properties properties in hibernate cfg file
		based on database configuration in catissueInstall.properties file.-->
	<target name="replacecfgfiles" description="This target replaces databases properties properties in hibernate cfg file based on database configuration in catissueInstall.properties file">
		<copy file="${base.dir}/DE_conf/hibernate.cfg.xml" todir="${temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />
		<copy file="${base.dir}/DE_conf/DynamicExtensionsHibernate.cfg.xml" todir="${temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
					<include name="*.cfg.xml" />
					<replacefilter token="@@DIALECT@@" value="${mysql.dialect.string}" />
					<replacefilter token="@@DRIVER@@" value="com.mysql.jdbc.Driver" />
					<replacefilter token="@@URL@@" value="jdbc:mysql://${database.host}:${database.port}/${database.name}" />
				</replace>
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
						<include name="*.cfg.xml" />
						<replacefilter token="@@DIALECT@@" value="${oracle.dialect.string}" />
						<replacefilter token="@@DRIVER@@" value="${oracle.driver.string}" />
						<replacefilter token="@@URL@@" value="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" />
					</replace>
				</then>
			</elseif>
		</if>
		<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
			<include name="*.cfg.xml" />
			<replacefilter token="@@DATABASE_USERNAME@@" value="${database.username}" />
			<replacefilter token="${token.database.password}" value="${database.password}" />
		</replace>
	</target>

	<!-- This target replaces proper application dao properties file in ApplicationDAOProperties.xml
		based on database configuration in catissueInstall.properties file.-->
	<target name="replace_app_dao_prop_file" description="This target replaces proper application dao properties file in ApplicationDAOProperties.xml based on database configuration in catissueInstall.properties file">
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<replace file="${temp.dir}/catissuecore/WEB-INF/classes/ApplicationDAOProperties.xml">
					<replacefilter token="${oracle.dao.prop.filename}" value="${mysql.dao.prop.filename}" />
				</replace>
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<replace file="${temp.dir}/catissuecore/WEB-INF/classes/ApplicationDAOProperties.xml">
						<replacefilter token="${mysql.dao.prop.filename}" value="${oracle.dao.prop.filename}" />
					</replace>
				</then>
			</elseif>
		</if>
	</target>


	<target name="update_metadata_for_tagged_values" depends="commondbconfig" description="update metadata for tagged values">
		<echo message="Updating Tagged Values....." />
			<java classname="edu.wustl.catissuecore.querysuite.metadata.UpdateMetadataTagPath" fork="true" maxmemory="1024M" failonerror="true">
				<arg value="${base.dir}/taggedvalues.xml" />
				<classpath location="${temp.dir}/catissuecore/WEB-INF/classes" />
				<classpath refid="temp.classpath" />
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
						<fileset dir="${temp.dir}/catissuecore/WEB-INF/lib">
							<include name="*.jar" />
						</fileset>
				</classpath>
			</java>
		<delete dir="${temp.dir}" />
	</target>

	<target name="update_metaPhone_data_for_participant" description="update metaPhone data for participant">
				<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore"/>
		 	    <delete file="${temp.dir}/catissuecore/WEB-INF/lib/mmtxProject.jar" />
				<if>
					<equals arg1="mysql" arg2="${database.type}" />
					<then>
						<antcall target="update_metaPhoneData_for_participant_mysql" />
					</then>
					<elseif>
						<equals arg1="oracle" arg2="${database.type}" />
						<then>
							<antcall target="update_metaPhoneData_for_participant_oracle" />
						</then>
					</elseif>
					<else>
						<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
					</else>
				</if>
				<delete dir="${temp.dir}" />
		</target>

   <target name="update_metaPhoneData_for_participant_mysql" description="Updating metaPhone information for participant last name (mysql).....">

		<echo message="Updating metaPhone information for participant last name (mysql)....." />
		<java classname="UpdateParticipantMetaPhoneInfo"  fork="true" maxmemory="512m">
			<classpath location="${temp.dir}/catissuecore/WEB-INF/classes" />
			<classpath refid="temp.classpath" />
 			<arg value="${database.host}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.username}"/>
			<arg value="${database.password}"/>
			<arg value="${mysql.driver.string}"/>
		</java>
  </target>


	<target name="update_metaPhoneData_for_participant_oracle" description="Updating metaPhone information for participant last name (oracle).....">

		<echo message="Updating metaPhone information for participant last name (oracle)....." />
		<java classname="UpdateParticipantMetaPhoneInfo"  fork="true" maxmemory="512m">
			<classpath location="${temp.dir}/catissuecore/WEB-INF/classes" />
			<classpath refid="temp.classpath" />
			<arg value="${database.host}"/>
			<arg value="${database.port}"/>
			<arg value="${database.type}"/>
			<arg value="${database.name}"/>
			<arg value="${database.username}"/>
			<arg value="${database.password}"/>
			<arg value="${oracle.driver.string}"/>
		</java>
	</target>

	<target name="replaceQuerycfgfile" description="Replacing query configuration files">
		<copy file="${base.dir}/DE_conf/QueryHibernate.cfg.xml" todir="${temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
					<include name="*.cfg.xml" />
					<replacefilter token="@@DIALECT@@" value="${mysql.dialect.string}" />
					<replacefilter token="@@DRIVER@@" value="com.mysql.jdbc.Driver" />
				</replace>
			<var name="databaseurl" value="jdbc:mysql://"/>
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
						<include name="*.cfg.xml" />
						<replacefilter token="@@DIALECT@@" value="${oracle.dialect.string}" />
						<replacefilter token="@@DRIVER@@" value="${oracle.driver.string}" />
					</replace>
					<var name="databaseurl" value="jdbc:oracle:thin:@" />
				</then>
			</elseif>
			</if>
			<echo message="Database url is  ${databaseurl}......" />
		<!--	<if>
				<equals arg1="true" arg2="${idp.enabled}" />
			<then>
				<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
				<include name="*.cfg.xml" />
					<replacefilter token="@@URL@@" value="${databaseurl}${csm.database.host}:${csm.database.port}:${csm.database.name}" />
					<replacefilter token="@@DATABASE_USERNAME@@" value="${csm.database.username}" />
					<replacefilter token="@@DATABASE_PASSWORD@@" value="${csm.database.password}" />
			</replace>
			</then>
			<else> -->
				<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
					<include name="*.cfg.xml" />
					<replacefilter token="@@URL@@" value="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" />
					<replacefilter token="@@DATABASE_USERNAME@@" value="${database.username}" />
					<replacefilter token="@@DATABASE_PASSWORD@@" value="${database.password}" />
				</replace>
		<!--	</else>
			</if> -->
	</target>
	<target name="upgrade_saved_queries" description="Upgrading saved queries....">
          <echo message="Upgrading saved queries...."/>
          <unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore"/>
          <copy file="${base.dir}/catissuecore-properties/ApplicationSecurityConfig.xml" todir="${temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />
          <antcall target="replacecfgfiles" />
		  <antcall target="replaceQuerycfgfile" />
          <replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
                <include name="ApplicationSecurityConfig.xml" />
                <replacefilter token="@@hibernate-config-file@@" value="${temp.dir}/catissuecore/WEB-INF/classes/QueryHibernate.cfg.xml" />
          </replace>
          <java classname="edu.wustl.query.upgrade.UpgradeSavedQueries" fork="true" maxmemory="1024M">
                <classpath location="${temp.dir}/catissuecore/WEB-INF/classes" />
                <classpath refid="temp.classpath" />
                <classpath>
                      <fileset dir="${lib.dir}">
                            <include name="*.jar" />
                      </fileset>
                </classpath>
                <arg value="${temp.dir}/catissuecore/WEB-INF/classes/ApplicationSecurityConfig.xml"/>
          		<arg value="${saved.query.owner}"/>
          </java>
		<delete dir="${temp.dir}" />
    </target>

	<property name="operationName" value="" />
	<property name="dropdownName" value="" />
	<property name="csvFile" value="" />
	<property name="xmlFile" value="" />

	<target name="add_bulk_operation_template" description="this target adds the bulk operation XML and CSV template in the database.">
		<echo message="Starting to load Bulk Operator Template.........." />
		<java classname="com.krishagni.catissueplus.bulkoperator.templateImport.ImportBulkOperationTemplate"
				fork="true" maxmemory="1024m">
			<arg value="${operationName}" />
			<arg value="${dropdownName}" />
			<arg value="${csvFile}" />
			<arg value="${xmlFile}" />
			<classpath>
				<fileset dir="./caTissueSuite_Client/lib/">
					<include name="*.jar" />
					<exclude name="AdvanceQuery*.jar" />
				</fileset>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
			<sysproperty key="config.dir" value="catissuecore-properties" />
		</java>
		
	</target>

	<property name="operationName" value="" />
	<property name="csvFile" value="" />
	<property name="url" value="" />
	<property name="applicationUserName" value="" />
	<property name="applicationUserPassword" value="" />
	<property name="templateFile" value="" />
	<property name="keyStoreLocation" value="" />
	<property name="bulkArtifactsLocation" value="" />

	<target name="runBulkOperation" description="this target runs the bulk operation module through API client.">
		<echo message="Starting to run Bulk Operation... " />
		<java classname="com.krishagni.catissueplus.bulkoperator.client.BulkOperationCommand"
				fork="true" maxmemory="1024m">
			<arg value="${operationName}" />
			<arg value="${csvFile}" />
			<arg value="${url}" />
			<arg value="${applicationUserName}" />
			<arg value="${applicationUserPassword}" />
			<arg value="${templateFile}"/>
			<arg value="${keyStoreLocation}" />
			<arg value="${bulkArtifactsLocation}" />
			<classpath>
				<fileset dir="./caTissueSuite_Client/lib/">
					<include name="*.jar" />
					<exclude name="AdvanceQuery*.jar" />
				</fileset>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
					<exclude name="AdvanceQuery*.jar" />
				</fileset>
				<fileset dir="./caTissueSuite_Client/">
						<include name="*.properties" />
				</fileset>
			</classpath>
		</java>
	</target>

	<target name="insertPaths">
			<antcall target="unzip_aq_installable" />
			<property name="tempInsertPaths" value="${basedir}/tempInsertPaths"></property>
			<unwar src="${base.dir}/catissuecore.war" dest="${tempInsertPaths}" />
			<antcall target="replacecfgfilesForInsertPaths"/>
			<ant dir="${temp.dir}/AdvanceQuery" inheritAll="false" antfile="queryintegration.xml" target="insertPaths">
				<property name="parent.base.dir" value="${base.dir}" />
				<property name="deploy.temp.dir" value="${basedir}" />
				<property name="war.dir" value="tempInsertPaths" />
				<property name="lib.dir" value="${basedir}/lib" />
				<property name="property.file" value="${basedir}/caTissueInstall.properties" />
			</ant>
			<delete dir="${tempInsertPaths}" quiet="true"/>
		</target>

	<target name="replacecfgfilesForInsertPaths" description="This target replaces databases properties properties in hibernate cfg file based on database configuration in catissueInstall.properties file">
			<copy file="${base.dir}/DE_conf/hibernate.cfg.xml" todir="${tempInsertPaths}/WEB-INF/classes" overwrite="true" />
			<copy file="${base.dir}/DE_conf/DynamicExtensionsHibernate.cfg.xml" todir="${tempInsertPaths}/WEB-INF/classes" overwrite="true" />
			<if>
				<equals arg1="mysql" arg2="${database.type}" />
				<then>
					<replace dir="${tempInsertPaths}/WEB-INF/classes">
						<include name="*.cfg.xml" />
						<replacefilter token="@@DIALECT@@" value="${mysql.dialect.string}" />
						<replacefilter token="@@DRIVER@@" value="com.mysql.jdbc.Driver" />
						<replacefilter token="@@URL@@" value="jdbc:mysql://${database.host}:${database.port}/${database.name}" />
					</replace>
				</then>
				<elseif>
					<equals arg1="oracle" arg2="${database.type}" />
					<then>
						<replace dir="${tempInsertPaths}/WEB-INF/classes">
							<include name="*.cfg.xml" />
							<replacefilter token="@@DIALECT@@" value="${oracle.dialect.string}" />
							<replacefilter token="@@DRIVER@@" value="${oracle.driver.string}" />
							<replacefilter token="@@URL@@" value="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" />
						</replace>
					</then>
				</elseif>
			</if>
			<replace dir="${tempInsertPaths}/WEB-INF/classes">
				<include name="*.cfg.xml" />
				<replacefilter token="@@DATABASE_USERNAME@@" value="${database.username}" />
				<replacefilter token="${token.database.password}" value="${database.password}" />
			</replace>
		</target>

	<target name="upgrade_db_from_p5_to_p5.1" description="Target for Database Upgrade from caTissue p5 to p5.1">
			<echo message="Upgrading Database v1.1p5 to v1.1p5.1" />
		    <if>
				<equals arg1="mysql" arg2="${database.type}" />
				<then>
					<antcall target="upgrade_mysql_from_v1.1p5_to_v1.1p5.1" />
				</then>
				<elseif>
					<equals arg1="oracle" arg2="${database.type}" />
					<then>
						<antcall target="upgrade_oracle_from_v1.1p5_to_v1.1p5.1" />
					</then>
				</elseif>
				<else>
					<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
				</else>
			</if>
		</target>

	<!-- Upgrading from Suite1.1 p5 to p5.1 - MySQL -->
		<target name="upgrade_mysql_from_v1.1p5_to_v1.1p5.1" description="Upgrading from Suite1.1 p5 to p5.1 - MySQL">
			<echo message="Upgrading MySQL Database." />
			<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" password="${database.password}" >
				<transaction src="${dbupgrade.sql.dir}/MySql/DBUpgrade_v1.1p5_to_v1.1p5.1.sql" />
				<transaction>commit;</transaction>
				<classpath>
					<fileset dir="${lib.dir}">
						<include name="*.jar" />
					</fileset>
				</classpath>
			</sql>

			<echo message="Upgrading MSSQL Metadata from p5 to p5.1" />
			<antcall target="update_metadata_for_model_changes_mysql_post_P5" />

		</target>

	<target name="upgrade_oracle_from_v1.1p5_to_v1.1p5.1" description=" Upgrading Oracle Database. Upgrading from Suite1.1 p5 to p5.1 - Oracle">
			<echo message="Upgrading Oracle Database p5 to p5.1" />
			<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle">
				<transaction src="${dbupgrade.sql.dir}/Oracle/DBUpgrade_v1.1p5_to_v1.1p5.1.sql" />
				<transaction>commit;</transaction>
				<classpath>
					<fileset dir="${lib.dir}">
						<include name="*.jar" />
					</fileset>
				</classpath>
			</sql>
			<echo message="Upgrading Oracle Metadata from p5 to p5.1" />
		    <antcall target="update_metadata_for_model_changes_oracle_post_P5" />
	   </target>

		<target name="upgrade_query_metadata_for_1.2" description="Upgrading database for query metadata">
			<echo message="Upgrading Database" />
			<if>
				<equals arg1="mysql" arg2="${database.type}" />
				<then>
					<antcall target="upgrade_query_metadata_for_1.2_mysql" />
				</then>
				<elseif>
					<equals arg1="oracle" arg2="${database.type}" />
					<then>
						<antcall target="upgrade_query_metadata_for_1.2_oracle" />
					</then>
				</elseif>
				<else>
					<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
				</else>
			</if>
		</target>

		<target name="upgrade_query_metadata_for_1.2_mysql" description="Upgrading MySQL Metadata">
			<echo message="Upgrading MySQL Database." />
			<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" password="${database.password}" >
				<transaction src="${dbupgrade.sql.dir}/MySql/DBUpgrade_query_metadata.sql" />
				<transaction>commit;</transaction>
				<classpath>
					<fileset dir="${lib.dir}">
						<include name="*.jar" />
					</fileset>
				</classpath>
			</sql>
			<echo message="Upgrading MSSQL Metadata" />
		</target>

		<target name="upgrade_query_metadata_for_1.2_oracle" description="Upgrading Oracle metadata">
			<echo message="Upgrading Oracle Database."/>
			<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle" delimiter="/" delimitertype="row">
				<transaction src="${dbupgrade.sql.dir}/Oracle/UpdateMetadata.sql" />
				<classpath>
					<fileset dir="${lib.dir}">
						<include name="*.jar" />
					</fileset>
				</classpath>
			</sql>
			<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle">
				<transaction src="${dbupgrade.sql.dir}/Oracle/DBUpgrade_query_metadata.sql" />
				<transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
			</sql>
			<echo message="Upgrading Oracle Metadata" />
		</target>

	<target name="upgrade_db_for_1.2" description="Upgrading database for all changes required for v1.2">
				<echo message="Upgrading Database" />
				<if>
					<equals arg1="mysql" arg2="${database.type}" />
					<then>
						<antcall target="upgrade_db_for_v1.2_mysql" />
					</then>
					<elseif>
						<equals arg1="oracle" arg2="${database.type}" />
						<then>
							<antcall target="upgrade_db_for_v1.2_oracle" />
						</then>
					</elseif>
					<else>
						<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
					</else>
				</if>
			</target>
	
	<target name="upgrade_db_from_v1.2.3_to_1.2.4" description="Upgrading database for all changes required for v1.2.2">
		<echo message="Upgrading Database" />
		<if>
			<equals arg1="mysql" arg2="${database.type}" />
			<then>
				<antcall target="upgrade_db_from_v1.2.3_to_1.2.4_mysql" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" />
				<then>
					<antcall target="upgrade_db_from_v1.2.3_to_1.2.4_oracle" />
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
	</target>
	<target name="upgrade_db_from_v1.2.3_to_1.2.4_mysql" description="Upgrading mysql database for all changes required for v1.2.2 ">
		<echo message="Upgrading MySQL Database." />
		<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" password="${database.password}" >
			<transaction src="${dbupgrade.sql.dir}/MySql/DBUpgrade_v1.2.3_to_v1.2.4.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<echo message="Upgrading mysql database for all changes required for v1.2" />
	</target>
	<target name="upgrade_db_for_empi_id__mysql" description="Upgrading mysql database for all changes required for v1.2 ">
					<echo message="Upgrading MySQL Database." />
					<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" password="${database.password}" onerror="continue">
						<transaction src="${dbupgrade.sql.dir}/MySql/alter_participant_empi_id.sql" />
						<transaction>commit;</transaction>
						<classpath>
							<fileset dir="${lib.dir}">
								<include name="*.jar" />
							</fileset>
						</classpath>
					</sql>
					<echo message="Upgrading mysql database for all changes required for v1.2" />
	</target>
	<target name="upgrade_db_from_v1.2.3_to_1.2.4_oracle" description="Upgrading oracle database for all changes required for v1.2.2">
		<echo message="Upgrading Oracle Database."/>
		<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle">
			<transaction src="${dbupgrade.sql.dir}/Oracle/DBUpgrade_v1.2.3_to_v1.2.4.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<echo message="Upgrading oracle database for all changes required for v1.2" />
	</target>
	<target name="upgrade_db_for_empi_id_oracle" description="Upgrading oracle database for all changes required for v1.2">
					<echo message="Upgrading Oracle Database."/>
					<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle" onerror="continue">
						<transaction src="${dbupgrade.sql.dir}/Oracle/alter_participant_empi_id.sql" />
						<transaction>commit;</transaction>
						<classpath>
							<fileset dir="${lib.dir}">
								<include name="*.jar" />
							</fileset>
						</classpath>
					</sql>
					<echo message="Upgrading oracle database for all changes required for v1.2" />
				</target>


			<target name="upgrade_db_for_v1.2_mysql" description="Upgrading mysql database for all changes required for v1.2 ">
				<echo message="Upgrading MySQL Database." />
				<sql driver="${mysql.driver.string}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" password="${database.password}" >
					<transaction src="${dbupgrade.sql.dir}/MySql/UpgradeDB_To_v1.2.sql" />
					<transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
				</sql>
				<echo message="Upgrading mysql database for all changes required for v1.2" />
			</target>

			<target name="upgrade_db_for_v1.2_oracle" description="Upgrading oracle database for all changes required for v1.2">
				<echo message="Upgrading Oracle Database."/>
				<sql driver="${oracle.driver.string}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" rdbms="oracle">
					<transaction src="${dbupgrade.sql.dir}/Oracle/UpgradeDB_To_v1.2.sql" />
					<transaction>commit;</transaction>
					<classpath>
						<fileset dir="${lib.dir}">
							<include name="*.jar" />
						</fileset>
					</classpath>
				</sql>
				<echo message="Upgrading oracle database for all changes required for v1.2" />
			</target>

		<target name="upgrade_db_from_v1.1_to_v1.2" description="Target for Application and Database Upgrade from caTissue v1.1 to v1.2">
			<echo message="Upgrading Database v1.1 to v1.2" />
			<antcall target="upgrade_db_from_v1.1_to_p4" />
			<antcall target="upgrade_db_from_p4_to_p5" />
			<antcall target="upgrade_db_from_p5_to_p5.1" />
			<antcall target="upgrade_de_from_v1.1_to_1.2"/>
			<antcall target="upgrade_query_metadata_for_1.2"/>
			<antcall target="upgrade_db_for_1.2"/>
			<antcall target="insertPaths"/>
		</target>
	
	<target name="upgarde_db_from_v1.2_to_v1.2.1" depends="upgrade_bulk_operation">
		<antcall target="upgrade_category_entity_names"></antcall>
	</target>

	<target name="upgrade_bulk_operation" description="Executes the Bulk Operation Mysql commands.">
			<antcall target="unzip_bulkoperation_installable" />
				<if>
					<equals arg1="mysql" arg2="${database.type}" />
					<then>
						<ant dir="${temp.dir}/bulkoperation" inheritAll="false" antfile="bulkoperationintegration.xml" target="alter_bulk_operation_table">
							<property name="database.driver" value="${mysql.driver.string}" />
							<property name="database.type" value="${database.type}" />
							<property name="parent.base.dir" value="${basedir}/lib" />
							<property name="database.url" value="jdbc:mysql://${database.host}:${database.port}/${database.name}" />
							<property name="database.username" value="${database.username}" />
							<property name="database.password" value="${database.password}" />
							<property name="deploy.temp.dir" value="${basedir}/deploytempCatissuecore"/>
						</ant>
						<ant dir="${temp.dir}/bulkoperation" inheritAll="false" antfile="bulkoperationintegration.xml" target="upgrade_bulk_operation_table">
							<property name="database.driver" value="${mysql.driver.string}" />
							<property name="database.type" value="${database.type}" />
							<property name="parent.base.dir" value="${basedir}/lib" />
							<property name="database.url" value="jdbc:mysql://${database.host}:${database.port}/${database.name}" />
							<property name="database.username" value="${database.username}" />
							<property name="database.password" value="${database.password}" />
							<property name="deploy.temp.dir" value="${basedir}/deploytempCatissuecore"/>
						</ant>
					</then>
					<elseif>
					<equals arg1="oracle" arg2="${database.type}" />
					<then>
						<ant dir="${temp.dir}/bulkoperation" inheritAll="false" antfile="bulkoperationintegration.xml" target="alter_bulk_operation_table">
							<property name="database.driver" value="${oracle.driver.string}" />
							<property name="database.type" value="${database.type}" />
							<property name="parent.base.dir" value="${basedir}/lib" />
							<property name="database.url" value="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" />
							<property name="database.username" value="${database.username}" />
							<property name="database.password" value="${database.password}" />
							<property name="deploy.temp.dir" value="${basedir}/deploytempCatissuecore"/>
							<property name="rdbms" value="oracle" />
						</ant>
						<ant dir="${temp.dir}/bulkoperation" inheritAll="false" antfile="bulkoperationintegration.xml" target="upgrade_bulk_operation_table">
							<property name="database.driver" value="${oracle.driver.string}" />
							<property name="database.type" value="${database.type}" />
							<property name="parent.base.dir" value="${basedir}/lib" />
							<property name="database.url" value="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" />
							<property name="database.username" value="${database.username}" />
							<property name="database.password" value="${database.password}" />
							<property name="deploy.temp.dir" value="${basedir}/deploytempCatissuecore"/>
							<property name="rdbms" value="oracle" />
						</ant>
					</then>
					</elseif>
					<else>
						<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
					</else>
				</if>
			
		</target>

	
		<target name="upgrade_de_from_v1.1_to_1.2" description="Target for upgrading the database for DE from v1.1 to v1.2">
			<antcall target="upgrade_db_from_DE_1.4.0.1_to_DE_1.4.0.2" />
			<antcall target="upgrade_db_from_DE_1.4.0_to_DE_1.4.2"/>
			<antcall target="upgrade_db_maincontainer_data_fixes"/>
		</target>


	<!--Target call for both fresh deployment of caTissue-->
	<target name="deploy_app" depends="deploy_app_catissue">
		<!-- antcall target="insert_dashboard_queries" / -->
		 	<antcall target="jboss_configuration" />
		</target>



	<!-- Upgrade tasks for all P releases -->
		<target name="upgrade_p5.1" description="Upgrading Database from v1.1.p5.1 to v1.2">
			<echo message="Upgrading Database v1.1.p5.1 to v1.2" />
			<antcall target="upgrade_de_from_v1.1_to_1.2"/>
			<antcall target="upgrade_query_metadata_for_1.2"/>
			<antcall target="upgrade_db_for_1.2"/>
			<antcall target="insertPaths"/>
			<antcall target="upgrade_app"/>
		</target>
	
	<target name="upgarde_p5.1_to_1.2.1" description="Upgrading Database from v1.1.p5.1 to v1.2.1">
		
		<antcall target="upgrade_de_from_v1.1_to_1.2"/>
		<antcall target="upgrade_query_metadata_for_1.2"/>
		<antcall target="upgrade_db_for_1.2"/>
		<antcall target="insertPaths"/>
		<antcall target="upgarde_db_from_v1.2_to_v1.2.1"/>
	</target>

		<target name="upgrade_p5" description="Upgrading Database from v1.1.p5 to v1.2">
			<echo message="Upgrading Database v1.1.p5 to v1.2" />
			<antcall target="upgrade_db_from_p5_to_p5.1"/>
			<antcall target="upgrade_p5.1"/>
		</target>

		<target name="upgrade_p4.4" description="Upgrading Database from v1.1.p4.4 to v1.2" depends="upgrade_p4">
		</target>

		<target name="upgrade_p4.3" description="Upgrading Database from v1.1.p4.3 to v1.2" depends="upgrade_p4">
		</target>

		<target name="upgrade_p4" description="Upgrading Database from v1.1.p4 to v1.2">
			<echo message="Upgrading Database v1.1.p4 to v1.2" />
			<antcall target="upgrade_db_from_p4_to_p5"/>
			<antcall target="upgrade_p5"/>
		</target>

	    <target name="upgrade_p2.2" description="Upgrading Database from v1.1.p2.2 to v1.2" depends="upgrade_p2">
		</target>

		<target name="upgrade_p2" description="Upgrading Database from v1.1.p2 to v1.2">
				<echo message="Upgrading Database vp2 to v1.2" />
				<antcall target="upgrade_db_from_p2_to_p4"/>
				<antcall target="upgrade_p4"/>
		</target>

	    <target name="upgrade_p1" description="Upgrading Database from v1.1.p1 to v1.2">
				<echo message="Upgrading Database v1.1.p1 to v1.2" />
				<antcall target="upgrade_db_from_v1.1.p1 to v1.1.p2"/>
				<antcall target="upgrade_p2"/>
		</target>
	
	<property name="categoryNameOrFile" value=" " />
	<property name="mappingXMLFile" value="./BulkOperations/conf/mapping.xml" />
	
	<property name="entityNameOrFile" value=" " />
	<property name="mappingXMLFile" value="./BulkOperations/conf/mapping.xml" />

	<target name="createEMPIAdminUser_oracle">
		<sql driver="${oracle.driver.string}"
			url="jdbc:oracle:thin:@${csm.database.host}:${csm.database.port}:${csm.database.name}"
			userid="${csm.database.username}" password="${csm.database.password}"
			onerror="continue" rdbms="oracle">
			<transaction src="${oracle.sql.dir}/csm_createEMPIAdminUser.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<sql driver="${oracle.driver.string}" output="adminUser.properties"
			print="yes" showheaders="false"
			url="jdbc:oracle:thin:@${csm.database.host}:${csm.database.port}:${csm.database.name}"
			userid="${csm.database.username}" password="${csm.database.password}"
			onerror="continue" rdbms="oracle">
	
			<![CDATA[        select 'user.id=' ||  user_id from csm_user where login_name='clinportal_eMPI@admin.com';
				]]>
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<property file="${base.dir}/adminUser.properties" />
		<echo>${user.id} </echo>
		<copy file="${oracle.sql.dir}/clinportal_createEMPIAdminUser.sql"
			tofile="${oracle.sql.dir}/clinportal_createEMPIAdminUser1.sql" />
		<replace file="${oracle.sql.dir}/clinportal_createEMPIAdminUser1.sql"
			token="@@id@@" value="${user.id}" />
		<sql driver="${oracle.driver.string}"
			url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}"
			userid="${database.username}" password="${database.password}"
			onerror="continue" rdbms="oracle">
			<transaction src="${oracle.sql.dir}/clinportal_createEMPIAdminUser1.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<delete file="adminUser.properties">
		</delete>
		<delete file="${oracle.sql.dir}/clinportal_createEMPIAdminUser1.sql">
		</delete>
	</target>
	
	
	<target name="createEMPIAdminUser_mysql">
		<sql driver="${mysql.driver.string}"
			url="jdbc:mysql://@${csm.database.host}:${csm.database.port}/${csm.database.name}"
			userid="${csm.database.username}" password="${csm.database.password}"
			onerror="continue">
			<transaction src="${mysql.sql.dir}/csm_createEMPIAdminUser.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<sql driver="${mysql.driver.string}" output="adminUser.properties"
			print="yes" showheaders="false"
			url="jdbc:mysql://@${csm.database.host}:${csm.database.port}/${csm.database.name}"
			userid="${csm.database.username}" password="${csm.database.password}"
			onerror="continue">
	
			<![CDATA[        select 'user.id=' ||  user_id from csm_user where login_name='clinportal_eMPI@admin.com';
				]]>
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<property file="${base.dir}/adminUser.properties" />
		<echo>${user.id} </echo>
		<copy file="${mysql.sql.dir}/clinportal_createEMPIAdminUser.sql"
			tofile="${mysql.sql.dir}/clinportal_createEMPIAdminUser1.sql" />
		<replace file="${mysql.sql.dir}/clinportal_createEMPIAdminUser1.sql"
			token="@@id@@" value="${user.id}" />
		<sql driver="${mysql.driver.string}"
			url="jdbc:mysql://${database.host}:${database.port}:${database.name}"
			userid="${database.username}" password="${database.password}"
			onerror="continue">
			<transaction src="${mysql.sql.dir}/clinportal_createEMPIAdminUser1.sql" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<delete file="adminUser.properties">
		</delete>
		<delete file="${mysql.sql.dir}/clinportal_createEMPIAdminUser1.sql">
		</delete>
	</target>
	

	<!--Ashraf: Target for creating CP dashboard tables -->
	
	<target name="add_labelsql_tables_for_cp_dashboard">
		<echo message="Creating lablesql tables for CS dashboard for mysql" />		
		<updateDatabase changeLogFile="${base.dir}/SQL/liquibase_xml/dashboard_scripts.xml" driver="${final.database.driver}" url="${final.database.url}" username="${database.username}" password="${database.password}" dropFirst="false" classpathref="liquibaseClasspath" />
	</target>
	
	
	<!--Ashraf: CS dashboard configuration script-->
			
			                      
			                       
				<property name="filename" value=" " />
				<target name="configureDashboardItem">
				<antcall target="prepare_temp_folder_for_class_execution" /> 
					<java classname="edu.wustl.common.labelSQLApp.util.InsertCSDashboardItem"  fork="true" classpath="${temp.dir}/catissuecore/WEB-INF/classes" maxmemory="1024m">
					<arg value="${filename}" />
						<classpath>
							<fileset dir="${temp.dir}/catissuecore/WEB-INF/lib">
								<include name="**/*.jar" />
							</fileset>
							<fileset dir="${lib.dir}">
								<include name="**/*.jar" />
							</fileset>
						</classpath>
					</java>
				</target>
	
	<target name="prepare_temp_folder_for_class_execution">
			<delete quiet="true" includeemptydirs="true">
				<fileset dir="${temp.dir}/catissuecore">
					<include name="**/*" />
				</fileset>
			</delete>

			<unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore" />
			<copy file="${base.dir}/DE_conf/hibernate.cfg.xml" todir="${temp.dir}/catissuecore/WEB-INF/classes" overwrite="true" />

						<antcall target="copy_de_hibernateconfig_for_class_execution" />

			<unjar src="${temp.dir}/dynamicextensions/binaries/DynamicExtensionsInterface/DynamicExtensions.jar" dest="${temp.dir}/dynamicextensions/WEB-INF/classes" />
			<echo message="Concatenating the Application Resource Properties file" />
			<concat destfile="${temp.dir}/dynamicextensions/WEB-INF/classes/ApplicationResources.properties" append="true">
				<fileset file="${temp.dir}/catissuecore/WEB-INF/classes/ApplicationResources.properties" />
			</concat>
			<copy file="${temp.dir}/dynamicextensions/WEB-INF/classes/ApplicationResources.properties" todir="${temp.dir}/clinportal/WEB-INF/classes" overwrite="true" />

			<if>
				<equals arg1="mysql" arg2="${database.type}" />
				<then>
					<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
						<include name="*.cfg.xml" />
						<replacefilter token="@@DIALECT@@" value="${mysql.dialect.string}" />
						<replacefilter token="@@DRIVER@@" value="com.mysql.jdbc.Driver" />
						<replacefilter token="@@URL@@" value="jdbc:mysql://${database.host}/${database.name}" />
					</replace>
				</then>
				<elseif>
					<equals arg1="oracle" arg2="${database.type}" />
					<then>
						<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
							<include name="*.cfg.xml" />
							<replacefilter token="@@DIALECT@@" value="${oracle.dialect.string}" />
							<replacefilter token="@@DRIVER@@" value="${oracle.driver.string}" />
							<replacefilter token="@@URL@@" value="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" />
						</replace>
					</then>
				</elseif>
			</if>
			<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
				<include name="*.cfg.xml" />
				<replacefilter token="@@DATABASE_USERNAME@@" value="${database.username}" />
				<replacefilter token="@@DATABASE_PASSWORD@@" value="${database.password}" />
			</replace>

			<delete dir="${tempcacore.dir}" />
			<mkdir dir="${tempcacore.dir}" />

		</target>
	    
	
	<target name="copy_de_hibernateconfig_for_class_execution">
			<unzip src="dynamicextensions.zip" dest="${temp.dir}/dynamicextensions" overwrite="true" />
			<copy file="${temp.dir}/dynamicextensions/conf/DynamicExtensionsHibernate.cfg.xml" tofile="${temp.dir}/catissuecore/WEB-INF/classes/DynamicExtensionsHibernate.cfg.xml" overwrite="true" />
			<copy file="${temp.dir}/dynamicextensions/conf/DynamicExtensionsAuditMetadata.xml" tofile="${temp.dir}/catissuecore/WEB-INF/classes/DynamicExtensionsAuditMetadtaa.xml" overwrite="true" />

			<replace dir="${temp.dir}/catissuecore/WEB-INF/classes">
				<include name="DynamicExtensionsHibernate.cfg.xml" />
				<replacefilter token="@@DATABASE_USERNAME@@" value="${database.username}" />
				<replacefilter token="@@DATABASE_PASSWORD@@" value="${database.password}" />
			</replace>
	</target>
	
	<target name="upgrade_db_from_plusv20_plusv2.1">
		<echo message="Upgrading DataBase with URL ${final.database.url}" />	
		<updateDatabase changeLogFile="${base.dir}/SQL/liquibase_xml/DBUpgrade_v21.xml" driver="${final.database.driver}" url="${final.database.url}" username="${database.username}" password="${database.password}" dropFirst="false" classpathref="liquibaseClasspath" />
	</target>
	
	<target name="upgrade_db_from_plusv2.1_plusv3.0">
			<echo message="Upgrading DataBase with URL ${final.database.url}" />	
			<updateDatabase changeLogFile="${base.dir}/SQL/liquibase_xml/DBUpgrade_v30.xml" driver="${final.database.driver}" url="${final.database.url}" username="${database.username}" password="${database.password}" dropFirst="false" classpathref="liquibaseClasspath" />
	</target>
	
	<target name="update_protection_element">
			<echo message="Upgrading DataBase with URL ${final.database.url}" />	
			<updateDatabase changeLogFile="${base.dir}/SQL/liquibase_xml/DBUpgrade_protection_element.xml" driver="${final.database.driver}" url="${final.csm.database.url}" username="${csm.database.username}" password="${csm.database.password}" dropFirst="false" classpathref="liquibaseClasspath" />
	</target>
	
	<target name="upgrade_db_from_plusv1.2_to_plusv2.1">
		<antcall target="upgrade_db_from_suitev1.2_to_plus20" />
		<antcall target="upgrade_db_from_plusv20_plusv2.1" />
		<antcall target="update_protection_element" />
	</target>
	
	<target name="upgrade_db_from_plusv1.2_to_plusv3.0">
		<antcall target="upgrade_db_from_suitev1.2_to_plus20" />
		<antcall target="upgrade_db_from_plusv20_plusv2.1" />
		<antcall target="update_protection_element" />
		<antcall target="upgrade_db_from_plusv2.1_plusv3.0" />
	</target>

	<target name="migrate_forms">
          <unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore" />
          <antcall target="setupClassExecutionEnvironment"/>
          <java classname="krishagni.catissueplus.upgrade.MigrateForms" fork="true" maxmemory="1536M">
            <arg value="${username}"/>
            <classpath>
              <pathelement location="${temp.dir.DE}" />
              <pathelement location="${temp.dir.DE}/old" />
              <fileset dir="WEB-INF/lib">
                <include name="*" />
              </fileset>
              <pathelement location="${temp.dir}/catissuecore/WEB-INF/classes" />
            </classpath>
          </java>
        </target>

        <target name="import_queries">
          <unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore" />
          <antcall target="setupClassExecutionEnvironment"/>
          <java classname="krishagni.catissueplus.upgrade.ImportQueries" fork="true" maxmemory="1024M">
            <arg value="${username}"/>
            <arg value="aq-queries"/>
            <arg value="Default Queries"/>
            <classpath>
              <pathelement location="${temp.dir.DE}" />
              <pathelement location="${temp.dir.DE}/old" />
              <fileset dir="WEB-INF/lib">
                <include name="*" />
              </fileset>
              <pathelement location="${temp.dir}/catissuecore/WEB-INF/classes" />
            </classpath>
          </java>
        </target>

	<target name="migrate_spp">
          <unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore" />
          <antcall target="setupClassExecutionEnvironment"/>
          <java classname="krishagni.catissueplus.upgrade.MigrateSppForms" fork="true" maxmemory="1536M">
            <arg value="${username}"/>
            <classpath>
              <pathelement location="${temp.dir.DE}" />
              <pathelement location="${temp.dir.DE}/old" />
              <fileset dir="WEB-INF/lib">
                <include name="*" />
              </fileset>
              <pathelement location="${temp.dir}/catissuecore/WEB-INF/classes" />
            </classpath>
          </java>
	</target>

        <target name="migrate_specimen_events">
          <unwar src="${base.dir}/catissuecore.war" dest="${temp.dir}/catissuecore" />
          <antcall target="setupClassExecutionEnvironment"/>

          <java classname="krishagni.catissueplus.upgrade.MigrateSpecimenEvents" fork="true" maxmemory="1024M">
            <arg value="${username}"/>
            <arg value="spe-forms/events-cfg.json"/>
            <classpath>
              <pathelement location="${temp.dir.DE}" />
              <pathelement location="${temp.dir.DE}/old" />
              <fileset dir="WEB-INF/lib">
                <include name="*" />
              </fileset>
              <pathelement location="${temp.dir}/catissuecore/WEB-INF/classes" />
            </classpath>
          </java>
        </target>

        <target name="prepare_nciv20_for_os_upgrade">
          <echo message="Preparing caTissue NCI v2.0 database for OS upgrade."/>
          <updateDatabase 
            changeLogFile="${base.dir}/SQL/liquibase_xml/db-nciv2-changelog.xml" 
            driver="${final.database.driver}" 
            url="${final.database.url}" 
            username="${database.username}" 
            password="${database.password}" 
            dropFirst="false" 
            classpathref="liquibaseClasspath" />
	</target>

	<target name="post_upgrade">
          <antcall target="aq_form"/>
	</target>
</project>
